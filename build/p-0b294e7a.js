import{ac as t,ad as s,aR as e,bI as i,c as r,s as o,fS as p,fV as a,ay as n,b1 as h,V as m,at as c,hu as f,P as l,aS as j,eV as d,hv as b,k as u,l as y,n as w,bM as v}from"./p-98455486.js";import{j as x,i as M}from"./p-962c5bf1.js";import"./p-2b228be3.js";import{a as _}from"./p-5572f01a.js";import"./p-1ecac668.js";import{T as g}from"./p-7dc0ec82.js";import"./p-1abe3c64.js";import{c as E,u as R}from"./p-908b7a05.js";import{D as T,F as V}from"./p-13e550f5.js";import{i as S,w as P}from"./p-ed1a11ab.js";import{T as A,b as I}from"./p-7099a764.js";import{n as L}from"./p-0c70c0e2.js";import"./p-620ed352.js";import"./p-220b11a0.js";import"./p-4f76b2d1.js";import{t as q}from"./p-2d1dac84.js";import"./p-8a4ae095.js";import"./p-25e77904.js";import"./p-8e3fbd83.js";import"./p-a3c11f30.js";import"./p-aff398b0.js";import"./p-bd7f9fc7.js";import"./p-af5dfb20.js";import"./p-38e70926.js";import"./p-8399f9e1.js";import{r as z}from"./p-b4b7d6a0.js";import{v as C}from"./p-14843b2a.js";import{y as D,d as H}from"./p-4cbc7b66.js";import"./p-f5452a6b.js";import"./p-8b2bb530.js";import{e as O}from"./p-de65f975.js";import{r as G}from"./p-3a9bb31c.js";import{n as U}from"./p-783b6965.js";import{r as k,i as F,M as Q,f as W,h as B}from"./p-b8afab55.js";import{e as J}from"./p-07f12c16.js";import{G as K}from"./p-d46be2b1.js";import{f as N,d as X}from"./p-f7917469.js";import"./p-b0610ac0.js";import"./p-ffb89da5.js";import"./p-9f1a0adc.js";import"./p-2b6b8db8.js";import"./p-50b034e8.js";import"./p-e6a64715.js";import"./p-6bb7b693.js";import"./p-0e94eaa4.js";import"./p-ecc7ed03.js";import"./p-de65627f.js";import"./p-0d2202fd.js";import"./p-f33b44a5.js";import"./p-a2737e04.js";import"./p-1172b129.js";import"./p-4e1a9b2e.js";import"./p-eda79132.js";import"./p-69ec1c26.js";import"./p-5977fcaf.js";import"./p-eeca6bc1.js";import"./p-21ae9bf7.js";import"./p-aedab47c.js";import"./p-30bab7e4.js";import"./p-73062657.js";import"./p-f705ab94.js";import"./p-3c3976eb.js";import"./p-623dbe5e.js";import"./p-073c3089.js";import"./p-c6ce33a2.js";import"./p-795f7c81.js";import"./p-42c332a2.js";import"./p-c782b111.js";import"./p-83c727f2.js";import"./p-cc77f67d.js";import"./p-a18c7841.js";import"./p-dc29c329.js";import"./p-9a4094ba.js";import"./p-fc9cd10b.js";import"./p-4f27d9ab.js";import"./p-c5929b55.js";import"./p-8043ab9b.js";import"./p-a9fef357.js";import"./p-e91d9d8d.js";import"./p-e22a21a4.js";import"./p-958a5da8.js";import"./p-fcbd27c0.js";import"./p-5abe9c67.js";import"./p-66f65b6a.js";import"./p-dfd7ee02.js";import"./p-da8336be.js";import"./p-0fdabe4a.js";import"./p-9803a24d.js";import"./p-b15bfa44.js";import"./p-baa730bb.js";import"./p-e1758a64.js";import"./p-ec443a8b.js";import"./p-f4b056c3.js";import"./p-6133cc0f.js";import"./p-e75aa2b5.js";import"./p-f5f26b1f.js";const Y=O();class Z extends _{constructor(p){super(),this.elementView=p,this.isWrapAround=!1,this.perspectiveTransform=U(),this._vertices=new Float32Array(20),this._handles=[],this._handles.push(t((()=>this.elementView.element.opacity),(t=>this.opacity=t),s),t((()=>[this.elementView.coords]),(()=>{this.requestRender()}),s),e((()=>this.elementView.element.loaded),(()=>{const t=this.elementView.element;this.ready(),"video"===t.type&&null!=t.content&&this._handles.push(i(t.content,"play",(()=>this.requestRender())))}),s)),p.element.load().catch((t=>{r.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new o("element-load-error","Element cannot be displayed",{element:p,error:t}))}))}destroy(){this._handles.forEach((t=>t.remove())),this.texture=p(this.texture)}get dvsMat3(){return this.parent.dvsMat3}beforeRender(t){const{context:s}=t,e=this.elementView.element.content;if(null!=e){const t=e instanceof HTMLImageElement,i=e instanceof HTMLVideoElement,r=t?e.naturalWidth:i?e.videoWidth:e.width,o=t?e.naturalHeight:i?e.videoHeight:e.height;if(this._updatePerspectiveTransform(r,o),this.texture)i&&!e.paused&&(this.texture.setData(e),this.requestRender(),(s.type===L.WEBGL2||a(r)&&a(o))&&this.texture.generateMipmap());else{const t=new I;t.wrapMode=T.CLAMP_TO_EDGE,t.preMultiplyAlpha=!0,t.width=r,t.height=o,this.texture=new A(s,t,e),(s.type===L.WEBGL2||a(r)&&a(o))&&this.texture.generateMipmap(),i&&!e.paused&&this.requestRender()}}super.beforeRender(t)}_createTransforms(){return null}updateDrawCoords(t,s){const e=this.elementView.coords;if(null==e)return;const[i,r,o,p]=e.rings[0],a=this._vertices,{x:n,y:h}=t,m=0!==s;m?a.set([r[0]-n,r[1]-h,i[0]-n,i[1]-h,o[0]-n,o[1]-h,p[0]-n,p[1]-h,p[0]-n,p[1]-h,r[0]+s-n,r[1]-h,r[0]+s-n,r[1]-h,i[0]+s-n,i[1]-h,o[0]+s-n,o[1]-h,p[0]+s-n,p[1]-h]):a.set([r[0]-n,r[1]-h,i[0]-n,i[1]-h,o[0]-n,o[1]-h,p[0]-n,p[1]-h]),this.isWrapAround=m}getVAO(t,s,e){if(null==this.elementView.coords)return null;const i=this._vertices;if(this._vao)this._geometryVbo.setData(i);else{this._geometryVbo=E.createVertex(t,V.DYNAMIC_DRAW,i);const r=E.createVertex(t,V.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new R(t,e,s,{geometry:this._geometryVbo,tex:r})}return this._vao}_updatePerspectiveTransform(t,s){const e=this._vertices;x(Y,[0,0,t,0,0,s,t,s],[e[0],e[1],e[4],e[5],e[2],e[3],e[6],e[7]]),G(this.perspectiveTransform,Y[6]/Y[8]*t,Y[7]/Y[8]*s)}}class $ extends S{constructor(){super(...arguments),this._localOrigin=n(0,0),this._viewStateId=-1,this._dvsMat3=J(),this.requiresDedicatedFBO=!1}get dvsMat3(){return this._dvsMat3}beforeRender(t){this._updateMatrices(t),this._updateOverlays(t,this.children);for(const s of this.children)s.beforeRender(t)}prepareRenderPasses(t){const s=t.registerRenderPass({name:"overlay",brushes:[P.overlay],target:()=>this.children,drawPhase:g.MAP});return[...super.prepareRenderPasses(t),s]}_updateMatrices(t){const{state:s}=t,{id:e,size:i,pixelRatio:r,resolution:o,rotation:p,viewpoint:a,displayMat3:n}=s;if(this._viewStateId===e)return;const h=Math.PI/180*p,m=r*i[0],c=r*i[1],{x:f,y:l}=a.targetGeometry,j=C(f,s.spatialReference);this._localOrigin.x=j,this._localOrigin.y=l;const d=o*m,b=o*c,u=k(this._dvsMat3);F(u,u,n),Q(u,u,q(m/2,c/2)),W(u,u,z(m/d,-c/b,1)),B(u,u,-h),this._viewStateId=e}_updateOverlays(t,s){const{state:e}=t,{rotation:i,spatialReference:r,worldScreenWidth:o,size:p,viewpoint:a}=e,n=this._localOrigin;let m=0;const c=h(r);if(c&&r.isWrappable){const t=p[0],h=p[1],f=180/Math.PI*i,l=Math.abs(Math.cos(f)),j=Math.abs(Math.sin(f)),d=Math.round(t*l+h*j),[b,u]=c.valid,y=K(r),{x:w,y:v}=a.targetGeometry,x=[w,v],M=[0,0];e.toScreen(M,x);const _=[0,0];let g;g=d>o?.5*o:.5*d;const E=Math.floor((w+.5*y)/y),R=b+E*y,T=u+E*y,V=[M[0]+g,0];e.toMap(_,V),_[0]>T&&(m=y),V[0]=M[0]-g,e.toMap(_,V),_[0]<R&&(m=-y);for(const t of s){const s=t.elementView.bounds;if(null==s)continue;const[e,,i]=s;e<b&&i>b?t.updateDrawCoords(n,y):i>u&&e<u?t.updateDrawCoords(n,-y):t.updateDrawCoords(n,m)}}else for(const t of s)t.updateDrawCoords(n,m)}}let tt=class extends(N(X)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this.layer=null,this.elements=new m}attach(){this.addAttachHandles([c((()=>this.layer.effectiveSource),"refresh",(()=>{this._tileStrategy.refresh((t=>this._updateTile(t))),this.requestUpdate()})),c((()=>this.layer.effectiveSource),"change",(({element:t})=>this._elementUpdateHandler(t)))]),this._overlayContainer=new $,this.container.addChild(this._overlayContainer),this._fetchQueue=new D({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(t,s)=>this._queryElements(t,s)}),this._tileStrategy=new H({cachePolicy:"purge",resampling:!0,acquireTile:t=>this._acquireTile(t),releaseTile:t=>this._releaseTile(t),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(t){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(t){this._tileStrategy.update(t),this._debugGraphicsView?.update(t)}async hitTest(t,s){const e=[],i=t.normalize(),r=[i.x,i.y];for(const{projectedElement:{normalizedCoords:s,element:i}}of this._elementReferences.values())null!=s&&f(s.rings,r)&&e.push({type:"media",element:i,layer:this.layer,mapPoint:t});return e.reverse()}canResume(){return null!=this.layer.source&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh((t=>this._updateTile(t)))}_acquireTile(t){const s=new rt(t.clone());return this._updateTile(s),s}_updateTile(t){this.updatingHandles.addPromise(this._fetchQueue.push(t.key).then((s=>{const[e,i]=t.setElements(s);this._referenceElements(t,e),this._dereferenceElements(t,i),this.requestUpdate()}),(t=>{l(t)||r.getLogger(this).error(t)})))}_releaseTile(t){this._fetchQueue.abort(t.key.id),t.elements&&this._dereferenceElements(t,t.elements),this.requestUpdate()}async _queryElements(t,s){const e=this.layer.effectiveSource;if(null==e)return[];this.view.featuresTilingScheme.getTileBounds(st,t,!0);const i=new j({xmin:st[0],ymin:st[1],xmax:st[2],ymax:st[3],spatialReference:this.view.spatialReference});return e.queryElements(i,s)}_referenceElements(t,s){if(null!=this.layer.source)for(const e of s)this._referenceElement(t,e)}_referenceElement(t,s){d(this._elementReferences,s.uid,(()=>{const t=new M({element:s,spatialReference:this.view.spatialReference}),e=new Z(t);this._overlayContainer.addChild(e),this.elements.add(s);let i=null;return{tiles:new Set,projectedElement:t,overlay:e,debugGraphic:i}})).tiles.add(t)}_dereferenceElements(t,s){for(const e of s)this._dereferenceElement(t,e)}_dereferenceElement(t,s){const e=this._elementReferences.get(s.uid);e.tiles.delete(t),e.tiles.size||(this._overlayContainer.removeChild(e.overlay),e.overlay.destroy(),e.projectedElement.destroy(),this._elementReferences.delete(s.uid),this.elements.remove(s),this._debugGraphicsView?.graphics.remove(e.debugGraphic))}_elementUpdateHandler(t){let s=this._elementReferences.get(t.uid);if(s){const e=s.projectedElement.normalizedCoords;if(null==e)return this._overlayContainer.removeChild(s.overlay),s.overlay.destroy(),s.projectedElement.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),void this._debugGraphicsView?.graphics.remove(s.debugGraphic);const i=[],r=[];for(const t of this._tileStrategy.tiles){const o=it(this.view.featuresTilingScheme,t,e);s.tiles.has(t)?o||r.push(t):o&&i.push(t)}for(const s of i)this._referenceElement(s,t);for(const s of r)this._dereferenceElement(s,t);return s=this._elementReferences.get(t.uid),void(s?.debugGraphic&&(s.debugGraphic.geometry=s.projectedElement.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:s.debugGraphic,property:"geometry"})))}const e=new M({element:t,spatialReference:this.view.spatialReference}).normalizedCoords;if(null!=e)for(const s of this._tileStrategy.tiles){it(this.view.featuresTilingScheme,s,e)&&this._referenceElement(s,t)}}};u([y()],tt.prototype,"_fetchQueue",void 0),u([y()],tt.prototype,"layer",void 0),u([y({readOnly:!0})],tt.prototype,"elements",void 0),tt=u([w("esri.views.2d.layers.MediaLayerView2D")],tt);const st=v(),et={xmin:0,ymin:0,xmax:0,ymax:0};function it(t,s,e){return t.getTileBounds(st,s.key,!0),et.xmin=st[0],et.ymin=st[1],et.xmax=st[2],et.ymax=st[3],b(et,e)}class rt{constructor(t){this.key=t,this.elements=null,this.isReady=!1,this.visible=!0}setElements(t){const s=[],e=new Set(this.elements);this.elements=t;for(const i of t)e.has(i)?e.delete(i):s.push(i);return this.isReady=!0,[s,Array.from(e)]}destroy(){}}const ot=tt;export default ot;
//# sourceMappingURL=p-0b294e7a.js.map