import{ac as t,P as s,aQ as i,c as p,k as e,l as r,n as a}from"./p-98455486.js";import{t as o,n as h}from"./p-65915957.js";import{f as m,d as c}from"./p-f7917469.js";import{h as j}from"./p-f5452a6b.js";import{e as n}from"./p-8b2bb530.js";import{y as f,d as l}from"./p-4cbc7b66.js";import{a as b}from"./p-4c46e2fb.js";import"./p-17257453.js";import"./p-07f12c16.js";import"./p-fde2045e.js";import"./p-b8afab55.js";import"./p-2d1dac84.js";import"./p-5572f01a.js";import"./p-1abe3c64.js";import"./p-13e550f5.js";import"./p-7099a764.js";import"./p-0c70c0e2.js";import"./p-cc77f67d.js";import"./p-ed1a11ab.js";import"./p-908b7a05.js";import"./p-795f7c81.js";import"./p-7dc0ec82.js";import"./p-0e94eaa4.js";import"./p-620ed352.js";import"./p-9f1a0adc.js";import"./p-220b11a0.js";import"./p-4f76b2d1.js";import"./p-42c332a2.js";import"./p-38e70926.js";import"./p-3a9bb31c.js";import"./p-783b6965.js";import"./p-8399f9e1.js";import"./p-e6a64715.js";import"./p-dc29c329.js";import"./p-1382d09e.js";import"./p-d46be2b1.js";import"./p-fc9cd10b.js";import"./p-4f27d9ab.js";import"./p-ecc7ed03.js";import"./p-c5929b55.js";import"./p-8043ab9b.js";import"./p-a9fef357.js";import"./p-0d2202fd.js";import"./p-f33b44a5.js";import"./p-e91d9d8d.js";import"./p-e22a21a4.js";import"./p-958a5da8.js";import"./p-fcbd27c0.js";import"./p-5abe9c67.js";import"./p-66f65b6a.js";import"./p-14843b2a.js";import"./p-ffb89da5.js";import"./p-dfd7ee02.js";import"./p-da8336be.js";import"./p-1172b129.js";import"./p-0fdabe4a.js";import"./p-9803a24d.js";import"./p-b15bfa44.js";import"./p-baa730bb.js";import"./p-e1758a64.js";import"./p-ec443a8b.js";import"./p-f4b056c3.js";import"./p-6133cc0f.js";import"./p-e75aa2b5.js";import"./p-f5f26b1f.js";import"./p-c782b111.js";import"./p-9a4094ba.js";const d=[102113,102100,3857,3785,900913],u=[0,0];let w=class extends(b(o(m(c)))){constructor(){super(...arguments),this._tileStrategy=null,this._fetchQueue=null,this._tileRequests=new Map,this.layer=null}get tileMatrixSet(){const t=this._getTileMatrixSetBySpatialReference(this.layer.activeLayer);return t?(t.id!==this.layer.activeLayer.tileMatrixSetId&&(this.layer.activeLayer.tileMatrixSetId=t.id),t):null}update(t){this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume()}attach(){const s=this.tileMatrixSet?.tileInfo;s&&(this._tileInfoView=new j(s),this._fetchQueue=new f({tileInfoView:this._tileInfoView,concurrency:16,process:(t,s)=>this.fetchTile(t,s)}),this._tileStrategy=new l({cachePolicy:"keep",resampling:!0,acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView}),this.addAttachHandles(t((()=>[this.layer?.activeLayer?.styleId,this.tileMatrixSet]),(()=>this._refresh()))),super.attach())}detach(){super.detach(),this._tileStrategy?.destroy(),this._fetchQueue?.destroy(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}releaseTile(t){this._fetchQueue.abort(t.key.id),this._bitmapView.removeChild(t),t.once("detach",(()=>t.destroy())),this.requestUpdate()}acquireTile(t){const s=this._bitmapView.createTile(t),i=s.bitmap;return[i.x,i.y]=this._tileInfoView.getTileCoords(u,s.key),i.resolution=this._tileInfoView.getTileResolution(s.key),[i.width,i.height]=this._tileInfoView.tileInfo.size,this._enqueueTileFetch(s),this._bitmapView.addChild(s),this.requestUpdate(),s}async doRefresh(){!this.attached||this.updateRequested||this.suspended||this._refresh()}isUpdating(){return this._fetchQueue?.updating??!1}async fetchTile(t,i={}){const p="tilemapCache"in this.layer?this.layer.tilemapCache:null,{signal:e,resamplingLevel:r=0}=i;if(!p)return this._fetchImage(t,e);const a=new n(0,0,0,0);let o;try{await p.fetchAvailabilityUpsample(t.level,t.row,t.col,a,{signal:e}),o=await this._fetchImage(a,e)}catch(p){if(s(p))throw p;if(r<3){const s=this._tileInfoView.getTileParentId(t.id);if(s){const p=new n(s),e=await this.fetchTile(p,{...i,resamplingLevel:r+1});return h(this._tileInfoView,e,p,t)}}throw p}return h(this._tileInfoView,o,a,t)}canResume(){const t=super.canResume();return t?null!==this.tileMatrixSet:t}supportsSpatialReference(t){return this.layer.activeLayer.tileMatrixSets?.some((s=>i(s.tileInfo?.spatialReference,t)))??!1}async _enqueueTileFetch(t){if(!this._fetchQueue.has(t.key.id)){try{const s=await this._fetchQueue.push(t.key);t.bitmap.source=s,t.bitmap.width=this._tileInfoView.tileInfo.size[0],t.bitmap.height=this._tileInfoView.tileInfo.size[1],t.once("attach",(()=>this.requestUpdate()))}catch(t){s(t)||p.getLogger(this).error(t)}this.requestUpdate()}}async _fetchImage(t,s){return this.layer.fetchImageBitmapTile(t.level,t.row,t.col,{signal:s})}_refresh(){this._fetchQueue.reset(),this._tileStrategy.refresh((t=>{if(!t.bitmap.source)return;const i={id:t.key.id,fulfilled:!1,promise:this._fetchQueue.push(t.key).then((s=>{t.bitmap.source=s})).catch((i=>{s(i)||(t.bitmap.source=null)})).finally((()=>{t.requestRender(),i.fulfilled=!0}))};this._tileRequests.set(t,i)}))}_getTileMatrixSetBySpatialReference(t){const s=this.view.spatialReference;if(!t.tileMatrixSets)return null;let p=t.tileMatrixSets.find((t=>i(t.tileInfo?.spatialReference,s)));return!p&&s.isWebMercator&&(p=t.tileMatrixSets.find((t=>d.includes(t.tileInfo?.spatialReference.wkid??-1)))),p}};e([r()],w.prototype,"_fetchQueue",void 0),e([r({readOnly:!0})],w.prototype,"tileMatrixSet",null),w=e([a("esri.views.2d.layers.WMTSLayerView2D")],w);const y=w;export default y;
//# sourceMappingURL=p-2cbe61dc.js.map