import{a5 as t}from"./p-98455486.js";import{q as n,C as e,i as r}from"./p-7565150d.js";class l{constructor(t=15e3,n=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,n)}decreaseRefCount(t,n){const e=t+"/"+n,r=this._cachedBlocks;if(r.has(e)){const t=r.get(e);return t.refCount--,t.refCount<=0&&(r.delete(e),t.controller&&t.controller.abort()),t.refCount}return 0}getBlock(t,n){const e=t+"/"+n,r=this._cachedBlocks;if(r.has(e)){const t=r.get(e);return t.ts=Date.now(),t.refCount++,r.delete(e),r.set(e,t),t.block}return null}putBlock(t,n,e,r){const l=this._cachedBlocks,i=t+"/"+n;if(l.has(i)){const t=l.get(i);t.ts=Date.now(),t.refCount++}else l.set(i,{block:e,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(t,n){const e=this._cachedBlocks,r=t+"/"+n;e.has(r)&&e.delete(r)}updateMaxSize(t){this._size=t,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const t=this._cachedBlocks;this._timer=setInterval((()=>{const n=Array.from(t),e=Date.now();for(let r=0;r<n.length&&n[r][1].ts<=e-this._duration;r++)t.delete(n[r][0]);0===t.size&&this._clearTimer()}),this._interval)}_trim(){const t=this._cachedBlocks;if(-1===this._size||this._size>=t.size)return;const n=Array.from(t);for(let e=0;e<n.length-this._size;e++)t.delete(n[e][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}const i=new Map,s=new l;function o(t,n){return null==n?t:`${t}?sliceId=${n}`}function u(t,n){const e={extent:null,rasterInfo:n,cache:new Map},r=i.get(t);return r?(r.push(e),r.length-1):(i.set(t,[e]),0)}function c(t,n){const e=i.get(t);e&&(e[n]=null,e.some((t=>null!=t))||i.delete(t))}function f(t,n,e){const r=i.get(t);if(!r)return null==n?s.decreaseRefCount(t,e):0;if(null==n||null==r[n])return s.decreaseRefCount(t,e);const l=r[n]?.cache,o=l?.get(e);if(l&&o){if(o.refCount--,0===o.refCount){l.delete(e);for(let t=0;t<r.length;t++)r[t]?.cache.delete(e);o.controller&&o.controller.abort()}return o.refCount}return 0}function a(t,n,e){const r=i.get(t);if(!r)return null==n?s.getBlock(t,e):null;if(null==n||null==r[n]){for(let t=0;t<r.length;t++){const n=r[t]?.cache.get(e);if(n)return n.refCount++,n.block}return s.getBlock(t,e)}const l=r[n]?.cache.get(e);if(l)return l.refCount++,l.block;for(let t=0;t<r.length;t++){if(t===n||!r[t])continue;const l=r[t]?.cache,i=l?.get(e);if(l&&i)return i.refCount++,l.set(e,i),i.block}return null}function h(t,n,e,r,l=null){const o=i.get(t);if(!o)return void(null==n&&s.putBlock(t,e,r,l));if(null==n||null==o[n])return void s.putBlock(t,e,r,l);const u={refCount:1,block:r,isResolved:!1,isRejected:!1,controller:l};r.then((()=>u.isResolved=!0)).catch((()=>u.isRejected=!0)),o[n]?.cache.set(e,u)}function M(t,n,e){const r=i.get(t);r?null!=n&&null!=r[n]?r[n]?.cache.delete(e):s.deleteBlock(t,e):null==n&&s.deleteBlock(t,e)}function p(t,n){const e=i.get(t);return e?e[n]??null:null}function m(l,i,s,o,u,c,f=null){const a=p(l,i);if(!a)return;const h=a.extent,{cache:M,rasterInfo:m}=a;if(h&&h.xmin===s.xmin&&h.xmax===s.xmax&&h.ymin===s.ymin&&h.ymax===s.ymax)return;o=o??0;const d=s.clone().normalize(),{spatialReference:x,transform:y}=m,v=new Set;for(let l=0;l<d.length;l++){const i=d[l];if(i.xmax-i.xmin<=o||i.ymax-i.ymin<=o)continue;let s=n(i,x,f);null!=y&&(s=y.inverseTransform(s));const a=new t({x:o,y:o,spatialReference:i.spatialReference});if(null==u&&!(u=e(a,x,i,f)))return;const{pyramidLevel:h,pyramidResolution:M,excessiveReading:p}=r(u,m,c||"closest");if(p)return;const{storageInfo:R}=m,{origin:w}=R,I={x:Math.max(0,Math.floor((s.xmin-w.x)/M.x)),y:Math.max(0,Math.floor((w.y-s.ymax)/M.y))},g=Math.ceil((s.xmax-s.xmin)/M.x-.1),k=Math.ceil((s.ymax-s.ymin)/M.y-.1),$=h>0?R.pyramidBlockWidth:R.blockWidth,C=h>0?R.pyramidBlockHeight:R.blockHeight,D=1,j=Math.max(0,Math.floor(I.x/$)-D),B=Math.max(0,Math.floor(I.y/C)-D),S=Math.floor((I.x+g-1)/$)+D,_=Math.floor((I.y+k-1)/C)+D;for(let t=B;t<=_;t++)for(let n=j;n<=S;n++)v.add(`${h}/${t}/${n}`)}M.forEach(((t,n)=>{if(!v.has(n)){const t=M.get(n);(null==t||t.isResolved||t.isRejected)&&M.delete(n)}})),a.extent={xmin:s.xmin,ymin:s.ymin,xmax:s.xmax,ymax:s.ymax}}export{c as a,m as g,M as h,o as i,a as m,f as s,u,h as x};
//# sourceMappingURL=p-44f0468a.js.map