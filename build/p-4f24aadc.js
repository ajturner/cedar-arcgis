import{k as e,l as t,n,a2 as i,o as r,aT as s,h as o,bB as a,s as l,a$ as d,dl as c,a5 as h,ce as u,b6 as p,c as y,j as w,cv as f,g,cL as m,dJ as v,aJ as b,iT as T,hP as I,i4 as E,hG as j,hH as k,hJ as G,bS as S,iU as R,fL as x,r as M,t as C,i7 as A,hM as N,M as _,aS as D,hp as P,id as O,V as F,v as L}from"./p-98455486.js";import{p as $}from"./p-6b190929.js";import{r as q}from"./p-8399f9e1.js";import{a as U,t as Q}from"./p-e6a64715.js";import{m as B}from"./p-db9c2186.js";import{e as H}from"./p-c05df3c1.js";import{c as z,o as Y}from"./p-79c78b39.js";import"./p-dc29c329.js";import"./p-c73bdcee.js";import"./p-fe526e38.js";import"./p-9a4094ba.js";import"./p-9f1a0adc.js";import"./p-073c3089.js";import"./p-c6ce33a2.js";import"./p-f63bd4b0.js";import"./p-14843b2a.js";import"./p-ffb89da5.js";import"./p-0ea2a103.js";import"./p-623dbe5e.js";import"./p-1b4a7439.js";import"./p-0d2202fd.js";import"./p-f33b44a5.js";import"./p-f4b056c3.js";const K="ESRI__DESTINATION_ID",W="ESRI__ORIGIN_ID";class J{constructor(){this._featureLookup=new Map}static getInstance(){return J.instance||(J.instance=new J),J.instance}static resetInstance(){J.instance&&(J.instance=null)}deleteFromStore(e){e.forEach((e=>{this._featureLookup.delete(e)}))}readFromStoreByList(e){const t=[];return e.forEach((e=>{const n=this.readFromStoreById(e);n&&t.push(n)})),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,t,n){const i=[];return e.forEach((e=>{if(!e||!e.id)return;e.properties||(e.properties=[]);let r,s=null;if(n&&(s=e.properties[n]?q(e.properties[n]):null),"originId"in e&&"destinationId"in e&&(e.properties[W]=e.originId,e.properties[K]=e.destinationId),e.properties[t]=e.id,e.id&&this._featureLookup.has(e.id)&&this._featureLookup.get(e.id).attributes){const n=this._featureLookup.get(e.id);r=new U(s?JSON.parse(JSON.stringify(s)):n?.geometry?JSON.parse(JSON.stringify(n.geometry)):null,JSON.parse(JSON.stringify(Object.assign(n.attributes,e.properties))),null,e.properties[t])}else r=new U(s?JSON.parse(JSON.stringify(s)):null,e.properties,null,e.properties[t]);this._featureLookup.set(e.id,r),i.push(r)})),i}}let V=class extends i{constructor(e){super(e),this.resultRows=[]}};e([t()],V.prototype,"resultRows",void 0),V=e([n("esri.rest.knowledgeGraph.GraphQueryResult")],V);const Z=V;let X=class extends i{constructor(e){super(e),this.resultRowsStream=new ReadableStream}};e([t()],X.prototype,"resultRowsStream",void 0),X=e([n("esri.rest.knowledgeGraph.GraphQueryResult")],X);const ee=X;let te=class extends r{constructor(e){super(e),this.name=null,this.unique=null,this.ascending=null,this.description=null,this.fieldNames=null}};e([t({type:String,json:{write:!0}})],te.prototype,"name",void 0),e([t({type:Boolean,json:{write:!0}})],te.prototype,"unique",void 0),e([t({type:Boolean,json:{write:!0}})],te.prototype,"ascending",void 0),e([t({type:String,json:{write:!0}})],te.prototype,"description",void 0),e([t({type:[String],json:{write:!0}})],te.prototype,"fieldNames",void 0),te=e([n("esri.rest.knowledgeGraph.FieldIndex")],te);const ne=te;let ie=class extends r{constructor(e){super(e),this.name=null,this.alias=null,this.fieldType=null,this.geometryType=null,this.hasM=null,this.hasZ=null,this.nullable=null,this.editable=null,this.required=null,this.defaultVisibility=null,this.systemMaintained=null,this.role=null,this.defaultValue=null}};e([t({type:String,json:{write:!0}})],ie.prototype,"name",void 0),e([t({type:String,json:{write:!0}})],ie.prototype,"alias",void 0),e([t({type:String,json:{write:!0}})],ie.prototype,"fieldType",void 0),e([t({type:String,json:{write:!0}})],ie.prototype,"geometryType",void 0),e([t({type:Boolean,json:{write:!0}})],ie.prototype,"hasM",void 0),e([t({type:Boolean,json:{write:!0}})],ie.prototype,"hasZ",void 0),e([t({type:Boolean,json:{write:!0}})],ie.prototype,"nullable",void 0),e([t({type:Boolean,json:{write:!0}})],ie.prototype,"editable",void 0),e([t({type:Boolean,json:{write:!0}})],ie.prototype,"required",void 0),e([t({type:Boolean,json:{write:!0}})],ie.prototype,"defaultVisibility",void 0),e([t({type:Boolean,json:{write:!0}})],ie.prototype,"systemMaintained",void 0),e([t()],ie.prototype,"role",void 0),e([t({type:Object,json:{type:String,write:{writer:(e,t)=>{t.defaultValue=null!=e?e.toString():null}}}})],ie.prototype,"defaultValue",void 0),ie=e([n("esri.rest.knowledgeGraph.GraphProperty")],ie);const re=ie;let se=class extends r{constructor(e){super(e),this.name=null,this.alias=null,this.role=null,this.strict=null,this.properties=null,this.fieldIndexes=null}};e([t({type:String,json:{write:!0}})],se.prototype,"name",void 0),e([t({type:String,json:{write:!0}})],se.prototype,"alias",void 0),e([t({type:String,json:{write:!0}})],se.prototype,"role",void 0),e([t({type:Boolean,json:{write:!0}})],se.prototype,"strict",void 0),e([t({type:[re],json:{write:!0}})],se.prototype,"properties",void 0),e([t({type:[ne],json:{write:!0}})],se.prototype,"fieldIndexes",void 0),se=e([n("esri.rest.knowledgeGraph.GraphObjectType")],se);const oe=se;let ae=class extends oe{constructor(e){super(e)}};ae=e([n("esri.rest.knowledgeGraph.EntityType")],ae);const le=ae;let de=class extends oe{constructor(e){super(e),this.endPoints=[]}};e([t()],de.prototype,"endPoints",void 0),de=e([n("esri.rest.knowledgeGraph.RelationshipType")],de);const ce=de;let he=class extends r{constructor(e){super(e),this.timestamp=null,this.spatialReference=null,this.strict=null,this.objectIdField=null,this.globalIdField=null,this.arcgisManaged=null,this.identifierInfo=null,this.searchIndexes=null,this.entityTypes=null,this.relationshipTypes=null}};e([t({type:Date,json:{type:Number,write:{writer:(e,t)=>{t.timestamp=e?.getTime()}}}})],he.prototype,"timestamp",void 0),e([t({type:s,json:{write:!0}})],he.prototype,"spatialReference",void 0),e([t({type:Boolean,json:{write:!0}})],he.prototype,"strict",void 0),e([t({type:String,json:{write:!0}})],he.prototype,"objectIdField",void 0),e([t({type:String,json:{write:!0}})],he.prototype,"globalIdField",void 0),e([t()],he.prototype,"arcgisManaged",void 0),e([t()],he.prototype,"identifierInfo",void 0),e([t()],he.prototype,"searchIndexes",void 0),e([t({type:[le],json:{write:!0}})],he.prototype,"entityTypes",void 0),e([t({type:[ce],json:{write:!0}})],he.prototype,"relationshipTypes",void 0),he=e([n("esri.rest.knowledgeGraph.DataModel")],he);const ue=he;let pe=class extends r{constructor(e){super(e),this.capabilities=[],this.supportsSearch=!1,this.supportedQueryFormats=[],this.allowGeometryUpdates=!1,this.searchMaxRecordCount=null,this.serviceCapabilities=null,this.maxRecordCount=null,this.description="",this.copyrightText="",this.units="",this.spatialReference=null,this.currentVersion=null,this.dateFieldsTimeReference=null,this.serviceItemId="",this.supportsDocuments=!1,this.dataEditingNotSupported=!1,this.schemaEditingNotSupported=!1}};e([t({type:[String],json:{write:!0}})],pe.prototype,"capabilities",void 0),e([t({type:Boolean,json:{write:!0}})],pe.prototype,"supportsSearch",void 0),e([t({type:[String],json:{write:!0}})],pe.prototype,"supportedQueryFormats",void 0),e([t({type:Boolean,json:{write:!0}})],pe.prototype,"allowGeometryUpdates",void 0),e([t({type:Number,json:{write:!0}})],pe.prototype,"searchMaxRecordCount",void 0),e([t({type:Object,json:{write:!0}})],pe.prototype,"serviceCapabilities",void 0),e([t({type:Number,json:{write:!0}})],pe.prototype,"maxRecordCount",void 0),e([t({type:String,json:{write:!0}})],pe.prototype,"description",void 0),e([t({type:String,json:{write:!0}})],pe.prototype,"copyrightText",void 0),e([t({type:String,json:{write:!0}})],pe.prototype,"units",void 0),e([t({type:Object,json:{write:!0}})],pe.prototype,"spatialReference",void 0),e([t({type:Number,json:{write:!0}})],pe.prototype,"currentVersion",void 0),e([t({type:Object,json:{write:!0}})],pe.prototype,"dateFieldsTimeReference",void 0),e([t({type:String,json:{write:!0}})],pe.prototype,"serviceItemId",void 0),e([t({type:Boolean,json:{write:!0}})],pe.prototype,"supportsDocuments",void 0),e([t({type:Boolean,json:{write:!0}})],pe.prototype,"dataEditingNotSupported",void 0),e([t({type:Boolean,json:{write:!0}})],pe.prototype,"schemaEditingNotSupported",void 0),pe=e([n("esri.rest.knowledgeGraph.ServiceDefinition")],pe);const ye=pe;let we=class extends r{constructor(e){super(e),this.dataModel=null,this.serviceDefinition=null}};e([t({type:String,json:{write:!0}})],we.prototype,"url",void 0),e([t({type:ue,json:{write:!0}})],we.prototype,"dataModel",void 0),e([t({type:ye,json:{write:!0}})],we.prototype,"serviceDefinition",void 0),we=e([n("esri.rest.knowledgeGraph.KnowledgeGraph")],we);const fe=we;const ge="esri/rest/knowledgeGraph/wasmInterface/";let me;async function ve(){const e=me;if(e)return e;const t=o("wasm-simd");return me=be(t),me}async function be(e){if(e){const{default:e}=await import("./p-1b68cdf0.js").then((e=>e.a));return e({locateFile:e=>a(ge+e)})}const{default:t}=await import("./p-e8e38995.js").then((e=>e.a));return t({locateFile:e=>a(ge+e)})}function Te(e,t){const n=new t.ArrayValue;return n.deleteLater(),e.forEach((e=>{n.add_value(Ge(e,t))})),n}function Ie(e,t){const n=new t.ObjectValue;n.deleteLater();for(const[i,r]of Object.entries(e))n.set_key_value(i,Ge(r,t));return n}function Ee(e,t){if(e instanceof c)return Re(e,t);if(e instanceof h)return xe(e,t);if(e instanceof u||e instanceof p)return Se(e,t);throw new l("knowledge-graph:unsupported-geometry","Only Point, Multipoint, Polyline, and Polygon geometry are supported by ArcGIS Knowledge",{geometry:e})}function je(e,t){t.input_quantization_parameters={xy_resolution:e.xyResolution,x_false_origin:e.xFalseOrigin,y_false_origin:e.yFalseOrigin,z_resolution:e.zResolution,z_false_origin:e.zFalseOrigin,m_resolution:e.mResolution,m_false_origin:e.mFalseOrigin}}function ke(e,t,n){if(!e.extent)throw new l("knowledge-graph:illegal-output-quantization","The Output quantization provided to the encoder had an illegal value as part of its extent",e.extent);if(!e.quantizeMode)throw new l("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal mode setting",e.quantizeMode);if(!e.tolerance)throw new l("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal tolerance setting",e.quantizeMode);t.output_quantization_parameters={extent:{xmax:e.extent.xmax,ymax:e.extent.ymax,xmin:e.extent.xmin,ymin:e.extent.ymin},quantize_mode:n.esriQuantizeMode[e.quantizeMode],tolerance:e.tolerance}}function Ge(e,t){if(null==e)return"";if("object"!=typeof e)return e;if(e instanceof Date)return e;if(e instanceof d)return Ee(e,t);if(Array.isArray(e)){const n=new t.ArrayValue;return n.deleteLater(),e.forEach((e=>{n.add_value(Ge(e,t))})),n}return Ie(e,t)}function Se(e,t){const n=new t.GeometryValue;n.deleteLater(),n.has_z=e.hasZ,n.has_m=e.hasM;const i=[],r=[];let s=[];e instanceof u?(n.geometry_type=t.esriGeometryType.esriGeometryPolyline,s=e.paths):e instanceof p&&(n.geometry_type=t.esriGeometryType.esriGeometryPolygon,s=e.rings);let o=0,a=0;return s.forEach((e=>{let t=0;e.forEach((e=>{t++,e.forEach((e=>{i[a]=e,a++}))})),r[o]=t,o++})),n.coords=new Float64Array(i),n.lengths=new Uint32Array(r),n}function Re(e,t){const n=new t.GeometryValue;n.deleteLater(),n.geometry_type=n.geometry_type=t.esriGeometryType.esriGeometryMultipoint,n.has_z=e.hasZ,n.has_m=e.hasM;const i=[],r=[];r[0]=e.points.length;let s=0;return e.points.forEach((e=>{e.forEach((e=>{i[s]=e,s++}))})),n.coords=new Float64Array(i),n.lengths=new Uint32Array(r),n}function xe(e,t){const n=new t.GeometryValue;n.deleteLater(),n.geometry_type=t.esriGeometryType.esriGeometryPoint,n.has_z=e.hasZ,n.has_m=e.hasM;const i=[],r=[];r[0]=1,i[0]=e.x,i[1]=e.y;let s=2;return e.hasZ&&(i[s]=e.z,s++),e.hasM&&(i[s]=e.m,s++),n.coords=new Float64Array(i),n.lengths=new Uint32Array(r),n}let Me=class extends r{constructor(e){super(e),this.properties=null}};e([t({json:{write:!0}})],Me.prototype,"properties",void 0),Me=e([n("esri.rest.knowledgeGraph.GraphObject")],Me);const Ce=Me;let Ae=class extends Ce{constructor(e){super(e),this.typeName=null,this.id=null}};e([t({type:String,json:{write:!0}})],Ae.prototype,"typeName",void 0),e([t({type:String,json:{write:!0}})],Ae.prototype,"id",void 0),Ae=e([n("esri.rest.knowledgeGraph.GraphNamedObject")],Ae);const Ne=Ae;let _e=class extends Ne{constructor(e){super(e),this.layoutGeometry=null}};e([t({type:h,json:{write:!0}})],_e.prototype,"layoutGeometry",void 0),_e=e([n("esri.rest.knowledgeGraph.Entity")],_e);const De=_e;let Pe=class extends Ne{constructor(e){super(e),this.originId=null,this.destinationId=null,this.layoutGeometry=null}};e([t({type:String,json:{write:!0}})],Pe.prototype,"originId",void 0),e([t({type:String,json:{write:!0}})],Pe.prototype,"destinationId",void 0),e([t({type:u,json:{write:!0}})],Pe.prototype,"layoutGeometry",void 0),Pe=e([n("esri.rest.Relationship.Relationship")],Pe);const Oe=Pe;function Fe(e,t){if(!e.typeName)throw new l("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits");if(e instanceof De){const n=new t.EntityValue;n.deleteLater(),n.type_name=e.typeName;for(const[i,r]of Object.entries(e.properties))n.set_key_value(i,$e(r,t));return e.id&&n.set_id(e.id),n}if(e instanceof Oe){const n=new t.RelationshipValue;n.deleteLater(),n.type_name=e.typeName;for(const[i,r]of Object.entries(e.properties))n.set_key_value(i,$e(r,t));return e.id&&n.set_id(e.id),e.originId&&e.destinationId&&n.set_related_entity_ids(e.originId,e.destinationId),n}throw new l("knowledge-graph:applyEdits-encoding-failure","Could not determine the type of a named graph object passed to the encoder")}function Le(e){return{xy_resolution:e.xyResolution,x_false_origin:e.xFalseOrigin,y_false_origin:e.yFalseOrigin,z_resolution:e.zResolution,z_false_origin:e.zFalseOrigin,m_resolution:e.mResolution,m_false_origin:e.mFalseOrigin}}function $e(e,t){return null==e?"":"object"!=typeof e||e instanceof Date?e:e instanceof d?Ee(e,t):""}let qe=class extends i{constructor(e){super(e),this.name=null,this.supportedCategory=null,this.analyzers=[],this.searchProperties=new Map}};e([t()],qe.prototype,"name",void 0),e([t()],qe.prototype,"supportedCategory",void 0),e([t()],qe.prototype,"analyzers",void 0),e([t()],qe.prototype,"searchProperties",void 0),qe=e([n("esri.rest.knowledgeGraph.SearchIndex")],qe);const Ue=qe;var Qe,Be,He,ze,Ye,Ke,We;!function(e){e[e.Regular=0]="Regular",e[e.Provenance=1]="Provenance",e[e.Document=2]="Document"}(Qe||(Qe={})),function(e){e[e.esriFieldTypeSmallInteger=0]="esriFieldTypeSmallInteger",e[e.esriFieldTypeInteger=1]="esriFieldTypeInteger",e[e.esriFieldTypeSingle=2]="esriFieldTypeSingle",e[e.esriFieldTypeDouble=3]="esriFieldTypeDouble",e[e.esriFieldTypeString=4]="esriFieldTypeString",e[e.esriFieldTypeDate=5]="esriFieldTypeDate",e[e.esriFieldTypeOID=6]="esriFieldTypeOID",e[e.esriFieldTypeGeometry=7]="esriFieldTypeGeometry",e[e.esriFieldTypeBlob=8]="esriFieldTypeBlob",e[e.esriFieldTypeRaster=9]="esriFieldTypeRaster",e[e.esriFieldTypeGUID=10]="esriFieldTypeGUID",e[e.esriFieldTypeGlobalID=11]="esriFieldTypeGlobalID",e[e.esriFieldTypeXML=12]="esriFieldTypeXML",e[e.esriFieldTypeBigInteger=13]="esriFieldTypeBigInteger"}(Be||(Be={})),function(e){e[e.esriGeometryNull=0]="esriGeometryNull",e[e.esriGeometryPoint=1]="esriGeometryPoint",e[e.esriGeometryMultipoint=2]="esriGeometryMultipoint",e[e.esriGeometryPolyline=3]="esriGeometryPolyline",e[e.esriGeometryPolygon=4]="esriGeometryPolygon",e[e.esriGeometryEnvelope=5]="esriGeometryEnvelope",e[e.esriGeometryAny=6]="esriGeometryAny",e[e.esriGeometryMultiPatch=7]="esriGeometryMultiPatch"}(He||(He={})),function(e){e[e.esriMethodHintUNSPECIFIED=0]="esriMethodHintUNSPECIFIED",e[e.esriUUIDESRI=1]="esriUUIDESRI",e[e.esriUUIDRFC4122=2]="esriUUIDRFC4122"}(ze||(ze={})),function(e){e[e.esriTypeUNSPECIFIED=0]="esriTypeUNSPECIFIED",e[e.esriTypeEntity=1]="esriTypeEntity",e[e.esriTypeRelationship=2]="esriTypeRelationship",e[e.esriTypeBoth=4]="esriTypeBoth"}(Ye||(Ye={})),function(e){e[e.esriGraphPropertyUNSPECIFIED=0]="esriGraphPropertyUNSPECIFIED",e[e.esriGraphPropertyRegular=1]="esriGraphPropertyRegular",e[e.esriGraphPropertyDocumentName=2]="esriGraphPropertyDocumentName",e[e.esriGraphPropertyDocumentTitle=3]="esriGraphPropertyDocumentTitle",e[e.esriGraphPropertyDocumentUrl=4]="esriGraphPropertyDocumentUrl",e[e.esriGraphPropertyDocumentText=5]="esriGraphPropertyDocumentText",e[e.esriGraphPropertyDocumentKeywords=6]="esriGraphPropertyDocumentKeywords",e[e.esriGraphPropertyDocumentContentType=7]="esriGraphPropertyDocumentContentType",e[e.esriGraphPropertyDocumentMetadata=8]="esriGraphPropertyDocumentMetadata",e[e.esriGraphPropertyDocumentFileExtension=9]="esriGraphPropertyDocumentFileExtension"}(Ke||(Ke={})),function(e){e[e.esriIdentifierInfoTypeUNSPECIFIED=0]="esriIdentifierInfoTypeUNSPECIFIED",e[e.esriIdentifierInfoTypeDatabaseNative=1]="esriIdentifierInfoTypeDatabaseNative",e[e.esriIdentifierInfoTypeUniformProperty=2]="esriIdentifierInfoTypeUniformProperty"}(We||(We={}));function Je(e){return e.deleteLater(),new ue({timestamp:e.timestamp,spatialReference:new s(e.spatial_reference),strict:e.strict,objectIdField:e.objectid_property,globalIdField:e.globalid_property,arcgisManaged:e.arcgis_managed,identifierInfo:{identifierMappingInfo:{identifierInfoType:We[e.identifier_info?.identifier_mapping_info?.identifier_info_type?.value],databaseNativeIdentifier:e.identifier_info?.identifier_mapping_info?.database_native_identifier,uniformPropertyIdentifier:{identifierPropertyName:e.identifier_info?.identifier_mapping_info?.uniform_property_identifier?.identifier_property_name}},identifierGenerationInfo:{uuidMethodHint:ze[e.identifier_info?.identifier_generation_info?.uuid_method_hint?.value]}},searchIndexes:at(e.search_indexes),entityTypes:nt(e.entity_types),relationshipTypes:ot(e.relationship_types)})}function Ve(e){return e.deleteLater(),new le(Xe(e))}function Ze(e){return e.deleteLater(),new ne({name:e.name,unique:e.unique,ascending:e.ascending,description:e.description,fieldNames:it(e.fields)})}function Xe(e){return{name:e.name,alias:e.alias,role:Qe[e.role.value]?Qe[e.role.value]:null,strict:e.strict,properties:rt(e.properties),fieldIndexes:st(e.field_indexes)}}function et(e){return e.deleteLater(),new re({alias:e.alias,name:e.name,fieldType:Be[e.field_type.value]?Be[e.field_type.value]:null,geometryType:He[e.geometry_type.value]?He[e.geometry_type.value]:null,hasM:e.has_m,hasZ:e.has_z,nullable:e.nullable,editable:e.editable,required:e.required,defaultVisibility:e.default_visibility,systemMaintained:e.system_maintained,role:Ke[e.role.value],defaultValue:e.default_value})}function tt(e){e.deleteLater();const t=Xe(e),n=[];for(let t=0;t<e.end_points.size();t++){const i=e.end_points.get(t);n.push({originEntityType:i.origin_entity_type,destinationEntityType:i.dest_entity_type})}return new ce(Object.assign({endPoints:n},t))}function nt(e){const t=[];for(let n=0;n<e.size();n++)t.push(Ve(e.get(n)));return t}function it(e){const t=[];for(let n=0;n<e.size();n++)t.push(e.get(n));return t}function rt(e){const t=[];for(let n=0;n<e.size();n++)t.push(et(e.get(n)));return t}function st(e){const t=[];for(let n=0;n<e.size();n++)t.push(Ze(e.get(n)));return t}function ot(e){const t=[];for(let n=0;n<e.size();n++)t.push(tt(e.get(n)));return t}function at(e){const t=[];for(let n=0;n<e.size();n++){const n=new Ue,i=e.get(0);n.name=i.name,n.supportedCategory=Ye[i.supported_category.value];const r=i.analyzers.size();for(let e=0;e<r;e++)n.analyzers.push({name:i.analyzers.get(e).name});for(let e=0;e<i.search_properties.keys().size();e++){const t=i.search_properties.keys().get(e),r=i.search_properties.get(t),s=[];for(let e=0;e<r.property_names.size();e++)s.push(r.property_names.get(e));n.searchProperties.set(t,{propertyNames:s})}t.push(n)}return t}let lt=class extends Ce{constructor(e){super(e)}};lt=e([n("esri.rest.knowledgeGraph.ObjectValue")],lt);const dt=lt;let ct=class extends r{constructor(e){super(e),this.path=null}};e([t({type:[Ce],json:{write:!0}})],ct.prototype,"path",void 0),ct=e([n("esri.rest.knowledgeGraph.Path")],ct);const ht=ct;var ut;!function(e){e[e.ESRI_GEOMETRY_NULL=0]="ESRI_GEOMETRY_NULL",e[e.ESRI_GEOMETRY_POINT=1]="ESRI_GEOMETRY_POINT",e[e.ESRI_GEOMETRY_MULTIPOINT=2]="ESRI_GEOMETRY_MULTIPOINT",e[e.ESRI_GEOMETRY_POLYLINE=3]="ESRI_GEOMETRY_POLYLINE",e[e.ESRI_GEOMETRY_POLYGON=4]="ESRI_GEOMETRY_POLYGON",e[e.ESRI_GEOMETRY_ENVELOPE=5]="ESRI_GEOMETRY_ENVELOPE",e[e.ESRI_GEOMETRY_ANY=6]="ESRI_GEOMETRY_ANY",e[e.ESRI_GEOMETRY_MULTI_PATCH=7]="ESRI_GEOMETRY_MULTI_PATCH"}(ut||(ut={}));var pt,yt;!function(e){e[e.OBJECT=0]="OBJECT",e[e.ENTITY=1]="ENTITY",e[e.RELATIONSHIP=2]="RELATIONSHIP",e[e.PATH=3]="PATH",e[e.ARRAY=4]="ARRAY"}(pt||(pt={})),function(e){e[e.view=0]="view",e[e.edit=1]="edit"}(yt||(yt={}));function wt(e){const t={},n=bt(e,t),i=e.lengths,r=e.coords,s=i[0];t.points=[];let o=0;for(let e=0;e<s;e++){const e=[];for(let t=0;t<n;t++)e[t]=r[o],o++;t.points.push(e)}return new c(t)}function ft(e){const t={};let n=2;bt(e,t);const i=e.coords;return t.x=i[0],t.y=i[1],e.has_z&&(t.z=i[n],n++),e.has_m&&(t.m=i[n]),new h(t)}function gt(e){return new u(vt(e))}function mt(e){return new p(vt(e))}function vt(e){const t={},n=bt(e,t),i=e.lengths,r=e.coords;let s="";if(e.geometry_type.value===ut.ESRI_GEOMETRY_POLYGON)s="rings";else{if(e.geometry_type.value!==ut.ESRI_GEOMETRY_POLYLINE)throw new l("KnowledgeGraph:illegal-geometry-type","Illegal Geometry type for multipath conversion");s="paths"}t[s]=[];let o=0;return i.forEach((e=>{const i=[];for(let t=0;t<e;t++){const e=[];for(let t=0;t<n;t++)e[t]=r[o],o++;i.push(e)}t[s].push(i)})),t}function bt(e,t){let n=2;return e.has_z?(t.hasZ=e.has_z,n++):t.hasZ=!1,e.has_m?(t.hasM=e.has_m,n++):t.hasM=!1,n}const Tt=y.getLogger("esri.rest.knowledgeGraph.WasmToQueryResponseObjConstructors"),It={decodedWasmObjToQueryResponseObj:(e,t)=>{if(null==e)return null;if("object"!=typeof e)return e;if("getDate"in e)return e;if("geometry_type"in e)switch(e.geometry_type.value){case null:return null;case ut.ESRI_GEOMETRY_POINT:return ft(e);case ut.ESRI_GEOMETRY_MULTIPOINT:return wt(e);case ut.ESRI_GEOMETRY_POLYLINE:return gt(e);case ut.ESRI_GEOMETRY_POLYGON:return mt(e);case ut.ESRI_GEOMETRY_ENVELOPE:case ut.ESRI_GEOMETRY_MULTI_PATCH:return Tt.warnOnce("Envelope and Multipatch are not supported on knowledge entities, but one of those geometry types was detected. Result interpreted as null"),null;case ut.ESRI_GEOMETRY_NULL:case ut.ESRI_GEOMETRY_ANY:default:return Tt.warnOnce("Unknown or blank geometry type returned - Result interpreted as null"),null}else{if(!("object_value_type"in e))return Tt.warnOnce("A decoded value came back of a type that is not supported. Result interpreted as null"),null;switch(e.object_value_type.value){case pt.OBJECT:return St(e,t);case pt.ENTITY:return kt(e,t);case pt.RELATIONSHIP:return xt(e,t);case pt.PATH:return Rt(e,t);case pt.ARRAY:return Et(e,t);default:return Tt.warnOnce("Unknown graph object type detected!  Result interpreted as null"),null}}}};function Et(e,t){const n=[],i=e.count();for(let r=0;r<i;r++){const i=e.get_value_at(r);n.push(jt(i,t))}return n}function jt(e,t){return It.decodedWasmObjToQueryResponseObj(e,t)}function kt(e,t){const n=e.type_name,i=Gt(e,t),r=e.get_id();return new De(Object.assign({typeName:n,id:r},i))}function Gt(e,t){const n={},i=e.key_count();for(let r=0;r<i;r++)n[e.get_key_at(r)]=jt(e.get_value_at(r),t);return{properties:n}}function St(e,t){return new dt(Gt(e,t))}function Rt(e,t){const n=e.entity_count(),i=e.relationship_count(),r=[];for(let s=0;s<n;s++)r.push(kt(e.get_entity_at(s),t)),s<i&&r.push(xt(e.get_relationship_at(s),t));return new ht({path:r})}function xt(e,t){const n=e.type_name,i=Gt(e,t);return new Oe(Object.assign({typeName:n,id:e.get_id(),originId:e.get_origin_entity_id(),destinationId:e.get_destination_entity_id()},i))}let Mt=class extends i{constructor(e){super(e),this.hasError=null,this.error=null,this.editResults=[]}};e([t()],Mt.prototype,"hasError",void 0),e([t()],Mt.prototype,"error",void 0),e([t()],Mt.prototype,"editResults",void 0),Mt=e([n("esri.rest.knowledgeGraph.GraphApplyEdits")],Mt);const Ct=Mt;function At(e){const t=new Ct;t.hasError=e.has_error(),t.hasError&&(t.error={errorCode:e.error.error_code,errorMessage:e.error.error_message});const n=e.get_edit_results_count();for(let i=0;i<n;i++){const n=e.get_edit_results_at(i),r=e.get_edit_results_type_name_at(i),s=[],o=[],a=[],l=n.get_add_results_count(),d=n.get_update_results_count(),c=n.get_delete_results_count();for(let e=0;e<l;e++){const t=n.get_add_result_at(e);s.push({id:t.id,error:{errorCode:t.error.error_code,errorMessage:t.error.error_message}})}for(let e=0;e<d;e++){const t=n.get_update_result_at(e);o.push({id:t.id,error:{errorCode:t.error.error_code,errorMessage:t.error.error_message}})}for(let e=0;e<c;e++){const t=n.get_delete_result_at(e);a.push({id:t.id,error:{errorCode:t.error.error_code,errorMessage:t.error.error_message}})}t.editResults.push({typeName:r,adds:s,updates:o,deletes:a})}return t}const Nt={fetchKnowledgeGraph:async e=>{const t=new fe({url:e}),n=[];return n.push(Pt(t)),n.push(Ot(t)),await Promise.all(n),t},refreshDataModel:async e=>{e.dataModel=await Wt(e)},refreshServiceDefinition:async e=>{const t=(await w(e.url,{query:{f:"json"}})).data;return t.capabilities=t?.capabilities?.split(","),t.supportedQueryFormats=t?.supportedQueryFormats?.split(","),e.serviceDefinition=new ye(t),e.serviceDefinition},executeQueryStreaming:async(e,t,n)=>{const i=`${e.url}/graph/query`;await Lt(e);const r=await Ht(i,n);r.data.body=await Qt(t,e);const s=await Ft(r.data.url,r.data);if(e.dataModel)return new ee({resultRowsStream:await Kt(s,e.dataModel)});throw new l("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")},executeApplyEdits:async(e,t,n)=>{if(e.serviceDefinition?.dataEditingNotSupported)throw new l("knowledge-graph:data-editing-not-supported","The Knowledge Graph Service definition indicated that data editing is not supported");const i=`${e.url}/graph/applyEdits`;await Lt(e);const r=await Ht(i,n);r.data.body=await Ut(t,e);return zt(await Ft(r.data.url,r.data))},executeQuery:async(e,t,n)=>{const i=`${e.url}/graph/query`,r=await w(i,{responseType:"array-buffer",query:{f:"pbf",openCypherQuery:t.openCypherQuery,...n?.query},signal:n?.signal,timeout:n?.timeout}),s=r.getHeader?.("content-type"),o=r.data;if(s?.includes("application/x-protobuf")){const t=new((await ve()).GraphQueryDecoder);if(t.deleteLater(),e.dataModel)return new Z({resultRows:Yt(t,o,e.dataModel)});throw new l("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new l("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:s,data:r.data})},executeSearch:async(e,t,n)=>{const i=t.typeCategoryFilter,r=`${e.url}/graph/search`,s=await w(r,{responseType:"array-buffer",query:{f:"pbf",searchQuery:`"${t.searchQuery}"`,typeCategoryFilter:i,...n?.query},signal:n?.signal,timeout:n?.timeout}),o=s.getHeader?.("content-type"),a=s.data;if(o?.includes("application/x-protobuf")){const t=new((await ve()).GraphQueryDecoder);if(t.deleteLater(),e.dataModel)return new Z({resultRows:Yt(t,a,e.dataModel)});throw new l("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new l("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:o,data:s.data})},executeSearchStreaming:async(e,t,n)=>{const i=`${e.url}/graph/search`;await Lt(e);const r=await Ht(i,n);r.data.body=await Bt(t);const s=await Ft(r.data.url,r.data);if(e.dataModel)return new ee({resultRowsStream:await Kt(s,e.dataModel)});throw new l("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")},_fetchWrapper:async(e,t)=>fetch(e,t)};async function _t(e,t,n){return Nt.executeQueryStreaming(e,t,n)}async function Dt(e){return Nt.fetchKnowledgeGraph(e)}async function Pt(e){return Nt.refreshDataModel(e)}async function Ot(e){return Nt.refreshServiceDefinition(e)}async function Ft(e,t){return Nt._fetchWrapper(e,t)}async function Lt(e){const t=f?.findCredential(e.url);t||(e.dataModel?await Wt(e):await Pt(e))}function $t(e,t,n){if(0!==e.error_code)throw new l(t,n,{errorCode:e.error_code,errorMessage:e.error_message})}function qt(e,t,n,i){null==t?n.set_param_key_value(e,""):"object"!=typeof t||t instanceof Date?n.set_param_key_value(e,t):t instanceof d?n.set_param_key_value(e,Ee(t,i)):t instanceof Array?n.set_param_key_value(e,Te(t,i)):n.set_param_key_value(e,Ie(t,i))}async function Ut(e,t){if(t.dataModel||await Pt(t),!t.dataModel)throw new l("knowledge-graph:data-model-undefined","Encoding could not proceed because a data model was not provided and it could not be determined from the service");const n=await ve(),i=!!e.options?.cascadeDelete,r=new n.GraphApplyEditsEncoder(n.SpatialReferenceUtil.WGS84(),e.options?.inputQuantizationParameters?Le(e.options?.inputQuantizationParameters):n.InputQuantizationUtil.WGS84_lossless());r.deleteLater(),r.cascade_delete=i;try{let t;e.entityAdds?.forEach((e=>{t=r.add_entity(Fe(e,n)),$t(t,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")})),e.relationshipAdds?.forEach((e=>{if(!e.originId||!e.destinationId)throw new l("knowledge-graph:relationship-origin-destination-missing","When adding a new relationship, you must provide both an origin and destination id on the appropriate class property");t=r.add_relationship(Fe(e,n)),$t(t,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")})),e.entityUpdates?.forEach((e=>{if(!e.id)throw new l("knowledge-graph:entity-id-missing","When updating an entity or relationship, you must specify the id on the class level property");t=r.update_entity(Fe(e,n)),$t(t,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")})),e.relationshipUpdates?.forEach((e=>{if(!e.id)throw new l("knowledge-graph:relationship-id-missing","When updating an entity or relationship, you must specify the id on the class level property");t=r.update_relationship(Fe(e,n)),$t(t,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")})),e.entityDeletes?.forEach((e=>{if(!e.typeName)throw new l("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const t=r.make_delete_helper(e.typeName,!0);t.deleteLater(),e.ids?.forEach((e=>{t.delete_by_id(e)}))})),e.relationshipDeletes?.forEach((e=>{if(!e.typeName)throw new l("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const t=r.make_delete_helper(e.typeName,!1);e.ids?.forEach((e=>{t.delete_by_id(e)}))})),r.encode()}catch(e){throw new l("knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed",{error:e})}const s=r.get_encoding_result();return $t(s.error,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed"),s.get_byte_buffer()}async function Qt(e,t){const n=await ve(),i=new n.GraphQueryRequestEncoder;if(i.deleteLater(),i.output_spatial_reference=n.SpatialReferenceUtil.WGS84(),i.open_cypher_query=e.openCypherQuery,e.bindParameters)for(const[t,r]of Object.entries(e.bindParameters))qt(t,r,i,n);if(e.bindGeometryQuantizationParameters)je(e.bindGeometryQuantizationParameters,i);else{if(t.dataModel||await Pt(t),4326!==t.dataModel?.spatialReference?.wkid)throw new l("knowledge-graph:SR-quantization-mismatch","If the DataModel indicates a coordinate system other than WGS84, inputQuantizationParameters must be provided to the query encoder");i.input_quantization_parameters=n.InputQuantizationUtil.WGS84_lossless()}e.outputQuantizationParameters&&ke(e.outputQuantizationParameters,i,n);try{i.encode()}catch(e){throw new l("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{error:e})}const r=i.get_encoding_result();if(0!==r.error.error_code)throw new l("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{errorCode:r.error.error_code,errorMessage:r.error.error_message});return r.get_byte_buffer()}async function Bt(e){const t=await ve(),n=new t.GraphSearchRequestEncoder;if(n.deleteLater(),n.search_query=e.searchQuery,n.type_category_filter=t.esriNamedTypeCategory[e.typeCategoryFilter],!0===e.returnSearchContext&&(n.return_search_context=e.returnSearchContext),null!=e.start&&e.start>0&&(n.start_index=e.start),null!=e.num&&(n.max_num_results=e.num),null!=e.idsFilter&&Array.isArray(e.idsFilter)&&e.idsFilter.length>0)try{n.set_ids_filter(Te(e.idsFilter,t))}catch(e){throw new l("knowledge-graph:ids-format-error","Attempting to set ids filter failed.  This is usually caused by an incorrectly formatted UUID string",{error:e})}e.namedTypesFilter?.forEach((e=>{n.add_named_type_filter(e)}));try{n.encode()}catch(e){throw new l("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{error:e})}const i=n.get_encoding_result();if(0!==i.error.error_code)throw new l("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{errorCode:i.error.error_code,errorMessage:i.error.error_message});return i.get_byte_buffer()}async function Ht(e,t){return w(e,{responseType:"native-request-init",method:"post",query:{f:"pbf",...t?.query},body:"x",headers:{"Content-Type":"application/octet-stream"},signal:t?.signal,timeout:t?.timeout})}async function zt(e){const t=e.headers.get("content-type");if(t?.includes("application/x-protobuf")){const t=await e.arrayBuffer(),n=new((await ve()).GraphApplyEditsDecoder);return n.deleteLater(),n.decode(new Uint8Array(t)),At(n)}throw new l("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:t,data:e.text()})}function Yt(e,t,n){e.push_buffer(new Uint8Array(t));const i=[];let r=0;for(;e.next_row();){r||(r=e.get_header_keys().size());const t=new Array(r);for(let i=0;i<r;i++){const r=e.get_value(i);t[i]=jt(r,n)}i.push(t)}if(e.has_error())throw new l("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:e.error.error_code,errorMessage:e.error.error_message});return i}async function Kt(e,t){const n=e.headers.get("content-type");if(e.headers.get("content-length")&&y.getLogger("esri.rest.knowledgeGraph.knowledgeGraphService").warnOnce("Found `Content-Length` header when expecting a streaming HTTP response! Please investigate whether all intermediate HTTP proxies and/or load balancers are configured such that they don't forcefully buffer the entire response before returning it to the client. A valid HTTP streaming response should use Chunked Transfer Encoding and not have a Content Length defined."),n?.includes("application/x-protobuf")){const n=e.body?.getReader(),i=new((await ve()).GraphQueryDecoder);return i.deleteLater(),new ReadableStream({async start(e){try{return r()}catch(t){n?.releaseLock(),e.error(new l("knowledge-graph:stream-decoding-error","The server returned a valid response, but there was an error decoding the response stream",{error:t})),e.close()}function r(){return n?.read().then((({done:s,value:o})=>{if(s){let t;if(i.has_error()&&(t=new l("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:i.error.error_code,errorMessage:i.error.error_message})),n.releaseLock(),t)throw e.error(t),t;return void e.close()}const a=Yt(i,o,t);return a.length>0&&e.enqueue(a),r()}))}}})}throw new l("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:n,data:e.text()})}async function Wt(e){const t=`${e.url}/dataModel/queryDataModel`,n=await w(t,{responseType:"array-buffer",query:{f:"pbf"}}),i=n.getHeader?.("content-type"),r=n.data;if(i?.includes("application/x-protobuf")){const e=(await ve()).decode_data_model_from_protocol_buffer(new Uint8Array(r));if(!e)throw new l("knowledge-graph:data-model-decode-failure","The server responded to the data model query, but the response failed to be decoded.  This typically occurs when the Knowledge JS API (4.26 or later) is used with an unsupported backend (11.0 or earlier)");return Je(e)}throw new l("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:i,data:n.data})}let Jt=class extends i{constructor(e){super(e),this.openCypherQuery=""}};e([t()],Jt.prototype,"openCypherQuery",void 0),Jt=e([n("esri.rest.knowledgeGraph.GraphQuery")],Jt);const Vt=Jt;let Zt=class extends Vt{constructor(e){super(e),this.bindParameters=null,this.bindGeometryQuantizationParameters=null,this.outputQuantizationParameters=null}};e([t()],Zt.prototype,"bindParameters",void 0),e([t()],Zt.prototype,"bindGeometryQuantizationParameters",void 0),e([t()],Zt.prototype,"outputQuantizationParameters",void 0),Zt=e([n("esri.rest.knowledgeGraph.GraphQueryStreaming")],Zt);const Xt=Zt;const en="ESRI__ID",tn="ESRI__ORIGIN_ID",nn="ESRI__DESTINATION_ID",rn="ESRI__LAYOUT_GEOMETRY",sn=12,on=y.getLogger("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager");let an=class extends i{constructor(e){super(e),this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this._processingCacheUpdatesLookup=new Map,this._memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach((n=>{n.name&&(t.set(n.name,"entity"),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(n.name),n.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(n.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((n=>{n.name&&(t.set(n.name,"relationship"),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(n.name),n.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(n.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((n,i)=>{if("entity"===t.get(i))this.entityTypeNames.add(i);else{if("relationship"!==t.get(i))return on.warn(`A named type, ${i}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(i);this.relationshipTypeNames.add(i)}const r=new Map;n.members?.forEach((e=>{this._memberIdTypeLookup.set(e.id,i);const t=this.getById(e.id);t&&r.set(e.id,t)})),this.sublayerCaches.set(i,r)}))}addToLayerInclusionSet(e){e.forEach((({typeName:e,id:t})=>{if(!this.inclusionModeDefinition)throw new l("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const n=this.inclusionModeDefinition.namedTypeDefinitions.get(e);if(n.useAllData)throw new l("knowledge-graph:layer-data-manager","You cannot add members to an exclusion list for a sublayer where the sublayer is set to always retrieve its entire data set");n.members||(n.members=new Map),n.members.set(t,{id:t}),this._memberIdTypeLookup.set(t,e)}}else{const n=new Map;n.set(t,{id:t}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:n}),this._memberIdTypeLookup.set(t,e)}}))}getById(e){return J.getInstance().readFromStoreById(e)}async getData(e,t,n){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let i;if(i=e||new g({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){const e=t.parentCompositeLayer,n=this._processingCacheUpdatesLookup.get(t.objectType.name??""),r=i.outFields,s=i.geometry;let o="",a="";s&&s.extent&&(o=$(s.extent.ymin,s.extent.xmin,sn),a=$(s.extent.ymax,s.extent.xmax,sn)),r&&1===r.length&&r[0]===en&&"1=1"===i.where||await Promise.all(n??[]);const l=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],d=[];return l.forEach((n=>{if(n.geometry=e.linkChartDiagramLookup.get(n.attributes[t.objectIdField]),n.attributes[rn]=n.geometry,o&&a){const i=e.linkChartGeohashLookup.get(n.attributes[t.objectIdField]);i?i>=o&&i<=a&&d.push(n):d.push(n)}else d.push(n)})),d}return this.retrieveDataFromService(i,t,n)}async getConnectedRecordIds(e){const t=[],n=[],i=new Map;return e.forEach((e=>{if(this._memberIdTypeLookup.has(e)){const t=this._memberIdTypeLookup.get(e);if(!this.entityTypeNames.has(t))return;i.has(t)?i.get(t)?.push(e):i.set(t,[e])}})),i.forEach(((e,i)=>{const r=`MATCH (n:${i})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`,s=new Promise((n=>{(async()=>{const n=(await _t(this.knowledgeGraph,new Xt({openCypherQuery:r,bindParameters:{ids:e}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:i}=await n.read();if(e)break;for(let e=0;e<i.length;e++){const n=i[e];t.push({id:n[0],typeName:n[1]}),t.push({id:n[2],typeName:n[3]})}}}catch(e){if("AbortError"!==e.name)throw e;on.info("Request aborted as expected")}})().then((()=>{n()}))}));n.push(s)})),await Promise.all(n),t}async refreshCacheContent(e,t,n,i=!0){const r=J.getInstance(),s=[],o=new Map,a=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&a.set(e.name,e)})),this.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&a.set(e.name,e)})),e||this.inclusionModeDefinition?e?e.forEach((e=>{if(this._memberIdTypeLookup.has(e)){const t=this._memberIdTypeLookup.get(e);o.has(t)?o.get(t)?.push(e):o.set(t,[e])}})):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e.useAllData?o.set(t,null):e.members&&e.members.forEach((e=>{o.has(t)&&null!==o.get(t)?o.get(t)?.push(e.id):o.set(t,[e.id])}))})):(this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&o.set(e.name,null)})),this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&o.set(e.name,null)})));for(const[e,d]of o){const o=new Promise((s=>{const o=async()=>{const s=new Set,o=[];let c,h="",u=!1;if(t||a.get(e)?.properties?.forEach((e=>{e.name&&s.add(e.name)})),n&&this.geographicLookup.has(e)){const t=this.geographicLookup.get(e)?.name;t&&s.add(t)}if(this.entityTypeNames.has(e))h=`MATCH (n:${e}) ${d?"WHERE id(n) IN $ids ":""}return ID(n)`,s.forEach((e=>{h+=`, n.${e}`,o.push(e)}));else{if(!this.relationshipTypeNames.has(e))throw new l("knowledge-graph:layer-data-manager",`The graph type of ${e} could not be determined. Was this type set in the KG data model and inclusion definition?`);u=!0,h=`MATCH ()-[n:${e}]->() ${d?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,s.forEach((e=>{h+=`, n.${e}`,o.push(e)}))}c=new Xt(d?{openCypherQuery:h,bindParameters:{ids:d}}:{openCypherQuery:h});const p=(await _t(this.knowledgeGraph,c)).resultRowsStream.getReader();for(;;){const{done:t,value:n}=await p.read();if(t)break;const s=[];for(let e=0;e<n.length;e++){const t=n[e];let i=0,r=0;const a={properties:{}};for(a.id=t[i],i++,r++,u&&(a.originId=t[i],i++,r++,a.destinationId=t[i],i++,r++);i<t.length;i++)a.properties[o[i-r]]=t[i];s.push(a)}const a=r.writeToStore(s,en,this.geographicLookup.get(e)?.name);this.sublayerCaches.has(e)||this.sublayerCaches.set(e,new Map),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(e)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(e,{useAllData:!1,members:new Map}),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(e).members=new Map);const l=this.sublayerCaches.get(e);a.forEach((t=>{l?.set(t.attributes[en],t),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.has(t.attributes[en])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.set(t.attributes[en],{id:t.attributes[en]}),this._memberIdTypeLookup.set(t.attributes[en],e))}))}};o().then((()=>{s(null)}))}));s.push(o),this._processingCacheUpdatesLookup.get(e)?.push(o)}await Promise.all(s)}removeFromLayer(e){const t=new Set;e.forEach((e=>{this._memberIdTypeLookup.get(e)&&t.add(this._memberIdTypeLookup.get(e)),this._memberIdTypeLookup.delete(e),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((t=>{t.members?.has(e)&&t.members.delete(e)}))})),t.forEach((t=>{this.sublayerCaches.get(t)?.forEach(((n,i)=>{e.includes(i)&&this.sublayerCaches.get(t)?.delete(i)}))}))}async retrieveDataFromService(e,t,n){const i=J.getInstance(),r=new Set,s=[];let o,a="",l=[];const d="relationship"===t.graphType,c=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,h=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let u=!c&&h?Array.from(h).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&null!=e.objectIds&&(u=e.objectIds);else if(null!=e.objectIds&&u&&u.length>0){const t=e.objectIds;e.objectIds=u.filter((e=>t.includes(e)))}else if(null!=e.objectIds)u=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=u}if(null!=e.outFields){const n=e.outFields;n.includes("*")?t.fields.forEach((e=>{r.add(e.name)})):n.forEach((e=>{e!==en&&e!==t.geometryFieldName&&r.add(e)}))}if(null!=e.geometry){const n=e.geometry;let i;if(n?.extent?.spatialReference&&!n.spatialReference?.isWGS84?(await m(n.extent.spatialReference,v),i=b(n.extent,v)):i=n.extent,null!=e.where&&"1=1"!==e.where){const n=await T(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach((e=>{n.fieldNames.includes(e.name)&&r.add(e.name)}))}a=d?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach((e=>{a+=`, n.${e}`,s.push(e)})),o=new Xt({openCypherQuery:a,bindParameters:{param_filter_geom:new p({rings:[[[i.xmin,i.ymin],[i.xmin,i.ymax],[i.xmax,i.ymax],[i.xmax,i.ymin],[i.xmin,i.ymin]]]})}})}else{let n="";if(null!=e.where&&"1=1"!==e.where){const i=await T(e.where,t.fieldsIndex);t.fields.forEach((e=>{i.fieldNames.includes(e.name)&&r.add(e.name)}));const s=["column-reference","string","number","binary-expression"],o=["=","<","<=","<>",">",">=","AND","OR","LIKE"];let a=!1;const l=e=>{if("column-reference"===e.type)return`n.${e.column}`;if("string"===e.type)return`'${e.value}'`;if("number"===e.type)return`${e.value}`;if("binary-expression"===e.type&&s.includes(e.left.type)&&s.includes(e.right.type)&&o.includes(e.operator))return`${l(e.left)} ${e.operator} ${l(e.right)}`;if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+=`lower(n.${e.left.args.value[0].column})`;else{if("column-reference"!==e.left.type)return a=!0,"";t+=`lower(n.${e.left.column})`}if(t+=" CONTAINS (","string"!==e.right.type)return a=!0,"";{let n=e.right.value;"%"===n.charAt(0)&&(n=n.slice(1)),"%"===n.charAt(n.length-1)&&(n=n.slice(0,-1)),t+=`'${n.toLowerCase()}')`}return t}return a=!0,""};n=l(i.parseTree),a&&(n="")}let i="";i=d?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let a=!1;u&&(a=!0,i+=" WHERE ID(n) IN $ids"),n&&(i+=a?" AND":" WHERE",i+=` ${n}`),i+=" return ID(n)",d&&(i+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach((e=>{i+=`, n.${e}`,s.push(e)})),o=new Xt(u?{openCypherQuery:i,bindParameters:{ids:u}}:{openCypherQuery:i})}const y=(await _t(t.parentCompositeLayer.dataManager.knowledgeGraph,o,n)).resultRowsStream.getReader();for(;;){const{done:e,value:n}=await y.read();if(e)break;const r=[];for(let e=0;e<n.length;e++){const t=n[e];let i=0,o=0;const a={properties:{}};for(a.id=t[i],i++,o++,d&&(a.originId=t[i],i++,o++,a.destinationId=t[i],i++,o++);i<t.length;i++)a.properties[s[i-o]]=t[i];r.push(a)}l=l.concat(i.writeToStore(r,en,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return l}};e([t()],an.prototype,"knowledgeGraph",void 0),e([t()],an.prototype,"inclusionModeDefinition",void 0),e([t()],an.prototype,"entityTypeNames",void 0),e([t()],an.prototype,"relationshipTypeNames",void 0),e([t()],an.prototype,"geographicLookup",void 0),e([t()],an.prototype,"sublayerCaches",void 0),an=e([n("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],an);const ln=I(),dn=i=>{let r=class extends i{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return e([t(ln.fields)],r.prototype,"fields",void 0),e([t(ln.fieldsIndex)],r.prototype,"fieldsIndex",void 0),r=e([n("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],r),r};let cn=class extends(E(dn(j(k(G(S)))))){constructor(e){if(super(e),this.capabilities=z(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=en,this.objectType=null,this.parentCompositeLayer=null,this.popupTemplate=null,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new R(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{const n=g.fromJSON(e);return this.queryFeaturesJSON(n,t)}}},(()=>null)),[e.port2]}))},this.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=rn;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&"esriGeometryNull"!==e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?x.fromJSON(t.geometryType):null;const n=t?.name,i=n?e.objectType.properties?.[n]:null;i?(this.hasM=i.hasM??!1,this.hasZ=i.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach((e=>{let t=null,n=e.fieldType;"esriFieldTypeOID"===n&&(n="esriFieldTypeInteger"),this.fields.push(M.fromJSON({name:e.name,type:n,alias:e.alias,defaultValue:t,editable:e.editable,nullable:e.nullable}))})),this.fields.push(M.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?this.renderer=C(Y(x.toJSON("polyline")).renderer):this.renderer=C(Y(x.toJSON("point")).renderer):this.renderer=C(Y(x.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){A(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return N(this,e)}createQuery(){return new g({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];throw new Error("Field not found")}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e),r=_.fromJSON(await i.executeQuery(n.toJSON(),t?.signal));return r.features.forEach((e=>{e.sourceLayer=this})),r}async queryFeaturesJSON(e,t){const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e);return await i.executeQuery(n.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e);return i.executeQueryForCount(n.toJSON(),t?.signal)}async queryExtent(e={},t){const n={...e,returnGeometry:!0},{resolvedQuery:i,queryEngine:r}=await this._setupQueryObjects(n),s=await r.executeQueryForExtent(i.toJSON(),t?.signal);let o;return o=null!=s.extent?.xmin&&null!=s.extent?.xmax&&null!=s.extent?.ymin&&null!=s.extent?.ymax?new D(s.extent):new D,{count:s.count,extent:o}}async queryObjectIds(e,t){const n=g.from(e);let i;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(n,this,t);i=this.loadQueryEngine(e)}return i.executeQueryForIds(n.toJSON(),t?.signal)}loadQueryEngine(e){const t=new B({geometryType:x.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),n=new H({fields:this.fields.map((e=>e.toJSON())),geometryType:x.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return n.featureStore.addMany(e),n}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new g({where:"1=1",outFields:[en]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const n=g.from(e),i=n.geometry;let r;if(i&&!i.spatialReference?.isWGS84&&(await m(i.spatialReference,v),n.geometry=b(i instanceof p||i instanceof u?i:i.extent,v)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)r=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(n,this,t);r=this.loadQueryEngine(e)}return{resolvedQuery:n,queryEngine:r}}};e([t()],cn.prototype,"capabilities",void 0),e([t({readOnly:!0})],cn.prototype,"defaultPopupTemplate",null),e([t()],cn.prototype,"definitionExpression",void 0),e([t()],cn.prototype,"displayField",void 0),e([t()],cn.prototype,"elevationInfo",void 0),e([t()],cn.prototype,"geometryType",void 0),e([t()],cn.prototype,"geometryFieldName",void 0),e([t()],cn.prototype,"graphType",void 0),e([t()],cn.prototype,"hasM",void 0),e([t()],cn.prototype,"hasZ",void 0),e([t()],cn.prototype,"labelsVisible",void 0),e([t()],cn.prototype,"labelingInfo",void 0),e([t()],cn.prototype,"objectIdField",void 0),e([t()],cn.prototype,"objectType",void 0),e([t()],cn.prototype,"parentCompositeLayer",void 0),e([t({type:P,json:{name:"popupInfo",write:!0}})],cn.prototype,"popupTemplate",void 0),e([t({types:O,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],cn.prototype,"renderer",null),e([t()],cn.prototype,"source",void 0),e([t({json:{read:!1}})],cn.prototype,"type",void 0),cn=e([n("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],cn);const hn=cn;let un,pn=null;function yn(){return un||(un=import("./p-cd3e78f0.js").then((e=>e.l)).then((({default:e})=>e({locateFile:e=>a(`esri/libs/linkchartlayout/${e}`)}))).then((e=>{wn(e)})),un)}function wn(e){pn=e}var fn;function gn(e,t,n,i,r,s){const o=n.length,a=r.length,l=Float64Array.BYTES_PER_ELEMENT,d=Uint32Array.BYTES_PER_ELEMENT,c=Uint8Array.BYTES_PER_ELEMENT,h=16,u=h-1+o*(c+2*l)+a*(2*d),p=pn._malloc(u);try{const c=p+h-p%h,u=c+o*l,y=u+o*l,w=y+a*d,f=w+a*d,g=()=>[pn.HEAPF64.subarray(c>>3,(c>>3)+o),pn.HEAPF64.subarray(u>>3,(u>>3)+o),pn.HEAPU32.subarray(y>>2,(y>>2)+a),pn.HEAPU32.subarray(w>>2,(w>>2)+a),pn.HEAPU8.subarray(f,f+o)],[m,v,b,T,I]=g();m.set(n),v.set(i),b.set(r),T.set(s),I.set(t);const E=e(o,f,c,u,a,y,w),[j,k,G,S,R]=g();return n.set(j),i.set(k),r.set(G),s.set(S),t.set(R),E}finally{pn._free(p)}}!function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"}(fn||(fn={}));const mn=2,vn=1,bn=-1;var Tn,In,En,jn,kn,Gn,Sn,Rn;!function(e){function t(){return pn.getMinIdealEdgeLength()}function n(e,t,n,i,r,s=mn,o=vn,a=bn){return gn(((e,t,n,i,r,l,d)=>pn.applyForceDirectedLayout(e,t,n,i,r,l,d,s,o,a)),e,t,n,i,r)}e.getMinIdealEdgeLength=t,e.apply=n}(Tn||(Tn={})),function(e){function t(e,t,n,i,r,s=mn,o=vn,a=bn){return gn(((e,t,n,i,r,l,d)=>pn.applyCommunityLayout(e,t,n,i,r,l,d,s,o,a)),e,t,n,i,r)}e.apply=t}(In||(In={})),function(e){function t(e,t,n,i,r){return gn(pn.applySimpleLayout,e,t,n,i,r)}e.apply=t}(En||(En={})),function(e){function t(e,t,n,i,r){return gn(pn.applyHierarchicalLayout,e,t,n,i,r)}e.apply=t}(jn||(jn={})),function(e){function t(e,t,n,i,r){return gn(pn.applyRadialTreeLayout,e,t,n,i,r)}e.apply=t}(kn||(kn={})),function(e){function t(e,t,n,i,r){return gn(pn.applySmartTreeLayout,e,t,n,i,r)}e.apply=t}(Gn||(Gn={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(Sn||(Sn={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(Rn||(Rn={}));const xn=(e,t,n)=>(e.has(t)||e.set(t,n()),e.get(t));let Mn=class extends(j(k(S))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE",xScaleFactor:1,yScaleFactor:1},this._graphTypeLookup=new Map,this.layers=new F,this.linkChartDiagramLookup=new Map,this.linkChartExtent=new D({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.sublayerIdsCache=new Map,this.tables=new F,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new l("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const e=this.url.split("/");this.title=e[e.length-2]}const t=new Set;let n=[],i=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new l("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e)})),e.inclusionModeDefinition?.generateAllSublayers?(n=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((r,s)=>{if(!this._graphTypeLookup.get(s))return y.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);this._graphTypeLookup.get(s)instanceof ce||"strictOrigin"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),i.push(this._graphTypeLookup.get(s))):this._graphTypeLookup.get(s)instanceof le||"properties"in this._graphTypeLookup.get(s)?t.has(s)||(t.add(s),n.push(this._graphTypeLookup.get(s))):(y.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(s))})):(n=e.knowledgeGraph.dataModel.entityTypes??[],i=e.knowledgeGraph.dataModel.relationshipTypes??[]);const r=new an({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=n,this.memberRelationshipTypes=i,this.dataManager=r}load(e){return this.addResolvingPromise(new Promise((t=>{Dt(this.url).then((n=>{if(this._initializeLayerProperties({knowledgeGraph:n,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})})),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}))),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e=>{e.useAllData=!1,e.members?.forEach((e=>{let t;t=e.linkChartLocation instanceof Q?e.linkChartLocation:e.linkChartLocation?q(e.linkChartLocation):null,this.linkChartDiagramLookup.set(e.id,t),t&&2===t.coords.length&&0===t.lengths.length?this.linkChartGeohashLookup.set(e.id,$(t.coords[1],t.coords[0],sn)):this.linkChartGeohashLookup.set(e.id,"")})),this.addResolvingPromise(this._initializeDiagram().then((async()=>{this.layers.forEach((async e=>{await e.refreshCachedQueryEngine()})),this.tables.forEach((async e=>{await e.refreshCachedQueryEngine()}))})))}));else{const t="GEOGRAPHIC"===this.defaultLinkChartConfig?.layoutMode;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,t,!0).then((async()=>{L(e);const t=[],n=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach((e=>{e.useAllData=!1}))),await this._initializeDiagram(),this.layers.forEach((e=>{n.push(e.refreshCachedQueryEngine()),t.push(new Promise((t=>{e.on("layerview-create",(()=>{t(null)}))})))})),this.tables.forEach((e=>{n.push(e.refreshCachedQueryEngine())})),await Promise.all(n)})))}t(null)}))}))),Promise.resolve(this)}async addRecords(e){await this._handleNewRecords(e)}async expand(e){const t=await this.dataManager.getConnectedRecordIds(e),n=t.filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));return await this._handleNewRecords(t),{records:n}}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach((e=>{const t=new hn({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.memberEntityTypes.forEach((e=>{const t=new hn({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{const n=xn(this.sublayerIdsCache,t,(()=>new Set));e.members?.forEach((e=>{if(n.add(e.id),e.linkChartLocation)if(e.linkChartLocation instanceof Q)this.linkChartDiagramLookup.set(e.id,e.linkChartLocation),2===e.linkChartLocation.coords.length&&0===e.linkChartLocation.lengths.length?this.linkChartGeohashLookup.set(e.id,$(e.linkChartLocation.coords[1],e.linkChartLocation.coords[0],sn)):this.linkChartGeohashLookup.set(e.id,"");else{const t=q(e.linkChartLocation);this.linkChartDiagramLookup.set(e.id,e.linkChartLocation?t:null),"x"in e.linkChartLocation&&"y"in e.linkChartLocation?this.linkChartGeohashLookup.set(e.id,$(e.linkChartLocation.x,e.linkChartLocation.y,sn)):this.linkChartGeohashLookup.set(e.id,"")}}))}))}async calculateLinkChartLayout(e="RADIAL_TREE",t){const n=[],i=[];this.dataManager.sublayerCaches.forEach(((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach((e=>{n.push({typeName:t,feature:e})})):this.dataManager.relationshipTypeNames.has(t)&&e.forEach((e=>{i.push({typeName:t,feature:e})}))})),this.linkChartDiagramLookup=new Map;const r=new Map,s=new Map,o=new Map,a=new Map,d=new Uint8Array(n.length),c=new Float64Array(n.length),p=new Float64Array(n.length),w=new Uint32Array(i.length),f=new Uint32Array(i.length),g=[],m="FORCE_DIRECTED",v=t?.xScaleFactor??1,b=t?.yScaleFactor??1,T=new D({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let I,E="FORCE_DIRECTED",j=0,k=0;switch(E="GEOGRAPHIC"===e?m:e,E){case"FORCE_DIRECTED":I=Tn.apply;break;case"COMMUNITY":I=In.apply;break;case"HIERARCHICAL":I=jn.apply;break;case"RADIAL_TREE":I=kn.apply;break;case"SMART_TREE":I=Gn.apply;break;default:I=En.apply}n.forEach((({typeName:n,feature:i})=>{if(t?.lockedNodeLocations?.has(i.attributes[en])){"GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(n)?d[j]=fn.IsGeographic:d[j]=fn.None;const r=t.lockedNodeLocations.get(i.attributes[en]);c[j]=r.x,p[j]=r.y}else if("GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(n)){d[j]=fn.IsGeographic;let e=null;const t=i.attributes[this.dataManager.geographicLookup.get(n).name],r=this.dataManager.geographicLookup.get(n)?.geometryType;switch(r){case"esriGeometryPoint":c[j]=t?.x,p[j]=t?.y;break;case"esriGeometryPolygon":e=t?.centroid,null!=e?.x&&null!=e?.y?(c[j]=e.x,p[j]=e.y):d[j]=fn.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=t?.extent?.center,null!=e?.x&&null!=e?.y?(c[j]=e.x,p[j]=e.y):d[j]=fn.IsMovable;break;default:d[j]=fn.IsMovable}(null==c[j]||null==p[j]||Number.isNaN(c[j])||Number.isNaN(p[j]))&&(d[j]=fn.IsMovable,c[j]=0,p[j]=0)}else d[j]=fn.IsMovable,c[j]=0,p[j]=0;a.set(i.attributes[en],j),g[j]={feature:i,typeName:n},j++}));let G=!1;i.forEach((e=>{const t=a.get(e.feature.attributes[tn]),n=a.get(e.feature.attributes[nn]);void 0!==t&&void 0!==n?(w[k]=t,f[k]=n,k++):(G=!0,this.linkChartDiagramLookup.set(e.feature.attributes[tn],null),this.linkChartGeohashLookup.set(e.feature.attributes[tn],null))})),G&&y.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await yn();if(!I(d,c,p,w,f))throw new l("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let e=0;e<g.length;e++){if(d[e]===fn.IsMovable&&(c[e]=c[e]*v,p[e]=p[e]*b),p[e]>84.9999&&(p[e]=84.9999),p[e]<-84.9999&&(p[e]=-84.9999),c[e]>179.9999&&(c[e]=179.9999),c[e]<-179.9999&&(c[e]=-179.9999),g[e].feature.attributes[rn]=new h(c[e],p[e]),r.has(g[e].typeName)){const t=r.get(g[e].typeName);t?.set(g[e].feature.attributes[en],g[e].feature)}else{const t=new Map;t.set(g[e].feature.attributes[en],g[e].feature),r.set(g[e].typeName,t)}o.set(g[e].feature.attributes[en],g[e].feature);const t=q(g[e].feature.attributes[rn]);this.linkChartDiagramLookup.set(g[e].feature.attributes[en],g[e].feature.attributes[rn]?t:null),this.linkChartGeohashLookup.set(g[e].feature.attributes[en],$(g[e].feature.attributes[rn].y,g[e].feature.attributes[rn].x,sn)),g[e].feature.attributes[rn].x<T.xmin&&(T.xmin=g[e].feature.attributes[rn].x),g[e].feature.attributes[rn].x>T.xmax&&(T.xmax=g[e].feature.attributes[rn].x),g[e].feature.attributes[rn].y<T.ymin&&(T.ymin=g[e].feature.attributes[rn].y),g[e].feature.attributes[rn].y>T.ymax&&(T.ymax=g[e].feature.attributes[rn].y)}return this.linkChartExtent.xmin=T.xmin,this.linkChartExtent.xmax=T.xmax,this.linkChartExtent.ymin=T.ymin,this.linkChartExtent.ymax=T.ymax,i.forEach((e=>{const t=g[a.get(e.feature.attributes[tn])]?.feature.attributes[rn],n=g[a.get(e.feature.attributes[nn])]?.feature.attributes[rn];if(!t||!n)return;const i=new u({paths:[[t.x,t.y],[n.x,n.y]]});if(e.feature.attributes[rn]=i,s.has(e.typeName)){const t=s.get(e.typeName);t?.set(e.feature.attributes[en],e.feature)}else{const t=new Map;t.set(e.feature.attributes[en],e.feature),s.set(e.typeName,t)}o.set(e.feature.attributes[en],e.feature);const r=q(e.feature.attributes[rn]);this.linkChartDiagramLookup.set(e.feature.attributes[en],e.feature.attributes[rn]?r:null),this.linkChartGeohashLookup.set(e.feature.attributes[en],"")})),this._currentLinkChartConfig={layoutMode:e,xScaleFactor:v,yScaleFactor:b},{nodes:r,links:s,idMap:o}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const n=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach((e=>{n.push(e.refreshCachedQueryEngine())})),await Promise.all(n),this.layers.forEach((e=>{e.emit("refresh",{dataChanged:!0})}))}getCurrentNodeLocations(){const e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t=>{t?.members?.forEach((t=>{const n=t.linkChartLocation;let i;const r=t.id;n&&(i="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]},e.set(r,new h({x:i.x,y:i.y})))}))})),e}async synchronizeInclusionListWithCache(){return new Promise((e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{if(e.useAllData=!1,e.members&&e.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;const n=Array.from(this.dataManager.sublayerCaches.get(t).keys());Array.from(e.members.keys()).filter((e=>!n.includes(e))).forEach((t=>{e.members?.delete(t)}))}})),e()}))}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach((e=>{t.push(e.refreshCachedQueryEngine())})),await Promise.all(t),this.layers.forEach((e=>{e.emit("refresh",{dataChanged:!0})}))}async _handleNewRecords(e){const t=[];this.dataManager.addToLayerInclusionSet(e);for(const n of e)this.sublayerIdsCache.has(n.typeName)||(this.sublayerIdsCache.set(n.typeName,new Set),t.push(n.typeName)),this.sublayerIdsCache.get(n.typeName).add(n.id);for(const e of t)if(this._graphTypeLookup.has(e)){const t=this._graphTypeLookup.get(e),n="endPoints"in t?"relationship":"entity",i=new hn({objectType:t,parentCompositeLayer:this,graphType:n,title:e});"entity"===n?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e),i.geometryType?this.layers.push(i):this.tables.push(i),this.dataManager.sublayerCaches.set(e,new Map)}await this.dataManager.refreshCacheContent(e.map((e=>e.id))),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,{xScaleFactor:this._currentLinkChartConfig.xScaleFactor,yScaleFactor:this._currentLinkChartConfig.xScaleFactor})}async _initializeDiagram(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e=>{e?.members?.forEach((e=>{const t=e.linkChartLocation;let n;const i=e.id;if(!t)return;n="x"in t?{x:t.x,y:t.y}:{x:t.coords[0],y:t.coords[1]};const r=q(n);this.linkChartDiagramLookup.set(i,r),this.linkChartGeohashLookup.set(i,$(n.x,n.y,sn)),this.linkChartExtent.xmin>n.x&&(this.linkChartExtent.xmin=n.x),this.linkChartExtent.xmax<n.x&&(this.linkChartExtent.xmax=n.x),this.linkChartExtent.ymin>n.y&&(this.linkChartExtent.ymin=n.y),this.linkChartExtent.ymax<n.y&&(this.linkChartExtent.ymax=n.y)}))})),this.memberRelationshipTypes.forEach((e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach((e=>{const t=this.linkChartDiagramLookup.get(e.attributes[tn]),n=this.linkChartDiagramLookup.get(e.attributes[nn]);if(t&&n){const i=q(new u({paths:[[t.coords[0],t.coords[1]],[n.coords[0],n.coords[1]]]}));this.linkChartDiagramLookup.set(e.attributes[en],i)}else this.linkChartDiagramLookup.set(e.attributes[en],null);this.linkChartGeohashLookup.set(e.attributes[en],"")}))}))):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{xScaleFactor:this.defaultLinkChartConfig.xScaleFactor,yScaleFactor:this.defaultLinkChartConfig.yScaleFactor,lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}};e([t()],Mn.prototype,"dataPreloadedInLocalCache",void 0),e([t()],Mn.prototype,"defaultLinkChartConfig",void 0),e([t()],Mn.prototype,"dataManager",void 0),e([t()],Mn.prototype,"knowledgeGraph",void 0),e([t()],Mn.prototype,"layers",void 0),e([t()],Mn.prototype,"linkChartDiagramLookup",void 0),e([t()],Mn.prototype,"linkChartExtent",void 0),e([t()],Mn.prototype,"linkChartGeohashLookup",void 0),e([t()],Mn.prototype,"memberEntityTypes",void 0),e([t()],Mn.prototype,"memberRelationshipTypes",void 0),e([t()],Mn.prototype,"sublayerIdsCache",void 0),e([t()],Mn.prototype,"tables",void 0),e([t({json:{read:!1}})],Mn.prototype,"type",void 0),Mn=e([n("esri.layers.LinkChartLayer")],Mn);const Cn=Mn;export default Cn;
//# sourceMappingURL=p-4f24aadc.js.map