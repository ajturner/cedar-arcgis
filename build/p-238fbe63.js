import{bX as t,a_ as s,gz as e,an as i,ar as r}from"./p-98455486.js";import{O as o}from"./p-af5dfb20.js";import{i as a}from"./p-1382d09e.js";import{z as n,$ as h}from"./p-7dc0ec82.js";import{e as l,d as c}from"./p-ed1a11ab.js";import{n as u}from"./p-c782b111.js";function f(t,s){const e=s.length;if(t<s[0].value||1===e)return s[0].size;for(let i=1;i<e;i++)if(t<s[i].value){const e=(t-s[i-1].value)/(s[i].value-s[i-1].value);return s[i-1].size+e*(s[i].size-s[i-1].size)}return s[e-1].size}class p{constructor(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.outsideLabelsVisible=!1,this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1},this._technique=l}getSizeVVFieldStops(t){const s=this._vvSizeFieldStops;if(s)switch(s.type){case"static":return s;case"level-dependent":return s.levels[t]??(()=>{let e=1/0,i=0;for(const r in s.levels){const s=parseFloat(r),o=Math.abs(t-s);o<e&&(e=o,i=s)}if(e===1/0)return{sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};const r=2**((t-i)/2),o=s.levels[i],a=new Float32Array(o.values);return a[2]*=r,a[3]*=r,{sizes:o.sizes,values:a}})();default:return}}get vvMaterialParameters(){return this._vvMaterialParameters}update(t){null!=this._vvInfo&&this._updateVisualVariables(this._vvInfo.vvRanges,t)}setInfo(t,s,e){this._updateEffects(e),this._vvInfo=s,this._technique=c(t),this.rendererSchema=this._technique.createOrUpdateRendererSchema(this.rendererSchema,t)}getVariation(){return{...this._technique.getVariation(this.rendererSchema),outsideLabelsVisible:this.outsideLabelsVisible,supportsTextureFloat:u("2d").supportsTextureFloat}}getVariationHash(){return this._technique.getVariationHash(this.rendererSchema)<<1|(this.outsideLabelsVisible?1:0)}_updateEffects(t){this.outsideLabelsVisible=null!=t&&t.excludedLabelsVisible}_updateVisualVariables(i,r){const o=this._vvMaterialParameters;if(o.vvOpacityEnabled=!1,o.vvSizeEnabled=!1,o.vvColorEnabled=!1,o.vvRotationEnabled=!1,!i)return;const a=i.size;if(a){if(o.vvSizeEnabled=!0,a.minMaxValue){const s=a.minMaxValue;let e,i;if(n(s.minSize)&&n(s.maxSize))if(h(s.minSize)&&h(s.maxSize))e=t(s.minSize),i=t(s.maxSize);else{const o=r.scale;e=t(f(o,s.minSize.stops)),i=t(f(o,s.maxSize.stops))}this.vvSizeMinMaxValue.set([s.minDataValue,s.maxDataValue,e,i])}if(a.scaleStops&&(this.vvSizeScaleStopsValue=t(f(r.scale,a.scaleStops.stops))),a.unitValue){const t=s(r.spatialReference)/e[a.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=t/r.resolution}a.fieldStops&&(this._vvSizeFieldStops=a.fieldStops)}const l=i.color;l&&(o.vvColorEnabled=!0,this.vvColorValues.set(l.values),this.vvColors.set(l.colors));const c=i.opacity;c&&(o.vvOpacityEnabled=!0,this.vvOpacityValues.set(c.values),this.vvOpacities.set(c.opacities));const u=i.rotation;u&&(o.vvRotationEnabled=!0,o.vvRotationType=u.type)}}class d extends a{constructor(t){super(t),this._rendererInfo=new p,this._materialItemsRequestQueue=new i,this.attributeView=new o((()=>this.onAttributeStoreUpdate()))}destroy(){this.children.forEach((t=>t.destroy())),this.removeAllChildren(),this.attributeView.destroy(),this._materialItemsRequestQueue.clear()}setRendererInfo(t,s,e){this._rendererInfo.setInfo(t,s,e),this.requestRender()}async getMaterialItems(t,s){if(!t||0===t.length)return[];const e=r();return this._materialItemsRequestQueue.push({items:t,abortOptions:s,resolver:e}),this.requestRender(),e.promise}doRender(t){if(t.context.capabilities.enable("textureFloat"),t.context.capabilities.enable("vao"),this._materialItemsRequestQueue.length>0){let s=this._materialItemsRequestQueue.pop();for(;s;)this._processMaterialItemRequest(t,s),s=this._materialItemsRequestQueue.pop()}super.doRender(t)}renderChildren(t){for(const s of this.children)s.commit(t);this._rendererInfo.update(t.state),super.renderChildren(t)}updateTransforms(t){if(this.children.some((t=>t.hasData)))for(const s of this.children)s.setTransform(t)}createRenderParams(t){const s=super.createRenderParams(t);return s.rendererInfo=this._rendererInfo,s.attributeView=this.attributeView,s}onAttributeStoreUpdate(){}_processMaterialItemRequest(t,{items:s,abortOptions:e,resolver:i}){const{painter:r,pixelRatio:o}=t,a=s.map((t=>r.textureManager.rasterizeItem(t.symbol,o,t.glyphIds,e)));Promise.all(a).then((t=>{if(!this.stage)return void i.reject();const e=t.map(((t,e)=>({id:s[e].id,mosaicItem:t})));i.resolve(e)}),i.reject)}}export{d as o};
//# sourceMappingURL=p-238fbe63.js.map