import{bB as e,aT as t}from"./p-98455486.js";import{p as n,m as r,y as o}from"./p-28b18b6c.js";import{m as a}from"./p-0a76eb6d.js";import{n as i,s}from"./p-49fcc632.js";import"./p-7bd5d456.js";import"./p-52d8e383.js";import"./p-de65f975.js";import"./p-cc24e5bd.js";import"./p-603bf978.js";import"./p-783b6965.js";var c,l;!function(e){e[e.None=0]="None",e[e.Int16=1]="Int16",e[e.Int32=2]="Int32"}(c||(c={})),function(e){e[e.Replace=0]="Replace",e[e.Outside=1]="Outside",e[e.Inside=2]="Inside",e[e.Finished=3]="Finished"}(l||(l={}));function f(){return d||(d=new Promise((e=>import("./p-b8df2e0b.js").then((e=>e.i)).then((({default:t})=>{const n=t({locateFile:u,onRuntimeInitialized:()=>e(n)});delete n.then})))).catch((e=>{throw e}))),d}function u(t){return e(`esri/libs/i3s/${t}`)}let d;var m,p,y,w,b;!function(e){e[e.Unmodified=0]="Unmodified",e[e.Culled=1]="Culled",e[e.NotChecked=2]="NotChecked"}(m||(m={})),function(e){e[e.Unmodified=0]="Unmodified",e[e.PotentiallyModified=1]="PotentiallyModified",e[e.Culled=2]="Culled",e[e.Unknown=3]="Unknown",e[e.NotChecked=4]="NotChecked"}(p||(p={}));!function(e){e[e.Unknown=0]="Unknown",e[e.Uncached=1]="Uncached",e[e.Cached=2]="Cached"}(y||(y={})),function(e){e[e.None=0]="None",e[e.MaxScreenThreshold=1]="MaxScreenThreshold",e[e.ScreenSpaceRelative=2]="ScreenSpaceRelative",e[e.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",e[e.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(w||(w={})),function(e){e[e.Hole=0]="Hole",e[e.Leaf=1]="Leaf"}(b||(b={}));async function A(e){await P();const t=[e.geometryBuffer];return{result:S(e,t),transferList:t}}async function j(e){await P();const t=[e.geometryBuffer],{geometryBuffer:n}=e,r=n.byteLength,o=M._malloc(r),a=new Uint8Array(M.HEAPU8.buffer,o,r);a.set(new Uint8Array(n));const i=M.dracoDecompressPointCloudData(o,a.byteLength);if(M._free(o),i.error.length>0)throw new Error(`i3s.wasm: ${i.error}`);const s=i.featureIds?.length>0?i.featureIds.slice():null,c=i.positions.slice();return s&&t.push(s.buffer),t.push(c.buffer),{result:{positions:c,featureIds:s},transferList:t}}async function F(e){await P(),I(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function g(e){await P(),C(e)}async function h(e){await P(),M.setLegacySchema(e.context,e.jsonSchema)}async function v(e){const{localMatrix:i,origin:s,positions:c,vertexSpace:l,local:f}=e,u=t.fromJSON(e.inSpatialReference),d=t.fromJSON(e.outSpatialReference),m={georeferenced:n,georeferencedRelative:a,local:r}[l.type].fromJSON(l);let p;if("georeferenced"===m.type){const{projectBuffer:e,initializeProjection:t}=await import("./p-98455486.js").then((function(e){return e.ke}));await t(u,d),p=new Float64Array(c.length),e(c,u,0,p,d,0,p.length/3)}else{const{project:e}=await import("./p-6f1307db.js").then((function(e){return e.c}));p=o(e({positions:c,transform:i?{localMatrix:i}:void 0,vertexSpace:m,inSpatialReference:u,outSpatialReference:d,local:f}))}const y=p.length,[w,b,A]=s;for(let e=0;e<y;e+=3)p[e]-=w,p[e+1]-=b,p[e+2]-=A;return{result:{projected:p,original:c},transferList:[p.buffer,c.buffer]}}async function x({normalMatrix:e,normals:t}){const n=new Float32Array(t.length);return i(n,t,e),s(n,n),{result:{transformed:n,original:t},transferList:[n.buffer,t.buffer]}}function U(e){L(e)}let R,M;function C(e){const t=e.modifications,n=M._malloc(8*t.length),r=new Float64Array(M.HEAPU8.buffer,n,t.length);for(let e=0;e<t.length;++e)r[e]=t[e];M.setModifications(e.context,n,t.length,e.isGeodetic),M._free(n)}function S(e,t){if(!M)return null;const{context:n,localOrigin:r,globalTrafo:o,mbs:a,obb:i,elevationOffset:s,geometryBuffer:l,geometryDescriptor:f,indexToVertexProjector:u,vertexToRenderProjector:d}=e,m=M._malloc(l.byteLength),p=33,y=M._malloc(p*Float64Array.BYTES_PER_ELEMENT),w=new Uint8Array(M.HEAPU8.buffer,m,l.byteLength);w.set(new Uint8Array(l));const b=new Float64Array(M.HEAPU8.buffer,y,p);O(b,r);let A=b.byteOffset+3*b.BYTES_PER_ELEMENT,j=new Float64Array(b.buffer,A);O(j,o),A+=16*b.BYTES_PER_ELEMENT,j=new Float64Array(b.buffer,A),O(j,a),A+=4*b.BYTES_PER_ELEMENT,null!=i&&(j=new Float64Array(b.buffer,A),O(j,i.center),A+=3*b.BYTES_PER_ELEMENT,j=new Float64Array(b.buffer,A),O(j,i.halfSize),A+=3*b.BYTES_PER_ELEMENT,j=new Float64Array(b.buffer,A),O(j,i.quaternion));const F=f,g={isDraco:!1,isLegacy:!1,color:e.layouts.some((e=>e.some((e=>"color"===e.name)))),normal:e.needNormals&&e.layouts.some((e=>e.some((e=>"normalCompressed"===e.name)))),uv0:e.layouts.some((e=>e.some((e=>"uv0"===e.name)))),uvRegion:e.layouts.some((e=>e.some((e=>"uvRegion"===e.name)))),featureIndex:F.featureIndex},h=M.process(n,!!e.obb,m,w.byteLength,F,g,y,s,u,d,e.normalReferenceFrame);if(M._free(y),M._free(m),h.error.length>0)throw new Error(`i3s.wasm: ${h.error}`);if(h.discarded)return null;const v=h.componentOffsets.length>0?h.componentOffsets.slice():null,x=h.featureIds.length>0?h.featureIds.slice():null,U=h.anchorIds.length>0?Array.from(h.anchorIds):null,R=h.anchors.length>0?Array.from(h.anchors):null,C=h.interleavedVertedData.slice().buffer,S=h.indicesType===c.Int16?new Uint16Array(h.indices.buffer,h.indices.byteOffset,h.indices.byteLength/2).slice():new Uint32Array(h.indices.buffer,h.indices.byteOffset,h.indices.byteLength/4).slice(),D=h.positions.slice(),I=h.positionIndicesType===c.Int16?new Uint16Array(h.positionIndices.buffer,h.positionIndices.byteOffset,h.positionIndices.byteLength/2).slice():new Uint32Array(h.positionIndices.buffer,h.positionIndices.byteOffset,h.positionIndices.byteLength/4).slice(),L={layout:e.layouts[0],interleavedVertexData:C,indices:S,hasColors:h.hasColors,hasModifications:h.hasModifications,positionData:{data:D,indices:I}};return x&&t.push(x.buffer),v&&t.push(v.buffer),t.push(C),t.push(S.buffer),t.push(D.buffer),t.push(I.buffer),{componentOffsets:v,featureIds:x,anchorIds:U,anchors:R,transformedGeometry:L,obb:h.obb}}function D(e){return 0===e?p.Unmodified:1===e?p.PotentiallyModified:2===e?p.Culled:p.Unknown}function I(e){const{context:t,buffer:n}=e,r=M._malloc(n.byteLength),o=n.byteLength/Float64Array.BYTES_PER_ELEMENT,a=new Float64Array(M.HEAPU8.buffer,r,o),i=new Float64Array(n);a.set(i),M.filterOBBs(t,r,o),i.set(a),M._free(r)}function L(e){M&&(M.destroy(e),M=null)}function O(e,t){for(let n=0;n<t.length;++n)e[n]=t[n]}function P(){return M?Promise.resolve():(R||(R=f().then((e=>{M=e,R=null}))),R)}const N={transform:S,destroy:L};export{U as destroyContext,j as dracoDecompressPointCloudData,F as filterObbsForModifications,I as filterObbsForModificationsSync,P as initialize,D as interpretObbModificationResults,A as process,v as project,h as setLegacySchema,g as setModifications,C as setModificationsSync,N as test,x as transformNormals};
//# sourceMappingURL=p-1d167ec8.js.map