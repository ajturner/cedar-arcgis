{"version":3,"names":["async","p","e","t","r","instance","portalItem","id","load","c","y","type","supportedTypes","includes","expectedType","join","a","url","n","title","o","s","l","read","f","u","h","resourceReferences","paths","readResourcePaths","i","layerModuleTypeMap","OrientedImageryLayer","FeatureLayer","StreamLayer","SceneLayer","Promise","all","w","j","length","SubtypeGroupLayer","layerType","b","P","v","d","layers","map","m","tables","name","forEach","layerDefinition","push","filter","T","add","reverse","g","clone","layerId","sourceJSON","sublayerTitleMode","origin","portal","getDefault","showLegend","supportsData","fetchData","S","I","L","find","F","coverage","URL","toLowerCase","searchParams","get","fromPortalItem","fromArcGISServerUrl","layersJSON"],"sources":["./node_modules/@arcgis/core/portal/support/layersLoader.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.27/esri/copyright.txt for details.\n*/\nimport e from\"../../core/Error.js\";import t from\"../../layers/Layer.js\";import{isArcGISUrl as r}from\"../../layers/support/arcgisLayerUrl.js\";import{fetchFeatureService as a}from\"../../layers/support/fetchService.js\";import n from\"../Portal.js\";import o from\"../PortalItem.js\";import{createForItemRead as l}from\"./jsonContext.js\";import{hasTypeKeyword as s}from\"./portalItemUtils.js\";import{loadStyleRenderer as i}from\"../../renderers/support/styleUtils.js\";import{fetchArcGISServiceJSON as u}from\"../../support/requestPresets.js\";async function p(e,t){const r=e.instance.portalItem;if(r&&r.id)return await r.load(t),c(e),y(e,t)}function c(t){const r=t.instance.portalItem;if(!r?.type||!t.supportedTypes.includes(r.type))throw new e(\"portal:invalid-layer-item-type\",\"Invalid layer item type '${type}', expected '${expectedType}'\",{type:r?.type,expectedType:t.supportedTypes.join(\", \")})}async function y(e,t){const r=e.instance,a=r.portalItem;if(!a)return;const{url:n,title:o}=a,s=l(a);if(\"group\"===r.type)return r.read({title:o},s),f(r,e);n&&r.read({url:n},s);const u=await h(e,t);return u&&r.read(u,s),r.resourceReferences={portalItem:a,paths:s.readResourcePaths??[]},\"subtype-group\"!==r.type&&r.read({title:o},s),i(r,s)}async function f(t,r){let a;const{portalItem:n}=t;if(!n)return;const o=n.type,l=r.layerModuleTypeMap,i=s(n,\"Oriented Imagery Layer\")??!1;switch(o){case\"Feature Service\":a=i?l.OrientedImageryLayer:l.FeatureLayer;break;case\"Stream Service\":a=l.StreamLayer;break;case\"Scene Service\":a=l.SceneLayer;break;case\"Feature Collection\":a=l.FeatureLayer;break;default:throw new e(\"portal:unsupported-item-type-as-group\",`The item type '${o}' is not supported as a 'IGroupLayer'`)}let[u,p]=await Promise.all([a(),h(r)]),c=()=>u;if(\"Feature Service\"===o){p=n.url?await w(p,n.url):{};if(j(p).length){const e=l.SubtypeGroupLayer,t=await e();c=e=>\"SubtypeGroupLayer\"===e.layerType?t:u}return b(t,c,p,await P(n.url))}return v(p)>0?b(t,c,p):d(t,c)}async function d(e,t){const{portalItem:r}=e;if(!r?.url)return;const a=await u(r.url);a&&b(e,t,{layers:a.layers?.map(m),tables:a.tables?.map(m)})}function m(e){return{id:e.id,name:e.name}}function b(e,t,r,a){let n=r.layers||[];const o=r.tables||[];if(\"Feature Collection\"===e.portalItem?.type&&(n.forEach((e=>{\"Table\"===e?.layerDefinition?.type&&o.push(e)})),n=n.filter((e=>\"Table\"!==e?.layerDefinition?.type))),\"coverage\"in r){const t=T(r);t&&e.add(t)}n.reverse().forEach((n=>{const o=a?.(n);if(o||!a){const a=g(e,t(n),r,n,o);e.add(a)}})),o.reverse().forEach((n=>{const o=a?.(n);if(o||!a){const a=g(e,t(n),r,n,o);e.tables.add(a)}}))}function g(e,t,r,a,o){const l=e.portalItem,s=new t({portalItem:l.clone(),layerId:a.id});if(\"sourceJSON\"in s&&(s.sourceJSON=o),\"subtype-group\"!==s.type&&(s.sublayerTitleMode=\"service-name\"),\"Feature Collection\"===l.type){const e={origin:\"portal-item\",portal:l.portal||n.getDefault()};s.read(a,e);const t=r.showLegend;null!=t&&s.read({showLegend:t},e)}return s}async function h(e,t){if(!1===e.supportsData)return;const r=e.instance,a=r.portalItem;if(!a)return;let n=null;try{n=await a.fetchData(\"json\",t)}catch(o){}if(S(r)){let e=null,t=!0;if(n&&v(n)>0){if(null==r.layerId){const e=j(n);r.layerId=\"subtype-group\"===r.type?e?.[0]:I(n)}e=L(n,r),e&&(1===v(n)&&(t=!1),null!=n.showLegend&&(e.showLegend=n.showLegend))}return t&&\"sublayerTitleMode\"in r&&\"service-name\"!==r.sublayerTitleMode&&(r.sublayerTitleMode=\"item-title-and-service-name\"),e}return n}async function w(e,t){if(null==e?.layers||null==e?.tables){const r=await u(t);(e=e||{}).layers=e.layers||r?.layers,e.tables=e.tables||r?.tables}return e}function I(e){const t=e.layers;if(t&&t.length)return t[0].id;const r=e.tables;return r&&r.length?r[0].id:null}function L(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&F(a,t)?a:null}function v(e){return(e?.layers?.length??0)+(e?.tables?.length??0)}function S(e){return\"stream\"!==e.type&&\"oriented-imagery\"!==e.type&&\"layerId\"in e}function T(a){const{coverage:n}=a;if(!n)return null;const l=new URL(n);if(n.toLowerCase().includes(\"item.html\")){const e=l.searchParams.get(\"id\"),r=l.origin;return t.fromPortalItem({portalItem:new o({id:e,url:r})})}if(r(n))return t.fromArcGISServerUrl({url:n});throw new e(\"portal:oriented-imagery-layer-coverage\",\"the provided coverage url couldn't be loaded as a layer\")}function j(e){const t=[];return e?.layers?.forEach((e=>{\"SubtypeGroupLayer\"===e.layerType&&t.push(e.id)})),t}function F(e,t){return!(\"feature\"===t.type&&\"layerType\"in e&&\"SubtypeGroupLayer\"===e.layerType||\"subtype-group\"===t.type&&!(\"layerType\"in e))}async function P(e){const{layersJSON:t}=await a(e);if(!t)return null;const r=[...t.layers,...t.tables];return e=>r.find((t=>t.id===e.id))}export{I as getFirstLayerOrTableId,v as getNumLayersAndTables,j as getSubtypeGroupLayerIds,p as load,w as preprocessFSItemData};\n"],"mappings":"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"}