import{ac as t,aQ as i,P as s,c as p,k as r,l as e,n as a}from"./p-98455486.js";import{i as o}from"./p-6133cc0f.js";import"./p-2b228be3.js";import"./p-5572f01a.js";import"./p-1ecac668.js";import"./p-7dc0ec82.js";import"./p-1abe3c64.js";import"./p-908b7a05.js";import"./p-13e550f5.js";import"./p-ed1a11ab.js";import"./p-7099a764.js";import"./p-0c70c0e2.js";import"./p-620ed352.js";import"./p-220b11a0.js";import"./p-4f76b2d1.js";import"./p-2d1dac84.js";import"./p-8a4ae095.js";import"./p-25e77904.js";import"./p-8e3fbd83.js";import"./p-a3c11f30.js";import"./p-aff398b0.js";import{o as h}from"./p-bd7f9fc7.js";import"./p-af5dfb20.js";import"./p-38e70926.js";import"./p-8399f9e1.js";import"./p-b4b7d6a0.js";import"./p-14843b2a.js";import{t as m,o as j,n as c}from"./p-65915957.js";import{f,d as n}from"./p-f7917469.js";import{n as b}from"./p-f2824b64.js";import{h as l}from"./p-f5452a6b.js";import{e as d}from"./p-8b2bb530.js";import{y as u,d as w}from"./p-4cbc7b66.js";import{a as g}from"./p-4c46e2fb.js";import{S as y,U as v,r as T}from"./p-e89101d7.js";import"./p-9f1a0adc.js";import"./p-2b6b8db8.js";import"./p-50b034e8.js";import"./p-e6a64715.js";import"./p-6bb7b693.js";import"./p-0e94eaa4.js";import"./p-ecc7ed03.js";import"./p-3a9bb31c.js";import"./p-de65627f.js";import"./p-0d2202fd.js";import"./p-f33b44a5.js";import"./p-a2737e04.js";import"./p-1172b129.js";import"./p-4e1a9b2e.js";import"./p-eda79132.js";import"./p-69ec1c26.js";import"./p-5977fcaf.js";import"./p-eeca6bc1.js";import"./p-21ae9bf7.js";import"./p-aedab47c.js";import"./p-30bab7e4.js";import"./p-73062657.js";import"./p-f705ab94.js";import"./p-3c3976eb.js";import"./p-623dbe5e.js";import"./p-073c3089.js";import"./p-c6ce33a2.js";import"./p-d46be2b1.js";import"./p-fc9cd10b.js";import"./p-4f27d9ab.js";import"./p-c5929b55.js";import"./p-8043ab9b.js";import"./p-a9fef357.js";import"./p-e91d9d8d.js";import"./p-e22a21a4.js";import"./p-958a5da8.js";import"./p-fcbd27c0.js";import"./p-5abe9c67.js";import"./p-66f65b6a.js";import"./p-dfd7ee02.js";import"./p-da8336be.js";import"./p-dc29c329.js";import"./p-0fdabe4a.js";import"./p-9803a24d.js";import"./p-b15bfa44.js";import"./p-baa730bb.js";import"./p-e1758a64.js";import"./p-ec443a8b.js";import"./p-f4b056c3.js";import"./p-e75aa2b5.js";import"./p-f5f26b1f.js";import"./p-783b6965.js";import"./p-b8afab55.js";import"./p-07f12c16.js";import"./p-c782b111.js";import"./p-795f7c81.js";import"./p-42c332a2.js";import"./p-b0610ac0.js";import"./p-ffb89da5.js";import"./p-83c727f2.js";import"./p-cc77f67d.js";import"./p-a18c7841.js";import"./p-17257453.js";import"./p-fde2045e.js";import"./p-1382d09e.js";import"./p-4a6353a7.js";import"./p-238fbe63.js";import"./p-9a4094ba.js";import"./p-5f505b32.js";import"./p-6b09cddc.js";import"./p-3142f421.js";import"./p-1ba2f0a8.js";const C=[0,0];let P=class extends(g(m(f(n)))){constructor(){super(...arguments),this._fetchQueue=null,this._highlightGraphics=new o,this._highlightView=null,this._popupHighlightHelper=null,this._tileStrategy=null,this.layer=null}get resampling(){return!("resampling"in this.layer)||!1!==this.layer.resampling}get tilemapCache(){return"tilemapCache"in this.layer?this.layer.tilemapCache:null}update(t){this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume(),this._highlightView?.processUpdate(t)}attach(){const i="tileServers"in this.layer?this.layer.tileServers:null,s=this.tilemapCache;if(this._tileInfoView=new l(this.layer.tileInfo,this.layer.fullExtent,s?.effectiveMinLOD,s?.effectiveMaxLOD),this._fetchQueue=new u({tileInfoView:this._tileInfoView,concurrency:i&&10*i.length||10,process:(t,i)=>this.fetchTile(t,i)}),this._tileStrategy=new w({cachePolicy:"keep",resampling:this.resampling,acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView}),y(this,this.layer)){const t=this._highlightView=new h({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new b(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1});this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new v({createFetchPopupFeaturesQueryGeometry:(t,i)=>T(t,i,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:(i,s)=>{t.graphicUpdateHandler({graphic:i,property:s})},layerView:this,updatingHandles:this.updatingHandles})}this.requestUpdate(),this.addAttachHandles(t((()=>this.resampling),(()=>{this.doRefresh()}))),super.attach()}detach(){super.detach(),this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._popupHighlightHelper?.destroy(),this._fetchQueue=this._tileStrategy=this._tileInfoView=this._popupHighlightHelper=null}async fetchPopupFeatures(t,i){return this._popupHighlightHelper?this._popupHighlightHelper.fetchPopupFeatures(t,i):[]}highlight(t){return this._popupHighlightHelper?this._popupHighlightHelper.highlight(t):{remove(){}}}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(t){return i(this.layer.tileInfo?.spatialReference,t)}async doRefresh(){!this.attached||this.updateRequested||this.suspended||(this._fetchQueue.reset(),this._tileStrategy.refresh((t=>this._enqueueTileFetch(t))))}isUpdating(){return this._fetchQueue?.updating??!1}acquireTile(t){const i=this._bitmapView.createTile(t),s=i.bitmap;return[s.x,s.y]=this._tileInfoView.getTileCoords(C,i.key),s.resolution=this._tileInfoView.getTileResolution(i.key),[s.width,s.height]=this._tileInfoView.tileInfo.size,this._enqueueTileFetch(i),this._bitmapView.addChild(i),this.requestUpdate(),i}releaseTile(t){this._fetchQueue.abort(t.key.id),this._bitmapView.removeChild(t),t.once("detach",(()=>t.destroy())),this.requestUpdate()}async fetchTile(t,i={}){const p=this.tilemapCache,{signal:r,resamplingLevel:e=0}=i;if(!p)try{return await this._fetchImage(t,r)}catch(p){if(!s(p)&&!this.resampling)return j(this._tileInfoView.tileInfo.size);if(e<3){const s=this._tileInfoView.getTileParentId(t.id);if(s){const p=new d(s),r=await this.fetchTile(p,{...i,resamplingLevel:e+1});return c(this._tileInfoView,r,p,t)}}throw p}const a=new d(0,0,0,0);let o;try{if(await p.fetchAvailabilityUpsample(t.level,t.row,t.col,a,{signal:r}),a.level!==t.level&&!this.resampling)return j(this._tileInfoView.tileInfo.size);o=await this._fetchImage(a,r)}catch(i){if(s(i))throw i;o=await this._fetchImage(t,r)}return this.resampling?c(this._tileInfoView,o,a,t):o}async _enqueueTileFetch(t){if(!this._fetchQueue.has(t.key.id)){try{const i=await this._fetchQueue.push(t.key);t.bitmap.source=i,t.bitmap.width=this._tileInfoView.tileInfo.size[0],t.bitmap.height=this._tileInfoView.tileInfo.size[1],t.requestRender(),t.once("attach",(()=>this.requestUpdate()))}catch(t){s(t)||p.getLogger(this).error(t)}this.requestUpdate()}}async _fetchImage(t,i){return this.layer.fetchImageBitmapTile(t.level,t.row,t.col,{signal:i})}};r([e()],P.prototype,"_fetchQueue",void 0),r([e()],P.prototype,"resampling",null),r([e()],P.prototype,"tilemapCache",null),P=r([a("esri.views.2d.layers.TileLayerView2D")],P);const q=P;export default q;
//# sourceMappingURL=p-4ea21f42.js.map