import{h as t,n as s,b as i,i as e,e as n}from"./p-4cbc7b66.js";import"./p-f5452a6b.js";import{e as r}from"./p-8b2bb530.js";import{h,i as o,c as a,w as c,g as l,m as u,j as f,a as m,b as d,k as M,o as p,p as w,u as y,x as g,v as b,$ as _,y as x,K as S,P as v,T as P,U as k,Z as I,a0 as z,a1 as L,a2 as T}from"./p-1abe3c64.js";import{f as C,p as F}from"./p-69ec1c26.js";import{E as G,R as A,c as R,w as N,g as V,h as j,S as E,k as B,G as W}from"./p-7dc0ec82.js";import{o as O}from"./p-5977fcaf.js";import{s as D,bX as K,fg as q,c as H,a8 as U,ar as $,dw as X,cK as J,dA as Z,dt as Q,dB as Y,bm as tt,bP as st,dx as it,dC as et,gs as nt,gt as rt,gu as ht,P as ot,aM as at,bu as ct,R as lt,fd as ut}from"./p-98455486.js";import{r as ft,c as mt,i as dt}from"./p-eeca6bc1.js";import{f as Mt,o as pt,e as wt}from"./p-0e94eaa4.js";import{U as yt,s as gt,r as bt,n as _t,i as xt,b as St,Z as vt,d as Pt,o as kt,N as It,C as zt,w as Lt,O as Tt,f as Ct,c as Ft,P as Gt,g as At}from"./p-220b11a0.js";import{h as Rt,S as Nt,j as Vt,k as jt,b as Et,V as Bt,G as Wt,m as Ot}from"./p-2b6b8db8.js";import{t as Dt,n as Kt}from"./p-2d1dac84.js";import{r as qt,z as Ht}from"./p-3a9bb31c.js";import{t as Ut,e as $t}from"./p-ecc7ed03.js";import"./p-38e70926.js";import{c as Xt,a as Jt}from"./p-6bb7b693.js";import{t as Zt}from"./p-e6a64715.js";import{c as Qt,a as Yt}from"./p-21ae9bf7.js";import{getStyleItemFromStyle as ts}from"./p-aedab47c.js";function ss(t,s){if(t&&"name"in t){const i=t;return s&&s.error(new D(i.name,i.message,i.details)),!1}return!0}const is=1.25;class es{get length(){return this._pos}constructor(t,s){this._pos=0;const i=s?this._roundToNearest(s,t.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(i),this._buffer=new t(this._array),this._ctor=t,this._i16View=new Int16Array(this._array)}_roundToNearest(t,s){const i=Math.round(t);return 1===s?i:i+(s-i%s)}_ensureSize(t){if(this._pos+t>=this._buffer.length){const s=this._roundToNearest((this._array.byteLength+t*this._buffer.BYTES_PER_ELEMENT)*is,this._buffer.BYTES_PER_ELEMENT),i=new ArrayBuffer(s),e=new this._ctor(i);e.set(this._buffer,0),this._array=i,this._buffer=e,this._i16View=new Int16Array(this._array)}}ensureSize(t){this._ensureSize(t)}writeF32(t){this._ensureSize(1);const s=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=t,this._pos++,s}push(t){this._ensureSize(1);const s=this._pos;return this._buffer[this._pos++]=t,s}writeFixed(t){this._buffer[this._pos++]=t}setValue(t,s){this._buffer[t]=s}i1616Add(t,s,i){this._i16View[2*t]+=s,this._i16View[2*t+1]+=i}getValue(t){return this._buffer[t]}incr(t){if(this._buffer.length<t)throw new Error("Increment index overflows the target buffer");this._buffer[t]++}decr(t){this._buffer[t]--}writeRegion(t){this._ensureSize(t.length);const s=this._pos;return this._buffer.set(t,this._pos),this._pos+=t.length,s}writeManyFrom(t,s,i){this._ensureSize(i-s);for(let e=s;e!==i;e++)this.writeFixed(t._buffer[e])}buffer(){const t=this._array.slice(0,4*this._pos);return this.destroy(),t}toArray(){return[...this._buffer]}seek(t){this._pos=t}destroy(){this._array=null,this._buffer=null}}const ns=new Map;function rs(t,s,i){const{indicesPerRecord:e,multiplier:n,verticesPerRecord:r}=ns.get(t);return{recordBytes:i*h*Uint32Array.BYTES_PER_ELEMENT,indexBytes:n*e*i*Uint32Array.BYTES_PER_ELEMENT,vertexBytes:n*r*i*s}}ns.set(G.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4}),ns.set(G.LINE,{multiplier:1,indicesPerRecord:24,verticesPerRecord:8}),ns.set(G.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10}),ns.set(G.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4}),ns.set(G.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});class hs{constructor(t,s,i){this._start={index:0,vertex:0};const e=rs(t,s,i),n=s/4;this.geometryType=t,this._records=new es(Int32Array,e.recordBytes),this._indices=new es(Uint32Array,e.indexBytes),this._vertices=new es(Uint32Array,e.vertexBytes),this._metrics=new es(Float32Array,0),this._strideInt=n}serialize(t){const s=this._records.buffer(),i=this._indices.buffer(),e=this._vertices.buffer(),n=this._metrics.length?this._metrics.buffer():null,r=4*this._strideInt;return t.push(s,i,e),{stride:r,records:s,indices:i,vertices:e,metrics:n}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/h}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(t){this._vertices.ensureSize(t)}indexEnsureSize(t){this._indices.ensureSize(t)}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(t,s,i,e,n,r,h,o){this._records.push(t),this._records.push(s??0),this._records.push(i),this._records.push(e),this._records.push(n),this._records.push(r),this._records.push(h),this._records.writeF32(o)}writeIndex(t){this._indices.push(t)}writeVertex(t){this._vertices.push(t)}writeVertexF32(t){this._vertices.writeF32(t)}copyLastFrom(t,s,i){const e=t._records.length-h,n=t._records.getValue(e),r=t._records.getValue(e+1),o=t._records.getValue(e+2),a=t._records.getValue(e+4),c=t._records.getValue(e+6),l=t._records.getValue(e+7),u=this._vertices.length,f=(t._start.vertex-this._vertices.length)/this._strideInt,m=this._indices.length,d=this.vertexCount;for(let s=t._start.index;s!==t._indices.length;s++){const i=t._indices.getValue(s);this._indices.push(i-f)}for(let s=t._start.vertex;s!==t._vertices.length;s++){const i=t._vertices.getValue(s);this._vertices.push(i)}for(let t=u;t<=this._vertices.length;t+=this._strideInt)this._vertices.i1616Add(t,s,i);this._records.push(n),this._records.push(r),this._records.push(o),this._records.push(m),this._records.push(a),this._records.push(d),this._records.push(c),this._records.push(l)}}const os=1,as=2,cs=4,ls=8,us=16,fs=32,ms=64,ds=128;function Ms(t){switch(t){case os:case ls:case fs:return-1;case as:case ms:return 0;case cs:case us:case ds:return 1}}function ps(t){switch(t){case os:case as:case cs:return-1;case ls:case us:return 0;case fs:case ms:case ds:return 1}}const ws=os|ls|fs,ys=cs|us|ds,gs=os|as|cs,bs=fs|ms|ds;class _s{constructor(t,s,i,e,n,r=0){this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._version=0,this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,sortKey:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=s,this.tileKey=t,this._hasAggregate=e,this._pixelBufferEnabled=n,this._version=r,this._symbologyType=i}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(t){const s=[];return s.push(this._serializeTileVertexData(this.tileKey,this.tileKey,this._data.self)),this._data.neighbors.forEach(((i,e)=>{const n=1<<e,h=Ms(n),o=ps(n),a=O(new r(this.tileKey),h,o,t),c=this._serializeTileVertexData(this.tileKey,a.id,i.vertexData);c.message.bufferIds=i.displayIds,s.push(c)})),s}_serializeTileVertexData(t,s,i){const e=new Array;return{message:{tileKeyOrigin:t,tileKey:s,data:{[G.MARKER]:i.get(G.MARKER)?.serialize(e),[G.FILL]:i.get(G.FILL)?.serialize(e),[G.LINE]:i.get(G.LINE)?.serialize(e),[G.TEXT]:i.get(G.TEXT)?.serialize(e),[G.LABEL]:i.get(G.LABEL)?.serialize(e)},version:this._version},transferList:e}}featureStart(t,s){this._current.insertAfter=t,this._current.sortKey=s}featureEnd(){}recordStart(t,s,i,e){this._current.writer=this._getVertexWriter(i),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=e,this._current.id=t,this._current.materialKey=s,this._current.geometryType=i,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexEnsureSize(t){this._current.writer.vertexEnsureSize(t)}indexEnsureSize(t){this._current.writer.indexEnsureSize(t)}vertexBounds(t,s,i,e){this._current.bufferingEnabled&&this._addOverlap(t,s,i,e)}vertexWrite(t){this._current.writer.writeVertex(t)}vertexWriteF32(t){this._current.writer.writeVertexF32(t)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(t){this._current.writer.writeIndex(t)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(t,s,i,e,n,r,h,o){this._current.writer=this._getVertexWriter(G.LABEL);const a=this._current.writer.metricWriter;a.push(C(t)),a.push(s),a.push(i),a.push(e),a.push(n),a.push(r),a.push(h),a.push(o),a.push(255),this._current.metricBoxLenPointer=a.push(0)}metricEnd(){const t=this._current.writer.metricWriter;0===t.getValue(this._current.metricBoxLenPointer)&&t.seek(t.length-10)}metricBoxWrite(t,s,i,e){const n=this._current.writer.metricWriter;n.incr(this._current.metricBoxLenPointer),n.push(0),n.push(0),n.push(t),n.push(s),n.push(i),n.push(e)}recordEnd(){const t=this._current.vertStart,s=this._current.writer.vertexCount-t;if(!s)return!1;this.hasRecords=!0;const i=this._current.indexStart,e=this._current.writer.indexCount-i;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,i,e,t,s,this._current.sortKey),!this._pixelBufferEnabled||this._hasAggregate||0===this._current.overlaps||this._current.geometryType===G.LABEL)return!0;const n=this._current.writer;for(let t=0;t<8;t++){const s=1<<t;if(!!(this._current.overlaps&s)){this._data.neighbors[t]||(this._data.neighbors[t]={vertexData:new Map,displayIds:new Set});const i=this._data.neighbors[t],e=this._current.geometryType;if(!i.vertexData.has(e)){const t=A(e,this._symbologyType).geometry,s=new hs(e,t,o);i.vertexData.set(e,s)}const r=i.vertexData.get(this._current.geometryType),h=8,a=512*-Ms(s)*h,c=512*-ps(s)*h;r?.copyLastFrom(n,a,c),i.displayIds.add(this._current.id)}}return!0}_addOverlap(t,s,i,e){const n=255^((t<0+i?ys:t>=a-i?ws:ys|ws)|(s<0+e?bs:s>=a-e?gs:bs|gs));this._current.overlaps|=n}_getVertexWriter(t){if(!this._data.self.has(t)){const s=this._data.self,i=A(t,this._symbologyType).geometry;s.set(t,new hs(t,i,this.hint.records))}return this._data.self.get(t)}}const xs=0,Ss=100;function vs(t,s,i){return t[0]=s[0]-i[0],t[1]=s[1]-i[1],t}function Ps(t,s){return Math.sqrt(t*t+s*s)}function ks(t){const s=Ps(t[0],t[1]);t[0]/=s,t[1]/=s}function Is(t,s){return Ps(t[0]-s[0],t[1]-s[1])}function zs(t=2){return 1/Math.max(t,1)}function Ls(t,s){return[!!t?.minScale&&s.scaleToZoom(t.minScale)||xs,!!t?.maxScale&&s.scaleToZoom(t.maxScale)||Ss]}function Ts(t,s){return t[s+1]}function Cs(t){return t.length-1}function Fs(t){let s=0;for(let i=0;i<Cs(t);i++)s+=Gs(t,i);return s}function Gs(t,s,i=1){const[e,n]=Ts(t,s);return Math.sqrt(e*e+n*n)*i}class As{constructor(t,s,i,e,n){this._segments=t,this._index=s,this._distance=i,this._xStart=e,this._yStart=n,this._done=!1}static create(t){return new As(t,0,0,t[0][0],t[0][1])}clone(){return new As(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(0===this._distance||1===t._distance)||t._index===this._index+1&&(1===this._distance||0===t._distance)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,s=(0*t+-1*-this.dx)/(1*this.length);let i=Math.acos(s);return t>0&&(i=2*Math.PI-i),i}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:s}=this;return Math.sqrt(t*t+s*s)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Cs(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,s){const i=this.backwardLength;if(t<=i)return this._distance=(i-t)/this.length,this;let e=this.backwardLength;for(;this.prev();){if(e+this.length>t)return this._seekBackwards(t-e);e+=this.length}return this._distance=0,s?this:null}seek(t,s=!1){if(t<0)return this._seekBackwards(Math.abs(t),s);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>t)return this.seek(t-i,s);i+=this.length}return this._distance=1,s?this:null}}function Rs(t,s,i,e=!0){const n=Fs(t),r=As.create(t),h=n/2;if(!e)return r.seek(h),void i(r.clone(),0,h+0*s,n);const o=Math.max((n-s)/2,0),a=Math.floor(o/s),c=h-a*s;r.seek(c);for(let t=-a;t<=a;t++)r.x<512&&r.x>=0&&r.y<512&&r.y>=0&&i(r.clone(),t,h+t*s,n),r.seek(s)}function Ns(t,s){const i=s;for(let s=0;s<t.length;s++){let e=t[s];Vs(e,i);const n=[];n.push(e[0]);for(let t=1;t<e.length;t++){const[s,i]=e[t-1],[r,h]=e[t],o=Math.round(r-s),a=Math.round(h-i);n.push([o,a])}t[s]=n,e=n}return t}function Vs(t,s){const i=1e-6;if(s<=0)return;const e=t.length;if(e<3)return;const n=[];let r=0;n.push(0);for(let s=1;s<e;s++)r+=Is(t[s],t[s-1]),n.push(r);s=Math.min(s,.2*r);const h=[];h.push(t[0][0]),h.push(t[0][1]);const o=t[e-1][0],a=t[e-1][1],c=vs([0,0],t[0],t[1]);ks(c),t[0][0]+=s*c[0],t[0][1]+=s*c[1],vs(c,t[e-1],t[e-2]),ks(c),t[e-1][0]+=s*c[0],t[e-1][1]+=s*c[1];for(let t=1;t<e;t++)n[t]+=s;n[e-1]+=s;const l=.5*s;for(let r=1;r<e-1;r++){let o=0,a=0,c=0;for(let e=r-1;e>=0&&!(n[e+1]<n[r]-l);e--){const h=l+n[e+1]-n[r],u=n[e+1]-n[e],f=n[r]-n[e]<l?1:h/u;if(Math.abs(f)<i)break;const m=f*f,d=f*h-.5*m*u,M=f*u/s,p=t[e+1],w=t[e][0]-p[0],y=t[e][1]-p[1];o+=M/d*(p[0]*f*h+.5*m*(h*w-u*p[0])-m*f*u*w/3),a+=M/d*(p[1]*f*h+.5*m*(h*y-u*p[1])-m*f*u*y/3),c+=M}for(let h=r+1;h<e&&!(n[h-1]>n[r]+l);h++){const e=l-n[h-1]+n[r],u=n[h]-n[h-1],f=n[h]-n[r]<l?1:e/u;if(Math.abs(f)<i)break;const m=f*f,d=f*e-.5*m*u,M=f*u/s,p=t[h-1],w=t[h][0]-p[0],y=t[h][1]-p[1];o+=M/d*(p[0]*f*e+.5*m*(e*w-u*p[0])-m*f*u*w/3),a+=M/d*(p[1]*f*e+.5*m*(e*y-u*p[1])-m*f*u*y/3),c+=M}h.push(o/c),h.push(a/c)}h.push(o),h.push(a);for(let s=0,i=0;s<e;s++)t[s][0]=h[i++],t[s][1]=h[i++]}class js{static getPlacement(t,s,i,e,n,r){const h=Rt(i);if(!h)return null;-1===s&&t.invertY();return h.execute(t,i,e,n,r)}}const Es=8,Bs=N(4,4),Ws=N(16,4),Os=N(4,2),Ds=N(4,6),Ks=[Os,Os,Ds,Ds],qs=[Os,Ds,Os,Ds],Hs=[Ds,Ds,Bs,Bs],Us=[Bs,Bs,Ds,Ds],$s=[Ds,Bs,Ds,Bs],Xs=[Bs,Ds,Bs,Ds],Js=t=>class extends t{constructor(...t){super(...t),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=G.TEXT,this._aux=R(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,s){t&&t.length?this._shapingInfo=Nt(t,s,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:c*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM,hasBackground:!!this._backgroundColor,borderLineSize:this._borderLineSize}):this._shapingInfo=null}_write(t,s,i,e){const n=s.getDisplayId();this._writeGeometry(t,s,n,i,e)}_writeGeometry(t,s,i,e,n){const r=this._shapingInfo;if(null==r)return;if(this._textPlacement)return this._writePlacedText(t,i,r,e,s,n);const h=n?n.asOptimized():"esriGeometryPolygon"===s.geometryType?s.readCentroid():s.readGeometryForDisplay();if(null!=h){if(h.isPoint){const[s,e]=h.coords;if(!t.hasAggregates&&t.hasPixelBufferEnabled&&(s<0||s>=512||e<0||e>=512))return;return this._writeGlyphs(t,i,{x:s,y:e},r)}h.forEachVertex(((s,e)=>this._writeGlyphs(t,i,{x:s,y:e},r)))}}_writePlacedText(t,s,i,e,n,r){const h=this._textPlacement,o=r||Vt.fromFeatureSetReaderCIM(n);if(!o)return;const a=-1,c=js.getPlacement(o,a,h,K(1),t.tileKey,e.geometryEngine);if(!c)return;const l=i.bounds,u=Math.sqrt(l.height*l.height+l.width*l.width);let f,m,d;for(;f=c.next();)if(m=f.tx,d=-f.ty,m+u>=0&&m-u<512&&d+u>=0&&d-u<512){const e=-f.getAngle();i.setRotation(e),this._writeGlyphs(t,s,{x:m,y:d},i),i.setRotation(-e)}}_writeGlyphs(t,s,i,e){const n=yt.load(this._materialKey),r=N(Math.round(Es*i.x),Math.round(Es*i.y)),h=this._vertexBoundsScale,{bounds:o,background:a,glyphs:c}=e;c.length>0&&(this._borderLineColor||this._backgroundColor)&&(n.textureBinding=c[0].textureBinding,t.recordStart(s,n.data,this.geometryType,!0),this._writeBackgroundGeometry(t,s,i,o,a),t.recordEnd());const l=2*Math.max(o.width,o.height);for(const a of e.glyphs)n.textureBinding=a.textureBinding,t.recordStart(s,n.data,this.geometryType,!0),t.vertexBounds(i.x+o.x+this._xOffset,i.y+o.y-this._yOffset,l*h,l*h),this._writeVertices(t,s,r,a),t.recordEnd()}_writeGlyph(t,s,i,e,n){const r=yt.load(this._materialKey),h=N(Math.round(Es*i),Math.round(Es*e));r.textureBinding=n.textureBinding,t.recordStart(s,r.data,this.geometryType,!0);const o=n.bounds,a=this._vertexBoundsScale;t.vertexBounds(i+o.x*a,e+o.y*a,o.width*a,o.height*a),this._writeVertices(t,s,h,n),t.recordEnd()}_writeVertices(t,s,i,e){const n=t.vertexCount();this._writeVertexCommon(t,s,i,e),t.vertexWrite(e.offsets.upperLeft),t.vertexWrite(e.texcoords.upperLeft),t.vertexEnd(),this._writeVertexCommon(t,s,i,e),t.vertexWrite(e.offsets.upperRight),t.vertexWrite(e.texcoords.upperRight),t.vertexEnd(),this._writeVertexCommon(t,s,i,e),t.vertexWrite(e.offsets.lowerLeft),t.vertexWrite(e.texcoords.lowerLeft),t.vertexEnd(),this._writeVertexCommon(t,s,i,e),t.vertexWrite(e.offsets.lowerRight),t.vertexWrite(e.texcoords.lowerRight),t.vertexEnd(),t.indexWrite(n+0),t.indexWrite(n+1),t.indexWrite(n+2),t.indexWrite(n+1),t.indexWrite(n+3),t.indexWrite(n+2)}_writeVertexCommon(t,s,i,e){const n=this._color,r=this._haloColor,h=R(0,0,this._referenceSize,this._bitset),o=R(0,0,this._size,this._haloSize);t.vertexWrite(i),t.vertexWrite(s),t.vertexWrite(n),t.vertexWrite(r),t.vertexWrite(o),t.vertexWrite(h),t.vertexWrite(this._minMaxZoom)}_writeBackgroundVertex(t,s,i,e,n,r){const h=R(0,1,this._referenceSize,this._bitset),o=R(0,0,this._size,this._haloSize),a=R(0,0,0,0);t.vertexWrite(i),t.vertexWrite(s),t.vertexWrite(e),t.vertexWrite(a),t.vertexWrite(o),t.vertexWrite(h),t.vertexWrite(this._minMaxZoom),t.vertexWrite(n),t.vertexWrite(r),t.vertexEnd()}_writeBackgroundQuad(t,s,i,e,n,r){const h=t.vertexCount();this._writeBackgroundVertex(t,s,i,e,n.upperLeft,r[0]),this._writeBackgroundVertex(t,s,i,e,n.upperRight,r[1]),this._writeBackgroundVertex(t,s,i,e,n.lowerLeft,r[2]),this._writeBackgroundVertex(t,s,i,e,n.lowerRight,r[3]),t.indexWrite(h+0),t.indexWrite(h+1),t.indexWrite(h+2),t.indexWrite(h+1),t.indexWrite(h+3),t.indexWrite(h+2)}_writeBackgroundGeometry(t,s,i,e,n){const r=N(Math.round(Es*i.x),Math.round(Es*i.y)),{x:h,y:o,width:a,height:c}=e,l=2*Math.max(a,c);if(t.vertexBounds(i.x+h+this._xOffset,i.y+o-this._yOffset,l*this._vertexBoundsScale,l*this._vertexBoundsScale),this._backgroundColor){const i=[Ws,Ws,Ws,Ws];this._writeBackgroundQuad(t,s,r,this._backgroundColor,n.main,i)}if(this._borderLineColor||this._backgroundColor){const i=!!this._borderLineColor&&!!this._borderLineSize&&this._borderLineSize>0,[e,h,o,a,c]=i?[Ks,Ks,qs,qs,this._borderLineColor]:[Hs,Us,$s,Xs,this._backgroundColor];this._writeBackgroundQuad(t,s,r,c,n.top,e),this._writeBackgroundQuad(t,s,r,c,n.bot,h),this._writeBackgroundQuad(t,s,r,c,n.left,o),this._writeBackgroundQuad(t,s,r,c,n.right,a)}}};class Zs{constructor(){this._materialKey=null}bindFeature(t,s,i){}write(t,s,i,e){if(this._effects&&this._effects.length>0){let i=Vt.fromFeatureSetReaderCIM(s);if(i){i.invertY();const n=jt.executeEffects(this._effects,i,t.tileKey,e.geometryEngine);for(;i=n.next();)i.invertY(),this._write(t,s,e,i)}}else this._write(t,s,e)}_write(t,s,i,e){}}const Qs=5;class Ys extends(Js(Zs)){constructor(t,s,i,e,n,r,h,o,a,c,f,m,d,M,p,w,y,g,b,_,x,S,v,P){super(),this._xOffset=K(d),this._yOffset=K(M),this._decoration=c||"none",this._backgroundColor=S,this._borderLineColor=v,this._borderLineSize=P,this._color=n,this._haloColor=r,this._haloSize=Math.min(Math.floor(Qs*K(q(i))),127),this._size=Math.min(Math.round(K(s)),127);const k=Math.min(Math.round(K(e||s)),127);this._referenceSize=Math.round(Math.sqrt(256*k)),this._scale=this._size/l,this._angle=m,this._justify=gt(h||"center"),this._xAlignD=bt(h||"center"),this._yAlignD=_t(o||"baseline"),this._baseline="baseline"===(o||"baseline"),this._bitset=(a===Mt.MAP?1:0)|(f?1:0)<<1;const I=yt.load(t);I.sdf=!0,this._materialKey=I.data,this._lineWidth=K(p)||512,this._lineHeight=w||1,this._textPlacement=y,this._effects=g,this._isCIM=b??!1,this._minMaxZoom=N(Math.round(_*u),Math.round(x*u))}static fromText(t,s){const i=t.font?.size,e=new Ys(t.materialKey,i,t.haloSize||0,i,t.color&&V(t.color)||0,t.haloColor&&V(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,Mt.SCREEN,t.font?.decoration,!1,t.angle||0,t.xoffset||0,t.yoffset||0,t.lineWidth||0,t.lineHeight||0,null,null,!1,xs,Ss,t.backgroundColor&&V(t.backgroundColor),t.borderLineColor&&V(t.borderLineColor),t.borderLineSize),[,n]=Et(t.text);return e.bindTextInfo(s??[],n),e._vertexBoundsScale=t.maxVVSize&&i?t.maxVVSize/i:1,e}static fromCIMText(t,s,i){const e=t.scaleFactor||1,n=t.size*t.sizeRatio*e,[r,h]=Ls(t.scaleInfo,i),o=new Ys(t.materialKey,n,t.outlineSize*t.sizeRatio,t.referenceSize,j(t.color),j(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked??!1,t.angle,t.offsetX*t.sizeRatio*e,t.offsetY*t.sizeRatio*e,512,1,t.markerPlacement,t.effects,!0,r,h,t.backgroundColor?j(t.backgroundColor):void 0,t.borderLineColor?j(t.borderLineColor):void 0,t.borderLineWidth),[,a]=Et(t.text);return o.bindTextInfo(s,a),o._vertexBoundsScale=t.maxVVSize?t.maxVVSize/n:1,o}}const ti=H.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),si=(t,s="mapview-labeling")=>ti.error(new D(s,t)),ii=1,ei=0,ni=4,ri=25;function hi(t,s){const i=!!t.minScale&&s.scaleToZoom(t.minScale)||0;return U(i,0,25.5)}function oi(t,s){const i=!!t.maxScale&&s.scaleToZoom(t.maxScale)||255;return U(i,0,25.5)}function ai(t){const s=new Map;return i=>(s.has(i)||s.set(i,t(i)),s.get(i))}const ci=ai((t=>{let s=0;if(0===t)return 1/0;for(;!(t%2);)s++,t/=2;return s})),li=t=>Math.floor(127*t+127),ui=t=>Math.floor(10*t),fi=t=>Math.round(t*(254/360));class mi extends Ys{constructor(t,s,i,e){super(t,i.font?.size,i.haloSize||0,i.font?.size,i.color&&V(i.color)||0,i.haloColor&&V(i.haloColor)||0,i.horizontalAlignment,i.verticalAlignment,xt(s.labelPlacement)?Mt.MAP:Mt.SCREEN,i.font?.decoration,!1,i.angle||0,i.xoffset,i.yoffset,i.lineWidth,i.lineHeight,null,null,!1,null,null,i.backgroundColor&&V(i.backgroundColor),i.borderLineColor&&V(i.borderLineColor),i.borderLineSize),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=G.LABEL,this._allowOverrun=s.allowOverrun??!1,this._repeatLabel=s.repeatLabel??!0,this._labelPosition=s.labelPosition??"curved";const n=hi(s,e),r=oi(s,e),h=s.labelPlacement,[o,a]=St(h);this._xAlignD=o,this._yAlignD=a,this._minZoom=n,this._maxZoom=r,this._minBackgroundZoom=n,this._maxBackgroundZoom=r,this._refPlacementPadding=K(i.haloSize)+f,this._repeatLabelDistance=s.repeatLabelDistance?K(s.repeatLabelDistance):128;const c=vt.load(t);c.sdf=!0,this._materialKey=c.data}static fromLabelClass(t,s){if("esriServerLinePlacementCenterAlong"===t.labelPlacement){const s=t.symbol;s.xoffset=0,s.yoffset=0,s.angle=0,s.font.decoration="none"}return new mi(t.materialKey,t,t.symbol,s)}get _shapedBox(){return this._shapingInfo.bounds}setZoomLevel(t){this._zoomLevel=t}bindReferenceTemplate(t){let s=Pt(this._xAlignD),i=kt(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,null==t)return void(this._refSymbolAndPlacementOffset=R(0,0,li(s),li(i)));if("circle"===t.boundsType&&(s||i)){const t=Math.sqrt(s*s+i*i);s/=t,i/=t}const e=Math.max(t.height,t.width),n=this._refPlacementPadding*ni;this._refSymbolAndPlacementOffset=R(n,e,li(s),li(i)),this._referenceSize=e,this._refPlacementDirX=s,this._refPlacementDirY=i,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}_write(t,s){if(null==this._shapingInfo)return;const i=this._shapingInfo,e=s.getDisplayId(),n="esriGeometryPolygon"===s.geometryType?s.readLegacyCentroid():s.readLegacyGeometry();if(n)switch(this._current={out:t,inId:e,inShaping:i,zoomLevel:this._zoomLevel},"esriGeometryPolyline"===s.geometryType&&"curved"===this._labelPosition&&(this._borderLineColor||this._backgroundColor)&&ti.warnOnce("TextSymbol properties 'borderLineColor', 'borderLineSize', and 'backgroundColor' are not supported in curved labels"),s.geometryType){case"esriGeometryPolyline":this._placeLineLabels(n);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(n);break;default:si(`Geometry of type ${s.geometryType} is not supported`)}}_isVisible(t,s){const i=ui(this._current.zoomLevel);return ui(t)<=i&&i<=ui(s)}_placePointLabels(t){const{out:s,inId:i,inShaping:e}=this._current;this._writeGlyphs(s,i,t,e)}_placeLineLabels(t){const s=Ns(t.paths,this._current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),e=(this._shapedBox.width+this._repeatLabelDistance)/(1<<ii);for(const t of s)Rs(t,e,i,this._repeatLabel)}_placeSubdivGlyphs(t,s,i,e){const n=ci(s),r=this._shapedBox.width/(1<<ii),h=Math.sqrt(this._repeatLabelDistance)/(1<<ii),o=Math.min(i,e-i),a=this._current.inShaping.isMultiline?ri:Math.log2(o/(h+r/2)),c=0===s?a:Math.min(n,a),l=Math.max(this._minZoom,this._current.zoomLevel+ii-c),u=this._current.zoomLevel-l,f=this._shapedBox.width/2*2**u;this._current.inShaping.isMultiline?0===s&&this._placeStraight(t,l):this._allowOverrun&&u<0?this._placeStraightAlong(t,this._minZoom):"parallel"===this._labelPosition?this._placeStraightAlong(t,l):"curved"===this._labelPosition&&this._placeCurved(t,l,f)}_placeStraight(t,s){const{out:i,inId:e,inShaping:n}=this._current,r=Math.ceil(t.angle*(180/Math.PI)%360),h=Math.ceil((t.angle*(180/Math.PI)+180)%360);this._outLineLabelAngle=fi(r),this._writeGlyphs(i,e,t,n,s),this._outLineLabelAngle=fi(h),this._writeGlyphs(i,e,t,n,s)}_placeCurved(t,s,i){const{out:e,inId:n}=this._current;e.metricStart(n,s,t.x,t.y,0,0,0,0);const r=t.clone(),h=t.angle*(180/Math.PI)%360,o=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=fi(h),this._placeFirst(r,s,1),this._placeBack(t,r,s,i,1),this._placeForward(t,r,s,i,1),this._outLineLabelAngle=fi(o),this._placeFirst(r,s,0),this._placeBack(t,r,s,i,0),this._placeForward(t,r,s,i,0),e.metricEnd()}_placeStraightAlong(i,e){const{out:n,inId:r,inShaping:h}=this._current;n.metricStart(r,e,i.x,i.y,0,0,0,0);const o=i.clone(),a=i.angle*(180/Math.PI)%360,c=(i.angle*(180/Math.PI)+180)%360,l=h.glyphs.length>0&&(this._borderLineColor||this._backgroundColor);if(this._maxBackgroundZoom=ri,this._minBackgroundZoom=Math.max(e,0),l){const e=vt.load(this._materialKey);e.textureBinding=h.glyphs[0].textureBinding;const o=t(s(),-i.angle),[l,u]=h.shapeBackground(o);this._outLineLabelAngle=fi(a),n.recordStart(r,e.data,this.geometryType,!0),this._writeBackgroundGeometry(n,r,i,l,u),n.recordEnd(),this._outLineLabelAngle=fi(c),n.recordStart(r,e.data,this.geometryType,!0),this._writeBackgroundGeometry(n,r,i,l,u),n.recordEnd()}this._outLineLabelAngle=fi(a),this._placeFirst(o,e,1,!0),this._outLineLabelAngle=fi(c),this._placeFirst(o,e,0,!0),n.metricEnd()}_placeBack(t,s,i,e,n){const r=t.clone();let h=t.backwardLength+ei;for(;r.prev()&&!(h>=e);)this._placeOnSegment(r,s,h,i,-1,n),h+=r.length+ei}_placeForward(t,s,i,e,n){const r=t.clone();let h=t.remainingLength+ei;for(;r.next()&&!(h>=e);)this._placeOnSegment(r,s,h,i,1,n),h+=r.length+ei}_placeFirst(t,s,i,e=!1){const n=t,r=this._current.inShaping,h=r.glyphs,o=this._current.zoomLevel,{out:a,inId:c}=this._current;for(const l of h){const h=l.x>r.bounds.x?i:1-i,u=h*t.remainingLength+(1-h)*t.backwardLength,f=Math.abs(l.x+l.width/2-r.bounds.x),m=Math.max(0,o+Math.log2(f/(u+ei))),d=Math.max(s,e?0:m);if(l.maxZoom=ri,l.angle=t.angle+(1-i)*Math.PI,l.minZoom=d,this._writeGlyph(a,c,n.x,n.y,l),i&&this._isVisible(l.minZoom,l.maxZoom)){const t=l.bounds;a.metricBoxWrite(t.center[0],t.center[1],t.width,t.height)}}}_placeOnSegment(t,s,i,e,n,r){const h=this._current.inShaping.glyphs,{out:o,inId:a}=this._current,c=this._current.inShaping,l=this._current.zoomLevel,u=t.dx/t.length,f=t.dy/t.length,m={x:t.x+i*-n*u,y:t.y+i*-n*f};for(const u of h){const h=u.x>c.bounds.x?r:1-r;if(!(h&&1===n||!h&&-1===n))continue;const f=Math.abs(u.x+u.width/2-c.bounds.x),d=Math.max(0,l+Math.log2(f/i)-.1),M=Math.max(e,l+Math.log2(f/(i+t.length+ei)));if(0!==d&&(u.angle=t.angle+(1-r)*Math.PI,u.minZoom=M,u.maxZoom=d,this._writeGlyph(o,a,m.x,m.y,u),r&&this._isVisible(u.minZoom,u.maxZoom))){const i=u.bounds,e=t.x-s.x,n=t.y-s.y;o.metricBoxWrite(i.center[0]+e,i.center[1]+n,i.width,i.height)}}}_writeGlyphs(t,s,i,e,n=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;if(e.glyphs.length>0&&(this._borderLineColor||this._backgroundColor)){const n=vt.load(this._materialKey);n.textureBinding=e.glyphs[0].textureBinding,t.recordStart(s,n.data,this.geometryType,!0),this._writeBackgroundGeometry(t,s,i,e.bounds,e.background),t.recordEnd()}const r=i.x+this._refOffsetX,h=i.y-this._refOffsetY;for(const i of e.glyphs)i.minZoom=n,i.maxZoom=this._maxZoom,this._writeGlyph(t,s,r,h,i);const o=this._refPlacementDirX,a=this._refPlacementDirY,c=e.boundsT;t.metricStart(s,n,r,h,o,a,this._referenceSize,this._materialKey),t.metricBoxWrite(c.center[0],c.center[1],c.width,c.height),t.metricEnd()}_writeVertexCommon(t,s,i,e){const n=this._color,r=this._haloColor,h=R(0,0,this._size,this._haloSize),o=Math.max(e.minZoom,this._minZoom),a=Math.min(e.maxZoom,this._maxZoom),c=R(ui(o),ui(a),this._outLineLabelAngle,0);t.vertexWrite(i),t.vertexWrite(s),t.vertexWrite(n),t.vertexWrite(r),t.vertexWrite(h),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(c)}_writeBackgroundVertex(t,s,i,e,n,r){const h=R(0,0,this._size,this._haloSize),o=R(0,0,0,0),a=R(ui(this._minBackgroundZoom),ui(this._maxBackgroundZoom),this._outLineLabelAngle,1);t.vertexWrite(i),t.vertexWrite(s),t.vertexWrite(e),t.vertexWrite(o),t.vertexWrite(h),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(a),t.vertexWrite(n),t.vertexWrite(r),t.vertexEnd()}}const di=3.14159265359/180,Mi=8,pi=r=>class extends r{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._allowBorrowing=!0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this.geometryType=G.MARKER}_write(t,s,i,e){const n=s.getDisplayId();t.recordStart(n,this._materialKey,this.geometryType,!0),this._writeGeometry(t,s,n,i,e),t.recordEnd()}_writeGeometry(t,s,i,e,n){if(null!=this._markerPlacement)return this._writePlacedMarkers(t,s,e,n);if(this._allowBorrowing=!0,!n&&"esriGeometryPoint"===s.geometryType){const e=s.getX(),n=s.getY();if(!t.hasAggregates&&t.hasPixelBufferEnabled&&(e<0||e>=513||n<0||n>=513))return;return this._writeVertices(t,i,this._getPos(e,n),e,n)}const r=n?n.asOptimized():"esriGeometryPolygon"===s.geometryType?s.readCentroid():s.readGeometryForDisplay();if(null!=r){if(r.isPoint){const[s,e]=r.coords;if(!t.hasAggregates&&t.hasPixelBufferEnabled&&(s<0||s>=512||e<0||e>=512))return;return this._writeVertices(t,i,this._getPos(s,e),s,e)}r.forEachVertex(((s,e)=>{const n=2*a;s<-n||s>=n||e<-n||e>=n||this._writeVertices(t,i,this._getPos(s,e),s,e)}))}}_writePlacedMarkers(t,i,e,n){const r=n||Vt.fromFeatureSetReaderCIM(i);if(!r)return;const h=-1,o=js.getPlacement(r,h,this._markerPlacement,K(1),t.tileKey,e.geometryEngine);if(!o)return;this._allowBorrowing="esriGeometryPolygon"!==i.geometryType;const a=i.getDisplayId(),c=Kt(),l=s(),u=-128,f=640;let m=o.next();for(;null!=m;){const s=m.tx,i=-m.ty;s>=u&&s<=f&&i>=u&&i<=f&&(this._applyTransformation(l,c,-m.getAngle()/di),this._writeVertices(t,a,this._getPos(s,i),s,i)),m=o.next()}}_writeVertices(t,s,i,e,n){const r=It.load(this._materialKey);return r.symbologyType===E.HEATMAP?this._writeHeatmapVertices(t,s,i):this._writeMarkerVertices(t,s,r,i,e,n)}_writeMarkerVertices(t,s,i,e,n,r){const h=i.vvRotation,o=t.vertexCount();let a=this._computedWidth*this._vertexBoundsScaleX,c=this._computedHeight*this._vertexBoundsScaleY;if(this.angle){const t=Math.max(a,c);a=t,c=t}if(h){const t=Math.max(this.xOffset,this.yOffset);a+=t,c+=t}this._allowBorrowing&&t.vertexBounds(n+this.xOffset,r-this.yOffset,a,c),t.vertexWrite(e),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(this._texUpperLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(s),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(e),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(this._texUpperRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(s),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(e),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(this._texBottomLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(s),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(e),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(this._texBottomRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(s),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),this._writeIndices(t,o)}_writeHeatmapVertices(t,s,i){const e=t.vertexCount();t.vertexWrite(i),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(s),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(s),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(s),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(s),t.vertexEnd(),this._writeIndices(t,e)}_writeIndices(t,s){t.indexWrite(s+0),t.indexWrite(s+1),t.indexWrite(s+2),t.indexWrite(s+1),t.indexWrite(s+3),t.indexWrite(s+2)}_applyTransformation(s,r,h=0){h?t(s,di*h):i(s),e(s,s,Dt(this.xOffset,-this.yOffset)),this.angle&&n(s,s,di*this.angle);const o=this._computedWidth,a=this._computedHeight,c=-(.5+this._anchorX)*o,l=-(.5-this._anchorY)*a;qt(r,c,l),Ht(r,r,s),this._offsetUpperLeft=N(16*r[0],16*r[1]),qt(r,c+o,l),Ht(r,r,s),this._offsetUpperRight=N(16*r[0],16*r[1]),qt(r,c,l+a),Ht(r,r,s),this._offsetBottomLeft=N(16*r[0],16*r[1]),qt(r,c+o,l+a),Ht(r,r,s),this._offsetBottomRight=N(16*r[0],16*r[1])}_computeSize(t,s,i,e,n,r,h,o){const a=t*i,c=s*i;if(!!r.sdf&&!h){const i=o&&t>s?a:t,n=s,r=e+2*1;t=Math.min(i+r,a),s=Math.min(n+r,c)}else t=a,s=c;const l=d/Math.max(a,c),u=.5*(a-t)*l,f=.5*(c-s)*l,M=r.rect.x+m+u,p=r.rect.y+m+f,w=M+r.width-2*u,y=p+r.height-2*f,g=Math.floor(M),b=Math.floor(p),_=Math.ceil(w),x=Math.ceil(y);t*=(_-g)/(w-M),s*=(x-b)/(y-p),this._texUpperLeft=N(g,b),this._texUpperRight=N(_,b),this._texBottomLeft=N(g,x),this._texBottomRight=N(_,x),this._anchorX*=a/t,this._anchorY*=c/s,t*=n,s*=n,this._computedWidth=t,this._computedHeight=s}_getPos(t,s){return N(Math.round(Mi*t),Math.round(Mi*s))}};class wi extends(pi(Zs)){constructor(t,i,e,n,r,h,o,a,c,l,f,m,d,b,_,x,S,v,P,k,I,z,L,T){super(),this.angle=n,this.height=o,this.width=h,this.xOffset=i*P,this.yOffset=e*P,this._markerPlacement=k||void 0,this._effects=I||void 0,this._anchorX=x,this._anchorY=S,this._minMaxZoom=N(Math.round(z*u),Math.round(L*u));const C=(b===Mt.MAP?M:p)|(f?w:0)|(d?y:0)|(m?g:0),F=_&&_.sdf,G=It.load(t);G.sdf=F,G.pattern=!0,G.textureBinding=_.textureBinding,this._materialKey=G.data,this._fillColor=r,this._outlineColor=c,this._sizeOutlineWidth=R(Math.round(Math.min(Math.sqrt(128*h),255)),Math.round(Math.min(Math.sqrt(128*o),255)),Math.round(Math.min(Math.sqrt(128*l),255)),Math.round(Math.min(Math.sqrt(128*a),255))),G.symbologyType===E.PIE_CHART?(h*=v*P,o*=v*P,this._computedWidth=h,this._computedHeight=o,this._texUpperLeft=N(0,1),this._texUpperRight=N(1,1),this._texBottomLeft=N(0,0),this._texBottomRight=N(1,0)):this._computeSize(h,o,v,l,P,_,G.hasSizeVV(),T);const A=Math.round(64*v);this._bitestAndDistRatio=N(C,A);const V=Kt(),j=s();this._applyTransformation(j,V)}static fromCIMMarker(t,s,i){const e=s&&s.width||1,n=s&&s.height||1,r=t.size,h=e/n*t.scaleX,o=t.scaleSymbolsProportionally&&t.frameHeight?r/t.frameHeight:1,a=j(t.color),c=j(t.outlineColor),l=K(r),u=l*h,f=K(t.offsetX||0),m=K(t.offsetY||0),d=K(t.outlineWidth||0)*o,M=t.alignment||Mt.SCREEN,p=K(t.referenceSize),[w,y]=Ls(t.scaleInfo,i);let g=t.rotation||0;t.rotateClockwise||(g=-g);let b=0,_=0;const x=t.anchorPoint;x&&(t.isAbsoluteAnchorPoint?r&&(b=x.x/(r*h),_=x.y/r):(b=x.x,_=x.y));const S=new wi(t.materialKey,f,m,g,a,u,l,p,c,d,t.colorLocked,t.scaleSymbolsProportionally,!1,M,s,b,_,t.sizeRatio,t.scaleFactor??1,t.markerPlacement,t.effects,w,y,!0);return S._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/u:1,S._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/l:1,S}static fromPictureMarker(t,s){const i=Math.round(K(t.width)),e=Math.round(K(t.height)),n=b,r=Math.round(K(t.xoffset||0)),h=Math.round(K(t.yoffset||0)),o=new wi(t.materialKey,r,h,t.angle,n,i,e,e,0,0,!1,!1,!1,Mt.SCREEN,s,0,0,1,1,null,null,xs,Ss,!1);return o._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.width:1,o._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.height:1,o}static fromSimpleMarker(t,s){const i=t.style,e=V(t.color),n=Math.round(K(t.size));let r=n;"esriSMSTriangle"===i&&(r*=s.height/s.width);const h=Math.round(K(t.xoffset||0)),o=Math.round(K(t.yoffset||0)),a=t.outline,c=0|(a?.color&&V(a.color)),l=0|(a?.width&&Math.round(K(a.width))),u=new wi(t.materialKey,h,o,t.angle??0,e,n,r,r,c,l,!1,!1,"esriSMSCross"===i||"esriSMSX"===i,Mt.SCREEN,s,0,0,2,1,null,null,xs,Ss,!1);return u.boundsType="esriSMSCircle"===i?"circle":"square",u._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.size:1,u._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.size:1,u}static fromLineSymbolMarker(t,s){const i=V(t.color),e=6,n=Math.round(K(e*t.lineWidth)),r=n,h="cross"===t.style||"x"===t.style;let o;switch(t.placement){case"begin-end":o=pt.Both;break;case"begin":o=pt.JustBegin;break;case"end":o=pt.JustEnd;break;default:o=pt.None}const a={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:o,offsetAlongLine:0},c=new wi(t.materialKey,0,0,0,i,n,r,r/e,i,h?Math.round(K(t.lineWidth)):0,!1,!1,h,Mt.MAP,s,0,0,2,1,a,null,xs,Ss,!1);return c.boundsType="circle"===t.style?"circle":"square",c}}function yi(t,s,i,e,n,r,h){Xi=0;const o=(e-i)*r,a=n&&n.length,c=a?(n[0]-i)*r:o;let l,u,f,m,d,M=gi(s,i,e,0,c,r,!0);if(M&&M.next!==M.prev){if(a&&(M=Ii(s,i,e,n,M,r)),o>80*r){l=f=s[0+i*r],u=m=s[1+i*r];for(let t=r;t<c;t+=r){const e=s[t+i*r],n=s[t+1+i*r];l=Math.min(l,e),u=Math.min(u,n),f=Math.max(f,e),m=Math.max(m,n)}d=Math.max(f-l,m-u),d=0!==d?1/d:0}_i(M,t,r,l,u,d,h,0)}}function gi(t,s,i,e,n,r,h){let o;if(h===Ri(t,s,i,e,n,r)>0)for(let i=e;i<n;i+=r)o=vi(i+s*r,t[i+s*r],t[i+1+s*r],o);else for(let i=n-r;i>=e;i-=r)o=vi(i+s*r,t[i+s*r],t[i+1+s*r],o);return o&&Ei(o,o.next)&&(Pi(o),o=o.next),o}function bi(t,s=t){if(!t)return t;let i,e=t;do{if(i=!1,e.steiner||!Ei(e,e.next)&&0!==Fi(e.prev,e,e.next))e=e.next;else{if(Pi(e),e=s=e.prev,e===e.next)break;i=!0}}while(i||e!==s);return s}function _i(t,s,i,e,n,r,h,o){if(!t)return;!o&&r&&(t=Ti(t,e,n,r));let a=t;for(;t.prev!==t.next;){const c=t.prev,l=t.next;if(r?Si(t,e,n,r):xi(t))s.push(c.index/i+h),s.push(t.index/i+h),s.push(l.index/i+h),Pi(t),t=l.next,a=l.next;else if((t=l)===a){o?1===o?_i(t=Wi(t,s,i,h),s,i,e,n,r,h,2):2===o&&Oi(t,s,i,e,n,r,h):_i(bi(t),s,i,e,n,r,h,1);break}}}function xi(t){const s=t.prev,i=t,e=t.next;if(Fi(s,i,e)>=0)return!1;let n=t.next.next;const r=n;let h=0;for(;n!==t.prev&&(0===h||n!==r);){if(h++,Ni(s.x,s.y,i.x,i.y,e.x,e.y,n.x,n.y)&&Fi(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function Si(t,s,i,e){const n=t.prev,r=t,h=t.next;if(Fi(n,r,h)>=0)return!1;const o=n.x<r.x?n.x<h.x?n.x:h.x:r.x<h.x?r.x:h.x,a=n.y<r.y?n.y<h.y?n.y:h.y:r.y<h.y?r.y:h.y,c=n.x>r.x?n.x>h.x?n.x:h.x:r.x>h.x?r.x:h.x,l=n.y>r.y?n.y>h.y?n.y:h.y:r.y>h.y?r.y:h.y,u=ji(o,a,s,i,e),f=ji(c,l,s,i,e);let m=t.prevZ,d=t.nextZ;for(;m&&m.z>=u&&d&&d.z<=f;){if(m!==t.prev&&m!==t.next&&Ni(n.x,n.y,r.x,r.y,h.x,h.y,m.x,m.y)&&Fi(m.prev,m,m.next)>=0)return!1;if(m=m.prevZ,d!==t.prev&&d!==t.next&&Ni(n.x,n.y,r.x,r.y,h.x,h.y,d.x,d.y)&&Fi(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(;m&&m.z>=u;){if(m!==t.prev&&m!==t.next&&Ni(n.x,n.y,r.x,r.y,h.x,h.y,m.x,m.y)&&Fi(m.prev,m,m.next)>=0)return!1;m=m.prevZ}for(;d&&d.z<=f;){if(d!==t.prev&&d!==t.next&&Ni(n.x,n.y,r.x,r.y,h.x,h.y,d.x,d.y)&&Fi(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function vi(t,s,i,e){const n=Hi.create(t,s,i);return e?(n.next=e.next,n.prev=e,e.next.prev=n,e.next=n):(n.prev=n,n.next=n),n}function Pi(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ki(t){let s=t,i=t;do{(s.x<i.x||s.x===i.x&&s.y<i.y)&&(i=s),s=s.next}while(s!==t);return i}function Ii(t,s,i,e,n,r){const h=new Array;for(let n=0,o=e.length;n<o;n++){const a=gi(t,s,i,e[n]*r,n<o-1?e[n+1]*r:i*r,r,!1);a===a.next&&(a.steiner=!0),h.push(ki(a))}h.sort(Bi);for(const t of h)n=zi(t,n);return n}function zi(t,s){const i=Li(t,s);if(!i)return s;const e=qi(i,t);return bi(e,e.next),bi(i,i.next)}function Li(t,s){let i=s;const e=t.x,n=t.y;let r,h=-1/0;do{if(n<=i.y&&n>=i.next.y&&i.next.y!==i.y){const t=i.x+(n-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(t<=e&&t>h){if(h=t,t===e){if(n===i.y)return i;if(n===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==s);if(!r)return null;if(e===h)return r.prev;const o=r,a=r.x,c=r.y;let l,u=1/0;for(i=r.next;i!==o;)e>=i.x&&i.x>=a&&e!==i.x&&Ni(n<c?e:h,n,a,c,n<c?h:e,n,i.x,i.y)&&(l=Math.abs(n-i.y)/(e-i.x),(l<u||l===u&&i.x>r.x)&&Vi(i,t)&&(r=i,u=l)),i=i.next;return r}function Ti(t,s,i,e){let n;for(;n!==t;n=n.next){if(n=n||t,null===n.z&&(n.z=ji(n.x,n.y,s,i,e)),n.prev.next!==n||n.next.prev!==n)return n.prev.next=n,n.next.prev=n,Ti(t,s,i,e);n.prevZ=n.prev,n.nextZ=n.next}return t.prevZ.nextZ=null,t.prevZ=null,Ci(t)}function Ci(t){let s,i=1;for(;;){let e,n=t;t=null,s=null;let r=0;for(;n;){r++,e=n;let h=0;for(;h<i&&e;h++)e=e.nextZ;let o=i;for(;h>0||o>0&&e;){let i;0===h?(i=e,e=e.nextZ,o--):0!==o&&e?n.z<=e.z?(i=n,n=n.nextZ,h--):(i=e,e=e.nextZ,o--):(i=n,n=n.nextZ,h--),s?s.nextZ=i:t=i,i.prevZ=s,s=i}n=e}if(s.nextZ=null,i*=2,r<2)return t}}function Fi(t,s,i){return(s.y-t.y)*(i.x-s.x)-(s.x-t.x)*(i.y-s.y)}function Gi(t,s,i,e){return!!(Ei(t,s)&&Ei(i,e)||Ei(t,e)&&Ei(i,s))||Fi(t,s,i)>0!=Fi(t,s,e)>0&&Fi(i,e,t)>0!=Fi(i,e,s)>0}function Ai(t,s){let i=t;do{if(i.index!==t.index&&i.next.index!==t.index&&i.index!==s.index&&i.next.index!==s.index&&Gi(i,i.next,t,s))return!0;i=i.next}while(i!==t);return!1}function Ri(t,s,i,e,n,r){let h=0;for(let i=e,o=n-r;i<n;i+=r)h+=(t[o+s*r]-t[i+s*r])*(t[i+1+s*r]+t[o+1+s*r]),o=i;return h}function Ni(t,s,i,e,n,r,h,o){return(n-h)*(s-o)-(t-h)*(r-o)>=0&&(t-h)*(e-o)-(i-h)*(s-o)>=0&&(i-h)*(r-o)-(n-h)*(e-o)>=0}function Vi(t,s){return Fi(t.prev,t,t.next)<0?Fi(t,s,t.next)>=0&&Fi(t,t.prev,s)>=0:Fi(t,s,t.prev)<0||Fi(t,t.next,s)<0}function ji(t,s,i,e,n){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*n)|t<<8))|t<<4))|t<<2))|t<<1))|(s=1431655765&((s=858993459&((s=252645135&((s=16711935&((s=32767*(s-e)*n)|s<<8))|s<<4))|s<<2))|s<<1))<<1}function Ei(t,s){return t.x===s.x&&t.y===s.y}function Bi(t,s){return t.x-s.x}function Wi(t,s,i,e){let n=t;do{const r=n.prev,h=n.next.next;!Ei(r,h)&&Gi(r,n,n.next,h)&&Vi(r,h)&&Vi(h,r)&&(s.push(r.index/i+e),s.push(n.index/i+e),s.push(h.index/i+e),Pi(n),Pi(n.next),n=t=h),n=n.next}while(n!==t);return n}function Oi(t,s,i,e,n,r,h){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.index!==t.index&&Di(o,t)){let a=qi(o,t);return o=bi(o,o.next),a=bi(a,a.next),_i(o,s,i,e,n,r,h,0),void _i(a,s,i,e,n,r,h,0)}t=t.next}o=o.next}while(o!==t)}function Di(t,s){return t.next.index!==s.index&&t.prev.index!==s.index&&!Ai(t,s)&&Vi(t,s)&&Vi(s,t)&&Ki(t,s)}function Ki(t,s){let i=t,e=!1;const n=(t.x+s.x)/2,r=(t.y+s.y)/2;do{i.y>r!=i.next.y>r&&i.next.y!==i.y&&n<(i.next.x-i.x)*(r-i.y)/(i.next.y-i.y)+i.x&&(e=!e),i=i.next}while(i!==t);return e}function qi(t,s){const i=Hi.create(t.index,t.x,t.y),e=Hi.create(s.index,s.x,s.y),n=t.next,r=s.prev;return t.next=s,s.prev=t,i.next=n,n.prev=i,e.next=i,i.prev=e,r.next=e,e.prev=r,e}class Hi{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,s,i){const e=Xi<Ui.length?Ui[Xi++]:new Hi;return e.index=t,e.x=s,e.y=i,e.prev=null,e.next=null,e.z=null,e.prevZ=null,e.nextZ=null,e.steiner=!1,e}}const Ui=new Array,$i=8096;let Xi=0;for(let t=0;t<$i;t++)Ui.push(new Hi);const Ji=1e-5,Zi=new Xt(0,0,0,1,0),Qi=new Xt(0,0,0,1,0);function Yi(t,s,i){let e=0;for(let n=1;n<i;n++){const i=t[2*(s+n-1)],r=t[2*(s+n-1)+1];e+=(t[2*(s+n)]-i)*(t[2*(s+n)+1]+r)}return e}function te(t,s,i,e,n){let r=0;const h=2;for(let o=i;o<e;o+=3){const i=(t[o]-n)*h,e=(t[o+1]-n)*h,a=(t[o+2]-n)*h;r+=Math.abs((s[i]-s[a])*(s[e+1]-s[i+1])-(s[i]-s[e])*(s[a+1]-s[i+1]))}return r}function se(t,s){const{coords:i,lengths:e,hasIndeterminateRingOrder:n}=s,r=0,h=t;if(n)return!1;let o=0;for(let t=0;t<e.length;){let s=t,n=e[t],a=Yi(i,o,n);const c=[];for(;++s<e.length;){const t=e[s],r=Yi(i,o+n,t);if(!(r>0))break;a+=r,c.push(o+n),n+=t}const l=h.length;yi(h,i,o,o+n,c,2,r);const u=te(h,i,l,h.length,r),f=Math.abs(a);if(Math.abs((u-f)/Math.max(1e-7,f))>Ji)return h.length=0,!1;t=s,o+=n}return!0}function ie(t){const{coords:s,lengths:i}=t,{buffer:e}=ft(s,i);return e}function ee(t,s,i){let e=0;for(let n=0;n<t.lengths.length;n++){const r=t.lengths[n];for(let n=0;n<r;n++){const r=t.coords[2*(n+e)],h=t.coords[2*(n+e)+1];if(r<s||r>i||h<s||h>i)return!0}e+=r}return!1}function ne(t,s){if(null==t)return null;if(!ee(t,-128,a+128))return t;Zi.setPixelMargin(s),Zi.reset(Jt.Polygon);let i=0;for(let s=0;s<t.lengths.length;s++){const e=t.lengths[s];let n=t.coords[2*(0+i)],r=t.coords[2*(0+i)+1];Zi.moveTo(n,r);for(let s=1;s<e;s++)n=t.coords[2*(s+i)],r=t.coords[2*(s+i)+1],Zi.lineTo(n,r);Zi.close(),i+=e}const e=Zi.result(!1);if(!e)return null;const n=[],r=[];for(const t of e){let s=0;for(const i of t)r.push(i.x),r.push(i.y),s++;n.push(s)}return new Zt(n,r)}function re(t,s){Qi.setPixelMargin(s);const i=Qi,e=-s,n=a+s;let r=[],h=!1;if(!t.nextPath())return null;let o=!0;for(;o;){t.seekPathStart();const s=[];if(!t.numPoints)return null;i.reset(Jt.LineString),t.nextPoint();let a=t.x,c=t.y;if(h)i.moveTo(a,c);else{if(a<e||a>n||c<e||c>n){h=!0;continue}s.push({x:a,y:c})}let l=!1;for(;t.nextPoint();)if(a=t.x,c=t.y,h)i.lineTo(a,c);else{if(a<e||a>n||c<e||c>n){l=!0;break}s.push({x:a,y:c})}if(l)h=!0;else{if(h){const t=i.resultWithStarts();if(t)for(const s of t)r.push(s)}else r.push({line:s,start:0});o=t.nextPath(),h=!1}}return r=r.filter((t=>t.line.length>1)),0===r.length?null:r}Zi.setExtent(a),Qi.setExtent(a);const he=8,oe=16,ae=65535,ce=t=>class extends t{constructor(...t){super(...t),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=G.LINE}writeGeometry(t,s,i,e){this._writeGeometry(t,s,i,e)}_initializeTessellator(t){const s=zt.load(this._materialKey),i=Lt.load(this._materialKey),e=this._tessellationOptions,n=s.vvSizeFieldStops||s.vvSizeMinMaxValue||s.vvSizeScaleStops||s.vvSizeUnitValue,r=this.tessellationProperties._halfWidth<_&&!t&&!n;this.tessellationProperties.minMaxZoom=this._minMaxZoom,e.wrapDistance=ae,e.textured=this._isDashed||this._hasPattern,e.offset=this.tessellationProperties.offset,e.halfWidth=this.tessellationProperties._halfWidth;const h=r?0:1,o=Tt(i)?ue:le;this._lineTessellator=new mt(o(this.tessellationProperties,h,h),fe(this.tessellationProperties),r)}_write(t,s,i,e){const n="esriGeometryPoint"===s.geometryType;t.recordStart(s.getDisplayId(),this._materialKey,this.geometryType,n),this._writeGeometry(t,s,e,n),t.recordEnd()}_writeGeometry(t,s,i,e){const n=i||Vt.fromFeatureSetReaderCIM(s);if(!n)return;const r=this._getLines(n,e);null!=r&&this._writeVertices(t,s,r)}_getLines(t,s){return re(t,s?256:16)}_writeVertices(t,s,i){const e=s.getDisplayId(),n=t.vertexCount(),r=this.tessellationProperties,h=this._tessellationOptions;r.out=t,r.id=e,r.indexCount=0,r.vertexCount=0,r.offset=n,h.capType=this._capType,h.joinType=this._joinType;const o=Lt.load(this._materialKey);this.tessellationProperties.key=Tt(o)?o:zt.load(this._materialKey);for(const{line:t,start:s}of i)h.initialDistance=s%ae,this._lineTessellator.tessellate(t,h)}},le=(t,s,i)=>(e,n,r,h,o,a,c,l,u,f,m)=>{const d=N(m,Math.ceil(oe*t._halfWidth)),M=R(Math.round(oe*c),Math.round(oe*l),Math.round(oe*u),Math.round(oe*f)),p=R(oe*o,oe*a,0,t._bitset),w=t.out;return w.vertexBounds(e,n,s,i),w.vertexWrite(N(he*e,he*n)),w.vertexWrite(t.id),w.vertexWrite(t._fillColor),w.vertexWrite(M),w.vertexWrite(d),w.vertexWrite(t._tl),w.vertexWrite(t._br),w.vertexWrite(p),w.vertexWrite(N(Math.ceil(oe*t._halfReferenceWidth),0)),w.vertexWrite(t.minMaxZoom),w.vertexEnd(),t.offset+t.vertexCount++},ue=(t,s,i)=>(e,n,r,h,o,a,c,l,u,f,m)=>{const d=N(oe*t._halfWidth,oe*t._halfReferenceWidth),M=R(oe*c+128,oe*l+128,oe*u+128,oe*f+128),p=t.out,w=t._bitset<<24|t.id;p.vertexBounds(e,n,s,i),p.vertexWrite(N(he*e,he*n)),p.vertexWrite(w),p.vertexWrite(t._fillColor);const y=Ct(t.key);return y||(p.vertexWrite(0),p.vertexWrite(0)),p.vertexWrite(0),p.vertexWrite(d),p.vertexWrite(M),y||p.vertexWrite(t.minMaxZoom),p.vertexEnd(),t.offset+t.vertexCount++},fe=t=>(s,i,e)=>{const n=t.out;n.indexWrite(s),n.indexWrite(i),n.indexWrite(e),t.indexCount+=3};class me extends(ce(Zs)){constructor(t,s,i,e,n,r,h,o,a,c,l,f,m,d,M,p,y,g,b,_){super();const P=zt.load(t);s&&(P.sdf=s.sdf,P.pattern=!0,P.textureBinding=s.textureBinding),this._capType=e,this._joinType=n,this._miterLimitCosine=zs(r),this.tessellationProperties._fillColor=h,this.tessellationProperties._tl=o,this.tessellationProperties._br=a,this._hasPattern=c,this._isDashed=l,this._zOrder=y,this._effects=g||null,this._minMaxZoom=N(Math.round(b*u),Math.round(_*u)),this._materialKey=P.data;const k=(m?w:0)|(d?x:0)|(f?S:0)|(M?v:0);this.tessellationProperties._bitset=k,this.tessellationProperties._halfWidth=.5*i,this.tessellationProperties._halfReferenceWidth=.5*p,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(t,s,i){const e=t.color,n=t.scaleFactor||1,r=!!t.dashTemplate;let h=t.cap;r&&h===wt.ROUND&&(h=wt.SQUARE);const o=t.join,a=K(t.width)*n,c=K(t.referenceWidth),l=K(t.miterLimit),u=e&&j(e)||0,[f,d]=Ls(t.scaleInfo,i),M=!1;if(!s)return new me(t.materialKey,s,a,h,o,l,u,0,0,!1,r,t.scaleDash??!1,t.colorLocked??!1,M,t.sampleAlphaOnly,c,t.zOrder,t.effects,f,d);const{rect:p,width:w,height:y}=s,g=p.x+m,b=p.y+m,_=g+w,x=b+y,S=N(g,b),v=N(_,x),P=!1;return new me(t.materialKey,s,a,h,o,l,u,S,v,!0,r,t.scaleDash??!1,t.colorLocked??!1,P,t.sampleAlphaOnly,c,t.zOrder,t.effects,f,d)}static fromFillOutline(t){const s=Lt.load(t.materialKey);return Tt(s)&&t.outline&&"esriSLSSolid"===t.outline?.style?me.fromSimpleLine({hash:"",materialKey:t.materialKey,...t.outline},null,!0):null}static fromSimpleLine(t,s,i=!1){const{color:e}=t,n="esriSLSSolid"!==t.style&&"esriSLSNull"!==t.style,r=B(t.cap||"round"),h=W(t.join||"round");let o=e&&"esriSLSNull"!==t.style&&V(e)||0;"esriSLSNull"===t.style&&(o=0);const a=K(t.width),c=t.miterLimit;if(!s)return new me(t.materialKey,s,a,r,h,c,o,0,0,!1,n,!0,!1,i,!1,a,0,null,xs,Ss);const{rect:l,width:u,height:f}=s,d=l.x+m,M=l.y+m,p=d+u,w=M+f,y=N(d,M),g=N(p,w);return new me(t.materialKey,s,a,r,h,c,o,y,g,!0,n,!0,!1,i,!1,a,0,null,xs,Ss)}static fromPictureLineSymbol(t,s,i,e){return H.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate").error("PictureLineSymbol support does not exist!"),null}}const de=100,Me=1,pe=t=>class extends t{constructor(...t){super(...t),this.forceLibtess=!1,this._bitset=0,this._lineTemplate=null,this.geometryType=G.FILL}_maybeAddLineTemplate(t){this._lineTemplate=me.fromFillOutline(t)}_write(t,s,i,e){const n="esriGeometryPoint"===s.geometryType,r=Lt.load(this._materialKey);t.recordStart(s.getDisplayId(),this._materialKey,this.geometryType,n),this._writeGeometry(t,s,r,e,n),Tt(r)&&null!=this._lineTemplate&&this._lineTemplate.writeGeometry(t,s,e,n),t.recordEnd()}_writeGeometry(t,s,i,e,n){const r=this._getGeometry(s,e,n);if(null==r)return;const h=[];if(!(r.maxLength>de)&&!this.forceLibtess&&se(h,r))return void(h.length&&this._writeVertices(t,s,r.coords,r.lengths,i,h));const o=ie(r);this._writeVertices(t,s,o,[o.length/2],i)}_writeVertex(t,s,i,e,n,r){const h=N(Me*e,Me*n);if(t.vertexBounds(e,n,0,0),t.vertexWrite(h),t.vertexWrite(s),i.symbologyType===E.DOT_DENSITY)t.vertexWriteF32(1/Math.abs(r.readGeometryArea()));else{t.vertexWrite(this.fillColor);const s=Ct(i);s||(t.vertexWrite(this.tl),t.vertexWrite(this.br)),t.vertexWrite(this.aux21),t.vertexWrite(this.aux22),t.vertexWrite(this.aux3),s||t.vertexWrite(this._minMaxZoom)}}_writeVertices(t,s,i,e,n,r){const h=s.getDisplayId(),o=this._bitset<<24|h,a=e.reduce(((t,s)=>t+s)),c=A(n.geometryType,n.symbologyType).geometry/4,l=t.vertexCount();t.vertexEnsureSize(c*a);let u=0;if(r)for(const e of r){const r=i[2*e],h=i[2*e+1];this._writeVertex(t,o,n,r,h,s),u++}else for(let e=0;e<i.length;e+=2){const r=Math.round(i[e]),h=Math.round(i[e+1]);this._writeVertex(t,o,n,r,h,s),u++}t.indexEnsureSize(u);for(let s=0;s<u;s++)t.indexWrite(s+l)}_getGeometry(t,s,i){const e=s?.asOptimized()||t.readGeometryForDisplay();if(!e)return null;return ne(e,i?256:8)}};const we=H.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class ye extends Zs{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}async analyze(t,s,i,e,n){if(n&&0===n.length)return null;const r=n&&n.length>0,h=s.readLegacyFeature(),o=s.getObjectId(),a=this._materialCache,c=this._cimLayer.materialHash;if(!c)return we.error("A Dynamic mesh template must have a material hash value or function!"),null;const l="function"==typeof c?c(h,i,e,o):c,u=a.get(l);if(null!=u)return u;const f=this._ongoingMaterialRequestMap.get(l);if(f)return f;const m=this._cimLayer,d=Bt(m.cim,this._cimLayer.materialOverrides);d.mosaicHash=l;const{type:M,url:p}=m,w={cim:d,type:M,mosaicHash:l,url:p,size:null,dashTemplate:null,text:null,fontName:null,objectId:o,animatedSymbolProperties:null};switch(M){case"marker":w.size=Ut(m.size,h,i,e),w.animatedSymbolProperties=Ut(m.animatedSymbolProperties,h,i,e);break;case"line":w.dashTemplate=m.dashTemplate;break;case"text":w.text=Ut(m.text,h,i,e),w.fontName=Ut(m.fontName,h,i,e)}const y=t.getMosaicItem(w,n).then((t=>(r||(this._ongoingMaterialRequestMap.delete(l),a.set(l,t)),t))).catch((t=>(this._ongoingMaterialRequestMap.delete(l),we.error(".analyze()",t.message),null)));return r||this._ongoingMaterialRequestMap.set(l,y),y}}class ge extends(pe(ye)){constructor(t,s,i){if(super(t),this._minMaxZoom=N(Math.round(s*u),Math.round(i*u)),$t(t.color)){const s=(s,i,e)=>{const n=t.color(s,i,e);return n&&j(n)||0};this._dynamicPropertyMap.set("fillColor",s)}else{const s=t.color;this.fillColor=s&&j(s)||0}const e="CIMMarkerPlacementInsidePolygon"===t.cim.placement?.type&&t.cim.placement.shiftOddRows?2:1,n=t.height;if($t(n)){const t=(t,s,i)=>n(t,s,i)*e;this._dynamicPropertyMap.set("_height",t)}else this._height=(n||0)*e;const r=t.offsetX;if($t(r)){const t=(t,s,i)=>K(r(t,s,i));this._dynamicPropertyMap.set("_offsetX",t)}else this._offsetX=K(r||0);const h=t.offsetY;if($t(h)){const t=(t,s,i)=>K(-h(t,s,i));this._dynamicPropertyMap.set("_offsetY",t)}else this._offsetY=K(-h||0);const o=t.scaleX;$t(o)?this._dynamicPropertyMap.set("_scaleX",o):this._scaleX=o||1;const a=t.angle;if($t(a)){const t=(t,s,i)=>Ft(a(t,s,i));this._dynamicPropertyMap.set("_angle",t)}else this._angle=Ft(a)||0;if(null!=t.effects){const s=t.effects;$t(s)?this._dynamicPropertyMap.set("_effects",s):this._effects=s}this._cimFillLayer=t,this._bitset=(t.colorLocked?w:0)|(t.applyRandomOffset?P:0)|(t.sampleAlphaOnly?v:0)|(t.hasUnresolvedReplacementColor?k:0),this._fillMaterialKey=t.materialKey}static fromCIMFill(t,s){const[i,e]=Ls(t.scaleInfo,s);return new ge(t,i,e)}bindFeature(t,s,i){const e=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,n)=>{this[n]=t(e,s,i)}));const n=Lt.load(this._fillMaterialKey),r=this._materialCache,h=(0,this._cimFillLayer.materialHash)(e,s,i),o=r.get(h);let a=null;if(o&&ss(o.spriteMosaicItem)&&(a=o.spriteMosaicItem),a){const{rect:t,width:s,height:i}=a,e=t.x+m,r=t.y+m,h=e+s,o=r+i;let c=K(this._height);c<=0&&(c=o-r),c<I&&(c*=z,this._bitset|=L),c=Math.round(c);let l=K(this._height/i*s);l<=0&&(l=h-e),l<I&&(l*=z,this._bitset|=T),l=Math.round(l);const u=this._scaleX,f=1;this.tl=N(e,r),this.br=N(h,o),this.aux21=N(l,c),this.aux22=N(this._offsetX,this._offsetY),this.aux3=R(u*z,f*z,this._angle,0),n.sdf=a.sdf,n.pattern=!0,n.textureBinding=a.textureBinding}else this.tl=0,this.br=0,this.aux21=0,this.aux22=0,this.aux3=0,n.sdf=!1,n.pattern=!1,n.textureBinding=0;this._materialKey=n.data}}class be extends(ce(ye)){constructor(t,s,i){super(t),this._minMaxZoom=N(Math.round(s*u),Math.round(i*u)),this._cimLineLayer=t;let e=0;$t(t.width)||(e=.5*K(t.width));const n=(s,i,n)=>$t(t.width)?.5*K(t.width(s,i,n)):e;this._dynamicPropertyMap.set("_halfWidth",n),$t(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,$t(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join;const r=t.color;if($t(r)){const t=(t,s,i)=>j(r(t,s,i));this._dynamicPropertyMap.set("_fillColor",t)}else this._fillColor=r&&j(r)||0;const h=t.miterLimit;if($t(h)){const t=(t,s,i)=>zs(h(t,s,i));this._dynamicPropertyMap.set("_miterLimitCosine",t)}else this._miterLimitCosine=zs(h);if(null!=t.effects){const s=t.effects;$t(s)?this._dynamicPropertyMap.set("_effects",s):this._effects=s}this._scaleFactor=t.scaleFactor||1,this._isDashed=null!=t.dashTemplate;const o=t.colorLocked?w:0,a=t.scaleDash?S:0,c=t.sampleAlphaOnly?v:0;this.tessellationProperties._bitset=o|a|c,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t,s){const[i,e]=Ls(t.scaleInfo,s);return new be(t,i,e)}bindFeature(t,s,i){const e=t.readLegacyFeature();this._dynamicPropertyMap.forEach(((t,n)=>{this[n]=t(e,s,i)})),this._halfWidth*=this._scaleFactor;const n=this._materialCache,r=(0,this._cimLineLayer.materialHash)(e,s,i),h=n.get(r);let o=null;if(h&&ss(h.spriteMosaicItem)&&(o=h.spriteMosaicItem),o){this._hasPattern=!0;const{rect:t,width:s,height:i}=o,e=t.x+m,n=t.y+m,r=e+s,h=n+i;this.tessellationProperties._tl=N(e,n),this.tessellationProperties._br=N(r,h)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const a=zt.load(this._materialKey);o&&(a.sdf=o.sdf,a.pattern=!0,a.textureBinding=o.textureBinding),this._materialKey=a.data}}const _e=Kt(),xe=s();class Se extends(pi(ye)){constructor(t,s,i){super(t),this._cimMarkerLayer=t,this._minMaxZoom=N(Math.round(s*u),Math.round(i*u));const e=t.color;if($t(e)){const t=(t,s,i)=>j(e(t,s,i));this._dynamicPropertyMap.set("_fillColor",t)}else this._fillColor=j(e);const n=t.outlineColor;if($t(n)){const t=(t,s,i)=>j(n(t,s,i));this._dynamicPropertyMap.set("_outlineColor",t)}else this._outlineColor=j(n);const r=t.size;if($t(r)){const t=(t,s,i)=>K(r(t,s,i));this._dynamicPropertyMap.set("_size",t)}else this._size=K(r)||0;const h=t.scaleX;$t(h)?this._dynamicPropertyMap.set("_scaleX",h):this._scaleX=h;const o=t.offsetX;if($t(o)){const t=(t,s,i)=>K(o(t,s,i));this._dynamicPropertyMap.set("xOffset",t)}else this.xOffset=K(o)||0;const a=t.offsetY;if($t(a)){const t=(t,s,i)=>K(a(t,s,i));this._dynamicPropertyMap.set("yOffset",t)}else this.yOffset=K(a)||0;const c=t.outlineWidth;if($t(c)){const t=(t,s,i)=>K(c(t,s,i));this._dynamicPropertyMap.set("_outlineWidth",t)}else this._outlineWidth=K(c)||0;const l=t.rotation;if($t(l)?this._dynamicPropertyMap.set("_angle",l):this._angle=l||0,null!=t.effects){const s=t.effects;$t(s)?this._dynamicPropertyMap.set("_effects",s):this._effects=s}if(null!=t.markerPlacement){const s=t.markerPlacement;$t(s)?this._dynamicPropertyMap.set("_markerPlacement",s):this._markerPlacement=s}this._scaleFactor=t.scaleFactor??1,this._bitSet=(t.alignment===Mt.MAP?M:p)|(t.colorLocked?w:0)|(t.scaleSymbolsProportionally?g:0),this._materialKey=t.materialKey}static fromCIMMarker(t,s){const[i,e]=Ls(t.scaleInfo,s);return new Se(t,i,e)}bindFeature(t,s,i){const e=t.readLegacyFeature(),n=t.getObjectId();this._dynamicPropertyMap.forEach(((t,n)=>{this[n]=t(e,s,i)}));const r=this._cimMarkerLayer.materialHash,h="function"==typeof r?r(e,s,i,n):r,o=this._materialCache.get(h);if(!o||!ss(o.spriteMosaicItem)||!o.spriteMosaicItem)return void H.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate").error(new D("mapview-cim","Encountered an error when binding feature"));const a=o.spriteMosaicItem,c=this._cimMarkerLayer.sizeRatio,l=a.width/a.height*this._scaleX,u=It.load(this._materialKey);u.sdf=a.sdf,u.pattern=!0,u.textureBinding=a.textureBinding,this._materialKey=u.data;const f=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,m=this._size,d=m*l,M=this.xOffset,p=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const w=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/K(this._cimMarkerLayer.frameHeight):1,y=this._outlineWidth*w,g=K(this._cimMarkerLayer.referenceSize);let b=0,_=0;const x=this._cimMarkerLayer.anchorPoint;x&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(b=K(x.x)/(this._size*l),_=K(x.y)/this._size):(b=x.x,_=x.y)),this._anchorX=b,this._anchorY=_,this._sizeOutlineWidth=R(Math.round(Math.min(Math.sqrt(128*d),255)),Math.round(Math.min(Math.sqrt(128*m),255)),Math.round(Math.min(Math.sqrt(128*y),255)),Math.round(Math.min(Math.sqrt(128*g),255))),this.angle=f;const S=Math.round(64*c);this._bitestAndDistRatio=N(this._bitSet,S),this._computeSize(d,m,c,y,this._scaleFactor,a,u.hasSizeVV(),!0),this._applyTransformation(xe,_e),this.xOffset=M,this.yOffset=p}}function ve(t){if(null==t)return[];const s=new Array(t.length);for(let i=0;i<t.length;i++)s[i]=t.charCodeAt(i);return s}const Pe=5;function ke(t,s,i,e){return"string"==typeof t.text?t.text:"function"==typeof t.text?t.text(s,i,e)??"":""}class Ie extends(Js(ye)){constructor(t,s,i){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=N(Math.round(s*u),Math.round(i*u));const e=t.scaleFactor||1;this._cimTextLayer=t;const n=t.color;if($t(n)){const t=(t,s,i)=>j(n(t,s,i));this._dynamicPropertyMap.set("_color",t)}else this._color=j(n);const r=t.outlineColor;if($t(r)){const t=(t,s,i)=>j(r(t,s,i));this._dynamicPropertyMap.set("_haloColor",t)}else this._haloColor=j(r);let h;$t(t.size)||(h=Math.min(Math.round(K(t.size*t.sizeRatio)),127));const o=(s,i,e)=>$t(t.size)?Math.min(Math.round(K(t.size(s,i,e)*t.sizeRatio)),127):h;if(this._dynamicPropertyMap.set("_size",o),$t(t.outlineSize)){const s=(s,i,e)=>Math.min(Math.floor(Pe*K(t.outlineSize(s,i,e)*t.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",s)}else this._haloSize=Math.min(Math.floor(Pe*K(t.outlineSize*t.sizeRatio)),127);let a;$t(t.offsetX)||(a=Math.round(K(t.offsetX*t.sizeRatio)));const c=(s,i,e)=>$t(t.offsetX)?Math.round(K(t.offsetX(s,i,e)*t.sizeRatio)):a;let l;this._dynamicPropertyMap.set("_xOffset",c),$t(t.offsetY)||(l=Math.round(K(t.offsetY*t.sizeRatio)));const f=(s,i,e)=>$t(t.offsetY)?Math.round(K(t.offsetY(s,i,e)*t.sizeRatio)):l;if(this._dynamicPropertyMap.set("_yOffset",f),$t(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,$t(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,$t(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,null!=t.effects){const s=t.effects;$t(s)?this._dynamicPropertyMap.set("_effects",s):this._effects=s}if(null!=t.markerPlacement){const s=t.markerPlacement;$t(s)?this._dynamicPropertyMap.set("_markerPlacement",s):this._textPlacement=s}$t(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text,this._backgroundColor=t.backgroundColor&&j(t.backgroundColor),this._borderLineColor=t.borderLineColor&&j(t.borderLineColor),this._borderLineSize=t.borderLineWidth,this._scaleFactor=e;const m=Math.min(Math.round(K(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*m)),this._materialKey=t.materialKey;const d=Gt.load(this._materialKey);d.sdf=!0,this._bitset=(t.alignment===Mt.MAP?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=d.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._isCIM=!0}static fromCIMText(t,s){const[i,e]=Ls(t.scaleInfo,s);return new Ie(t,i,e)}async analyze(t,s,i,e){const n=s.readLegacyFeature(),r=ke(this._cimTextLayer,n,i,e),h=await super.analyze(t,s,i,e,ve(r));return h&&h.glyphMosaicItems&&this._textToGlyphs.set(r,h.glyphMosaicItems),h}bindFeature(t,s,i){const e=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach(((t,n)=>{this[n]=t(e,s,i)})),!this._text||0===this._text.length)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/l,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=bt(this._horizontalAlignment??"center"),this._yAlignD=_t(this._verticalAlignment??"baseline");const n=this._textToGlyphs.get(this._text)??[];this.bindTextInfo(n,!1)}}class ze extends(pe(Zs)){constructor(t,s,i,e,n,r,h,o,a,c,l,f,m,d,M,p){super(),this._effects=d||void 0;const w=Lt.load(t);s&&(w.sdf=s.sdf,w.pattern=!0,w.textureBinding=s.textureBinding),this.fillColor=i,this.tl=e,this.br=n,this.aux21=N(r,h),this.aux22=N(o,a),this.aux3=R(c,l,f,0),this._bitset=m,this._minMaxZoom=N(Math.round(M*u),Math.round(p*u)),this._materialKey=w.data}static fromCIMFill(t,s,i){const e=t.color,n=e&&j(e)||0,r=t.materialKey,[h,o]=Ls(t.scaleInfo,i);let a=(t.colorLocked?w:0)|(t.applyRandomOffset?P:0)|(t.sampleAlphaOnly?v:0)|(t.hasUnresolvedReplacementColor?k:0);if(!s)return new ze(r,null,n,0,0,0,0,0,0,0,0,0,a,t.effects,h,o);const{rect:c,width:l,height:u}=s,f=t.scaleX||1,d=c.x+m,M=c.y+m,p=d+l,y=M+u,g=K(t.height);let b=f*g;"CIMHatchFill"===t.cim.type&&(b*=l/u);let _=g;_<=0&&(_=y-M),_<I&&(_*=z,a|=L),_=Math.round(_);let x=b;x<=0&&(x=p-d),x<I&&(x*=z,a|=T),x=Math.round(x);const S=K(t.offsetX||0),C=K(-t.offsetY||0),F=N(d,M),G=N(p,y);return new ze(r,s,n,F,G,x,_,S,C,z,z,Ft(t.angle),a,t.effects,h,o)}static fromSimpleFill(t,s,i=!1){const{color:e}=t,n=e&&"esriSFSNull"!==t.style&&V(e)||0;let r=i?w:0;const h=t.materialKey;let o;if(s){const{rect:t,width:i,height:e,pixelRatio:a}=s,c=t.x+m,l=t.y+m,u=c+i,f=l+e,d=N(c,l),M=N(u,f);let p=i/a;p<I&&(p*=z,r|=T),p=Math.round(p);let w=e/a;w<I&&(w*=z,r|=L),w=Math.round(w),o=new ze(h,s,n,d,M,p,w,0,0,z,z,0,r,null,xs,Ss)}else o=new ze(h,null,n,0,0,0,0,0,0,0,0,0,r,null,xs,Ss);return o._maybeAddLineTemplate(t),o}static fromPictureFill(t,s,i=!1){const e=b,{rect:n,width:r,height:h}=s,o=n.x+m,a=n.y+m,c=o+r,l=a+h,u=N(o,a),f=N(c,l);let d=i?w:0,M=K(t.width);M<I&&(M*=z,d|=T),M=Math.round(M);let p=K(t.height);p<I&&(p*=z,d|=L),p=Math.round(p);const y=K(t.xoffset),g=K(-t.yoffset),_=t.materialKey,x=new ze(_,s,e,u,f,M,p,y,g,z*t.xscale,z*t.yscale,0,d,null,xs,Ss);return x._maybeAddLineTemplate(t),x}}class Le{constructor(){this._resolver=null}isHeld(){return!!this._resolver}async acquire(){this._resolver?(await this._resolver.promise,await this.acquire()):this._resolver=$()}release(){const t=this._resolver;this._resolver=null,t?.resolve()}}async function Te(t,s,i){try{await t.acquire(),await s(i),t.release()}catch(s){throw t.release(),s}}const Ce={marker:G.MARKER,fill:G.FILL,line:G.LINE,text:G.TEXT};class Fe{constructor(t,s,i,e){const n={minScale:s?.minScale,maxScale:s?.maxScale},r=Ge(n);this.layers=t,this.data=s,this.hash=this._createHash()+r,this.rendererKey=i;const h={isOutline:!1,placement:null,symbologyType:E.DEFAULT,vvFlags:i};for(const s of t){const t=Ce[s.type];h.isOutline="line"===s.type&&s.isOutline,s.materialKey=At(t,h),s.maxVVSize=e,s.scaleInfo=n,s.templateHash+=r}}get type(){return"expanded-cim"}_createHash(){let t="";for(const s of this.layers)t+=s.templateHash;return t}}function Ge(t){return t.minScale||t.maxScale?t.minScale+"-"+t.maxScale:""}async function Ae(t,s,i){if(!t.name)throw new D("style-symbol-reference-name-missing","Missing name in style symbol reference");if(t.styleName&&"Esri2DPointSymbolsStyle"===t.styleName)return Re(t,i);try{return Ne(await X(t,s,i),t.name,s,i)}catch(t){return J(t),null}}async function Re(t,s){const i=Z.replaceAll(/\{SymbolName\}/gi,t.name);try{const t=await Q(i,s);return Y(t.data)}catch(t){return J(t),null}}async function Ne(t,s,i,e){const n={portal:i&&null!=i.portal?i.portal:tt.getDefault(),url:st(t.baseUrl),origin:"portal-item"},r=ts(s,t.data);if(!r){throw new D("symbolstyleutils:symbol-name-not-found",`The symbol name '${s}' could not be found`,{symbolName:s})}let h=it(et(r,"cimRef"),n);Qt()&&(h=Yt(h));try{const t=await Q(h,e);return Y(t.data)}catch(t){return J(t),null}}const Ve=async(t,s,i)=>{const e=new Wt(i,s);return new Fe(await e.analyzeSymbolReference(t.data,!1),t.data,t.rendererKey,t.maxVVSize)};async function je(t,s,i,e){if(!t)return null;if("cim"===t.type)return Ve(t,s,i);if("web-style"===t.type){const n={type:"cim",data:await Ae(t,null,e)??void 0,rendererKey:t.rendererKey,maxVVSize:t.maxVVSize};return Ve(n,s,i)}return t}function Ee(t){if(!t)return null;const{avoidSDFRasterization:s,type:i,cim:e,url:n,materialHash:r,maxVVSize:h}=t,o={cim:e,type:i,mosaicHash:r,url:n,size:null,dashTemplate:null,path:null,text:null,fontName:null,animatedSymbolProperties:null,avoidSDFRasterization:s};switch(i){case"marker":h&&"size"in e&&(e.size=Math.max(h,e.size)),o.size=t.size,o.path=t.path,o.animatedSymbolProperties=t.animatedSymbolProperties;break;case"line":o.dashTemplate=t.dashTemplate;break;case"text":o.text=t.text,o.fontName=t.fontName}return o}const Be=H.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),We={sortKey:null,templates:new Array},Oe={isOutline:!1,placement:null,symbologyType:E.DEFAULT,vvFlags:0},De={...nt,hash:JSON.stringify(nt),materialKey:At(G.MARKER,Oe)},Ke={...rt,hash:JSON.stringify(rt),materialKey:At(G.LINE,Oe)},qe={...ht,hash:JSON.stringify(ht),materialKey:At(G.FILL,Oe)};function He(t,s){const i=t.length;return t.push(null),s.then((s=>t[i]=s)),t}function Ue(t){return null!=t&&!!(1&t)}function $e(t){return"worker:port-closed"===t.name}class Xe{constructor(t,s){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new Le,this._fetchResource=t,this._tileInfo=s}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,s,i=null){this._initErrorTemplates();const e=t.hash,n=this._symbolToTemplate.get(e);if(null!=n)return n;const r=new Array,h={sortKey:i,templates:r};s&&this._createMeshTemplates(r,s,!0),this._createMeshTemplates(r,t,!1);const o=this._createGroupId("expanded-cim"===t.type&&Je(t));return this._idToTemplateGroup.set(o,h),this._symbolToTemplate.set(e,o),o}getTemplateGroup(t){return this._idToTemplateGroup.get(t)??We}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?(Ue(t)||Be.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):We}getMosaicItem(t,s){const i=this._createTemplateId(),e=new Promise((t=>this._idToResolver.set(i,t)));return this._fetchQueue.push({symbol:t,id:i,glyphIds:s}),e}finalize(t){return this._fetchQueue.length||this._lock.isHeld()?Te(this._lock,this._fetchAllQueuedResources.bind(this),t):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],qe,!1),marker:this._createMeshTemplates([],De,!1),line:this._createMeshTemplates([],Ke,!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return Promise.resolve();const s=this._fetchQueue,i=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(i).then((()=>this._fetchResource(s,t).then((t=>{for(const{id:s,mosaicItem:i}of t){this._idToResolver.get(s)(i),this._idToResolver.delete(s)}})))).catch((t=>{ot(t)?this._fetchQueue=this._fetchQueue.concat(s):$e(t)||Be.error(new D("mapview-template-store","Unable to fetch requested texture resources",t))}))}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return ss(s,Be)?wi.fromSimpleMarker(t,s):this._markerError}async _createPMS(t){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return ss(s,Be)?wi.fromPictureMarker(t,s):this._markerError}async _createSFS(t,s){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return ss(i,Be)?ze.fromSimpleFill(t,i,s):this._fillError}async _createPFS(t,s){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return ss(i,Be)?ze.fromPictureFill(t,i,s):this._fillError}async _createSLS(t,s){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return ss(i,Be)?me.fromSimpleLine(t,i):this._lineError}async _createLMS(t){const{spriteMosaicItem:s}=await this.getMosaicItem(t);return ss(s,Be)?wi.fromLineSymbolMarker(t,s):this._markerError}async _createTS(t){const{glyphMosaicItems:s}=await this.getMosaicItem(t);return Ys.fromText(t,s??[])}async _createCIMText(t){const{glyphMosaicItems:s}=await this.getMosaicItem(Ee(t),ve(t.text));return ss(s,Be)?Ys.fromCIMText(t,s,this._tileInfo):this._textError}async _createCIMFill(t){const{spriteMosaicItem:s}=await this.getMosaicItem(Ee(t));return ss(s,Be)?ze.fromCIMFill(t,s,this._tileInfo):this._fillError}async _createCIMLine(t){const{spriteMosaicItem:s}=await this.getMosaicItem(Ee(t));return ss(s,Be)?me.fromCIMLine(t,s,this._tileInfo):this._lineError}async _createCIMMarker(t){const{spriteMosaicItem:s}=await this.getMosaicItem(Ee(t));return ss(s,Be)?wi.fromCIMMarker(t,s,this._tileInfo):this._markerError}async _createCIM(t){const s=t.templateHash;let i=this._cimTemplateCache.get(s);if(null!=i)return i;switch(t.type){case"marker":i=await this._createCIMMarker(t);break;case"line":i=await this._createCIMLine(t);break;case"fill":i=await this._createCIMFill(t);break;case"text":i=await this._createCIMText(t)}return this._cimTemplateCache.set(s,i),i}async _createDynamicCIM(t){const s=t.templateHash;let i=this._cimTemplateCache.get(s);if(null!=i)return i;switch(t.type){case"marker":i=Se.fromCIMMarker(t,this._tileInfo);break;case"line":i=be.fromCIMLine(t,this._tileInfo);break;case"fill":i=ge.fromCIMFill(t,this._tileInfo);break;case"text":i=Ie.fromCIMText(t,this._tileInfo)}return this._cimTemplateCache.set(s,i),i}_createPrimitiveMeshTemplates(t,s,i){switch(s.type){case"esriSMS":return He(t,this._createSMS(s));case"esriPMS":return He(t,this._createPMS(s));case"esriSFS":return He(t,this._createSFS(s,i));case"line-marker":return He(t,this._createLMS(s));case"esriPFS":return He(t,this._createPFS(s,i));case"esriSLS":return He(t,this._createSLS(s,!1));case"esriTS":return He(t,this._createTS(s));default:return Be.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,s,i){if(s.type.includes("3d"))return Be.error("3D symbols are not supported with MapView"),t;if("expanded-cim"===s.type){for(const i of s.layers)"function"==typeof i.materialHash?He(t,this._createDynamicCIM(i)):He(t,this._createCIM(i));return t}if("composite-symbol"===s.type){for(const e of s.layers)this._createPrimitiveMeshTemplates(t,e,i);return t}return"cim"===s.type||"label"===s.type||"web-style"===s.type?t:this._createPrimitiveMeshTemplates(t,s,i)}}const Je=t=>{if(!t.layers)return!1;for(const s of t.layers)if("function"==typeof s.materialHash)return!0;return!1};class Ze{constructor(t,s,i){this._loadPromise=dt(),this._geometryType=t,this._idField=s,this._templateStore=i}update(t,s){null!=t.mesh.labels&&(this._labelTemplates=this._createLabelTemplates(t.mesh.labels,s)),this._schema=t}_createLabelTemplates(t,s){const i=new Map;if("simple"===t.type){for(const e of t.classes){const t=mi.fromLabelClass(e,s);i.set(e.index,t)}return i}for(const e in t.classes){const n=t.classes[e];for(const t of n){const e=mi.fromLabelClass(t,s);i.set(t.index,e)}}return i}get templates(){return this._templateStore}async analyze(t,s,i,e,n,r,h){if(at(h))return;let o;"dictionary"===i?.type&&(o=await i.analyze(this._idField,t.copy(),s,n,r,h));let a=0;for(;t.next();){let s=null;if(s=o?o[a++]:null!=e&&F(t.getDisplayId())&&1!==t.readAttribute("cluster_count")?e.match(this._idField,t,this._geometryType,n,r):i.match(this._idField,t,this._geometryType,n,r),t.setGroupId(s),Ue(s)){const i=this._templateStore.getDynamicTemplateGroup(s).templates;for(const s of i)s&&s.analyze&&s.analyze(this._templateStore,t,n,r)}}return await this._loadPromise,this._templateStore.finalize(h)}async analyzeGraphics(t,s,i,e,n,r){if(at(r))return;const h=t.getCursor();for(i&&await i.analyze(this._idField,h.copy(),s,e,n,r);h.next();){let t=h.getGroupId();if(null!=t&&-1!==t||(t=i?.match(this._idField,h,h.geometryType,e,n),h.setGroupId(t)),Ue(t)){const s=this._templateStore.getDynamicTemplateGroup(t).templates;for(const t of s)t&&t.analyze&&t.analyze(this._templateStore,h,e,n)}h.setGroupId(t)}return await this._loadPromise,this._templateStore.finalize(r)}writeGraphic(t,s,i,e){const n=s.getGroupId(),r=s.getDisplayId(),h=this._templateStore.getTemplateGroup(n);if(t.featureStart(s.insertAfter,0),null!=r){if(Ue(n))for(const t of h.templates)t&&t.bindFeature(s,null,null);if(h){for(const n of h.templates)n&&n.write(t,s,i,e);t.featureEnd()}}}writeCursor(t,s,i,e,n,r,h){const o=s.getGroupId(),a=s.getDisplayId(),c=this._templateStore.getTemplateGroup(o),l=c.templates,u=this._getSortKeyValue(s,c);if(t.featureStart(0,u),null!=a&&l){if(Ue(o))for(const t of l)t.bindFeature(s,i,e);for(const i of l)i.write(t,s,n,h);if(null!=r&&t.hasRecords){const i=r&&this._findLabelRef(l);this._writeLabels(t,s,r,i,n,h)}t.featureEnd()}}_getSortKeyValue(t,s){const i=this._schema.mesh.sortKey;if(null==i)return 0;let e=0;return e=!0===i.byRenderer&&null!=s.sortKey?s.sortKey:null!=i.fieldIndex?t.getComputedNumericAtIndex(i.fieldIndex):null!=i.field?t.readAttribute(i.field):t.readAttribute(this._idField),e*="asc"===i.order?1:-1,null==e||isNaN(e)?0:e}_findLabelRef(t){for(const s of t)if(s instanceof wi)return s;return null}_writeLabels(t,s,i,e,n,r){for(const h of i)if(null!=h&&h){const{glyphs:i,rtl:o,index:a}=h,c=this._labelTemplates.get(a);if(!c)continue;c.setZoomLevel(n),c.bindReferenceTemplate(e),c.bindTextInfo(i,o),c.write(t,s,null,r)}}}const Qe=H.getLogger("esri/views/2d/engine/webgl/util/Matcher");async function Ye(t,s,i,e){switch(t.type){case"simple":case"heatmap":return tn.fromBasicRenderer(t,s,i,e);case"map":return nn.fromUVRenderer(t,s,i,e);case"interval":return en.fromCBRenderer(t,s,i,e);case"dictionary":return an.fromDictionaryRenderer(t,s,i,e);case"pie-chart":return sn.fromPieChartRenderer(t,s,i,e);case"subtype":return sn.fromSubtypes(t,s,i,e)}}class tn{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,s,i,e){const n=new tn;if(t.symbol){const r=await je(t.symbol,i,e),h=s.createTemplateGroup(r,null);n.setDefault(h)}return n}static async fromPieChartRenderer(t,s,i,e){const n=new tn;if(t.markerSymbol){const r=await je(t.markerSymbol,i,e);let h;t.fillSymbol&&(h=await je(t.fillSymbol,i,e));const o=s.createTemplateGroup(r,h);n.setDefault(o)}return n}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,s,i,e,n){return this.getDefault()}async analyze(t,s,i,e,n,r){return null}}class sn extends tn{constructor(t,s){super(),this._subMatchers=t,this._subtypeField=s}static async fromSubtypes(t,s,i,e){const n=new Map,r=[];for(const h in t.renderers){const o=parseInt(h,10),a=Ye(t.renderers[h],s,i,e).then((t=>n.set(o,t)));r.push(a)}return await Promise.all(r),new sn(n,t.subtypeField)}match(t,s,i,e,n){const r=s.readAttribute(this._subtypeField),h=this._subMatchers.get(r);return h?h.match(t,s,i,e,n):null}}class en extends tn{constructor(t,s,i,e){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=s,this._fieldIndex=e,this._field=t,this._normalizationInfo=i}static async fromCBRenderer(t,s,i,e){const{isMaxInclusive:n,normalizationField:r,normalizationTotal:h,normalizationType:o}=t,a=t.field,c=new en(a,n,{normalizationField:r,normalizationTotal:h,normalizationType:o},t.fieldIndex),l=await je(t.backgroundFillSymbol,i,e);await Promise.all(t.intervals.map((async t=>{const n=await je(t.symbol,i,e),r=await s.createTemplateGroup(n,l),h={min:t.min,max:t.max};c.add(h,r)})));const u=await je(t.defaultSymbol,i,e);if(u){const t=await s.createTemplateGroup(u,l);c.setDefault(t)}return c}add(t,s){this._intervals.push({interval:t,result:s}),this._intervals.sort(((t,s)=>t.interval.min-s.interval.min))}size(){return super.size()+this._intervals.length}match(t,s,i,e,n){if(null==this._fieldIndex&&!this._field)return this.getDefault();const r=null!=this._fieldIndex?s.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(s);if(null==r||isNaN(r)||r===1/0||r===-1/0)return this.getDefault();for(let t=0;t<this._intervals.length;t++){const{interval:s,result:i}=this._intervals[t],e=r>=s.min,n=this._isMaxInclusive?r<=s.max:r<s.max;if(e&&n)return i}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const s=t.readAttribute(this._field);if(!this._needsNormalization()||null==s)return s;const{normalizationField:i,normalizationTotal:e,normalizationType:n}=this._normalizationInfo,r=t.readAttribute(i)??1;if(n)switch(n){case"esriNormalizeByField":return r?s/r:void 0;case"esriNormalizeByLog":return Math.log(s)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return s/e*100;default:return void Qe.error(`Found unknown normalization type: ${n}`)}else Qe.error("Normalization is required, but no type was set!")}}class nn extends tn{constructor(t,s,i){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fieldsIndex=i,this._fields=t,this._seperator=s||""}static async fromUVRenderer(t,s,i,e){const n=t.fieldDelimiter,r=[t.field];t.field2&&r.push(t.field2),t.field3&&r.push(t.field3);const h=await je(t.backgroundFillSymbol,i,e),o=new nn(r,n,t.fieldIndex);await Promise.all(t.map.map((async(t,n)=>{const r=await je(t.symbol,i,e),a=n+1,c=await s.createTemplateGroup(r,h,a);"<Null>"===t.value?o.setNullResult(c):o.add(t.value,c)})));const a=await je(t.defaultSymbol,i,e);if(a){const t=Number.MAX_SAFE_INTEGER,i=await s.createTemplateGroup(a,h,t);o.setDefault(i)}return o}setNullResult(t){this._nullResult=t}add(t,s){this._resultsMap.set(t.toString(),s)}size(){return super.size()+this._resultsMap.size}match(t,s,i,e,n){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const r=null!=this._fieldsIndex?s.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(s);if(null!==this._nullResult&&(null==r||""===r||"<Null>"===r))return this._nullResult;if(null==r)return this.getDefault();const h=r.toString();return this._resultsMap.has(h)?this._resultsMap.get(h):this.getDefault()}_getValueFromFields(t){const s=[];for(const i of this._fields){const e=t.readAttribute(i);null==e||""===e?s.push("<Null>"):s.push(e)}return s.join(this._seperator)}}async function rn(t,s){const i=t||1;if("number"==typeof i)return(t,s,e)=>i;const e=await ut(i,s.spatialReference,s.fields);return(t,i,n)=>Ot(e,t,{$view:n},s.geometryType,i)||1}let hn;async function on(){return hn||(hn=import("./p-83c727f2.js")),hn}class an extends tn{constructor(t,s,i,e,n,r){super(),this.type="dictionary",this._groupIdCache=new ct(100),this._loader=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=s,this._info=i,this._scaleFn=e,this._schemaUtilsModule=n,this._symbolOptions=r}static async fromDictionaryRenderer(t,s,i,e){const[{DictionaryLoader:n},r]=await Promise.all([import("./p-98455486.js").then((function(t){return t.kc})),on()]),h=new n(t.url,t.config,t.fieldMap);await h.fetchResources({spatialReference:i.spatialReference,fields:i.fields});const o=await rn(t.scaleExpression,i);return new an(h,s,i,o,r,t.symbolOptions)}async _analyzeFeature(t,s,i,e,n){const r=t.readLegacyFeature(),h=this._scaleFn(r,i,e),o=this._attributeHash(r)+"-"+h,a=this._groupIdCache.get(o);if(a)return a;const c={...e,spatialReference:this._info.spatialReference,abortOptions:n,fields:this._info.fields},l=await this._loader.getSymbolAsync(r,c),u=this._schemaUtilsModule.createSymbolSchema(l,this._symbolOptions),f=je(u,this._info,s,n).then((t=>{if("expanded-cim"!==t?.type)return Qe.error(new D("mapview-bad-type",`Found unexpected type ${t?.type} in dictionary response`)),null;t.hash+="-"+h;for(const s of t.layers)s.scaleFactor=h,s.templateHash+="-"+h;return this._templates.createTemplateGroup(t,null)}));return this._groupIdCache.put(o,f,1),f}async analyze(t,s,i,e,n,r){const h=s.getCursor(),o=[];for(;h.next();)o.push(this._analyzeFeature(h,i,e,n,r));return Promise.all(o).then((t=>t.filter(lt)))}match(t,s,i,e,n){return null}_attributeHash(t){let s="";for(const i of this._symbolFields){const e=this._fieldMap?.[i];e&&(s+=t.attributes[e]+"-")}return s}}export{_s as E,es as a,Ze as b,ss as e,ve as n,Ye as o,je as r,Xe as x};
//# sourceMappingURL=p-eda79132.js.map