import{t}from"./p-9f1a0adc.js";import{c as i,n as s}from"./p-ed1a11ab.js";import{fY as e,bF as n,h as r,j as h,ax as a,av as o,s as c,ba as u,c as l,v as f,P as d,d as m,bX as w,fS as p,a1 as v,a8 as g,aN as y,a2 as b,k as M,l as _,n as x,ay as S,cV as k,e6 as A,b9 as z,fD as I,a5 as j,aR as T,fZ as $,cW as U,ae as D}from"./p-98455486.js";import{M as P,i as F,l as C,t as R,a as E,o as L,e as O,f as B,b as N}from"./p-2b6b8db8.js";import{r as G,s as V,a as q}from"./p-3a9bb31c.js";import{n as H}from"./p-2d1dac84.js";import{r as Z,e as X}from"./p-a2737e04.js";import{a as Y}from"./p-ecc7ed03.js";import{a as W,b as J,C as K,B as Q,A as tt,X as it,Y as st}from"./p-1abe3c64.js";import{u as et,_ as nt,p as rt,l as ht,n as at,a as ot,I as ct,f as ut,i as lt,o as ft,m as dt,s as mt,d as wt,T as pt}from"./p-7dc0ec82.js";import{t as vt}from"./p-de65627f.js";import{G as gt,D as yt,L as bt,R as Mt}from"./p-13e550f5.js";import{T as _t,b as xt}from"./p-7099a764.js";import{n as St}from"./p-1172b129.js";import{o as kt}from"./p-a3c11f30.js";import{e as At}from"./p-220b11a0.js";import{o as zt}from"./p-4e1a9b2e.js";import{d as It}from"./p-0e94eaa4.js";import{e as jt}from"./p-eda79132.js";import{u as Tt}from"./p-f5452a6b.js";import{t as $t}from"./p-30bab7e4.js";import{T as Ut}from"./p-aff398b0.js";import{e as Dt}from"./p-73062657.js";import{t as Pt}from"./p-f705ab94.js";import{_ as Ft,o as Ct,R as Rt,q as Et,s as Lt,X as Ot,t as Bt,v as Nt,x as Gt}from"./p-d46be2b1.js";import{n as Vt}from"./p-783b6965.js";import{a as qt}from"./p-620ed352.js";var Ht,Zt,Xt={exports:{}};Ht=Xt,Zt=function(){return function(t){var i={};function s(e){if(i[e])return i[e].exports;var n=i[e]={exports:{},id:e,loaded:!1};return t[e].call(n.exports,n,n.exports,s),n.loaded=!0,n.exports}return s.m=t,s.c=i,s.p="",s(0)}([function(t,i,s){Object.defineProperty(i,"__esModule",{value:!0}),i.isNotPNG=o,i.isNotAPNG=c,i.default=l;var e=r(s(1)),n=s(2);function r(t){return t&&t.__esModule?t:{default:t}}var h=new Error("Not a PNG"),a=new Error("Not an animated PNG");function o(t){return t===h}function c(t){return t===a}var u=new Uint8Array([137,80,78,71,13,10,26,10]);function l(t){var i=new Uint8Array(t);if(Array.prototype.some.call(u,(function(t,s){return t!==i[s]})))return h;var s=!1;if(f(i,(function(t){return!(s="acTL"===t)})),!s)return a;var e=[],r=[],o=null,c=null,l=0,d=new n.APNG;if(f(i,(function(t,i,s,h){var a=new DataView(i.buffer);switch(t){case"IHDR":o=i.subarray(s+8,s+8+h),d.width=a.getUint32(s+8),d.height=a.getUint32(s+12);break;case"acTL":d.numPlays=a.getUint32(s+8+4);break;case"fcTL":c&&(d.frames.push(c),l++),(c=new n.Frame).width=a.getUint32(s+8+4),c.height=a.getUint32(s+8+8),c.left=a.getUint32(s+8+12),c.top=a.getUint32(s+8+16);var u=a.getUint16(s+8+20),f=a.getUint16(s+8+22);0===f&&(f=100),c.delay=1e3*u/f,c.delay<=10&&(c.delay=100),d.playTime+=c.delay,c.disposeOp=a.getUint8(s+8+24),c.blendOp=a.getUint8(s+8+25),c.dataParts=[],0===l&&2===c.disposeOp&&(c.disposeOp=1);break;case"fdAT":c&&c.dataParts.push(i.subarray(s+8+4,s+8+h));break;case"IDAT":c&&c.dataParts.push(i.subarray(s+8,s+8+h));break;case"IEND":r.push(w(i,s,12+h));break;default:e.push(w(i,s,12+h))}})),c&&d.frames.push(c),0==d.frames.length)return a;var m=new Blob(e),g=new Blob(r);return d.frames.forEach((function(t){var i=[];i.push(u),o.set(v(t.width),0),o.set(v(t.height),4),i.push(p("IHDR",o)),i.push(m),t.dataParts.forEach((function(t){return i.push(p("IDAT",t))})),i.push(g),t.imageData=new Blob(i,{type:"image/png"}),delete t.dataParts,i=null})),d}function f(t,i){var s=new DataView(t.buffer),e=8,n=void 0,r=void 0,h=void 0;do{r=s.getUint32(e),h=i(n=d(t,e+4,4),t,e,r),e+=12+r}while(!1!==h&&"IEND"!=n&&e<t.length)}function d(t,i,s){var e=Array.prototype.slice.call(t.subarray(i,i+s));return String.fromCharCode.apply(String,e)}function m(t){for(var i=new Uint8Array(t.length),s=0;s<t.length;s++)i[s]=t.charCodeAt(s);return i}function w(t,i,s){var e=new Uint8Array(s);return e.set(t.subarray(i,i+s)),e}var p=function(t,i){var s=t.length+i.length,n=new Uint8Array(s+8),r=new DataView(n.buffer);r.setUint32(0,i.length),n.set(m(t),4),n.set(i,8);var h=(0,e.default)(n,4,s);return r.setUint32(s+4,h),n},v=function(t){return new Uint8Array([t>>>24&255,t>>>16&255,t>>>8&255,255&t])}},function(t,i){Object.defineProperty(i,"__esModule",{value:!0}),i.default=function(t){for(var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=-1,n=i,r=i+(arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.length-i);n<r;n++)e=e>>>8^s[255&(e^t[n])];return-1^e};for(var s=new Uint32Array(256),e=0;e<256;e++){for(var n=e,r=0;r<8;r++)n=0!=(1&n)?3988292384^n>>>1:n>>>1;s[e]=n}},function(t,i,s){Object.defineProperty(i,"__esModule",{value:!0}),i.Frame=i.APNG=void 0;var e=function(){function t(t,i){for(var s=0;s<i.length;s++){var e=i[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(i,s,e){return s&&t(i.prototype,s),e&&t(i,e),i}}(),n=r(s(3));function r(t){return t&&t.__esModule?t:{default:t}}function h(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}i.APNG=function(){function t(){h(this,t),this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[]}return e(t,[{key:"createImages",value:function(){return Promise.all(this.frames.map((function(t){return t.createImage()})))}},{key:"getPlayer",value:function(t){var i=this,s=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.createImages().then((function(){return new n.default(i,t,s)}))}}]),t}(),i.Frame=function(){function t(){h(this,t),this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.imageData=null,this.imageElement=null}return e(t,[{key:"createImage",value:function(){var t=this;return this.imageElement?Promise.resolve():new Promise((function(i,s){var e=URL.createObjectURL(t.imageData);t.imageElement=document.createElement("img"),t.imageElement.onload=function(){URL.revokeObjectURL(e),i()},t.imageElement.onerror=function(){URL.revokeObjectURL(e),t.imageElement=null,s(new Error("Image creation error"))},t.imageElement.src=e}))}}]),t}()},function(t,i,s){Object.defineProperty(i,"__esModule",{value:!0});var e=function(){function t(t,i){for(var s=0;s<i.length;s++){var e=i[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(i,s,e){return s&&t(i.prototype,s),e&&t(i,e),i}}();function n(t){return t&&t.__esModule?t:{default:t}}function r(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}function h(t,i){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!i||"object"!=typeof i&&"function"!=typeof i?t:i}function a(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function, not "+typeof i);t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),i&&(Object.setPrototypeOf?Object.setPrototypeOf(t,i):t.__proto__=i)}var o=function(t){function i(t,s,e){r(this,i);var n=h(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return n.playbackRate=1,n._currentFrameNumber=0,n._ended=!1,n._paused=!0,n._numPlays=0,n._apng=t,n.context=s,n.stop(),e&&n.play(),n}return a(i,t),e(i,[{key:"renderNextFrame",value:function(){this._currentFrameNumber=(this._currentFrameNumber+1)%this._apng.frames.length,this._currentFrameNumber===this._apng.frames.length-1&&(this._numPlays++,0!==this._apng.numPlays&&this._numPlays>=this._apng.numPlays&&(this._ended=!0,this._paused=!0)),this._prevFrame&&1==this._prevFrame.disposeOp?this.context.clearRect(this._prevFrame.left,this._prevFrame.top,this._prevFrame.width,this._prevFrame.height):this._prevFrame&&2==this._prevFrame.disposeOp&&this.context.putImageData(this._prevFrameData,this._prevFrame.left,this._prevFrame.top);var t=this.currentFrame;this._prevFrame=t,this._prevFrameData=null,2==t.disposeOp&&(this._prevFrameData=this.context.getImageData(t.left,t.top,t.width,t.height)),0==t.blendOp&&this.context.clearRect(t.left,t.top,t.width,t.height),this.context.drawImage(t.imageElement,t.left,t.top),this.emit("frame",this._currentFrameNumber),this._ended&&this.emit("end")}},{key:"play",value:function(){var t=this;this.emit("play"),this._ended&&this.stop(),this._paused=!1;var i=performance.now()+this.currentFrame.delay/this.playbackRate,s=function s(e){if(!t._ended&&!t._paused){if(e>=i){for(;e-i>=t._apng.playTime/t.playbackRate;)i+=t._apng.playTime/t.playbackRate,t._numPlays++;do{t.renderNextFrame(),i+=t.currentFrame.delay/t.playbackRate}while(!t._ended&&e>i)}requestAnimationFrame(s)}};requestAnimationFrame(s)}},{key:"pause",value:function(){this._paused||(this.emit("pause"),this._paused=!0)}},{key:"stop",value:function(){this.emit("stop"),this._numPlays=0,this._ended=!1,this._paused=!0,this._currentFrameNumber=-1,this.context.clearRect(0,0,this._apng.width,this._apng.height),this.renderNextFrame()}},{key:"currentFrameNumber",get:function(){return this._currentFrameNumber}},{key:"currentFrame",get:function(){return this._apng.frames[this._currentFrameNumber]}},{key:"paused",get:function(){return this._paused}},{key:"ended",get:function(){return this._ended}}]),i}(n(s(4)).default);i.default=o},function(t,i){function s(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function e(t){return"function"==typeof t}function n(t){return"number"==typeof t}function r(t){return"object"==typeof t&&null!==t}function h(t){return void 0===t}t.exports=s,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._maxListeners=void 0,s.defaultMaxListeners=10,s.prototype.setMaxListeners=function(t){if(!n(t)||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},s.prototype.emit=function(t){var i,s,n,a,o,c;if(this._events||(this._events={}),"error"===t&&(!this._events.error||r(this._events.error)&&!this._events.error.length)){if((i=arguments[1])instanceof Error)throw i;var u=new Error('Uncaught, unspecified "error" event. ('+i+")");throw u.context=i,u}if(h(s=this._events[t]))return!1;if(e(s))switch(arguments.length){case 1:s.call(this);break;case 2:s.call(this,arguments[1]);break;case 3:s.call(this,arguments[1],arguments[2]);break;default:a=Array.prototype.slice.call(arguments,1),s.apply(this,a)}else if(r(s))for(a=Array.prototype.slice.call(arguments,1),n=(c=s.slice()).length,o=0;o<n;o++)c[o].apply(this,a);return!0},s.prototype.addListener=function(t,i){var n;if(!e(i))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,e(i.listener)?i.listener:i),this._events[t]?r(this._events[t])?this._events[t].push(i):this._events[t]=[this._events[t],i]:this._events[t]=i,r(this._events[t])&&!this._events[t].warned&&(n=h(this._maxListeners)?s.defaultMaxListeners:this._maxListeners)&&n>0&&this._events[t].length>n&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),"function"==typeof console.trace&&console.trace()),this},s.prototype.on=s.prototype.addListener,s.prototype.once=function(t,i){if(!e(i))throw TypeError("listener must be a function");var s=!1;function n(){this.removeListener(t,n),s||(s=!0,i.apply(this,arguments))}return n.listener=i,this.on(t,n),this},s.prototype.removeListener=function(t,i){var s,n,h,a;if(!e(i))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(h=(s=this._events[t]).length,n=-1,s===i||e(s.listener)&&s.listener===i)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,i);else if(r(s)){for(a=h;a-- >0;)if(s[a]===i||s[a].listener&&s[a].listener===i){n=a;break}if(n<0)return this;1===s.length?(s.length=0,delete this._events[t]):s.splice(n,1),this._events.removeListener&&this.emit("removeListener",t,i)}return this},s.prototype.removeAllListeners=function(t){var i,s;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(i in this._events)"removeListener"!==i&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events={},this}if(e(s=this._events[t]))this.removeListener(t,s);else if(s)for(;s.length;)this.removeListener(t,s[s.length-1]);return delete this._events[t],this},s.prototype.listeners=function(t){return this._events&&this._events[t]?e(this._events[t])?[this._events[t]]:this._events[t].slice():[]},s.prototype.listenerCount=function(t){if(this._events){var i=this._events[t];if(e(i))return 1;if(i)return i.length}return 0},s.listenerCount=function(t,i){return t.listenerCount(i)}}])},Ht.exports=Zt();const Yt=t(Xt.exports);var Wt={},Jt={},Kt={};Object.defineProperty(Kt,"__esModule",{value:!0}),Kt.loop=Kt.conditional=Kt.parse=void 0;var Qt=function t(i,s){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e;if(Array.isArray(s))s.forEach((function(s){return t(i,s,e,n)}));else if("function"==typeof s)s(i,e,n,t);else{var r=Object.keys(s)[0];Array.isArray(s[r])?(n[r]={},t(i,s[r],e,n[r])):n[r]=s[r](i,e,n,t)}return e};Kt.parse=Qt;var ti=function(t,i){return function(s,e,n,r){i(s,e,n)&&r(s,t,e,n)}};Kt.conditional=ti;var ii=function(t,i){return function(s,e,n,r){for(var h=[],a=s.pos;i(s,e,n);){var o={};if(r(s,t,e,o),s.pos===a)break;a=s.pos,h.push(o)}return h}};Kt.loop=ii;var si={};Object.defineProperty(si,"__esModule",{value:!0}),si.readBits=si.readArray=si.readUnsigned=si.readString=si.peekBytes=si.readBytes=si.peekByte=si.readByte=si.buildStream=void 0;var ei=function(t){return{data:t,pos:0}};si.buildStream=ei;var ni=function(){return function(t){return t.data[t.pos++]}};si.readByte=ni;var ri=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(i){return i.data[i.pos+t]}};si.peekByte=ri;var hi=function(t){return function(i){return i.data.subarray(i.pos,i.pos+=t)}};si.readBytes=hi;var ai=function(t){return function(i){return i.data.subarray(i.pos,i.pos+t)}};si.peekBytes=ai;var oi=function(t){return function(i){return Array.from(hi(t)(i)).map((function(t){return String.fromCharCode(t)})).join("")}};si.readString=oi;var ci=function(t){return function(i){var s=hi(2)(i);return t?(s[1]<<8)+s[0]:(s[0]<<8)+s[1]}};si.readUnsigned=ci;var ui=function(t,i){return function(s,e,n){for(var r="function"==typeof i?i(s,e,n):i,h=hi(t),a=new Array(r),o=0;o<r;o++)a[o]=h(s);return a}};si.readArray=ui;var li=function(t,i,s){for(var e=0,n=0;n<s;n++)e+=t[i+n]&&Math.pow(2,s-n-1);return e},fi=function(t){return function(i){for(var s=ni()(i),e=new Array(8),n=0;n<8;n++)e[7-n]=!!(s&1<<n);return Object.keys(t).reduce((function(i,s){var n=t[s];return n.length?i[s]=li(e,n.index,n.length):i[s]=e[n.index],i}),{})}};si.readBits=fi,function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=Kt,s=si,e={blocks:function(t){for(var i=0,e=[],n=t.data.length,r=0,h=(0,s.readByte)()(t);h!==i&&h;h=(0,s.readByte)()(t)){if(t.pos+h>=n){var a=n-t.pos;e.push((0,s.readBytes)(a)(t)),r+=a;break}e.push((0,s.readBytes)(h)(t)),r+=h}for(var o=new Uint8Array(r),c=0,u=0;u<e.length;u++)o.set(e[u],c),c+=e[u].length;return o}},n=(0,i.conditional)({gce:[{codes:(0,s.readBytes)(2)},{byteSize:(0,s.readByte)()},{extras:(0,s.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,s.readUnsigned)(!0)},{transparentColorIndex:(0,s.readByte)()},{terminator:(0,s.readByte)()}]},(function(t){var i=(0,s.peekBytes)(2)(t);return 33===i[0]&&249===i[1]})),r=(0,i.conditional)({image:[{code:(0,s.readByte)()},{descriptor:[{left:(0,s.readUnsigned)(!0)},{top:(0,s.readUnsigned)(!0)},{width:(0,s.readUnsigned)(!0)},{height:(0,s.readUnsigned)(!0)},{lct:(0,s.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,i.conditional)({lct:(0,s.readArray)(3,(function(t,i,s){return Math.pow(2,s.descriptor.lct.size+1)}))},(function(t,i,s){return s.descriptor.lct.exists})),{data:[{minCodeSize:(0,s.readByte)()},e]}]},(function(t){return 44===(0,s.peekByte)()(t)})),h=(0,i.conditional)({text:[{codes:(0,s.readBytes)(2)},{blockSize:(0,s.readByte)()},{preData:function(t,i,e){return(0,s.readBytes)(e.text.blockSize)(t)}},e]},(function(t){var i=(0,s.peekBytes)(2)(t);return 33===i[0]&&1===i[1]})),a=(0,i.conditional)({application:[{codes:(0,s.readBytes)(2)},{blockSize:(0,s.readByte)()},{id:function(t,i,e){return(0,s.readString)(e.blockSize)(t)}},e]},(function(t){var i=(0,s.peekBytes)(2)(t);return 33===i[0]&&255===i[1]})),o=(0,i.conditional)({comment:[{codes:(0,s.readBytes)(2)},e]},(function(t){var i=(0,s.peekBytes)(2)(t);return 33===i[0]&&254===i[1]})),c=[{header:[{signature:(0,s.readString)(3)},{version:(0,s.readString)(3)}]},{lsd:[{width:(0,s.readUnsigned)(!0)},{height:(0,s.readUnsigned)(!0)},{gct:(0,s.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,s.readByte)()},{pixelAspectRatio:(0,s.readByte)()}]},(0,i.conditional)({gct:(0,s.readArray)(3,(function(t,i){return Math.pow(2,i.lsd.gct.size+1)}))},(function(t,i){return i.lsd.gct.exists})),{frames:(0,i.loop)([n,a,o,r,h],(function(t){var i=(0,s.peekByte)()(t);return 33===i||44===i}))}];t.default=c}(Jt);var di={};Object.defineProperty(di,"__esModule",{value:!0}),di.deinterlace=void 0;var mi=function(t,i){for(var s=new Array(t.length),e=t.length/i,n=function(e,n){var r=t.slice(n*i,(n+1)*i);s.splice.apply(s,[e*i,i].concat(r))},r=[0,4,2,1],h=[8,8,4,2],a=0,o=0;o<4;o++)for(var c=r[o];c<e;c+=h[o])n(c,a),a++;return s};di.deinterlace=mi;var wi={};Object.defineProperty(wi,"__esModule",{value:!0}),wi.lzw=void 0;var pi=function(t,i,s){var e,n,r,h,a,o,c,u,l,f,d,m,w,p,v,g,y=4096,b=-1,M=s,_=new Array(s),x=new Array(y),S=new Array(y),k=new Array(y+1);for(a=(n=1<<(f=t))+1,e=n+2,c=b,r=(1<<(h=f+1))-1,u=0;u<n;u++)x[u]=0,S[u]=u;for(d=m=w=p=v=g=0,l=0;l<M;){if(0===p){if(m<h){d+=i[g]<<m,m+=8,g++;continue}if(u=d&r,d>>=h,m-=h,u>e||u==a)break;if(u==n){r=(1<<(h=f+1))-1,e=n+2,c=b;continue}if(c==b){k[p++]=S[u],c=u,w=u;continue}for(o=u,u==e&&(k[p++]=w,u=c);u>n;)k[p++]=S[u],u=x[u];w=255&S[u],k[p++]=w,e<y&&(x[e]=c,S[e]=w,0==(++e&r)&&e<y&&(h++,r+=e)),c=o}p--,_[v++]=k[p],l++}for(l=v;l<M;l++)_[l]=0;return _};wi.lzw=pi,Object.defineProperty(Wt,"__esModule",{value:!0});var vi=Wt.decompressFrames=Wt.decompressFrame=ki=Wt.parseGIF=void 0,gi=xi(Jt),yi=Kt,bi=si,Mi=di,_i=wi;function xi(t){return t&&t.__esModule?t:{default:t}}var Si=function(t){var i=new Uint8Array(t);return(0,yi.parse)((0,bi.buildStream)(i),gi.default)},ki=Wt.parseGIF=Si,Ai=function(t){for(var i=t.pixels.length,s=new Uint8ClampedArray(4*i),e=0;e<i;e++){var n=4*e,r=t.pixels[e],h=t.colorTable[r]||[0,0,0];s[n]=h[0],s[n+1]=h[1],s[n+2]=h[2],s[n+3]=r!==t.transparentIndex?255:0}return s},zi=function(t,i,s){if(t.image){var e=t.image,n=e.descriptor.width*e.descriptor.height,r=(0,_i.lzw)(e.data.minCodeSize,e.data.blocks,n);e.descriptor.lct.interlaced&&(r=(0,Mi.deinterlace)(r,e.descriptor.width));var h={pixels:r,dims:{top:t.image.descriptor.top,left:t.image.descriptor.left,width:t.image.descriptor.width,height:t.image.descriptor.height}};return e.descriptor.lct&&e.descriptor.lct.exists?h.colorTable=e.lct:h.colorTable=i,t.gce&&(h.delay=10*(t.gce.delay||10),h.disposalType=t.gce.extras.disposal,t.gce.extras.transparentColorGiven&&(h.transparentIndex=t.gce.transparentColorIndex)),s&&(h.patch=Ai(h)),h}console.warn("gif frame does not have associated image.")};Wt.decompressFrame=zi;var Ii=function(t,i){return t.frames.filter((function(t){return t.image})).map((function(s){return zi(s,t.gct,i)}))};vi=Wt.decompressFrames=Ii;const ji=512;class Ti{constructor(t){this._resourceManager=t,this._rasterizationCanvas=null}dispose(){this._rasterizationCanvas=null}rasterizeJSONResource(t,i,s){if(this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),"simple-fill"===t.type||"esriSFS"===t.type){const[s,n,r]=Z(this._rasterizationCanvas,t.style,i);return{size:[n,r],image:new Uint32Array(s.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:e(Math.ceil(i))}}if("simple-line"===t.type||"esriSLS"===t.type||"line"===t.type&&t.dashTemplate){let i,s;if("simple-line"===t.type||"esriSLS"===t.type)switch(i=P(t.style,t.cap),t.cap){case"butt":s="Butt";break;case"square":s="Square";break;default:s="Round"}else i=t.dashTemplate,s=t.cim.capStyle;const[e,n,r]=X(i,s);return{size:[n,r],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let n,r=null,h=null,a=1;if("simple-marker"===t.type||"esriSMS"===t.type||"line-marker"===t.type?(n=F.fromSimpleMarker(t),h=C(n)):t.cim&&"CIMHatchFill"===t.cim.type?(n=F.fromCIMHatchFill(t.cim,i),r=new R(n.frame.xmin,-n.frame.ymax,n.frame.xmax-n.frame.xmin,n.frame.ymax-n.frame.ymin),a=i):t.cim.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===t.cim.markerPlacement.type?(n=F.fromCIMInsidePolygon(t.cim),r=new R(n.frame.xmin,-n.frame.ymax,n.frame.xmax-n.frame.xmin,n.frame.ymax-n.frame.ymin)):(n=t.cim,t.avoidSDFRasterization||(h=C(n))),h&&!s){const[t,i,s]=E(h);return t?{size:[i,s],image:new Uint32Array(t.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:a}:null}const[o,c,u,l,f]=F.rasterize(this._rasterizationCanvas,n,r,this._resourceManager,!s);return o?{size:[c,u],image:new Uint32Array(o.buffer),sdf:!1,simplePattern:!1,anchorX:l,anchorY:f}:null}rasterizeImageResource(t,i,s,e){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),this._rasterizationCanvas.width=t,this._rasterizationCanvas.height=i;const n=this._rasterizationCanvas.getContext("2d");s instanceof ImageData?n.putImageData(s,0,0):(s.setAttribute("width",`${t}px`),s.setAttribute("height",`${i}px`),n.drawImage(s,0,0,t,i));const r=n.getImageData(0,0,t,i),h=new Uint8Array(r.data);if(e)for(const t of e)if(t&&t.oldColor&&4===t.oldColor.length&&t.newColor&&4===t.newColor.length){const[i,s,e,n]=t.oldColor,[r,a,o,c]=t.newColor;if(i===r&&s===a&&e===o&&n===c)continue;for(let t=0;t<h.length;t+=4)i===h[t]&&s===h[t+1]&&e===h[t+2]&&n===h[t+3]&&(h[t]=r,h[t+1]=a,h[t+2]=o,h[t+3]=c)}let a;for(let t=0;t<h.length;t+=4)a=h[t+3]/255,h[t]=h[t]*a,h[t+1]=h[t+1]*a,h[t+2]=h[t+2]*a;let o=h,c=t,u=i;const l=ji;if(c>=l||u>=l){const s=c/u;s>1?(c=l,u=Math.round(l/s)):(u=l,c=Math.round(l*s)),o=new Uint8Array(4*c*u);const e=new Uint8ClampedArray(o.buffer);Y(h,t,i,e,c,u,!1)}return{size:[c,u],image:new Uint32Array(o.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}const $i={shaders:{vertexShader:i("bitBlit/bitBlit.vert"),fragmentShader:i("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};class Ui{constructor(t,i){this._width=0,this._height=0,this._free=[],this._width=t,this._height=i,this._free.push(new vt(0,0,t,i))}get width(){return this._width}get height(){return this._height}allocate(t,i){if(t>this._width||i>this._height)return new vt;let s=null,e=-1;for(let n=0;n<this._free.length;++n){const r=this._free[n];t<=r.width&&i<=r.height&&(null===s||r.y<=s.y&&r.x<=s.x)&&(s=r,e=n)}return null===s?new vt:(this._free.splice(e,1),s.width<s.height?(s.width>t&&this._free.push(new vt(s.x+t,s.y,s.width-t,i)),s.height>i&&this._free.push(new vt(s.x,s.y+i,s.width,s.height-i))):(s.width>t&&this._free.push(new vt(s.x+t,s.y,s.width-t,s.height)),s.height>i&&this._free.push(new vt(s.x,s.y+i,t,s.height-i))),new vt(s.x,s.y,t,i))}release(t){for(let i=0;i<this._free.length;++i){const s=this._free[i];if(s.y===t.y&&s.height===t.height&&s.x+s.width===t.x)s.width+=t.width;else if(s.x===t.x&&s.width===t.width&&s.y+s.height===t.y)s.height+=t.height;else if(t.y===s.y&&t.height===s.height&&t.x+t.width===s.x)s.x=t.x,s.width+=t.width;else{if(t.x!==s.x||t.width!==s.width||t.y+t.height!==s.y)continue;s.y=t.y,s.height+=t.height}this._free.splice(i,1),this.release(t)}this._free.push(t)}}const Di=256,Pi=t=>Math.floor(t/256);function Fi(t){const i=new Set;for(const s of t)i.add(Pi(s));return i}function Ci(t,i,s){return t.has(i)||t.set(i,s().then((()=>{t.delete(i)})).catch((s=>{t.delete(i),n(s)}))),t.get(i)}const Ri=t=>({rect:new vt(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:t,sdf:!0});class Ei{constructor(t,i,s){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this._preloadCache={},this.width=t,this.height=i,this._glyphSource=s,this._binPack=new Ui(t-4,i-4),this._glyphData.push(new Uint8Array(t*i)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs()}dispose(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyphs(){const t=[117,149,181,207,207,181,149,117],i=[],s=[];for(let e=0;e<t.length;e++){const n=t[e];for(let t=0;t<11;t++){const r=e>=3&&e<5&&t>=3&&t<8?255:0;i.push(n),s.push(r)}}const e={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(i)},n={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(s)};this._recordGlyph(e),this._recordGlyph(n)}async getGlyphItems(t,i,s){const e=this._getGlyphCache(t);return await this._fetchRanges(t,i,s),i.map((i=>this._getMosaicItem(e,t,i)))}bind(t,i,s,e){const n=this._getTexture(t,s);n.setSamplingMode(i),this._dirties[s]&&(n.setData(this._glyphData[s]),this._dirties[s]=!1),t.bindTexture(n,e)}preloadASCIIGlyphCache(t){const i=this._preloadCache[t];if(null!=i)return i;const s=this._glyphSource.preloadASCIIRange(t).then((()=>{const i=this._getGlyphCache(t);for(let s=0;s<256;s++)this._getMosaicItem(i,t,s)}));return this._preloadCache[t]=s,s}_getGlyphCache(t){return this._glyphCache[t]||(this._glyphCache[t]={}),this._glyphCache[t]}_getTexture(t,i){if(!this._textures[i]){const s=new xt;s.pixelFormat=gt.ALPHA,s.wrapMode=yt.CLAMP_TO_EDGE,s.width=this.width,s.height=this.height,this._textures[i]=new _t(t,s,new Uint8Array(this.width*this.height))}return this._textures[i]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(t,i,s){const e=Fi(i),n=[];e.forEach((i=>{n.push(this._fetchRange(t,i,s))})),await Promise.all(n)}async _fetchRange(t,i,s){if(i>Di)return;const e=t+i;return Ci(this._rangePromises,e,(()=>this._glyphSource.getRange(t,i,s)))}_getMosaicItem(t,i,s){if(!t[s]){const e=this._glyphSource.getGlyph(i,s);if(!e||!e.metrics)return Ri(s);const n=this._recordGlyph(e),r=this._currentPage,h=e.metrics;t[s]={rect:n,page:r,metrics:h,code:s,sdf:!0},this._invalidate()}return t[s]}_recordGlyph(t){const i=t.metrics;let s;if(0===i.width)s=new vt(0,0,0,0);else{const e=3,n=i.width+2*e,h=i.height+2*e;s=this._binPack.allocate(n,h),s.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs(),this._binPack=new Ui(this.width-4,this.height-4),s=this._binPack.allocate(n,h));const a=this._glyphData[this._currentPage],o=t.bitmap;let c,u;if(o)for(let t=0;t<h;t++){c=n*t,u=this.width*(s.y+t)+s.x;for(let t=0;t<n;t++)a[u+t]=o[c+t]}r("esri-glyph-debug")&&this._showDebugPage(a)}return s}_showDebugPage(t){const i=document.createElement("canvas"),s=i.getContext("2d"),e=new ImageData(this.width,this.height),n=e.data;i.width=this.width,i.height=this.height,i.style.border="1px solid black";for(let i=0;i<t.length;++i)n[4*i]=t[i],n[4*i+1]=0,n[4*i+2]=0,n[4*i+3]=255;s.putImageData(e,0,0),document.body.appendChild(i)}}class Li{constructor(t){for(this._metrics=[],this._bitmaps=[];t.next();)switch(t.tag()){case 1:{const i=t.getMessage();for(;i.next();)switch(i.tag()){case 3:{const t=i.getMessage();let s,e,n,r,h,a,o;for(;t.next();)switch(t.tag()){case 1:s=t.getUInt32();break;case 2:e=t.getBytes();break;case 3:n=t.getUInt32();break;case 4:r=t.getUInt32();break;case 5:h=t.getSInt32();break;case 6:a=t.getSInt32();break;case 7:o=t.getUInt32();break;default:t.skip()}t.release(),s&&(this._metrics[s]={width:n,height:r,left:h,top:a,advance:o},this._bitmaps[s]=e);break}default:i.skip()}i.release();break}default:t.skip()}}getMetrics(t){return this._metrics[t]}getBitmap(t){return this._bitmaps[t]}}class Oi{constructor(){this._ranges=[]}getRange(t){return this._ranges[t]}addRange(t,i){this._ranges[t]=i}}class Bi{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,i,s){const e=this._getFontStack(t);if(e.getRange(i))return Promise.resolve();const n=256*i,r=n+255,a=this._baseURL.replace("{fontstack}",t).replace("{range}",n+"-"+r);return h(a,{responseType:"array-buffer",...s}).then((t=>{e.addRange(i,new Li(new St(new Uint8Array(t.data),new DataView(t.data))))}))}async preloadASCIIRange(t){const i=this._getFontStack(t),s=0,e=255,n=this._baseURL.replace("{fontstack}",t).replace("{range}",s+"-"+e),r=await h(n,{responseType:"array-buffer"}),a=new Li(new St(new Uint8Array(r.data),new DataView(r.data)));for(let t=s;t<=e;t++)i.getRange(t)||i.addRange(t,a)}getGlyph(t,i){const s=this._getFontStack(t);if(!s)return;const e=Math.floor(i/256),n=s.getRange(e);return n?{metrics:n.getMetrics(i),bitmap:n.getBitmap(i)}:void 0}_getFontStack(t){let i=this._glyphInfo[t];return i||(i=this._glyphInfo[t]=new Oi),i}}const Ni=1e20;class Gi{constructor(t){this._svg=null,this.size=t;const i=document.createElement("canvas");i.width=i.height=t,this._context=i.getContext("2d"),this._gridOuter=new Float64Array(t*t),this._gridInner=new Float64Array(t*t),this._f=new Float64Array(t),this._d=new Float64Array(t),this._z=new Float64Array(t+1),this._v=new Int16Array(t)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(t,i,s=31){this._initSVG();const e=this.createSVGString(t);return new Promise(((t,n)=>{const r=new Image;r.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(e),r.onload=()=>{r.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(r,0,0,this.size,this.size);const i=this._context.getImageData(0,0,this.size,this.size),e=new Uint8Array(this.size*this.size*4);for(let t=0;t<this.size*this.size;t++){const s=i.data[4*t+3]/255;this._gridOuter[t]=1===s?0:0===s?Ni:Math.max(0,.5-s)**2,this._gridInner[t]=1===s?Ni:0===s?0:Math.max(0,s-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let t=0;t<this.size*this.size;t++){const i=this._gridOuter[t]-this._gridInner[t];kt(.5-i/(2*s),e,4*t)}t(e)};const h=i&&i.signal;h&&a(h,(()=>n(o())))}))}_initSVG(){if(!this._svg){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("style","position: absolute;"),t.setAttribute("width","0"),t.setAttribute("height","0"),t.setAttribute("aria-hidden","true"),t.setAttribute("role","presentation"),document.body.appendChild(t),this._svg=t}return this._svg}createSVGString(t){const i=this._initSVG(),s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d",t),i.appendChild(s);const e=s.getBBox(),n=e.width/e.height,r=this.size/2;let h,a,o,c;if(n>1){a=h=r/e.width;const t=r*(1/n);o=this.size/4,c=r-t/2}else{h=a=r/e.height;o=r-r*n/2,c=this.size/4}const u=-e.x*h+o,l=-e.y*a+c;s.setAttribute("style",`transform: matrix(${h}, 0, 0, ${a}, ${u}, ${l})`);const f=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${i.innerHTML}</svg>`;return i.removeChild(s),f}_edt(t,i,s){const e=this._f,n=this._d,r=this._v,h=this._z;for(let a=0;a<i;a++){for(let n=0;n<s;n++)e[n]=t[n*i+a];this._edt1d(e,n,r,h,s);for(let e=0;e<s;e++)t[e*i+a]=n[e]}for(let a=0;a<s;a++){for(let s=0;s<i;s++)e[s]=t[a*i+s];this._edt1d(e,n,r,h,i);for(let s=0;s<i;s++)t[a*i+s]=Math.sqrt(n[s])}}_edt1d(t,i,s,e,n){s[0]=0,e[0]=-Ni,e[1]=+Ni;for(let i=1,r=0;i<n;i++){let n=(t[i]+i*i-(t[s[r]]+s[r]*s[r]))/(2*i-2*s[r]);for(;n<=e[r];)r--,n=(t[i]+i*i-(t[s[r]]+s[r]*s[r]))/(2*i-2*s[r]);r++,s[r]=i,e[r]=n,e[r+1]=+Ni}for(let r=0,h=0;r<n;r++){for(;e[h+1]<r;)h++;i[r]=(r-s[h])*(r-s[h])+t[s[h]]}}}function Vi(t){return t&&"static"===t.type}class qi{constructor(t,i,s=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=i,s>0&&(this._maxItemSize=s),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new Ui(this._pageWidth,this._pageHeight);const e=Math.floor(this._pageWidth),n=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(e*n)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]}getHeight(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]}getPageTexture(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null}has(t){return this._mosaicRects.has(t)}get itemCount(){return this._mosaicRects.size}getSpriteItem(t){return this._mosaicRects.get(t)}addSpriteItem(t,i,s,e,n,h,a=1){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let o,c,u;if(Vi(s))[o,c,u]=this._allocateImage(i[0],i[1]);else{o=new vt(0,0,i[0],i[1]),c=this._mosaicPages.length;const t=void 0;this._mosaicPages.push({mosaicsData:s,size:[i[0]+2*W,i[1]+2*W],dirty:!0,texture:t})}if(o.width<=0||o.height<=0)return null;const l={rect:o,width:i[0],height:i[1],sdf:n,simplePattern:h,pixelRatio:a,page:c};return this._mosaicRects.set(t,l),Vi(s)&&(r("esri-mosaic-debug")&&this._showDebugSprite(i,s.data),this._copy({rect:o,spriteSize:i,spriteData:s.data,page:c,pageSize:u,repeat:e,sdf:n})),l}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)}getSpriteItems(t){const i={};for(const s of t)i[s]=this.getSpriteItem(s);return i}getMosaicItemPosition(t){const i=this.getSpriteItem(t),s=i&&i.rect;if(!s)return null;s.width=i.width,s.height=i.height;const e=i.width,n=i.height,r=W,h=this._mosaicPages[i.page].size;return{size:[i.width,i.height],tl:[(s.x+r)/h[0],(s.y+r)/h[1]],br:[(s.x+r+e)/h[0],(s.y+r+n)/h[1]],page:i.page}}bind(t,i,s=0,e=0){const n=this._mosaicPages[s],h=n.mosaicsData;let a=n.texture;if(a||(a=Zi(t,n.size),n.texture=a),a.setSamplingMode(i),Vi(h))t.bindTexture(a,e),n.dirty&&(a.setData(new Uint8Array(h.data.buffer)),a.generateMipmap(),r("esri-mosaic-debug")&&this._showDebugPage(s));else{h.data.bindFrame(t,a,e),a.generateMipmap()}n.dirty=!1}dispose(){this._binPack=null;for(const t of this._mosaicPages){const i=t.texture;i&&i.dispose();const s=t.mosaicsData;if(!Vi(s)){s.data.destroy()}}this._mosaicPages=null,this._mosaicRects.clear()}static _copyBits(t,i,s,e,n,r,h,a,o,c,u){let l=e*i+s,f=a*r+h;if(u){f-=r;for(let h=-1;h<=c;h++,l=((h+c)%c+e)*i+s,f+=r)for(let i=-1;i<=o;i++)n[f+i]=t[l+(i+o)%o]}else for(let s=0;s<c;s++){for(let i=0;i<o;i++)n[f+i]=t[l+i];l+=i,f+=r}}_copy(t){if(t.page>=this._mosaicPages.length)return;const i=this._mosaicPages[t.page],s=i.mosaicsData;if(!Vi(i.mosaicsData))throw new c("mapview-invalid-resource","unsuitable data type!");const e=t.spriteData,n=s.data;n&&e||console.error("Source or target images are uninitialized!"),qi._copyBits(e,t.spriteSize[0],0,0,n,t.pageSize[0],t.rect.x+W,t.rect.y+W,t.spriteSize[0],t.spriteSize[1],t.repeat),i.dirty=!0}_allocateImage(t,i){t+=2*W,i+=2*W;const s=Math.max(t,i);if(this._maxItemSize&&this._maxItemSize<s){const s=2**Math.ceil(At(t)),e=2**Math.ceil(At(i)),n=new vt(0,0,t,i);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(s*e)},size:[s,e],dirty:!0,texture:void 0}),[n,this._mosaicPages.length-1,[s,e]]}const e=this._binPack.allocate(t,i);if(e.width<=0){const s=this._mosaicPages[this._currentPage];return!s.dirty&&Vi(s.mosaicsData)&&(s.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new Ui(this._pageWidth,this._pageHeight),this._allocateImage(t,i)}return[e,this._currentPage,[this._pageWidth,this._pageHeight]]}_showDebugSprite([t,i],s){const e=document.createElement("canvas");e.width=t,e.height=i,e.setAttribute("style",`position: absolute; top: ${4+204*Hi++}px; right: 208px; width: 200px; height: 200px; border: 1px solid black;`);const n=e.getContext("2d"),r=new ImageData(t,i);r.data.set(new Uint8Array(s.buffer)),n.putImageData(r,0,0),document.body.appendChild(e)}_showDebugPage(t){const i=this._mosaicPages[t],{size:[s,e],mosaicsData:n}=i;if(!Vi(n))return void console.error("Could not show sprite mosaic debug for non-static resource");const r=`mosaicDebugPage${t}`,h=document.getElementById(r)??document.createElement("canvas");h.id=r,h.width=s,h.height=e,h.setAttribute("style",`position: absolute; top: ${4+204*t}px; right: 4px; width: 200px; height: 200px; border: 1px solid black;`);const a=h.getContext("2d"),o=new ImageData(s,e);o.data.set(new Uint8Array(n.data.buffer)),a.putImageData(o,0,0),document.body.appendChild(h)}}let Hi=0;function Zi(t,i){const s=new xt;return s.width=i[0],s.height=i[1],s.wrapMode=yt.CLAMP_TO_EDGE,new _t(t,s,null)}function Xi(t){return u(t.frameDurations.reduce(((t,i)=>t+i),0))}function Yi(t){const{width:i,height:s}=t;return{frameDurations:t.frameDurations.reverse(),getFrame:i=>{const s=t.frameDurations.length-1-i;return t.getFrame(s)},width:i,height:s}}function Wi(t,i){const{width:s,height:e,getFrame:n}=t,r=i/Xi(t);return{frameDurations:t.frameDurations.map((t=>u(t*r))),getFrame:n,width:s,height:e}}function Ji(t,i){const{width:s,height:e,getFrame:n}=t,r=t.frameDurations.slice(),h=r.shift();return r.unshift(u(h+i)),{frameDurations:r,getFrame:n,width:s,height:e}}function Ki(t,i){const{width:s,height:e,getFrame:n}=t,r=t.frameDurations.slice(),h=r.pop();return r.push(u(h+i)),{frameDurations:r,getFrame:n,width:s,height:e}}class Qi{constructor(t,i,s,e){this._animation=t,this._repeatType=s,this._onFrameData=e,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];let n=0;for(;i>n;)n+=this.timeToFrame,this.nextFrame();const r=this._animation.getFrame(this._currentFrame);this._onFrameData(r)}nextFrame(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case It.None:this._currentFrame-=this._direction;break;case It.Loop:this._currentFrame=0;break;case It.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(-1===this._currentFrame)switch(this._repeatType){case It.None:this._currentFrame-=this._direction;break;case It.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case It.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame];const t=this._animation.getFrame(this._currentFrame);this._onFrameData(t)}}function ts(t,i,s,e){let n,{repeatType:r}=i;if(null==r&&(r=It.Loop),!0===i.reverseAnimation&&(t=Yi(t)),null!=i.duration&&(t=Wi(t,u(1e3*i.duration))),null!=i.repeatDelay){const s=1e3*i.repeatDelay;r===It.Loop?t=Ki(t,u(s)):r===It.Oscillate&&(t=Ji(Ki(t,u(s/2)),u(s/2)))}if(null!=i.startTimeOffset)n=u(1e3*i.startTimeOffset);else if(null!=i.randomizeStartTime){const e=L(s),r=82749913,h=null!=i.randomizeStartSeed?i.randomizeStartSeed:r,a=O(e,h);n=u(a*Xi(t))}else n=u(0);return new Qi(t,n,r,e)}function is(t,i,s,e){const n=null==i.playAnimation||i.playAnimation,r=ts(t,i,s,e);let h,a=r.timeToFrame;function o(){h=n?setTimeout((()=>{r.nextFrame(),a=r.timeToFrame,o()}),a):void 0}return o(),{remove:()=>{n&&clearTimeout(h)}}}const ss=document.createElement("canvas"),es=ss.getContext("2d");function ns(t,i,s){ss.width=i,ss.height=s;const e=[],n=t.frameDurations.length;for(let r=0;r<n;r++){const n=t.getFrame(r);es.clearRect(0,0,i,s),n instanceof ImageData?es.drawImage(zt(n),0,0,i,s):es.drawImage(n,0,0,i,s),e.push(es.getImageData(0,0,i,s))}return{width:i,height:s,frameDurations:t.frameDurations,getFrame:t=>e[t]}}class rs{constructor(t,i,s,e){this._animation=t,this._frameData=null;const n=t=>{this._frameData=t,i.requestRender()};this.frameCount=this._animation.frameDurations.length,this.width=this._animation.width,this.height=this._animation.height,this._playHandle=is(this._animation,s,e,n)}destroy(){this._playHandle.remove()}bindFrame(t,i,s){t.bindTexture(i,s),null!=this._frameData&&(i.updateData(0,W,W,this._frameData.width,this._frameData.height,this._frameData),this._frameData=null)}}function hs(t){switch(t.type){case"esriSMS":return`${t.style}.${t.path}`;case"esriSLS":return`${t.style}.${t.cap}`;case"esriSFS":return`${t.style}`;case"esriPFS":case"esriPMS":return t.imageData?`${t.imageData}${t.width}${t.height}`:`${t.url}${t.width}${t.height}`;default:return"mosaicHash"in t?t.mosaicHash:JSON.stringify(t)}}const as=H(),os="arial-unicode-ms-regular",cs=l.getLogger("esri.views.2d.engine.webgl.TextureManager");function us(t,i){const s=Math.round(w(i)*window.devicePixelRatio),e=s>=128?2:4;return Math.min(t,s*e)}const ls=(t,i,s)=>cs.error(new c(t,i,s));class fs{static fromMosaic(t,i){return new fs(t,i.page,i.sdf)}constructor(t,i,s){this.mosaicType=t,this.page=i,this.sdf=s}}class ds{constructor(t,i,s){this._requestRender=t,this.resourceManager=i,this._allowNonPowerOfTwo=s,this._invalidFontsMap=new Map,this._sdfConverter=new Gi(J),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new Tt({concurrency:10,process:async(t,i)=>{f(i);try{return await h(t,{responseType:"image",signal:i})}catch(i){if(!d(i))throw new c("mapview-invalid-resource",`Could not fetch requested resource at ${t}`,i);throw i}}}),this._spriteMosaic=new qi(2048,2048,500),this._glyphSource=new Bi(`${m.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new Ei(1024,1024,this._glyphSource),this._rasterizer=new Ti(i)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}async rasterizeItem(t,i,s,e){if(null==t)return ls("mapview-null-resource","Unable to rasterize null resource"),null;switch(t.type){case"text":case"esriTS":{const i=await this._rasterizeText(t,s,e);return i.forEach((t=>this._setTextureBinding(nt.GLYPH,t))),{glyphMosaicItems:i}}default:{if(et(t))return ls("mapview-invalid-type",`MapView does not support symbol type: ${t.type}`,t),null;const s=await this._rasterizeSpriteSymbol(t,i,e);return jt(s)&&s&&this._setTextureBinding(nt.SPRITE,s),{spriteMosaicItem:s}}}}bindTextures(t,i,s,e=!1){if(0===s.textureBinding)return;const n=this._bindingInfos[s.textureBinding-1],r=n.page,h=e?bt.LINEAR_MIPMAP_LINEAR:bt.LINEAR;switch(n.mosaicType){case nt.SPRITE:{const s=this.sprites.getWidth(r),e=this.sprites.getHeight(r),n=G(as,s,e);return this._spriteMosaic.bind(t,h,r,Q),i.setUniform1i("u_texture",Q),void i.setUniform2fv("u_mosaicSize",n)}case nt.GLYPH:{const s=this.glyphs.width,e=this.glyphs.height,n=G(as,s,e);return this._glyphMosaic.bind(t,h,r,K),i.setUniform1i("u_texture",K),void i.setUniform2fv("u_mosaicSize",n)}default:cs.error("mapview-texture-manager",`Cannot handle unknown type ${n.mosaicType}`)}}_hashMosaic(t,i){return 1|t<<1|(i.sdf?1:0)<<2|i.page<<3}_setTextureBinding(t,i){const s=this._hashMosaic(t,i);if(!this._hashToBindingIndex.has(s)){const e=fs.fromMosaic(t,i),n=this._bindingInfos.length+1;this._hashToBindingIndex.set(s,n),this._bindingInfos.push(e)}i.textureBinding=this._hashToBindingIndex.get(s)}async _rasterizeText(t,i,s){let e,n;if("cim"in t){const i=t;e=i.fontName,n=i.text}else{const i=t;e=B(i.font),n=i.text}const h=this._invalidFontsMap.has(e),a=i||rt(N(n)[0]);try{const t=h?os:e;return r("esri-2d-stabilize-glyphs")&&await this._glyphMosaic.preloadASCIIGlyphCache(t),await this._glyphMosaic.getGlyphItems(t,a,s)}catch(t){return ls("mapview-invalid-resource",`Couldn't find font ${e}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(e,!0),this._glyphMosaic.getGlyphItems(os,a,s)}}async _rasterizeSpriteSymbol(t,i,s){if(ht(t))return;const e=hs(t);if(this._spriteMosaic.has(e))return this._spriteMosaic.getSpriteItem(e);if(at(t)||ot(t)&&!ct(t))return this._handleAsyncResource(e,t,s);const n=tt,r=this._rasterizer.rasterizeJSONResource(t,n);if(r){const{size:i,image:s,sdf:n,simplePattern:h,rasterizationScale:a}=r;return this._addItemToMosaic(e,i,{type:"static",data:s},ut(t),n,h,a)}return new c("TextureManager","unrecognized or null rasterized image")}async _handleAsyncResource(t,i,s){if(this._ongoingRasterizations.has(t))return this._ongoingRasterizations.get(t);let e;e=at(i)?this._handleSVG(i,t,s):this._handleImage(i,t,s),this._ongoingRasterizations.set(t,e);try{await e,this._ongoingRasterizations.delete(t)}catch{this._ongoingRasterizations.delete(t)}return e}async _handleSVG(t,i,s){const e=[J,J],n=await this._sdfConverter.draw(t.path,s);return this._addItemToMosaic(i,e,{type:"static",data:new Uint32Array(n.buffer)},!1,!0,!0)}async _handleGIFOrPNG(t,i,s){const n=mt(t);await this.resourceManager.fetchResource(n,s);let r=this.resourceManager.getResource(n);if(null==r)return new c("mapview-invalid-resource",`Could not fetch requested resource at ${n}.`);let h=r.width,a=r.height;if(r instanceof HTMLImageElement){"esriPMS"===t.type&&(h=Math.round(us(r.width,wt(t))),a=Math.round(r.height*(h/r.width)));const s="cim"in t?t.cim.colorSubstitutions:void 0,{size:e,sdf:n,image:o}=this._rasterizer.rasterizeImageResource(h,a,r,s);return this._addItemToMosaic(i,e,{type:"static",data:o},ut(t),n,!1)}this._allowNonPowerOfTwo||(h=e(r.width+2*W)-2*W,a=e(r.height+2*W)-2*W),h===r.width&&a===r.height||(r=ns(r,h,a));const o=t.animatedSymbolProperties||{},u=t.objectId,l=new rs(r,this._requestRender,o,u);return this._addItemToMosaic(i,[l.width,l.height],{type:"animated",data:l},ut(t),!1,!1)}async _handleImage(t,i,s){if(lt(t)||ft(t))return this._handleGIFOrPNG(t,i,s);const e=mt(t);try{let n;const r=this.resourceManager.getResource(e);if(null!=r&&r instanceof HTMLImageElement)n=r;else{const{data:t}=await this._imageRequestQueue.push(e,{...s});n=t}if(dt(e))if("width"in t&&"height"in t)n.width=w(t.width),n.height=w(t.height);else if("cim"in t){const i=t.cim;n.width=w(i.width??i.scaleX*i.size),n.height=w(i.size)}if(!n.width||!n.height)return null;let h=n.width,a=n.height;"esriPMS"===t.type&&(h=Math.round(us(n.width,wt(t))),a=Math.round(n.height*(h/n.width)));const o="cim"in t?t.cim.colorSubstitutions:void 0,{size:c,sdf:u,image:l}=this._rasterizer.rasterizeImageResource(h,a,n,o);return this._addItemToMosaic(i,c,{type:"static",data:l},ut(t),u,!1)}catch(t){if(!d(t))return new c("mapview-invalid-resource",`Could not fetch requested resource at ${e}. ${t.message}`)}}_addItemToMosaic(t,i,s,e,n,r,h){return this._spriteMosaic.addSpriteItem(t,i,s,e,n,r,h)}}const ms={shaders:{vertexShader:i("stencil/stencil.vert"),fragmentShader:i("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])};const ws=t=>t.replace("-","_").toUpperCase(),ps=t=>`#define ${ws(t)}\n`;function vs(t){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:ps(t)+i("blend/blend.vert"),fragmentShader:ps(t)+i("blend/blend.frag")}}}const gs=l.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class ys{constructor(){this._size=[0,0]}dispose(t){this._backBufferTexture=p(this._backBufferTexture),this._quad=p(this._quad)}draw(t,i,s,e,n){const{context:r,drawPhase:h}=t;if(this._setupShader(r),e&&"normal"!==e&&h!==pt.LABEL)return void this._drawBlended(t,i,s,e,n);const a=vs("normal"),o=r.programCache.acquire(a.shaders.vertexShader,a.shaders.fragmentShader,a.attributes);if(!o)return void gs.error(new c("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));r.useProgram(o),i.setSamplingMode(s),r.bindTexture(i,0),o.setUniform1i("u_layerTexture",0),o.setUniform1f("u_opacity",n),r.setBlendingEnabled(!0),r.setBlendFunction(Mt.ONE,Mt.ONE_MINUS_SRC_ALPHA);const u=this._quad;u.draw(),u.unbind(),o.dispose()}_drawBlended(t,i,s,e,n){const{context:r,state:h,pixelRatio:a,inFadeTransition:o}=t,{size:u}=h,l=r.getBoundFramebufferObject();let f,d;null!=l?(f=l.width,d=l.height):(f=Math.round(a*u[0]),d=Math.round(a*u[1])),this._createOrResizeTexture(t,f,d);const m=this._backBufferTexture;l.copyToTexture(0,0,f,d,0,0,m),r.setStencilTestEnabled(!1),r.setStencilWriteMask(0),r.setBlendingEnabled(!0),r.setDepthTestEnabled(!1),r.setDepthWriteEnabled(!1);const w=vs(e),p=r.programCache.acquire(w.shaders.vertexShader,w.shaders.fragmentShader,w.attributes);if(!p)return void gs.error(new c("mapview-BlendEffect",`Error creating shader program for blend mode ${e}`));r.useProgram(p),m.setSamplingMode(s),r.bindTexture(m,0),p.setUniform1i("u_backbufferTexture",0),i.setSamplingMode(s),r.bindTexture(i,1),p.setUniform1i("u_layerTexture",1),p.setUniform1f("u_opacity",n),p.setUniform1f("u_inFadeOpacity",o?1:0),r.setBlendFunction(Mt.ONE,Mt.ZERO);const v=this._quad;v.draw(),v.unbind(),p.dispose(),r.setBlendFunction(Mt.ONE,Mt.ONE_MINUS_SRC_ALPHA)}_setupShader(t){this._quad||(this._quad=new s(t,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(t,i,s){const{context:e}=t;if(null===this._backBufferTexture||i!==this._size[0]||s!==this._size[1]){if(this._backBufferTexture)this._backBufferTexture.resize(i,s);else{const t=new xt;t.internalFormat=gt.RGBA,t.wrapMode=yt.CLAMP_TO_EDGE,t.width=i,t.height=s,this._backBufferTexture=new _t(e,t)}this._size[0]=i,this._size[1]=s}}}const bs={shaders:{vertexShader:i("highlight/textured.vert"),fragmentShader:i("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},Ms={shaders:{vertexShader:i("highlight/textured.vert"),fragmentShader:i("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])};const _s=r("esri-2d-profiler");class xs{constructor(t,i){if(this._events=new v,this._entries=new Map,this._timings=new $t(10),this._currentContainer=null,this._currentPass=null,this._currentBrush=null,this._currentSummary=null,!_s)return;this._ext=Ut(t.gl,{}),this._debugOutput=i;const s=t.gl;if(!this.enableCommandLogging)return;let e;for(e in s)if("function"==typeof s[e]){const t=s[e],i=e.includes("draw");s[e]=(...n)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:e,args:n,isDrawCommand:i}),this._currentSummary&&(this._currentSummary.commands++,i&&this._currentSummary.drawCommands++),t.apply(s,n))}}get enableCommandLogging(){return!("object"==typeof _s&&_s.disableCommands)}recordContainerStart(t){_s&&(this._currentContainer=t)}recordContainerEnd(){_s&&(this._currentContainer=null)}recordPassStart(t){_s&&(this._currentPass=t,this._initSummary())}recordPassEnd(){_s&&(this._currentPass=null,this._emitSummary())}recordBrushStart(t){_s&&(this._currentBrush=t)}recordBrushEnd(){_s&&(this._currentBrush=null)}recordStart(t){if(_s&&null!=this._ext){if(this._entries.has(t)){const i=this._entries.get(t),s=this._ext.resultAvailable(i.query),e=this._ext.disjoint();if(s&&!e){const s=this._ext.getResult(i.query)/1e6;let e=0;if(null!=this._timings.enqueue(s)){const t=this._timings.entries,i=t.length;let s=0;for(const i of t)s+=i;e=s/i}const n=s.toFixed(2),r=e?e.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${t}, ${n} ms (${r} last 10 avg)\n${i.commandsLen} Commands (${i.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(i.summaries),console.log("Commands: ",i.commands),console.groupEnd()):console.log(`Frame report for ${t}, ${n} ms (${r} last 10 avg)`),this._debugOutput.innerHTML=`${n} (${r})`}for(const t of i.handles)t.remove();this._ext.deleteQuery(i.query),this._entries.delete(t)}const i={name:t,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(i.handles.push(this._events.on("command",(t=>{i.commandsLen++,i.commands.push(t),t.isDrawCommand&&i.drawCommands++}))),i.handles.push(this._events.on("summary",(t=>{i.summaries.push(t)})))),this._ext.beginTimeElapsed(i.query),this._entries.set(t,i)}}recordEnd(t){_s&&null!=this._ext&&this._entries.has(t)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._currentSummary&&this._events.emit("summary",this._currentSummary)}}const Ss=2,ks=1,As=0,zs=1,Is=2;class js{constructor(t,i,s){this._debugMap=new Map,this._width=t*s,this._height=i*s,this._pixelRatio=s;const e=Math.ceil(this._width/ks),n=Math.ceil(this._height/ks);this._cols=e,this._rows=n,this._cells=Pt.create(e*n)}insertMetrics(t){const i=this._hasCollision(t);return i===As&&this._markMetrics(t),i}getCellId(t,i){return t+i*this._cols}has(t){return this._cells.has(t)}hasRange(t,i){return this._cells.hasRange(t,i)}set(t){this._cells.set(t)}setRange(t,i){this._cells.setRange(t,i)}_collide(t,i,s,e){const n=t-s/2,r=i-e/2,h=n+s,a=r+e;if(h<0||a<0||n>this._width||r>this._height)return zs;const o=g(Math.floor(n/ks),0,this._cols),c=g(Math.floor(r/ks),0,this._rows),u=g(Math.ceil(h/ks),0,this._cols),l=g(Math.ceil(a/ks),0,this._rows);for(let t=c;t<=l;t++)for(let i=o;i<=u;i++){const s=this.getCellId(i,t);if(this.has(s))return Is}return As}_mark(t,i,s,e,n){const r=t-s/2,h=i-e/2,a=r+s,o=h+e,c=g(Math.floor(r/ks),0,this._cols),u=g(Math.floor(h/ks),0,this._rows),l=g(Math.ceil(a/ks),0,this._cols),f=g(Math.ceil(o/ks),0,this._rows);for(let t=u;t<=f;t++)for(let i=c;i<=l;i++){const s=this.getCellId(i,t);this._debugMap.set(s,n),this.set(s)}return!1}_hasCollision(t){const i=t.id;let s=0,e=0;t.save();do{const i=t.boundsCount;s+=i;for(let s=0;s<i;s++){const i=t.boundsComputedAnchorX(s),n=t.boundsComputedAnchorY(s),r=(t.boundsWidth(s)+Ss)*this._pixelRatio,h=(t.boundsHeight(s)+Ss)*this._pixelRatio;switch(this._collide(i,n,r,h)){case Is:return Is;case zs:e++}}}while(t.peekId()===i&&t.next());return t.restore(),s===e?zs:As}_markMetrics(t){const i=t.id;t.save();do{const i=t.boundsCount;for(let s=0;s<i;s++){const i=t.boundsComputedAnchorX(s),e=t.boundsComputedAnchorY(s),n=(t.boundsWidth(s)+Ss)*this._pixelRatio,r=(t.boundsHeight(s)+Ss)*this._pixelRatio;this._mark(i,e,n,r,t.id)}}while(t.peekId()===i&&t.next());t.restore()}}const Ts=254,$s=255,Us=0;function Ds(t,i){const s=[];t.forEachTile((t=>s.push(t))),s.sort(((t,i)=>t.instanceId-i.instanceId)),s.forEach((t=>{null!=t.labelMetrics&&t.isReady&&i(t,t.labelMetrics.getCursor())}))}class Ps{run(t,i,s){const e=[];for(let i=t.length-1;i>=0;i--){const s=t[i];s.labelingCollisionInfos&&e.push(...s.labelingCollisionInfos)}this._transformMetrics(e),this._runCollision(e,i,s)}_runCollision(t,i,s){const[e,n]=i.state.size,r=new js(e,n,i.pixelRatio);for(const{tileRenderer:i,deconflictionEnabled:e,visible:n}of t){const t=i.featuresView.attributeView;e?n?(this._prepare(i),this._collideVisible(r,i,s),this._collideInvisible(r,i)):Ds(i,((i,s)=>{for(;s.nextId();)t.setLabelMinZoom(s.id,$s)})):Ds(i,((i,s)=>{for(;s.nextId();)t.setLabelMinZoom(s.id,Us),n&&r.insertMetrics(s)}))}}_isFiltered(t,i,s){const e=i.getFilterFlags(t),n=!s.hasFilter||!!(e&it),r=null==s.featureEffect||s.featureEffect.excludedLabelsVisible||!!(e&st);return!(n&&r)}_prepare(t){const i=t.featuresView.attributeView,s=new Set;Ds(t,((e,n)=>{for(;n.nextId();){if(s.has(n.id))continue;if(s.add(n.id),this._isFiltered(n.id,i,t.layerView)){i.setLabelMinZoom(n.id,Ts);continue}i.getLabelMinZoom(n.id)!==Us?i.setLabelMinZoom(n.id,$s):i.setLabelMinZoom(n.id,Us)}}))}_collideVisible(t,i,s){const e=i.featuresView.attributeView,n=new Set;Ds(i,((i,r)=>{for(;r.nextId();)if(!n.has(r.id))if(i.key.level===s){if(0===e.getLabelMinZoom(r.id)){switch(t.insertMetrics(r)){case zs:break;case Is:e.setLabelMinZoom(r.id,Ts),n.add(r.id);break;case As:e.setLabelMinZoom(r.id,Us),n.add(r.id)}}}else e.setLabelMinZoom(r.id,Ts)}))}_collideInvisible(t,i){const s=i.featuresView.attributeView,e=new Set;Ds(i,((i,n)=>{for(;n.nextId();)if(!e.has(n.id)&&s.getLabelMinZoom(n.id)===$s){switch(t.insertMetrics(n)){case zs:break;case Is:s.setLabelMinZoom(n.id,$s),e.add(n.id);break;case As:s.setLabelMinZoom(n.id,Us),e.add(n.id)}}}))}_transformMetrics(t){for(const{tileRenderer:i,geometryType:s,vvEvaluators:e}of t)Ds(i,((t,n)=>{const r=i.featuresView.attributeView,h=t.transforms.labelMat2d;h[4]=Math.round(h[4]),h[5]=Math.round(h[5]);const a="polyline"===s;for(;n.next();){const t=n.boundsCount,i=n.anchorX,s=n.anchorY;let o=n.size;const c=e[0];if(null!=c){const t=c(r.getVVSize(n.id));o=isNaN(t)||null==t||t===1/0?o:t}const u=n.directionX*(o/2),l=n.directionY*(o/2);for(let e=0;e<t;e++){let t=i,r=n.anchorY;if(a){let i=t+n.boundsX(e)+u,s=r+n.boundsY(e)+l;i=h[0]*i+h[2]*s+h[4],s=h[1]*i+h[3]*s+h[5],n.setBoundsComputedAnchorX(e,Math.floor(i)),n.setBoundsComputedAnchorY(e,Math.floor(s))}else{t=h[0]*i+h[2]*s+h[4],r=h[1]*i+h[3]*s+h[5];const a=t+n.boundsX(e)+u,o=r+n.boundsY(e)+l;n.setBoundsComputedAnchorX(e,a),n.setBoundsComputedAnchorY(e,o)}}}}))}}const Fs=32;let Cs=class extends(y(b)){constructor(t){super(t),this.collisionEngine=new Ps,this.lastUpdateId=-1,this.updateRequested=!1,this.view=null,this._applyVisibilityPass=Dt((t=>{const i=this.view;if(i)try{const s=i.featuresTilingScheme.getClosestInfoForScale(t.state.scale).level;this.collisionEngine.run(i.allLayerViews.items,t,s)}catch(t){}}),Fs,this),this.addHandles(this._applyVisibilityPass)}get updating(){return r("esri-2d-log-updating")&&console.log(`Updating LabelManager ${this.updateRequested}:\n-> updateRequested: ${this.updateRequested}`),this.updateRequested}update(t){this._applyVisibilityPass(t)}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view?.requestUpdate())}processUpdate(t){this.updateRequested&&(this.updateRequested=!1,this.update(t))}};M([_()],Cs.prototype,"updateRequested",void 0),M([_()],Cs.prototype,"updating",null),M([_()],Cs.prototype,"view",void 0),Cs=M([x("esri.views.2d.LabelManager")],Cs);const Rs="esri-zoom-box",Es={container:`${Rs}__container`,overlay:`${Rs}__overlay`,background:`${Rs}__overlay-background`,box:`${Rs}__outline`},Ls={zoom:"Shift",counter:"Ctrl"};let Os=class extends b{constructor(t){super(t),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._rafId=null,this._handles=null,this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(t){this._handles&&this._handles.forEach((t=>{t.remove()})),this._handles=null,this._destroyOverlay(),this._set("view",t),t&&(t.on("drag",[Ls.zoom],(t=>this._handleDrag(t,1)),Ft.INTERNAL),t.on("drag",[Ls.zoom,Ls.counter],(t=>this._handleDrag(t,-1)),Ft.INTERNAL))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(t,i,s,e){this._box.x=t,this._box.y=i,this._box.width=s,this._box.height=e,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(t,i,s,e,n){const r=this.view,h=r.toMap(S(t+.5*s,i+.5*e));let a=Math.max(s/r.width,e/r.height);-1===n&&(a=1/a),this._destroyOverlay(),this.navigation.end(),r.goTo({center:h,scale:r.scale*a})}_updateBox(t,i,s,e){const n=this._boxShape;n.setAttributeNS(null,"x",""+t),n.setAttributeNS(null,"y",""+i),n.setAttributeNS(null,"width",""+s),n.setAttributeNS(null,"height",""+e),n.setAttributeNS(null,"class",Es.box)}_updateBackground(t,i,s,e){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(t,i,s,e,this.view.width,this.view.height))}_createContainer(){const t=document.createElement("div");t.className=Es.container,this.view.root.appendChild(t),this._container=t}_createOverlay(){const t=this.view.width,i=this.view.height,s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttributeNS(null,"d","M 0 0 L "+t+" 0 L "+t+" "+i+" L 0 "+i+" Z"),s.setAttributeNS(null,"class",Es.background);const e=document.createElementNS("http://www.w3.org/2000/svg","rect"),n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttributeNS(null,"class",Es.overlay),n.appendChild(s),n.appendChild(e),this._container.appendChild(n),this._backgroundShape=s,this._boxShape=e,this._overlay=n}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(t,i,s,e,n,r){const h=t+s,a=i+e;return"M 0 0 L "+n+" 0 L "+n+" "+r+" L 0 "+r+" ZM "+t+" "+i+" L "+t+" "+a+" L "+h+" "+a+" L "+h+" "+i+" Z"}_handleDrag(t,i){const s=t.x,e=t.y,n=t.origin.x,r=t.origin.y;let h,a,o,c;switch(s>n?(h=n,o=s-n):(h=s,o=n-s),e>r?(a=r,c=e-r):(a=e,c=r-e),t.action){case"start":this._start();break;case"update":this._update(h,a,o,c);break;case"end":this._end(h,a,o,c,i)}t.stopPropagation()}_redraw(){if(!this._rafId)return;if(this._rafId=null,!this._overlay)return;const{x:t,y:i,width:s,height:e}=this._box;this._updateBox(t,i,s,e),this._updateBackground(t,i,s,e),this._rafId=requestAnimationFrame(this._redraw)}};M([_()],Os.prototype,"navigation",void 0),M([_()],Os.prototype,"view",null),Os=M([x("esri.views.2d.navigation.ZoomBox")],Os);const Bs=Os;class Ns{constructor(t){this._gain=t,this.lastValue=void 0,this.filteredDelta=void 0}update(t){if(this.hasLastValue()){const i=this.computeDelta(t);this._updateDelta(i)}this.lastValue=t}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return void 0!==this.lastValue}hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(t){return void 0===this.lastValue?NaN:t-this.lastValue}_updateDelta(t){void 0!==this.filteredDelta?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*t:this.filteredDelta=t}}class Gs{constructor(t,i,s){this._initialVelocity=t,this._stopVelocity=i,this._friction=s,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(t){return t>this.duration}get friction(){return this._friction}value(t){return this.valueFromInitialVelocity(this._initialVelocity,t)}valueDelta(t,i){const s=this.value(t);return this.value(t+i)-s}valueFromInitialVelocity(t,i){i=Math.min(i,this.duration);const s=1-this.friction;return t*(s**i-1)/Math.log(s)}}class Vs extends Gs{constructor(t,i,s,e,n){super(t,i,s),this._sceneVelocity=e,this.direction=n}value(t){return super.valueFromInitialVelocity(this._sceneVelocity,t)}}class qs{constructor(t=300,i=12,s=.84){this._minimumInitialVelocity=t,this._stopVelocity=i,this._friction=s,this.enabled=!0,this._time=new Ns(.6),this._screen=[new Ns(.4),new Ns(.4)],this._scene=[new Ns(.6),new Ns(.6),new Ns(.6)],this._tmpDirection=k()}add(t,i,s){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(s)<.015)return}this._screen[0].update(t[0]),this._screen[1].update(t[1]),this._scene[0].update(i[0]),this._scene[1].update(i[1]),this._scene[2].update(i[2]),this._time.update(s)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const t=this._screen[0].filteredDelta,i=this._screen[1].filteredDelta,s=null==t||null==i?0:Math.sqrt(t*t+i*i),e=this._time.filteredDelta,n=null==e||null==s?0:s/e;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(t,i,s){A(this._tmpDirection,this._scene[0].filteredDelta??0,this._scene[1].filteredDelta??0,this._scene[2].filteredDelta??0);const e=I(this._tmpDirection);e>0&&z(this._tmpDirection,this._tmpDirection,1/e);const n=this._time.filteredDelta;return new Vs(t,i,s,null==n?0:e/n,this._tmpDirection)}}let Hs=class extends b{constructor(t){super(t),this.animationTime=0,this.momentumEstimator=new qs(500,6,.92),this.momentum=null,this.tmpMomentum=k(),this.momentumFinished=!1,this.viewpoint=new Ct({targetGeometry:new j,scale:0,rotation:0}),this._previousDrag=null,T((()=>this.momentumFinished),(()=>this.navigation.stop()))}begin(t,i){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(i),this._previousDrag=i}update(t,i){this.addToEstimator(i);let s=i.center.x,e=i.center.y;const n=this._previousDrag;s=n?n.center.x-s:-s,e=n?e-n.center.y:e,t.viewpoint=Rt(this.viewpoint,t.viewpoint,[s||0,e||0]),this._previousDrag=i}end(t,i){this.addToEstimator(i);const s=t.navigation.momentumEnabled;this.momentum=s?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(t),this._previousDrag=null,this.navigation.end()}addToEstimator(t){const i=t.center.x,s=t.center.y,e=$(-i,s),n=U(-i,s,0);this.momentumEstimator.add(e,n,.001*t.timestamp)}onAnimationUpdate(t){this.navigation.animationManager?.animateContinous(t.viewpoint,((i,s)=>{const{momentum:e,animationTime:n,tmpMomentum:r}=this,h=.001*s;if(!(this.momentumFinished=!e||e.isFinished(n))){const s=e.valueDelta(n,h);z(r,e.direction,s),Rt(i,i,r),t.constraints.constrainByGeometry(i)}this.animationTime+=h}))}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};M([_()],Hs.prototype,"momentumFinished",void 0),M([_()],Hs.prototype,"viewpoint",void 0),M([_()],Hs.prototype,"navigation",void 0),Hs=M([x("esri.views.2d.navigation.actions.Pan")],Hs);const Zs=Hs;class Xs{constructor(t=2.5,i=.01,s=.95,e=12){this._minimumInitialVelocity=t,this._stopVelocity=i,this._friction=s,this._maxVelocity=e,this.enabled=!0,this.value=new Ns(.8),this.time=new Ns(.3)}add(t,i){if(this.enabled&&null!=i){if(this.time.hasLastValue()){if(this.time.computeDelta(i)<.01)return;if(this.value.hasFilteredDelta()){const i=this.value.computeDelta(t);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(i),this.value.update(t)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let t=this.value.filteredDelta/this.time.filteredDelta;return t=g(t,-this._maxVelocity,this._maxVelocity),Math.abs(t)<this._minimumInitialVelocity?null:this.createMomentum(t,this._stopVelocity,this._friction)}createMomentum(t,i,s){return new Gs(t,i,s)}}class Ys extends Xs{constructor(t=3,i=.01,s=.95,e=12){super(t,i,s,e)}add(t,i){const s=this.value.lastValue;if(null!=s){let i=t-s;for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;t=s+i}super.add(t,i)}}class Ws extends Gs{constructor(t,i,s){super(t,i,s)}value(t){const i=super.value(t);return Math.exp(i)}valueDelta(t,i){const s=super.value(t),e=super.value(t+i)-s;return Math.exp(e)}}class Js extends Xs{constructor(t=2.5,i=.01,s=.95,e=12){super(t,i,s,e)}add(t,i){super.add(Math.log(t),i)}createMomentum(t,i,s){return new Ws(t,i,s)}}let Ks=class extends b{constructor(t){super(t),this._animationTime=0,this._momentumFinished=!1,this._previousAngle=0,this._previousRadius=0,this._previousCenter=null,this._rotationMomentumEstimator=new Ys(.6,.15,.95),this._rotationDirection=1,this._startAngle=0,this._startRadius=0,this._updateTimestamp=null,this._zoomDirection=1,this._zoomMomentumEstimator=new Js,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new Ct({targetGeometry:new j,scale:0,rotation:0}),this.addHandles(T((()=>this._momentumFinished),(()=>this.navigation.stop())))}begin(t,i){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=i.angle,this._previousRadius=this._startRadius=i.radius,this._previousCenter=i.center,this._updateTimestamp=null,t.constraints.rotationEnabled&&this.addToRotateEstimator(0,i.timestamp),this.addToZoomEstimator(i,1)}update(t,i){null===this._updateTimestamp&&(this._updateTimestamp=i.timestamp);const s=i.angle,e=i.radius,n=i.center,r=Math.abs(180*(s-this._startAngle)/Math.PI),h=Math.abs(e-this._startRadius),a=this._startRadius/e;if(this._previousRadius&&this._previousCenter){const o=e/this._previousRadius;let c=180*(s-this._previousAngle)/Math.PI;this._rotationDirection=c>=0?1:-1,this._zoomDirection=o>=1?1:-1,t.constraints.rotationEnabled?(null===this._zoomOnly&&i.timestamp-this._updateTimestamp>200&&(this._zoomOnly=h-r>0),null===this._zoomOnly||this._zoomOnly?c=0:this.addToRotateEstimator(s-this._startAngle,i.timestamp)):c=0,this.addToZoomEstimator(i,a),this.navigation.setViewpoint([n.x,n.y],1/o,c,[this._previousCenter.x-n.x,n.y-this._previousCenter.y])}this._previousAngle=s,this._previousRadius=e,this._previousCenter=n}end(t){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(t),this.navigation.end()}addToRotateEstimator(t,i){this._rotationMomentumEstimator.add(t,.001*i)}addToZoomEstimator(t,i){this._zoomMomentumEstimator.add(i,.001*t.timestamp)}canZoomIn(t){const i=t.scale,s=t.constraints.effectiveMaxScale;return 0===s||i>s}canZoomOut(t){const i=t.scale,s=t.constraints.effectiveMinScale;return 0===s||i<s}onAnimationUpdate(t){this.navigation.animationManager?.animateContinous(t.viewpoint,((i,s)=>{const e=!this.canZoomIn(t)&&this._zoomDirection>1||!this.canZoomOut(t)&&this._zoomDirection<1,n=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),r=e||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),h=.001*s;if(this._momentumFinished=n&&r,!this._momentumFinished){const s=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,h))*this._rotationDirection*180/Math.PI:0;let e=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,h)):1;const n=Vt(),r=Vt();if(this._previousCenter){G(n,this._previousCenter.x,this._previousCenter.y),Et(r,t.size,t.padding),V(n,n,r);const{constraints:h,scale:a}=t,o=a*e;e<1&&!h.canZoomInTo(o)?(e=a/h.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):e>1&&!h.canZoomOutTo(o)&&(e=a/h.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),Lt(i,t.viewpoint,e,s,n,t.size),t.constraints.constrainByGeometry(i)}}this._animationTime+=h}))}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};M([_()],Ks.prototype,"_momentumFinished",void 0),M([_()],Ks.prototype,"viewpoint",void 0),M([_()],Ks.prototype,"navigation",void 0),Ks=M([x("esri.views.2d.navigation.actions.Pinch")],Ks);const Qs=Ks;const te=Vt(),ie=Vt();let se=class extends b{constructor(t){super(t),this._previousCenter=Vt(),this.viewpoint=new Ct({targetGeometry:new j,scale:0,rotation:0})}begin(t,i){this.navigation.begin(),G(this._previousCenter,i.center.x,i.center.y)}update(t,i){const{state:{size:s,padding:e}}=t;G(te,i.center.x,i.center.y),Ot(ie,s,e),t.viewpoint=Bt(this.viewpoint,t.state.paddedViewState.viewpoint,Nt(ie,this._previousCenter,te)),q(this._previousCenter,te)}end(){this.navigation.end()}};M([_()],se.prototype,"viewpoint",void 0),M([_()],se.prototype,"navigation",void 0),se=M([x("esri.views.2d.actions.Rotate")],se);const ee=se;const ne=10,re=1,he=new Ct({targetGeometry:new j}),ae=[0,0],oe=250;let ce=class extends b{constructor(t){super(t),this._endTimer=null,this._lastEventTimestamp=null,this.animationManager=null,this.interacting=!1}initialize(){this.pan=new Zs({navigation:this}),this.rotate=new ee({navigation:this}),this.pinch=new Qs({navigation:this}),this.zoomBox=new Bs({view:this.view,navigation:this})}destroy(){this.pan=D(this.pan),this.rotate=D(this.rotate),this.pinch=D(this.pinch),this.zoomBox=D(this.zoomBox),this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(oe)}async zoom(t,i=this._getDefaultAnchor()){if(this.stop(),this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return t<1?this.zoomIn(i):this.zoomOut(i);this.setViewpoint(i,t,0,[0,0])}async zoomIn(t){const i=this.view,s=i.constraints.snapToNextScale(i.scale);return this._zoomToScale(s,t)}async zoomOut(t){const i=this.view,s=i.constraints.snapToPreviousScale(i.scale);return this._zoomToScale(s,t)}setViewpoint(t,i,s,e){this.begin(),this.view.stateManager.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,t,i,s,e),this.end()}setViewpointImmediate(t,i=0,s=[0,0],e=this._getDefaultAnchor()){this.view.stateManager.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,e,t,i,s)}continousRotateClockwise(){const t=this.get("view.viewpoint");this.animationManager?.animateContinous(t,(t=>{Bt(t,t,-re)}))}continousRotateCounterclockwise(){const t=this.get("view.viewpoint");this.animationManager?.animateContinous(t,(t=>{Bt(t,t,re)}))}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-ne,0])}continousPanRight(){this._continuousPan([ne,0])}continousPanUp(){this._continuousPan([0,ne])}continousPanDown(){this._continuousPan([0,-ne])}stop(){this.pan.stopMomentumNavigation(),this.animationManager?.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(t){const i=this.view.viewpoint;this.animationManager?.animateContinous(i,(i=>{Rt(i,i,t),this.view.constraints.constrainByGeometry(i)}))}_startTimer(t){return null!==this._endTimer||(this._endTimer=setTimeout((()=>{this._endTimer=null;const t=performance.now()-(this._lastEventTimestamp??0);t<oe?this._endTimer=this._startTimer(t):this._set("interacting",!1)}),t)),this._endTimer}_getDefaultAnchor(){const{size:t,padding:{left:i,right:s,top:e,bottom:n}}=this.view;return ae[0]=.5*(t[0]-s+i),ae[1]=.5*(t[1]-n+e),ae}async _zoomToScale(t,i=this._getDefaultAnchor()){const{view:s}=this,{constraints:e,scale:n,viewpoint:r,size:h,padding:a}=s,o=e.canZoomInTo(t),c=e.canZoomOutTo(t);if(!(t<n&&!o||t>n&&!c))return Gt(he,r,t/n,0,i,h,a),e.constrainByGeometry(he),s.goTo(he,{animate:!0})}_scaleRotateTranslateViewpoint(t,i,s,e,n){const{view:r}=this,{size:h,padding:a,constraints:o,scale:c,viewpoint:u}=r,l=c*s,f=o.canZoomInTo(l),d=o.canZoomOutTo(l);return(s<1&&!f||s>1&&!d)&&(s=1),Rt(u,u,n),Gt(t,u,s,e,i,h,a),o.constrainByGeometry(t)}};M([_()],ce.prototype,"animationManager",void 0),M([_({type:Boolean,readOnly:!0})],ce.prototype,"interacting",void 0),M([_()],ce.prototype,"pan",void 0),M([_()],ce.prototype,"pinch",void 0),M([_()],ce.prototype,"rotate",void 0),M([_()],ce.prototype,"view",void 0),M([_()],ce.prototype,"zoomBox",void 0),ce=M([x("esri.views.2d.navigation.MapViewNavigation")],ce);const ue=ce;const le={shaders:{vertexShader:i("magnifier/magnifier.vert"),fragmentShader:i("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};function fe(t){return qt(t,le)}export{ki as C,ds as Y,Ms as a,vi as b,fe as c,le as d,$i as e,Cs as f,ys as m,xs as n,ms as r,Yt as s,bs as t,ue as y};
//# sourceMappingURL=p-2b228be3.js.map