import{c as e}from"./p-3c3976eb.js";import{Q as n,V as t,A as r,L as o,d as i,aj as s,B as a,H as l,I as f,z as u,E as c,P as m,q as w,ak as p,O as d,a as E,b as y,al as N,am as h,a0 as b,an as $,S as A}from"./p-27972682.js";import{t as D,e as x}from"./p-623dbe5e.js";import{e as I,j as g,q as j,f as L,c as T,a as F,b as S,d as M,g as O,k as H,F as C,T as R,y as k,x as z,E as G,D as W,A as P}from"./p-3dfc1ed6.js";import{t as _}from"./p-af3366a9.js";import{e as v,N as B}from"./p-ed4314c0.js";import{bm as J,aY as q,bk as K,r as U}from"./p-98455486.js";import{f as V}from"./p-0ea2a103.js";import"./p-c9fb1370.js";import"./p-8399f9e1.js";import"./p-e6a64715.js";import"./p-dc29c329.js";import"./p-fcbd27c0.js";import"./p-5abe9c67.js";import"./p-66f65b6a.js";import"./p-14843b2a.js";import"./p-ffb89da5.js";import"./p-dfd7ee02.js";import"./p-da8336be.js";import"./p-1172b129.js";import"./p-0fdabe4a.js";import"./p-9803a24d.js";import"./p-950241ce.js";import"./p-e9eadde7.js";import"./p-e22a21a4.js";import"./p-f51cdd06.js";function Y(e,n,t,r){if(1===r.length){if(u(r[0]))return $(e,r[0],-1);if(w(r[0]))return $(e,r[0].toArray(),-1)}return $(e,r,-1)}async function Z(e,n,t){const r=e.getVariables();if(r.length>0){const o=[];for(let e=0;e<r.length;e++){const i={name:r[e]};o.push(await n.evaluateIdentifier(t,i))}const i={};for(let e=0;e<r.length;e++)i[r[e]]=o[e];return e.parameters=i,e}return e}function Q(e,n,t=null){for(const t in e)if(t.toLowerCase()===n.toLowerCase())return e[t];return t}function X(e){if(null===e)return null;const n={type:Q(e,"type",""),name:Q(e,"name","")};if("range"===n.type)n.range=Q(e,"range",[]);else{n.codedValues=[];for(const t of Q(e,"codedValues",[]))n.codedValues.push({name:Q(t,"name",""),code:Q(t,"code",null)})}return n}function ee(e){if(null===e)return null;const n={},t=Q(e,"wkt",null);null!==t&&(n.wkt=t);const r=Q(e,"wkid",null);return null!==r&&(n.wkid=r),n}function ne(e){if(null===e)return null;const n={hasZ:Q(e,"hasz",!1),hasM:Q(e,"hasm",!1)},t=Q(e,"spatialreference",null);t&&(n.spatialReference=ee(t));const r=Q(e,"x",null);if(null!==r)return n.x=r,n.y=Q(e,"y",null),n;const o=Q(e,"rings",null);if(null!==o)return n.rings=o,n;const i=Q(e,"paths",null);if(null!==i)return n.paths=i,n;const s=Q(e,"points",null);if(null!==s)return n.points=s,n;for(const t of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const r=Q(e,t,null);null!==r&&(n[t]=r)}return n}function te(e,n){for(const t of n)if(t===e)return!0;return!1}function re(e){return!!e.layerDefinition&&(!!e.featureSet&&(!1!==te(e.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])&&(!1!==u(e.layerDefinition.fields)&&!1!==u(e.featureSet.features))))}function oe($){"async"===$.mode&&($.functions.timezone=function(a,l){return $.standardFunctionAsync(a,l,(async(f,u,c)=>{if(n(c,1,2,a,l),t(c[0])){if(await c[0].load(),1===c.length||null===c[1])return c[0].dateTimeReferenceFieldIndex.layerDateFieldsTimeZone;if(!(c[1]instanceof r)||!1===c[1].hasField("type"))throw new D(a,x.InvalidParameter,l);const e=c[1].field("type");if(!1===o(e))throw new D(a,x.InvalidParameter,l);switch(i(e).toLowerCase()){case"preferredtimezone":return c[0].dateTimeReferenceFieldIndex.layerPreferredTimeZone;case"editfieldsinfo":return c[0].dateTimeReferenceFieldIndex.layerEditFieldsTimeZone;case"timeinfo":return c[0].dateTimeReferenceFieldIndex.layerTimeInfoTimeZone;case"field":if(c[1].hasField("fieldname")&&o(c[1].field("fieldname")))return c[0].dateTimeReferenceFieldIndex.fieldTimeZone(i(c[1].field("fieldname")))}throw new D(a,x.InvalidParameter,l)}const m=s(c[0],A(a));if(null===m)return null;const w=m.timeZone;return"system"===w?e.systemTimeZoneCanonicalName:w}))},$.functions.sqltimestamp=function(e,r){return $.standardFunctionAsync(e,r,(async(o,s,l)=>{n(l,1,3,e,r);const f=l[0];if(a(f)){if(1===l.length)return f.toSQLString();if(2===l.length)return f.changeTimeZone(i(l[1])).toSQLString();throw new D(e,x.InvalidParameter,r)}if(t(f)){if(3!==l.length)throw new D(e,x.InvalidParameter,r);await f.load();const n=i(l[1]);if(!1===a(l[2]))throw new D(e,x.InvalidParameter,r);const t=f.fieldTimeZone(n);return null===t?l[2].toSQLString():l[2].changeTimeZone(t).toSQLString()}throw new D(e,x.InvalidParameter,r)}))},$.signatures.push({name:"sqltimestamp",min:2,max:4}),$.functions.featuresetbyid=function(e,t){return $.standardFunctionAsync(e,t,((r,o,s)=>{if(n(s,2,4,e,t),s[0]instanceof I){const n=i(s[1]);let r=f(s[2],null);const o=l(f(s[3],!0));if(null===r&&(r=["*"]),!1===u(r))throw new D(e,x.InvalidParameter,t);return s[0].featureSetById(n,o,r)}throw new D(e,x.InvalidParameter,t)}))},$.signatures.push({name:"featuresetbyid",min:2,max:4}),$.functions.getfeatureset=function(e,t){return $.standardFunctionAsync(e,t,((r,o,s)=>{if(n(s,1,2,e,t),c(s[0])){let n=f(s[1],"datasource");return null===n&&(n="datasource"),n=i(n).toLowerCase(),g(s[0].fullSchema(),n,e.lrucache,e.interceptor,e.spatialReference)}throw new D(e,x.InvalidParameter,t)}))},$.signatures.push({name:"getfeatureset",min:1,max:2}),$.functions.featuresetbyportalitem=function(e,t){return $.standardFunctionAsync(e,t,((r,s,a)=>{if(n(a,2,5,e,t),null===a[0])throw new D(e,x.PortalRequired,t);if(a[0]instanceof m){const n=i(a[1]),r=i(a[2]);let o=f(a[3],null);const s=l(f(a[4],!0));if(null===o&&(o=["*"]),!1===u(o))throw new D(e,x.InvalidParameter,t);let c=null;return c=e.services&&e.services.portal?e.services.portal:J.getDefault(),c=_(a[0],c),j(n,r,e.spatialReference,o,s,c,e.lrucache,e.interceptor)}if(!1===o(a[0]))throw new D(e,x.PortalRequired,t);const c=i(a[0]),w=i(a[1]);let p=f(a[2],null);const d=l(f(a[3],!0));if(null===p&&(p=["*"]),!1===u(p))throw new D(e,x.InvalidParameter,t);return j(c,w,e.spatialReference,p,d,e.services?.portal??J.getDefault(),e.lrucache,e.interceptor)}))},$.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),$.functions.featuresetbyname=function(e,t){return $.standardFunctionAsync(e,t,((r,o,s)=>{if(n(s,2,4,e,t),s[0]instanceof I){const n=i(s[1]);let r=f(s[2],null);const o=l(f(s[3],!0));if(null===r&&(r=["*"]),!1===u(r))throw new D(e,x.InvalidParameter,t);return s[0].featureSetByName(n,o,r)}throw new D(e,x.InvalidParameter,t)}))},$.signatures.push({name:"featuresetbyname",min:2,max:4}),$.functions.featureset=function(e,t){return $.standardFunction(e,t,((i,s,a)=>{n(a,1,1,e,t);let l=a[0];const f={layerDefinition:{geometryType:"",objectIdField:"",hasM:!1,hasZ:!1,globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(o(l))l=JSON.parse(l),void 0!==l.layerDefinition?(f.layerDefinition=l.layerDefinition,f.featureSet=l.featureSet,l.layerDefinition.spatialReference&&(f.layerDefinition.spatialReference=l.layerDefinition.spatialReference)):(f.featureSet.features=l.features,f.featureSet.geometryType=l.geometryType,f.layerDefinition.geometryType=f.featureSet.geometryType,f.layerDefinition.objectIdField=l.objectIdFieldName??"",f.layerDefinition.typeIdField=l.typeIdFieldName,f.layerDefinition.globalIdField=l.globalIdFieldName,f.layerDefinition.fields=l.fields,l.spatialReference&&(f.layerDefinition.spatialReference=l.spatialReference));else{if(!(a[0]instanceof r))throw new D(e,x.InvalidParameter,t);{l=JSON.parse(a[0].castToText(!0));const e=Q(l,"layerdefinition");if(null!==e){f.layerDefinition.geometryType=Q(e,"geometrytype",""),f.featureSet.geometryType=f.layerDefinition.geometryType,f.layerDefinition.globalIdField=Q(e,"globalidfield",""),f.layerDefinition.objectIdField=Q(e,"objectidfield",""),f.layerDefinition.typeIdField=Q(e,"typeidfield",""),f.layerDefinition.hasZ=!0===Q(e,"hasz",!1),f.layerDefinition.hasM=!0===Q(e,"hasm",!1);const n=Q(e,"spatialreference",null);n&&(f.layerDefinition.spatialReference=ee(n));for(const n of Q(e,"fields",[])){const e={name:Q(n,"name",""),alias:Q(n,"alias",""),type:Q(n,"type",""),nullable:Q(n,"nullable",!0),editable:Q(n,"editable",!0),length:Q(n,"length",null),domain:X(Q(n,"domain"))};f.layerDefinition.fields.push(e)}const t=Q(l,"featureset",null);if(t){const e={};for(const n of f.layerDefinition.fields)e[n.name.toLowerCase()]=n.name;for(const n of Q(t,"features",[])){const t={},r=Q(n,"attributes",{});for(const n in r)t[e[n.toLowerCase()]]=r[n];f.featureSet.features.push({attributes:t,geometry:ne(Q(n,"geometry",null))})}}}else{f.layerDefinition.hasZ=!0===Q(l,"hasz",!1),f.layerDefinition.hasM=!0===Q(l,"hasm",!1),f.layerDefinition.geometryType=Q(l,"geometrytype",""),f.featureSet.geometryType=f.layerDefinition.geometryType,f.layerDefinition.objectIdField=Q(l,"objectidfieldname",""),f.layerDefinition.typeIdField=Q(l,"typeidfieldname","");const e=Q(l,"spatialreference",null);e&&(f.layerDefinition.spatialReference=ee(e));let n=Q(l,"fields",null);if(u(n))for(const e of n){const n={name:Q(e,"name",""),alias:Q(e,"alias",""),type:Q(e,"type",""),nullable:Q(e,"nullable",!0),editable:Q(e,"editable",!0),length:Q(e,"length",null),domain:X(Q(e,"domain"))};f.layerDefinition.fields.push(n)}else n=null,f.layerDefinition.fields=n;const t={};for(const e of f.layerDefinition.fields)t[e.name.toLowerCase()]=e.name;let r=Q(l,"features",null);if(u(r))for(const e of r){const n={},r=Q(e,"attributes",{});for(const e in r)n[t[e.toLowerCase()]]=r[e];f.featureSet.features.push({attributes:n,geometry:ne(Q(e,"geometry",null))})}else r=null,f.featureSet.features=r}}}if(!1===re(f))throw new D(e,x.InvalidParameter,t);return""===(f?.layerDefinition?.geometryType||"")&&(f.layerDefinition.geometryType="esriGeometryNull"),L.create(f,e.spatialReference)}))},$.signatures.push({name:"featureset",min:1,max:1}),$.functions.filter=function(e,r){return $.standardFunctionAsync(e,r,(async(o,i,s)=>{if(n(s,2,2,e,r),u(s[0])||w(s[0])){const n=[];let t=s[0];t instanceof p&&(t=t.toArray());let o=null;if(!d(s[1]))throw new D(e,x.InvalidParameter,r);o=s[1].createFunction(e);for(const e of t){const t=o(e);q(t)?!0===await t&&n.push(e):!0===t&&n.push(e)}return n}if(t(s[0])){const n=await s[0].load(),t=V.create(s[1],n.getFieldsIndex()),r=t.getVariables();if(r.length>0){const n=[];for(let t=0;t<r.length;t++){const o={name:r[t]};n.push(await $.evaluateIdentifier(e,o))}const o={};for(let e=0;e<r.length;e++)o[r[e]]=n[e];return t.parameters=o,new T({parentfeatureset:s[0],whereclause:t})}return new T({parentfeatureset:s[0],whereclause:t})}throw new D(e,x.InvalidParameter,r)}))},$.signatures.push({name:"filter",min:2,max:2}),$.functions.orderby=function(e,r){return $.standardFunctionAsync(e,r,(async(o,i,s)=>{if(n(s,2,2,e,r),t(s[0])){const e=new F(s[1]);return new S({parentfeatureset:s[0],orderbyclause:e})}throw new D(e,x.InvalidParameter,r)}))},$.signatures.push({name:"orderby",min:2,max:2}),$.functions.top=function(e,r){return $.standardFunctionAsync(e,r,(async(o,i,s)=>{if(n(s,2,2,e,r),t(s[0]))return new M({parentfeatureset:s[0],topnum:s[1]});if(u(s[0]))return E(s[1])>=s[0].length?s[0].slice(0):s[0].slice(0,E(s[1]));if(w(s[0]))return E(s[1])>=s[0].length()?s[0].slice(0):s[0].slice(0,E(s[1]));throw new D(e,x.InvalidParameter,r)}))},$.signatures.push({name:"top",min:2,max:2}),$.functions.first=function(e,r){return $.standardFunctionAsync(e,r,(async(o,i,s)=>{if(n(s,1,1,e,r),t(s[0])){const n=await s[0].first(o.abortSignal);if(null!==n){const t=y.createFromGraphicLikeObject(n.geometry,n.attributes,s[0],e.timeReference);return t._underlyingGraphic=n,t}return n}return u(s[0])?0===s[0].length?null:s[0][0]:w(s[0])?0===s[0].length()?null:s[0].get(0):null}))},$.signatures.push({name:"first",min:1,max:1}),$.functions.attachments=function(e,o){return $.standardFunctionAsync(e,o,(async(i,s,a)=>{n(a,1,2,e,o);const f={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(a.length>1)if(a[1]instanceof r){if(a[1].hasField("minsize")&&(f.minsize=E(a[1].field("minsize"))),a[1].hasField("metadata")&&(f.returnMetadata=l(a[1].field("metadata"))),a[1].hasField("maxsize")&&(f.maxsize=E(a[1].field("maxsize"))),a[1].hasField("types")){const e=N(a[1].field("types"),!1);e.length>0&&(f.types=e)}}else if(null!==a[1])throw new D(e,x.InvalidParameter,o);if(c(a[0])){let n=a[0]._layer;return n instanceof K&&(n=O(n,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)),null===n?[]:!1===t(n)?[]:(await n.load(),n.queryAttachments(a[0].field(n.objectIdField),f.minsize,f.maxsize,f.types,f.returnMetadata))}if(null===a[0])return[];throw new D(e,x.InvalidParameter,o)}))},$.signatures.push({name:"attachments",min:1,max:2}),$.functions.featuresetbyrelationshipname=function(e,r){return $.standardFunctionAsync(e,r,(async(o,s,a)=>{n(a,2,4,e,r);const m=a[0],w=i(a[1]);let p=f(a[2],null);const d=l(f(a[3],!0));if(null===p&&(p=["*"]),!1===u(p))throw new D(e,x.InvalidParameter,r);if(null===a[0])return null;if(!c(a[0]))throw new D(e,x.InvalidParameter,r);let E=m._layer;if(E instanceof K&&(E=O(E,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)),null===E)return null;if(!1===t(E))return null;E=await E.load();const y=E.relationshipMetaData().filter((e=>e.name===w));if(0===y.length)return null;if(void 0!==y[0].relationshipTableId&&null!==y[0].relationshipTableId&&y[0].relationshipTableId>-1)return H(E,y[0],m.field(E.objectIdField),E.spatialReference,p,d,e.lrucache,e.interceptor);let N=E.serviceUrl();if(!N)return null;N="/"===N.charAt(N.length-1)?N+y[0].relatedTableId.toString():N+"/"+y[0].relatedTableId.toString();const h=await C(N,E.spatialReference,p,d,e.lrucache,e.interceptor);await h.load();let b=h.relationshipMetaData();if(b=b.filter((e=>e.id===y[0].id)),!1===m.hasField(y[0].keyField)||null===m.field(y[0].keyField)){const e=await E.getFeatureByObjectId(m.field(E.objectIdField),[y[0].keyField]);if(e){const n=V.create(b[0].keyField+"= @id",h.getFieldsIndex());return n.parameters={id:e.attributes[y[0].keyField]},h.filter(n)}return new v({parentfeatureset:h})}const $=V.create(b[0].keyField+"= @id",h.getFieldsIndex());return $.parameters={id:m.field(y[0].keyField)},h.filter($)}))},$.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),$.functions.featuresetbyassociation=function(e,r){return $.standardFunctionAsync(e,r,(async(s,a,l)=>{n(l,2,3,e,r);const u=l[0],m=i(f(l[1],"")).toLowerCase(),w=o(l[2])?i(l[2]):null;if(null===l[0])return null;if(!c(l[0]))throw new D(e,x.InvalidParameter,r);let p=u._layer;if(p instanceof K&&(p=O(p,e.spatialReference,["*"],!0,e.lrucache,e.interceptor)),null===p)return null;if(!1===t(p))return null;await p.load();const d=p.serviceUrl(),E=await R(d,e.spatialReference);let y=null,N=null,$=!1;if(null!==w&&""!==w&&void 0!==w){for(const e of E.terminals)e.terminalName===w&&(N=e.terminalId);null===N&&($=!0)}const A=E.associations.getFieldsIndex(),I=A.get("TOGLOBALID").name,g=A.get("FROMGLOBALID").name,j=A.get("TOTERMINALID").name,L=A.get("FROMTERMINALID").name,T=A.get("FROMNETWORKSOURCEID").name,F=A.get("TONETWORKSOURCEID").name,S=A.get("ASSOCIATIONTYPE").name,M=A.get("ISCONTENTVISIBLE").name,H=A.get("OBJECTID").name;for(const e of p.fields)if("global-id"===e.type){y=u.field(e.name);break}let C=null,_=new k(new U({name:"percentalong",alias:"percentalong",type:"double"}),V.create("0",E.associations.getFieldsIndex())),v=new k(new U({name:"side",alias:"side",type:"string"}),V.create("''",E.associations.getFieldsIndex()));const B="globalid",J="globalId",q={};for(const e in E.lkp)q[e]=E.lkp[e].sourceId;const Y=new z(new U({name:"classname",alias:"classname",type:"string"}),null,q);let Z="";switch(m){case"midspan":{Z=`((${I}='${y}') OR ( ${g}='${y}')) AND (${S} IN (5))`,Y.codefield=V.create(`CASE WHEN (${I}='${y}') THEN ${T} ELSE ${F} END`,E.associations.getFieldsIndex());const e=b(W.findField(E.associations.fields,g));e.name=B,e.alias=B,C=new k(e,V.create(`CASE WHEN (${g}='${y}') THEN ${I} ELSE ${g} END`,E.associations.getFieldsIndex())),_=E.unVersion>=4?new P(W.findField(E.associations.fields,A.get("PERCENTALONG").name)):new k(new U({name:"percentalong",alias:"percentalong",type:"double"}),V.create("0",E.associations.getFieldsIndex()));break}case"junctionedge":{Z=`((${I}='${y}') OR ( ${g}='${y}')) AND (${S} IN (4,6))`,Y.codefield=V.create(`CASE WHEN (${I}='${y}') THEN ${T} ELSE ${F} END`,E.associations.getFieldsIndex());const e=b(W.findField(E.associations.fields,g));e.name=B,e.alias=B,C=new k(e,V.create(`CASE WHEN (${g}='${y}') THEN ${I} ELSE ${g} END`,E.associations.getFieldsIndex())),v=new k(new U({name:"side",alias:"side",type:"string"}),V.create(`CASE WHEN (${S}=4) THEN 'from' ELSE 'to' END`,E.associations.getFieldsIndex()));break}case"connected":{let e=`${I}='@T'`,n=`${g}='@T'`;null!==N&&(e+=` AND ${j}=@A`,n+=` AND ${L}=@A`),Z="(("+e+") OR ("+n+"))",Z=h(Z,"@T",y??""),e=h(e,"@T",y??""),null!==N&&(e=h(e,"@A",N.toString()),Z=h(Z,"@A",N.toString())),Y.codefield=V.create("CASE WHEN "+e+` THEN ${T} ELSE ${F} END`,E.associations.getFieldsIndex());const t=b(W.findField(E.associations.fields,g));t.name=B,t.alias=B,C=new k(t,V.create("CASE WHEN "+e+` THEN ${g} ELSE ${I} END`,E.associations.getFieldsIndex()));break}case"container":Z=`${I}='${y}' AND ${S} = 2`,null!==N&&(Z+=` AND ${j} = `+N.toString()),Y.codefield=T,Z="( "+Z+" )",C=new G(W.findField(E.associations.fields,g),B,B);break;case"content":Z=`(${g}='${y}' AND ${S} = 2)`,null!==N&&(Z+=` AND ${L} = `+N.toString()),Y.codefield=F,Z="( "+Z+" )",C=new G(W.findField(E.associations.fields,I),B,B);break;case"structure":Z=`(${I}='${y}' AND ${S} = 3)`,null!==N&&(Z+=` AND ${j} = `+N.toString()),Y.codefield=T,Z="( "+Z+" )",C=new G(W.findField(E.associations.fields,g),B,J);break;case"attached":Z=`(${g}='${y}' AND ${S} = 3)`,null!==N&&(Z+=` AND ${L} = `+N.toString()),Y.codefield=F,Z="( "+Z+" )",C=new G(W.findField(E.associations.fields,I),B,J);break;default:throw new D(e,x.InvalidParameter,r)}$&&(Z="1 <> 1");return new W({parentfeatureset:E.associations,adaptedFields:[new P(W.findField(E.associations.fields,H)),new P(W.findField(E.associations.fields,M)),C,v,Y,_],extraFilter:Z?V.create(Z,E.associations.getFieldsIndex()):null})}))},$.signatures.push({name:"featuresetbyassociation",min:2,max:6}),$.functions.groupby=function(e,s){return $.standardFunctionAsync(e,s,(async(a,l,f)=>{if(n(f,3,3,e,s),!t(f[0]))throw new D(e,x.InvalidParameter,s);const c=await f[0].load(),m=[],p=[];let d=!1,E=[];if(o(f[1]))E.push(f[1]);else if(f[1]instanceof r)E.push(f[1]);else if(u(f[1]))E=f[1];else{if(!w(f[1]))throw new D(e,x.InvalidParameter,s);E=f[1].toArray()}for(const n of E)if(o(n)){const e=V.create(i(n),c.getFieldsIndex()),t=!0===B(e)?i(n):"%%%%FIELDNAME";m.push({name:t,expression:e}),"%%%%FIELDNAME"===t&&(d=!0)}else{if(!(n instanceof r))throw new D(e,x.InvalidParameter,s);{const t=n.hasField("name")?n.field("name"):"%%%%FIELDNAME",r=n.hasField("expression")?n.field("expression"):"";if("%%%%FIELDNAME"===t&&(d=!0),!t)throw new D(e,x.InvalidParameter,s);m.push({name:t,expression:V.create(r||t,c.getFieldsIndex())})}}if(E=[],o(f[2]))E.push(f[2]);else if(u(f[2]))E=f[2];else if(w(f[2]))E=f[2].toArray();else{if(!(f[2]instanceof r))throw new D(e,x.InvalidParameter,s);E.push(f[2])}for(const n of E){if(!(n instanceof r))throw new D(e,x.InvalidParameter,s);{const t=n.hasField("name")?n.field("name"):"",r=n.hasField("statistic")?n.field("statistic"):"",o=n.hasField("expression")?n.field("expression"):"";if(!t||!r||!o)throw new D(e,x.InvalidParameter,s);p.push({name:t,statistic:r.toLowerCase(),expression:V.create(o,c.getFieldsIndex())})}}if(d){const e={};for(const n of c.fields)e[n.name.toLowerCase()]=1;for(const n of m)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);for(const n of p)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);let n=0;for(const t of m)if("%%%%FIELDNAME"===t.name){for(;1===e["field_"+n.toString()];)n++;e["field_"+n.toString()]=1,t.name="FIELD_"+n.toString()}}for(const n of m)await Z(n.expression,$,e);for(const n of p)await Z(n.expression,$,e);return f[0].groupby(m,p)}))},$.signatures.push({name:"groupby",min:3,max:3}),$.functions.distinct=function(e,s){return $.standardFunctionAsync(e,s,(async(a,l,f)=>{if(t(f[0])){n(f,2,2,e,s);const t=await f[0].load(),a=[];let l=[];if(o(f[1]))l.push(f[1]);else if(f[1]instanceof r)l.push(f[1]);else if(u(f[1]))l=f[1];else{if(!w(f[1]))throw new D(e,x.InvalidParameter,s);l=f[1].toArray()}let c=!1;for(const n of l)if(o(n)){const e=V.create(i(n),t.getFieldsIndex()),r=!0===B(e)?i(n):"%%%%FIELDNAME";a.push({name:r,expression:e}),"%%%%FIELDNAME"===r&&(c=!0)}else{if(!(n instanceof r))throw new D(e,x.InvalidParameter,s);{const r=n.hasField("name")?n.field("name"):"%%%%FIELDNAME",o=n.hasField("expression")?n.field("expression"):"";if("%%%%FIELDNAME"===r&&(c=!0),!r)throw new D(e,x.InvalidParameter,s);a.push({name:r,expression:V.create(o||r,t.getFieldsIndex())})}}if(c){const e={};for(const n of t.fields)e[n.name.toLowerCase()]=1;for(const n of a)"%%%%FIELDNAME"!==n.name&&(e[n.name.toLowerCase()]=1);let n=0;for(const t of a)if("%%%%FIELDNAME"===t.name){for(;1===e["field_"+n.toString()];)n++;e["field_"+n.toString()]=1,t.name="FIELD_"+n.toString()}}for(const n of a)await Z(n.expression,$,e);return f[0].groupby(a,[])}return Y("distinct",a,l,f)}))})}export{oe as registerFunctions};
//# sourceMappingURL=p-a2e1c8d4.js.map