import{eo as t,r as s,e as r,h_ as e,h$ as o,cv as n,cK as p,bl as i,bQ as a,bn as u}from"./p-b54724b6.js";import"./p-52a9dec5.js";import"./p-de65f975.js";import"./p-cc24e5bd.js";import"./p-cc3f40fb.js";import{r as c,e as l,I as h}from"./p-5a001adc.js";import"./p-2563414c.js";import"./p-d9618e4e.js";import{e as d}from"./p-603bf978.js";import{t as y}from"./p-b4b7d6a0.js";import"./p-e9a502d1.js";import"./p-e75aa2b5.js";const f={analytics:{supportsCacheHint:!1},attachment:{supportsContentType:!1,supportsExifInfo:!1,supportsKeywords:!1,supportsName:!1,supportsSize:!1,supportsCacheHint:!1,supportsResize:!1},data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsAsyncApplyEdits:!1},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},query:{maxRecordCount:0,maxRecordCountFactor:0,standardMaxRecordCount:0,supportsCacheHint:!1,supportsCentroid:!1,supportsCompactGeometry:!1,supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:!1,supportsPagination:!1,supportsPercentileStatistics:!1,supportsQuantization:!1,supportsQuantizationEditMode:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsSqlExpression:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsStatistics:!1,tileMaxRecordCount:0}};var m;!function(t){t[t.INVISIBLE=0]="INVISIBLE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OPAQUE=2]="OPAQUE"}(m||(m={}));function S(s=[0,0,0],r=[-1,-1,-1],e=d()){return{center:t(s),halfSize:y(r),quaternion:c(e)}}(()=>{const t=new Int8Array(162);let s=0;const r=r=>{for(let e=0;e<r.length;e++)t[s+e]=r[e];s+=6};return r([6,2,3,1,5,4]),r([0,2,3,1,5,4]),r([0,2,3,7,5,4]),r([0,1,3,2,6,4]),r([0,1,3,2,0,0]),r([0,1,5,7,3,2]),r([0,1,3,7,6,4]),r([0,1,3,7,6,2]),r([0,1,5,7,6,2]),r([0,1,5,4,6,2]),r([0,1,5,4,0,0]),r([0,1,3,7,5,4]),r([0,2,6,4,0,0]),r([0,0,0,0,0,0]),r([1,3,7,5,0,0]),r([2,3,7,6,4,0]),r([2,3,7,6,0,0]),r([2,3,1,5,7,6]),r([0,1,5,7,6,2]),r([0,1,5,7,6,4]),r([0,1,3,7,6,4]),r([4,5,7,6,2,0]),r([4,5,7,6,0,0]),r([4,5,1,3,7,6]),r([0,2,3,7,5,4]),r([6,2,3,7,5,4]),r([6,2,3,1,5,4]),t})();var I;function g(t,e,o,n,p){const i=[];for(const s of e)if(s&&p.includes(s.name)){const r=`${t}/nodes/${o}/attributes/${s.key}/0`;i.push({url:r,storageInfo:s})}return s(i.map((t=>r(t.url,{responseType:"array-buffer"}).then((s=>h(t.storageInfo,s.data)))))).then((t=>{const s=[];for(const r of n){const e={};for(let s=0;s<t.length;s++){const o=t[s].value;null!=o&&(e[i[s].storageInfo.name]=A(o,r))}s.push(e)}return s}))}!function(t){t[t.OUTSIDE=0]="OUTSIDE",t[t.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",t[t.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",t[t.INSIDE=3]="INSIDE"}(I||(I={}));const w=-32768,E=-(2**31);function A(t,s){if(!t)return null;const r=t[s];if(e(t))return r===w?null:r;if(o(t))return r===E?null:r;return r!=r?null:r}new Array(24);l();S();({data:new Array(72),size:3,exclusive:!0,stride:3});class T{constructor(t,s,r,e){this._parsedUrl=t,this._portalItem=s,this._apiKey=r,this.signal=e,this._rootDocument=null;const o=this._parsedUrl?.path.match(/^(.*)\/SceneServer\/layers\/([\d]*)\/?$/i);o&&(this._urlParts={root:o[1],layerId:parseInt(o[2],10)})}async fetch(){if(!this._urlParts)return null;const t=this._portalItem??await this._portalItemFromServiceItemId();if(null==t)return this._loadFromUrl();const s=await this._findAndLoadRelatedPortalItem(t);return null==s?null:this._loadFeatureLayerFromPortalItem(s)}async fetchPortalItem(){if(!this._urlParts)return null;const t=this._portalItem??await this._portalItemFromServiceItemId();return null==t?null:this._findAndLoadRelatedPortalItem(t)}async _fetchRootDocument(){if(null!=this._rootDocument)return this._rootDocument;if(null==this._urlParts)return this._rootDocument={},{};const t={query:{f:"json",token:this._apiKey},responseType:"json",signal:this.signal},s=`${this._urlParts.root}/SceneServer`;try{const e=await r(s,t);this._rootDocument=e.data}catch{this._rootDocument={}}return this._rootDocument}async _fetchServiceOwningPortalUrl(){const t=this._parsedUrl?.path,s=t?n?.findServerInfo(t):null;if(s?.owningSystemUrl)return s.owningSystemUrl;const e=t?t.replace(/(.*\/rest)\/.*/i,"$1")+"/info":null;try{const t=(await r(e,{query:{f:"json"},responseType:"json",signal:this.signal})).data.owningSystemUrl;if(t)return t}catch(t){p(t)}return null}async _findAndLoadRelatedPortalItem(t){try{return(await t.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},{signal:this.signal})).find((t=>"Feature Service"===t.type))||null}catch(t){return p(t),null}}async _loadFeatureLayerFromPortalItem(t){await t.load({signal:this.signal});const s=await this._findMatchingAssociatedSublayerUrl(t.url??"");return new i({url:s,portalItem:t}).load({signal:this.signal})}async _loadFromUrl(){const t=await this._findMatchingAssociatedSublayerUrl(`${this._urlParts?.root}/FeatureServer`);return new i({url:t}).load({signal:this.signal})}async _findMatchingAssociatedSublayerUrl(t){const s=t.replace(/^(.*FeatureServer)(\/[\d]*\/?)?$/i,"$1"),e=this._urlParts?.layerId,o=this._fetchRootDocument(),n=t=>{const e={query:{f:"json"},responseType:"json",authMode:t,signal:this.signal};return r(s,e)},p=n("anonymous").catch((()=>n("no-prompt"))),[i,a]=await Promise.all([p,o]),u=a&&a.layers,c=i.data&&i.data.layers;if(!Array.isArray(c))throw new Error("expected layers array");if(Array.isArray(u))for(let t=0;t<Math.min(u.length,c.length);t++){if(u[t].id===e)return`${s}/${c[t].id}`}else if(null!=e&&e<c.length)return`${s}/${c[e].id}`;throw new Error("could not find matching associated sublayer")}async _portalItemFromServiceItemId(){const t=(await this._fetchRootDocument()).serviceItemId;if(!t)return null;const s=new a({id:t,apiKey:this._apiKey}),r=await this._fetchServiceOwningPortalUrl();null!=r&&(s.portal=new u({url:r}));try{return s.load({signal:this.signal})}catch(t){return p(t),null}}}export{T as i,g as l,f as t};
//# sourceMappingURL=p-778d705c.js.map