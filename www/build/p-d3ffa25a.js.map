{"version":3,"names":["d","constructor","this","_queryEngine","_customParameters","_snapshotFeatures","async","objectIdField","t","r","_","_getFeatureUrl","_featureType","typeName","_getFeatureOutputFormat","customParameters","dateFields","fieldsIndex","map","e","name","signal","l","s","a","m","geometryType","hasZ","i","spatialReference","n","geometry","o","h","u","p","g","_fieldsIndex","attributes","objectId","destroy","getFeatureUrl","getFeatureOutputFormat","fields","featureType","y","f","_checkProjection","c","hasM","timeInfo","featureStore","addMany","extent","fetchRecomputedExtents","fullExtent","_waitSnapshotComplete","executeQuery","executeQueryForCount","executeQueryForIds","executeQueryForExtent","executeQueryForSnapping","_snapshotTask","abort","promise","then","clear","getLogger","error","finished"],"sources":["./node_modules/@arcgis/core/layers/graphics/sources/WFSSourceWorker.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.27/esri/copyright.txt for details.\n*/\nimport{createTask as e}from\"../../../core/asyncUtils.js\";import t from\"../../../core/Error.js\";import r from\"../../../core/Logger.js\";import{throwIfAborted as s,isAbortError as a}from\"../../../core/promiseUtils.js\";import{equals as i,WGS84 as n}from\"../../../geometry/support/spatialReferenceUtils.js\";import{convertFromGeometry as o,convertToGeometry as u}from\"../featureConversionUtils.js\";import p from\"../data/FeatureStore.js\";import{project as h,checkProjectionSupport as y}from\"../data/projectionSupport.js\";import{QueryEngine as c}from\"../data/QueryEngine.js\";import{validateGeoJSON as l,createOptimizedFeatures as m}from\"./geojson/geojson.js\";import{mixAttributes as g}from\"./support/sourceUtils.js\";import{getFeature as _}from\"../../ogc/wfsUtils.js\";import f from\"../../support/FieldsIndex.js\";class d{constructor(){this._queryEngine=null,this._customParameters=null,this._snapshotFeatures=async e=>{const{objectIdField:t}=this._queryEngine,r=await _(this._getFeatureUrl??\"\",this._featureType.typeName,this._getFeatureOutputFormat,{customParameters:this._customParameters,dateFields:this._queryEngine.fieldsIndex.dateFields.map((e=>e.name)),signal:e});await l(r),s(e);const a=m(r,{geometryType:this._queryEngine.geometryType,hasZ:!1,objectIdField:t});if(!i(this._queryEngine.spatialReference,n))for(const s of a)null!=s.geometry&&(s.geometry=o(h(u(s.geometry,this._queryEngine.geometryType,!1,!1),n,this._queryEngine.spatialReference)));let p=1;for(const s of a){const e={};g(this._fieldsIndex,e,s.attributes,!0),s.attributes=e,null==s.attributes[t]&&(s.objectId=s.attributes[t]=p++)}return a}}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(e,t){const{getFeatureUrl:r,getFeatureOutputFormat:a,spatialReference:i,fields:n,geometryType:o,featureType:u,objectIdField:h,customParameters:y}=e;this._featureType=u,this._customParameters=y,this._getFeatureUrl=r,this._getFeatureOutputFormat=a,this._fieldsIndex=new f(n),await this._checkProjection(i),s(t),this._queryEngine=new c({fields:n,geometryType:o,hasM:!1,hasZ:!1,objectIdField:h,spatialReference:i,timeInfo:null,featureStore:new p({geometryType:o,hasM:!1,hasZ:!1})});const l=await this._snapshotFeatures(t.signal);return this._queryEngine.featureStore.addMany(l),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async applyEdits(){throw new t(\"wfs-source:editing-not-supported\",\"applyEdits() is not supported on WFSLayer\")}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForSnapping(e,t.signal)}async refresh(s){return this._customParameters=s,this._snapshotTask?.abort(),this._snapshotTask=e(this._snapshotFeatures),this._snapshotTask.promise.then((e=>{this._queryEngine.featureStore.clear(),e&&this._queryEngine.featureStore.addMany(e)}),(e=>{this._queryEngine.featureStore.clear(),a(e)||r.getLogger(\"esri.layers.WFSLayer\").error(new t(\"wfs-layer:getfeature-error\",\"An error occurred during the GetFeature request\",{error:e}))})),await this._waitSnapshotComplete(),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _checkProjection(e){try{await y(n,e)}catch{throw new t(\"unsupported-projection\",\"Projection not supported\",{spatialReference:e})}}}export{d as default};\n"],"mappings":"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"}