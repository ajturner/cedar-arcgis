{"version":3,"names":["t","Math","PI","n","o","a","rotation","r","abs","cos","s","sin","u","c","size","round","h","y","x","S","f","_","container","fetchSource","requestUpdate","imageMaxWidth","imageMaxHeight","imageRotationSupported","imageNormalizationSupported","hidpi","w","e","constructor","super","this","_imagePromise","bitmaps","update","i","stationary","destroyed","state","l","spatialReference","pixelRatio","p","worldScreenWidth","m","d","floor","extent","xmin","valid","xmax","g","children","slice","paddedViewState","center","console","error","_singleExport","resolution","min","_tiledExport","includes","push","fadeOut","then","remove","destroy","fadeIn","Promise","all","updateExports","async","visible","stage","invalidateTexture","requestRender","forEach","updating","signal","ymax","width","opacity","addChild","setSourceAsync","_export","create","scales","scale","getTileCoverage","set","getTileBounds","prototype","v"],"sources":["./node_modules/@arcgis/core/views/2d/viewStateUtils.js","./node_modules/@arcgis/core/views/2d/layers/support/ExportStrategy.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.27/esri/copyright.txt for details.\n*/\nconst t=Math.PI/180;function n(n){return n*t}function o(t,o){const a=n(o.rotation),r=Math.abs(Math.cos(a)),s=Math.abs(Math.sin(a)),[u,c]=o.size;return t[0]=Math.round(c*s+u*r),t[1]=Math.round(c*r+u*s),t}function a(t,n,o,a){const[r,s]=n,[u,c]=a,h=.5*o;return t[0]=r-h*u,t[1]=s-h*c,t[2]=r+h*u,t[3]=s+h*c,t}export{a as getBBox,o as getOuterSize};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.27/esri/copyright.txt for details.\n*/\nimport{_ as t}from\"../../../../chunks/tslib.es6.js\";import e from\"../../../../core/Accessor.js\";import\"../../../../core/has.js\";import{debounce as i,throwIfAborted as o,throwIfAbortError as r,eachAlways as s}from\"../../../../core/promiseUtils.js\";import{property as a}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/accessorSupport/ensureType.js\";import\"../../../../core/arrayUtils.js\";import{subclass as p}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{create as n,toExtent as m}from\"../../../../geometry/support/aaBoundingRect.js\";import{getInfo as l}from\"../../../../geometry/support/spatialReferenceUtils.js\";import h from\"../../../../layers/support/TileInfo.js\";import{getOuterSize as d,getBBox as c}from\"../../viewStateUtils.js\";import{Bitmap as u}from\"../../engine/Bitmap.js\";import g from\"../../tiling/TileInfoView.js\";import f from\"../../tiling/TileKey.js\";const y=n(),x=[0,0],S=new f(0,0,0,0),_={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let w=class extends e{constructor(t){super(t),this._imagePromise=null,this.bitmaps=[],this.hidpi=_.hidpi,this.imageMaxWidth=_.imageMaxWidth,this.imageMaxHeight=_.imageMaxHeight,this.imageRotationSupported=_.imageRotationSupported,this.imageNormalizationSupported=_.imageNormalizationSupported,this.update=i((async(t,e)=>{if(o(e),!t.stationary||this.destroyed)return;const i=t.state,s=l(i.spatialReference),a=this.hidpi?t.pixelRatio:1,p=this.imageNormalizationSupported&&i.worldScreenWidth&&i.worldScreenWidth<i.size[0],n=this.imageMaxWidth??0,m=this.imageMaxHeight??0;p?(x[0]=i.worldScreenWidth,x[1]=i.size[1]):this.imageRotationSupported?(x[0]=i.size[0],x[1]=i.size[1]):d(x,i);const h=Math.floor(x[0]*a)>n||Math.floor(x[1]*a)>m,c=s&&(i.extent.xmin<s.valid[0]||i.extent.xmax>s.valid[1]),u=!this.imageNormalizationSupported&&c,g=!h&&!u,f=this.imageRotationSupported?i.rotation:0,y=this.container.children.slice();if(g){const t=p?i.paddedViewState.center:i.center;this._imagePromise&&console.error(\"Image promise was not defined!\"),this._imagePromise=this._singleExport(i,x,t,i.resolution,f,a,e)}else{let t=Math.min(n,m);u&&(t=Math.min(i.worldScreenWidth,t)),this._imagePromise=this._tiledExport(i,t,a,e)}try{const t=await this._imagePromise??[];o(e);const i=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=t;for(const e of y)t.includes(e)||i.push(e.fadeOut().then((()=>{e.remove(),e.destroy()})));for(const e of t)i.push(e.fadeIn());await Promise.all(i)}catch(S){this._imagePromise=null,r(S)}}),5e3),this.updateExports=i((async t=>{const e=[];for(const i of this.container.children){if(!i.visible||!i.stage)return;e.push(t(i).then((()=>{i.invalidateTexture(),i.requestRender()})))}this._imagePromise=s(e).then((()=>this._imagePromise=null)),await this._imagePromise}))}destroy(){this.bitmaps.forEach((t=>t.destroy())),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(t,e,i,r,s,a){const p=await this.fetchSource(t,Math.floor(e*s),Math.floor(i*s),{rotation:r,pixelRatio:s,signal:a});o(a);const n=new u(null,!0);return n.x=t.xmin,n.y=t.ymax,n.resolution=t.width/e,n.rotation=r,n.pixelRatio=s,n.opacity=0,this.container.addChild(n),await n.setSourceAsync(p,a),o(a),n}async _singleExport(t,e,i,o,r,s,a){c(y,i,o,e);const p=m(y,t.spatialReference);return[await this._export(p,e[0],e[1],r,s,a)]}_tiledExport(t,e,i,o){const r=h.create({size:e,spatialReference:t.spatialReference,scales:[t.scale]}),s=new g(r),a=s.getTileCoverage(t);if(!a)return null;const p=[];return a.forEach(((r,a,n,l)=>{S.set(r,a,n,0),s.getTileBounds(y,S);const h=m(y,t.spatialReference);p.push(this._export(h,e,e,0,i,o).then((t=>(0!==l&&(S.set(r,a,n,l),s.getTileBounds(y,S),t.x=y[0],t.y=y[3]),t))))})),Promise.all(p)}};t([a()],w.prototype,\"_imagePromise\",void 0),t([a()],w.prototype,\"bitmaps\",void 0),t([a()],w.prototype,\"container\",void 0),t([a()],w.prototype,\"fetchSource\",void 0),t([a()],w.prototype,\"hidpi\",void 0),t([a()],w.prototype,\"imageMaxWidth\",void 0),t([a()],w.prototype,\"imageMaxHeight\",void 0),t([a()],w.prototype,\"imageRotationSupported\",void 0),t([a()],w.prototype,\"imageNormalizationSupported\",void 0),t([a()],w.prototype,\"requestUpdate\",void 0),t([a()],w.prototype,\"updating\",null),w=t([p(\"esri.views.2d.layers.support.ExportStrategy\")],w);const v=w;export{v as default};\n"],"mappings":"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"}