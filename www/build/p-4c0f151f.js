import{fS as t,bM as s,l as i,y as e,n as r,aD as n,bC as a,aT as o,a6 as h,Q as u,b as c,r as l,ad as p,he as d,s as m,M as f,av as g,aW as b,ae as x}from"./p-b54724b6.js";import{o as y}from"./p-12b975f0.js";import{f as _,d as w,h as v}from"./p-dbc26b16.js";import{f as P,d as T}from"./p-5f5f43c2.js";import{G as j}from"./p-6ffbaa7a.js";import{r as S,M as R,h as F,b as M,i as I,s as z}from"./p-52a9dec5.js";import{e as C}from"./p-07f12c16.js";import{t as U}from"./p-2d1dac84.js";import{a as V}from"./p-843f0c78.js";import{L as D,P as G,G as A,U as O,D as L,R as B,I as k}from"./p-13e550f5.js";import{m as E,c as W,l as q,O as N,E as Q,p as Y,T as $,A as H,h as J,g as K,_ as X}from"./p-90332a18.js";import{n as Z}from"./p-541ec65c.js";import{f as tt}from"./p-783b6965.js";import{b as st,T as it}from"./p-49f0006c.js";import{c as et}from"./p-570a8a46.js";import{g as rt,n as nt}from"./p-0fe6a545.js";import{x as at}from"./p-1fd43aa6.js";import{r as ot}from"./p-b3dc802f.js";import{T as ht}from"./p-29040467.js";import{i as ut}from"./p-58405edc.js";import{u as ct,S as lt}from"./p-f7376ac9.js";import{j as pt}from"./p-8bc47c76.js";import{g as dt,a as mt,u as ft,i as gt}from"./p-166207f6.js";import{o as bt,K as xt,T as yt,q as _t}from"./p-22a6b5ef.js";import{e as wt}from"./p-6cd106e8.js";import{d as vt,y as Pt}from"./p-faf4e331.js";import{h as Tt}from"./p-cd4a8b9a.js";import"./p-cae2235f.js";import{n as jt}from"./p-a379c2ce.js";import{r as St}from"./p-015ba93b.js";import{p as Rt}from"./p-52324761.js";import{a as Ft}from"./p-3faf3e32.js";import"./p-795f7c81.js";import"./p-fc9cd10b.js";import"./p-fdc41b20.js";import"./p-ecc7ed03.js";import"./p-05938a61.js";import"./p-8043ab9b.js";import"./p-1184cc61.js";import"./p-98e621d1.js";import"./p-1b31d781.js";import"./p-f7f8e6f9.js";import"./p-a779e49b.js";import"./p-7572c366.js";import"./p-832f907c.js";import"./p-5abe9c67.js";import"./p-0856fe30.js";import"./p-a5e3ec2a.js";import"./p-80be55a5.js";import"./p-b88ddb1e.js";import"./p-8dc3148c.js";import"./p-ca5fb53c.js";import"./p-e6a64715.js";import"./p-dc29c329.js";import"./p-d7fc78fa.js";import"./p-a3f0a5f3.js";import"./p-581eca80.js";import"./p-2a2efb66.js";import"./p-1701e549.js";import"./p-07a1e707.js";import"./p-c19b935f.js";import"./p-c8e3775b.js";import"./p-e75aa2b5.js";import"./p-f5f26b1f.js";import"./p-74887bd8.js";import"./p-33c0f331.js";import"./p-9f1a0adc.js";import"./p-5b0b1d68.js";import"./p-4f76b2d1.js";import"./p-0e94eaa4.js";import"./p-42c332a2.js";import"./p-38e70926.js";import"./p-9a4094ba.js";const Mt={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class It extends V{constructor(t=null,s=null,i=null){super(),this._textureInvalidated=!0,this._colormapTextureInvalidated=!0,this._rasterTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,this._colormapTexture=null,this._colormap=null,this._supportsBilinearTexture=!0,this._processedTexture=null,this.functionTextures=[],this.projected=!1,this.stencilRef=0,this.coordScale=[1,1],this._processed=!1,this._symbolizerParameters=null,this.height=null,this.isRendereredSource=!1,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this.rawPixelData=null,this._suspended=!1,this._bandIds=null,this._interpolation=null,this._transformGrid=null,this.width=null,this.x=0,this.y=0,this.source=t,this.transformGrid=s,this.interpolation=i}destroy(){this._disposeTextures()}get processedTexture(){return this._processedTexture}set processedTexture(t){this._processedTexture!==t&&(this._disposeTextures(!0),this._processedTexture=t)}get rasterTexture(){return this._rasterTexture}set rasterTexture(t){this._rasterTexture!==t&&(this._rasterTexture?.dispose(),this._rasterTexture=t)}get processed(){return this._processed}set processed(s){this._processed=s,s||(t(this.processedTexture),this.invalidateTexture())}get symbolizerParameters(){return this._symbolizerParameters||Mt}set symbolizerParameters(t){this._symbolizerParameters!==t&&(this._symbolizerParameters=t,this._colormapTextureInvalidated=!0,this.commonUniforms=null)}get source(){return this._source}set source(t){this._source!==t&&(this._source=t,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._rasterTextureBandIds=null),this.projected=!1,this.invalidateTexture())}get suspended(){return this._suspended}set suspended(t){this._suspended&&!t&&this.stage&&(this.ready(),this.requestRender()),this._suspended=t}get bandIds(){return this._bandIds}set bandIds(t){this._bandIds=t,this._isBandIdschanged(t)&&(this.projected=!1,this.invalidateTexture())}get interpolation(){return this._interpolation||"nearest"}set interpolation(t){this._interpolation=t,this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===this._getTextureSamplingMethod(t||"nearest")?D.LINEAR:D.NEAREST)}get transformGrid(){return this._transformGrid}set transformGrid(s){this._transformGrid=s,this._transformGridTexture=t(this._transformGridTexture)}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())}_createTransforms(){return{dvs:C()}}setTransform(t){const s=S(this.transforms.dvs),[i,e]=t.toScreenNoRotation([0,0],[this.x,this.y]),r=this.resolution/this.pixelRatio/t.resolution,n=r*this.width,a=r*this.height,o=Math.PI*this.rotation/180;R(s,s,U(i,e)),R(s,s,U(n/2,a/2)),F(s,s,-o),R(s,s,U(-n/2,-a/2)),M(s,s,U(n,a)),I(this.transforms.dvs,t.displayViewMat3,s)}getTextures({forProcessing:t=!1,useProcessedTexture:s=!1}={}){const i=s?this._processedTexture??this._rasterTexture:this._rasterTexture,e=[],r=[];return i?s?(r.push(i),e.push("u_image"),this._colormapTexture&&(r.push(this._colormapTexture),e.push("u_colormap")),{names:e,textures:r}):(this._transformGridTexture&&(r.push(this._transformGridTexture),e.push("u_transformGrid")),r.push(i),e.push("u_image"),this._colormapTexture&&!t&&(r.push(this._colormapTexture),e.push("u_colormap")),{names:e,textures:r}):{names:e,textures:r}}onAttach(){this.invalidateTexture()}onDetach(){this.invalidateTexture()}updateTexture({context:t}){if(!this.stage)return void this._disposeTextures();const s=this._isValidSource(this.source);s&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(t)),this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(t),this._rasterTexture&&(s?this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=E(t,this.transformGrid)):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()))}updateProcessedTexture(){const{functionTextures:t}=this;0!==t.length&&(this.processedTexture=t.shift(),t.forEach((t=>t?.dispose())),t.length=0)}_createOrDestroyRasterTexture(t){const s=this.source?.extractBands(this.bandIds);if(!this._isValidSource(s))return void(this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTextureBandIds=null,this._rasterTexture=null));const i=!this._isBandIdschanged(this.bandIds);if(this._rasterTexture){if(i)return;this._rasterTexture.dispose(),this._rasterTextureBandIds=null,this._rasterTexture=null}this._supportsBilinearTexture=!!t.capabilities.textureFloat?.textureFloatLinear;const e=this._getTextureSamplingMethod(this.interpolation),r=this.isRendereredSource||!t.capabilities.textureFloat?.textureFloat;this._rasterTexture=W(t,s,e,r),this.projected=!1,this._processed=!1,this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}_isBandIdschanged(t){const s=this._rasterTextureBandIds;return!(null==s&&null==t||s&&t&&s.join("")===t.join(""))}_isValidSource(t){return null!=t&&t.pixels?.length>0}_getTextureSamplingMethod(t){const{type:s,colormap:i}=this.symbolizerParameters,e="lut"===s||"stretch"===s&&null!=i;return!this._supportsBilinearTexture||e||"bilinear"!==t&&"cubic"!==t?"nearest":"bilinear"}_updateColormapTexture(t){const s=this._colormap,i=this.symbolizerParameters.colormap;return i?s?i.length!==s.length||i.some(((t,i)=>t!==s[i]))?(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=q(t,i),void(this._colormap=i)):void 0:(this._colormapTexture=q(t,i),void(this._colormap=i)):(this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),void(this._colormap=null))}_disposeTextures(t=!1){this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null),!t&&this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null,this._colormap=null,this._colormapTextureInvalidated=!0),!t&&this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=null,this._rasterTextureBandIds=null),this._processedTexture&&(this._processedTexture.dispose(),this._processedTexture=null)}}function zt(t){return null!=t.source}function Ct(t){const s=[];return t&&(s.push("applyProjection"),1===t.spacing[0]&&s.push("lookupProjection")),s}function Ut(t,s,i){const e=!i.capabilities.textureFloat?.textureFloatLinear,r=[];return"cubic"===t?r.push("bicubic"):"bilinear"===t&&(s?(r.push("bilinear"),r.push("nnedge")):e&&r.push("bilinear")),r}const Vt={vsPath:"raster/common",fsPath:"raster/lut",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Dt(t,s,i){const e=i?[]:Ct(s.transformGrid);return{defines:e,program:t.painter.materialManager.getProgram(Vt,e)}}function Gt(t,s,i,e,r=!1){const{names:n,textures:a}=i.getTextures({useProcessedTexture:r});N(t.context,s,n,a),Q(s,e,i.commonUniforms),s.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs);const{colormap:o,colormapOffset:h}=i.symbolizerParameters,u=Y(o,h);Q(s,e,u)}const At={createProgram:Dt,bindTextureAndUniforms:Gt};const Ot={vsPath:"raster/common",fsPath:"raster/hillshade",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Lt(t,s,i){const{colormap:e}=s.symbolizerParameters,r=[...i?[]:Ct(s.transformGrid),...Ut(s.interpolation,null!=e,t.context)];null!=e&&r.push("applyColormap");return{defines:r,program:t.painter.materialManager.getProgram(Ot,r)}}function Bt(t,s,i,e,r=!1){const{names:n,textures:a}=i.getTextures({useProcessedTexture:r});N(t.context,s,n,a),Q(s,e,i.commonUniforms),s.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs);const o=i.symbolizerParameters,{colormap:h,colormapOffset:u}=o;if(null!=h){const t=Y(h,u);Q(s,e,t)}const c=$(o);Q(s,e,c)}const kt={createProgram:Lt,bindTextureAndUniforms:Bt};const Et={vsPath:"raster/common",fsPath:"raster/stretch",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Wt(t,s,i){const{colormap:e}=s.symbolizerParameters,r=[...i?[]:Ct(s.transformGrid),...Ut(s.interpolation,null!=e,t.context)];s.isRendereredSource&&!i?r.push("noop"):null!=e&&r.push("applyColormap");return{defines:r,program:t.painter.materialManager.getProgram(Et,r)}}function qt(t,s,i,e,r=!1){const{names:n,textures:a}=i.getTextures({useProcessedTexture:r});N(t.context,s,n,a),Q(s,e,i.commonUniforms),s.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs);const o=i.symbolizerParameters,{colormap:h,colormapOffset:u}=o;if(null!=h){const t=Y(h,u);Q(s,e,t)}const c=H(o);Q(s,e,c)}const Nt={createProgram:Wt,bindTextureAndUniforms:qt};const Qt=new Map;function Yt(t){return Qt.get(t)}Qt.set("lut",At),Qt.set("hillshade",kt),Qt.set("stretch",Nt);const $t=[1,1],Ht=[2,0,0,0,2,0,-1,-1,0];function Jt(t,s,i){const{context:e,rasterFunction:r,hasBranches:n}=t,{raster:a}=r.parameters,o=n?a?.id??-1:0,h=i.functionTextures[o]??i.rasterTexture;N(e,s,["u_image"],[h])}function Kt(t,s,i){const{rasters:e}=t.rasterFunction.parameters;if(!e)return;if(e.length<2)return Jt(t,s,i);const r=e.filter((t=>"Constant"!==t.name)).map((t=>null!=t.id&&"Identity"!==t.name?i.functionTextures[t.id]:i.rasterTexture));if(N(t.context,s,["u_image","u_image1","u_image2"].slice(0,r.length),r),r.length!==e.length)if(2===e.length){const t=e.findIndex((t=>"Constant"===t.name)),i=0===t?[0,1,0,1,0,0,0,0,0]:[1,0,0,0,1,0,0,0,0],{value:r}=e[t].parameters;s.setUniform1f("u_image1Const",r),s.setUniformMatrix3fv("u_imageSwap",i)}else if(3===e.length){const t=[];if(e.forEach(((s,i)=>"Constant"===s.name&&t.push(i))),1===t.length){const{value:i}=e[t[0]].parameters;s.setUniform1f("u_image1Const",i);const r=0===t[0]?[0,1,0,0,0,1,1,0,0]:1===t[0]?[1,0,0,0,0,1,0,1,0]:[1,0,0,0,1,0,0,0,1];s.setUniformMatrix3fv("u_imageSwap",r)}else if(2===t.length){const{value:i}=e[t[0]].parameters;s.setUniform1f("u_image1Const",i);const{value:r}=e[t[1]].parameters;s.setUniform1f("u_image2Const",r);const n=e.findIndex((t=>"Constant"!==t.name)),a=0===n?[1,0,0,0,1,0,0,0,1]:1===n?[0,1,0,1,0,0,0,0,1]:[0,0,1,1,0,0,0,1,0];s.setUniformMatrix3fv("u_imageSwap",a)}}}function Xt(t){t.setUniform2fv("u_coordScale",$t),t.setUniformMatrix3fv("u_dvsMat3",Ht)}const Zt={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/aspect",attributes:new Map([["a_position",0],["a_texcoord",1]])};function ts(t,s){return t.painter.materialManager.getProgram(Zt,[])}function ss(t,s,i){Jt(t,s,i),Xt(s);const{width:e,height:r,resolution:n}=i;s.setUniform2fv("u_srcImageSize",[e,r]),s.setUniform2fv("u_cellSize",[n,n])}const is={createProgram:ts,bindTextureAndUniforms:ss};const es={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/bandarithmetic",attributes:new Map([["a_position",0],["a_texcoord",1]])};function rs(t,s){const{painter:i,rasterFunction:e}=t,{indexType:r}=e.parameters;return i.materialManager.getProgram(es,[r])}function ns(t,s,i){Jt(t,s,i),Xt(s);const{bandIndexMat3:e}=t.rasterFunction.parameters;s.setUniformMatrix3fv("u_bandIndexMat3",e)}const as={createProgram:rs,bindTextureAndUniforms:ns};const os={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/compositeband",attributes:new Map([["a_position",0],["a_texcoord",1]])};function hs(t,s){return t.painter.materialManager.getProgram(os,[])}function us(t,s,i){Kt(t,s,i),Xt(s)}const cs={createProgram:hs,bindTextureAndUniforms:us};const ls={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/convolution",attributes:new Map([["a_position",0],["a_texcoord",1]])};function ps(t,s){const{painter:i,rasterFunction:e}=t,{kernelRows:r,kernelCols:n}=e.parameters,a=[{name:"rows",value:r},{name:"cols",value:n}];return i.materialManager.getProgram(ls,a)}function ds(t,s,i){Jt(t,s,i),Xt(s),s.setUniform2fv("u_srcImageSize",[i.width,i.height]);const{kernel:e,clampRange:r}=t.rasterFunction.parameters;s.setUniform1fv("u_kernel",e),s.setUniform2fv("u_clampRange",r)}const ms={createProgram:ps,bindTextureAndUniforms:ds};const fs={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/curvature",attributes:new Map([["a_position",0],["a_texcoord",1]])};function gs(t,s){const{painter:i,rasterFunction:e}=t,{curvatureType:r}=e.parameters,n=[r];return i.materialManager.getProgram(fs,n)}function bs(t,s,i){Jt(t,s,i),Xt(s);const{width:e,height:r,resolution:n}=i,{zFactor:a}=t.rasterFunction.parameters;s.setUniform2fv("u_srcImageSize",[e,r]),s.setUniform1f("u_zlFactor",200*a/n/n)}const xs={createProgram:gs,bindTextureAndUniforms:bs};const ys={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/extractband",attributes:new Map([["a_position",0],["a_texcoord",1]])};function _s(t,s){return t.painter.materialManager.getProgram(ys,[])}function ws(t,s,i){Jt(t,s,i),Xt(s);const{bandIndexMat3:e}=t.rasterFunction.parameters;s.setUniformMatrix3fv("u_bandIndexMat3",e)}const vs={createProgram:_s,bindTextureAndUniforms:ws};const Ps={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/local",attributes:new Map([["a_position",0],["a_texcoord",1]])},Ts=new Set(["sinh","cosh","tanh","asinh","acosh","atanh"]);function js(t){const{painter:s,rasterFunction:i}=t,{imageCount:e,operationName:r,rasters:n,isOutputRounded:a}=i.parameters;let o=r.toLowerCase();t.context.type===Z.WEBGL1&&Ts.has(o)&&(o=`polyfill${o}`);const h=[o];2===e&&h.push("twoImages");const u=n.filter((t=>"Constant"===t.name));return u.length&&(h.push("oneConstant"),2===u.length&&h.push("twoConstant")),a&&h.push("roundOutput"),s.materialManager.getProgram(Ps,h)}function Ss(t,s,i){Kt(t,s,i),Xt(s);const{domainRange:e}=t.rasterFunction.parameters;s.setUniform2fv("u_domainRange",e)}const Rs={createProgram:js,bindTextureAndUniforms:Ss};const Fs={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/mask",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Ms(t,s){const{painter:i,rasterFunction:e}=t,r=e.parameters.bandCount>1?["multiBand"]:[];return i.materialManager.getProgram(Fs,r)}function Is(t,s,i){Jt(t,s,i),Xt(s);const{includedRanges:e,noDataValues:r}=t.rasterFunction.parameters;s.setUniform1fv("u_includedRanges",e),s.setUniform1fv("u_noDataValues",r)}const zs={createProgram:Ms,bindTextureAndUniforms:Is};const Cs={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/ndvi",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Us(t,s){const{painter:i,rasterFunction:e}=t,r=e.parameters.scaled?["scaled"]:[];return i.materialManager.getProgram(Cs,r)}function Vs(t,s,i){Jt(t,s,i),Xt(s);const{bandIndexMat3:e}=t.rasterFunction.parameters;s.setUniformMatrix3fv("u_bandIndexMat3",e)}const Ds={createProgram:Us,bindTextureAndUniforms:Vs};const Gs={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/remap",attributes:new Map([["a_position",0],["a_texcoord",1]])};function As(t,s){return t.painter.materialManager.getProgram(Gs,[])}function Os(t,s,i){Jt(t,s,i),Xt(s);const{noDataRanges:e,rangeMaps:r,allowUnmatched:n,clampRange:a}=t.rasterFunction.parameters;s.setUniform1fv("u_noDataRanges",e),s.setUniform1fv("u_rangeMaps",r),s.setUniform1f("u_unmatchMask",n?1:0),s.setUniform2fv("u_clampRange",a)}const Ls={createProgram:As,bindTextureAndUniforms:Os};const Bs={vsPath:"raster/common",fsPath:"raster/reproject",attributes:new Map([["a_position",0],["a_texcoord",1]])};function ks(t,s){const{painter:i}=t,e=[],{interpolation:r,transformGrid:n}=s,a=!!t.rasterFunction?.parameters?.requireBilinear,o="bilinear"===r?!t.context.capabilities.textureFloat?.textureFloatLinear:a;return"cubic"===r?e.push("bicubic"):o&&e.push("bilinear"),n&&(e.push("applyProjection"),1===n.spacing[0]&&e.push("lookupProjection")),i.materialManager.getProgram(Bs,e)}function Es(t,s,i){const{names:e,textures:r}=i.getTextures({forProcessing:!0});N(t.context,s,e,r),s.setUniform1f("u_scale",1),s.setUniform2fv("u_offset",[0,0]),s.setUniform2fv("u_coordScale",[1,1]),s.setUniformMatrix3fv("u_dvsMat3",[2,0,0,0,2,0,-1,-1,0]),s.setUniform1i("u_flipY",0),s.setUniform1f("u_opacity",1);const{width:n,height:a,source:o,transformGrid:h}=i;s.setUniform2fv("u_srcImageSize",[o.width,o.height]),s.setUniform2fv("u_targetImageSize",[n,a]),s.setUniform2fv("u_transformSpacing",h?h.spacing:tt),s.setUniform2fv("u_transformGridSize",h?h.size:tt)}const Ws={createProgram:ks,bindTextureAndUniforms:Es};const qs={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/slope",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Ns(t,s){const{painter:i,rasterFunction:e}=t,{slopeType:r}=e.parameters,n="percent-rise"===r?["percentRise"]:[];return i.materialManager.getProgram(qs,n)}function Qs(t,s,i){Jt(t,s,i),Xt(s);const{width:e,height:r,resolution:n}=i,{zFactor:a,slopeType:o,pixelSizePower:h,pixelSizeFactor:u}=t.rasterFunction.parameters;s.setUniform2fv("u_srcImageSize",[e,r]),s.setUniform2fv("u_cellSize",[n,n]),s.setUniform1f("u_zFactor",a),s.setUniform1f("u_pixelSizePower","adjusted"===o?h:0),s.setUniform1f("u_pixelSizeFactor","adjusted"===o?u:0)}const Ys={createProgram:Ns,bindTextureAndUniforms:Qs};const $s={vsPath:"raster/rfx/vs",fsPath:"raster/rfx/stretch",attributes:new Map([["a_position",0],["a_texcoord",1]])};function Hs(t,s){const{useGamma:i,bandCount:e,isOutputRounded:r}=t.rasterFunction.parameters,n=[];return i&&n.push("useGamma"),e>1&&n.push("multiBand"),r&&n.push("roundOutput"),t.painter.materialManager.getProgram($s,n)}function Js(t,s,i){Jt(t,s,i),Xt(s);const{width:e,height:r}=i,n=t.rasterFunction.parameters;s.setUniform2fv("u_srcImageSize",[e,r]),s.setUniform1f("u_minOutput",n.outMin),s.setUniform1f("u_maxOutput",n.outMax),s.setUniform1fv("u_factor",n.factor),s.setUniform1fv("u_minCutOff",n.minCutOff),s.setUniform1fv("u_maxCutOff",n.maxCutOff),s.setUniform1fv("u_gamma",n.gamma),s.setUniform1fv("u_gammaCorrection",n.gammaCorrection)}const Ks={createProgram:Hs,bindTextureAndUniforms:Js};const Xs=new Map;function Zs(t,s,i){const e=new st;return e.width=s,e.height=i,e.internalFormat=t.type===Z.WEBGL2?G.RGBA32F:A.RGBA,e.samplingMode=D.NEAREST,e.dataType=O.FLOAT,e.isImmutable=t.type===Z.WEBGL2,e.wrapMode=L.CLAMP_TO_EDGE,e}function ti(t,s,i,e){const{context:r,requestRender:n,allowDelayedRender:a}=t,o=e.createProgram(t,i);if(a&&null!=n&&!o.compiled)return n(),null;const{width:h,height:u}=i;return r.bindFramebuffer(s),r.setViewport(0,0,h,u),r.useProgram(o),o}function si(t){return Xs.get(t.toLowerCase())}function ii(t,s,i,e){const r=t.rasterFunction.name.toLowerCase(),n="reproject"===r?Ws:si(r);if(null==n)return;const a=ti(t,i,e,n);if(!a)return;n.bindTextureAndUniforms(t,a,e),s.draw();const{width:o,height:h}=e,u=Zs(t.context,o,h),c=new it(t.context,u);if(i.copyToTexture(0,0,o,h,0,0,c),"reproject"===r)e.rasterTexture=c,e.projected=!0;else{const s=t.hasBranches?t.rasterFunction.id:0;e.functionTextures[s]=c}}Xs.set("aspect",is),Xs.set("bandarithmetic",as),Xs.set("compositeband",cs),Xs.set("convolution",ms),Xs.set("curvature",xs),Xs.set("extractband",vs),Xs.set("local",Rs),Xs.set("mask",zs),Xs.set("ndvi",Ds),Xs.set("remap",Ls),Xs.set("slope",Ys),Xs.set("stretch",Ks);class ei extends rt{constructor(){super(...arguments),this.name="raster",this._quad=null,this._rendererUniformInfos=new Map,this._fbo=null}dispose(){t(this._quad),t(this._fbo)}prepareState(t){const{context:s,renderPass:i}=t,e="raster"===i;s.setBlendingEnabled(!e),s.setBlendFunctionSeparate(B.ONE,B.ONE_MINUS_SRC_ALPHA,B.ONE,B.ONE_MINUS_SRC_ALPHA),s.setColorMask(!0,!0,!0,!0),s.setStencilWriteMask(0),s.setStencilTestEnabled(!e)}draw(t,s){if(!zt(s)||s.suspended)return;const{renderPass:i}=t;if("raster-bitmap"!==i)return"raster"===i?this._process(t,s):void this._drawBitmap(t,s,!0);this._drawBitmap(t,s)}_process(s,i){const{rasterFunction:e}=s,r="Reproject"===e.name;if(!(r?!(i.rasterTexture&&i.projected):!i.processed))return;const{timeline:n,context:a}=s;n.begin(this.name);const o=a.getBoundFramebufferObject(),h=a.getViewport();r||(i.processedTexture=t(i.processedTexture)),a.setStencilFunction(k.EQUAL,i.stencilRef,255),i.updateTexture(s),this._initQuad(a);const{isStandardRasterTileSize:u,fbo:c}=this._getRasterFBO(a,i.width,i.height);ii(s,this._quad,c,i),u||c.dispose(),a.bindFramebuffer(o),a.setViewport(h.x,h.y,h.width,h.height),n.end(this.name)}_drawBitmap(t,s,i=!1){const{timeline:e,context:r}=t;if(e.begin(this.name),r.setStencilFunction(k.EQUAL,s.stencilRef,255),s.updateTexture(t),i&&!s.processedTexture){if(s.updateProcessedTexture(),!s.processedTexture)return void e.end(this.name);s.processed=!0}this._initBitmapCommonUniforms(s);const n=s.symbolizerParameters.type,a=Yt(n),{requestRender:o,allowDelayedRender:h}=t,{defines:u,program:c}=a.createProgram(t,s,i);if(h&&null!=o&&!c.compiled)return void o();r.useProgram(c);const l=this._getUniformInfos(n,r,c,u);this._quad||(this._quad=new nt(r,[0,0,1,0,0,1,1,1])),a.bindTextureAndUniforms(t,c,s,l,i),this._quad.draw(),e.end(this.name)}_initBitmapCommonUniforms(t){if(!t.commonUniforms){const s=K(1,[0,0]),{transformGrid:i,width:e,height:r}=t,n=X(i,[e,r],[t.source.width,t.source.height],1,!1);t.commonUniforms={...s,...n,u_coordScale:t.coordScale}}}_getRasterFBO(t,s,i){const e=s===et||i===et;return e?(this._fbo||(this._fbo=this._createNewFBO(t,s,i)),{isStandardRasterTileSize:e,fbo:this._fbo}):{isStandardRasterTileSize:e,fbo:this._createNewFBO(t,s,i)}}_createNewFBO(t,s,i){const e=Zs(t,s,i);return new at(t,e)}_initQuad(t){this._quad||(this._quad=new nt(t,[0,0,1,0,0,1,1,1]))}_getUniformInfos(t,s,i,e){const r=e.length>0?t+"-"+e.join("-"):t;if(this._rendererUniformInfos.has(r))return this._rendererUniformInfos.get(r);const n=J(s,i);return this._rendererUniformInfos.set(r,n),n}}class ri extends ot{constructor(t,s,i,e,r,n,a=null){super(t,s,i,e,r,n),this.bitmap=null,this.bitmap=new It(a,null,null),this.bitmap.coordScale=[r,n],this.bitmap.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(t){this.bitmap.stencilRef=t}get stencilRef(){return this.bitmap.stencilRef}setTransform(t){super.setTransform(t),this.bitmap.transforms.dvs=this.transforms.dvs}_createTransforms(){return{dvs:C(),tileMat3:C()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}}class ni extends ut{constructor(){super(...arguments),this.isCustomTilingScheme=!1}createTile(t){const s=this._getTileBounds(t),[i,e]=this._tileInfoView.tileInfo.size,r=this._tileInfoView.getTileResolution(t.level);return new ri(t,r,s[0],s[3],i,e)}prepareRenderPasses(t){const s=t.registerRenderPass({name:"imagery (tile)",brushes:[ei],target:()=>this.children.map((t=>t.bitmap)),drawPhase:ht.MAP});return[...super.prepareRenderPasses(t),s]}doRender(t){if(!this.visible||t.drawPhase!==ht.MAP)return;const{rasterFunctionChain:s}=this;if(!s)return t.renderPass="raster-bitmap",void super.doRender(t);const[i,e]=this._tileInfoView.tileInfo.size;if(t.renderPass="raster",t.rasterFunction={name:"Reproject",parameters:{targetImageSize:[i,e],requireBilinear:s.hasSurfaceFunction},pixelType:"f32",id:0,isNoopProcess:!1},super.doRender(t),s?.functions.length){const{functions:i,hasBranches:e}=s;for(let s=0;s<i.length;s++){const r=i[s];"Constant"!==r.name&&"Identity"!==r.name&&(t.renderPass="raster",t.rasterFunction=r,t.hasBranches=e,super.doRender(t))}}t.rasterFunction=null,t.renderPass="bitmap",super.doRender(t)}_getTileBounds(t){const i=this._tileInfoView.getTileBounds(s(),t);if(this.isCustomTilingScheme&&t.world){const{tileInfo:s}=this._tileInfoView,e=j(s.spatialReference);if(e){const r=s.lodAt(t.level);if(!r)return i;const{resolution:n}=r,a=e/n%s.size[0],o=a?(s.size[0]-a)*n:0;i[0]-=o*t.world,i[2]-=o*t.world}}return i}}const ai=[0,0];let oi=class extends n{constructor(){super(...arguments),this._emptyTilePixelBlock=null,this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=[],this.previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._isCustomTilingScheme=!1,this._maxIndexedColormapSize=0,this._rasterFunctionState="na",this._globalUpdateRequested=!1,this.attached=!1,this.timeExtent=null,this.redrawOrRefetch=a((async(t={})=>{if(!this.previousLOD||this.layerView.suspended)return;const s=this._rasterFunctionState;t.reprocess&&(await this.updatingHandles.addPromise(this.layer.updateRasterFunction()),this.updateRasterFunctionParameters());const i=this._rasterFunctionState,{type:e}=this;return t.refetch||"raster"!==e&&!!t.reprocess||"cpu"===i||"cpu"===s?this.updatingHandles.addPromise(this.doRefresh()):this.updatingHandles.addPromise(this._redrawImage(t.signal))}))}get useWebGLForProcessing(){return this._get("useWebGLForProcessing")??!0}set useWebGLForProcessing(t){this._set("useWebGLForProcessing",t)}get useProgressiveUpdate(){return this._get("useProgressiveUpdate")??!0}set useProgressiveUpdate(t){if(this._tileStrategy&&this.useProgressiveUpdate!==t){this._tileStrategy.destroy(),this.container.removeAllChildren();const s=this._getCacheSize(t);this._tileStrategy=new vt({cachePolicy:"purge",acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),cacheSize:s,tileInfoView:this._tileInfoView}),this._set("useProgressiveUpdate",t),this.layerView.requestUpdate()}}update(t){this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume();const{extent:s,resolution:i,scale:e}=t.state,r=this._tileInfoView.getClosestInfoForScale(e);if(this.layer.raster){if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){const t=this._srcResolutions[r.level],e=s.toJSON?s:o.fromJSON(s);dt(this._blockCacheRegistryUrl,this._blockCacheRegistryId,e,i,t,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,this.previousLOD?.level!==r.level&&(this.previousLOD=r,null==this._symbolizerParams||this.layerView.hasTilingEffects||this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}}moveEnd(){!this.layerView.hasTilingEffects&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,0===this._fetchQueue.length&&this._redrawImage(this._abortController.signal).then((()=>{this._globalUpdateRequested=!1,this.layerView.requestUpdate()})));const t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(t),this.layerView.requestUpdate()}get updating(){return this._fetchQueue?.updating||this._globalUpdateRequested||!(!this.updatingHandles||!this.updatingHandles.updating)}attach(){const t=jt("2d");this._maxIndexedColormapSize=4*(t.maxTextureSize||4096),t.supportsTextureFloat||(this.useWebGLForProcessing=!1),this._initializeTileInfo(),this._tileInfoView=new Tt(this.layerView.tileInfo,this.layerView.fullExtent);const s=this._computeFetchConcurrency();this._fetchQueue=new Pt({tileInfoView:this._tileInfoView,concurrency:s,process:(t,s)=>this._fetchTile1(t,s)});const i=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new vt({cachePolicy:"purge",acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),cacheSize:i,tileInfoView:this._tileInfoView}),this._updateBlockCacheRegistry()}detach(){this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,mt(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryUrl=this._blockCacheRegistryId=null}acquireTile(t){const s=this.container.createTile(t);return this._enqueueTileFetch(s),this.layerView.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.layerView.hasTilingEffects||!this.useProgressiveUpdate,s}releaseTile(t){this._fetchQueue.abort(t.key.id),this.container.removeChild(t),t.once("detach",(()=>{t.destroy(),this.layerView.requestUpdate()})),this.layerView.requestUpdate()}createEmptyTilePixelBlock(t=null){const s=null==t||t.join(",")===this._tileInfoView.tileInfo.size.join(",");if(s&&null!=this._emptyTilePixelBlock)return this._emptyTilePixelBlock;t=t||this._tileInfoView.tileInfo.size;const[i,e]=t,r=new ct({width:i,height:e,pixels:[new Uint8Array(i*e)],mask:new Uint8Array(i*e),pixelType:"u8"});return s&&(this._emptyTilePixelBlock=r),r}_getBandIds(){if(!("rasterFunctionChain"in this.container)||!this.container.rasterFunctionChain)return this.layer.bandIds;const{bandIds:t,raster:s}=this.layer,i="rasterFunction"in s?s.rasterFunction.rawInputBandIds:null;return t?.length&&i?.length&&1!==s.rasterInfo.bandCount?t.map((t=>i[Math.min(t,i.length-1)])):t||i}updateRasterFunctionParameters(){}_fetchTile1(t,s){const i=null!=s?s.signal:null,e=this.canUseWebGLForProcessing(),{layerView:r}=this,{tileInfo:n}=r,a=!n.isWrappable&&null!=xt(r.view.spatialReference),o=e&&this.layer.raster.hasUniqueSourceStorageInfo,h={allowPartialFill:!0,datumTransformation:r.datumTransformation,interpolation:e?"nearest":this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:o,skipRasterFunction:"raster"===this.type&&null!=this.container.rasterFunctionChain,signal:i,srcResolution:this._srcResolutions[t.level],timeExtent:r.timeExtent,tileInfo:n,disableWrapAround:a};return this.fetchTile(t,h)}_getCacheSize(t){return t?40:0}_initializeTileInfo(){const{layerView:t}=this,s=t.view.spatialReference;if(this._canUseLayerLODs()){const{origin:i,lods:e}=this.layer.tileInfo,r=e.map((({scale:t})=>t)),n=pt.create({spatialReference:s,size:et,scales:r,origin:i});return t.set("tileInfo",n),void(this._srcResolutions=e.map((({resolution:t})=>({x:t,y:t}))))}const i=wt(this.layer.rasterInfo),{scales:e,srcResolutions:r,isCustomTilingScheme:n}=bt(this.layer.rasterInfo,s,{tileSize:et,alignGlobalDatasetWithAGOL:!0,limitToSrcResolution:i}),a=pt.create({spatialReference:s,size:et,scales:e}),o=new h({x:t.fullExtent.xmin,y:t.fullExtent.ymax,spatialReference:s});(0===a.origin.x||a.origin.x>o.x)&&(a.origin=o),this._isCustomTilingScheme=n,t.set("tileInfo",a),this._srcResolutions=r??[]}_canUseLayerLODs(){const{layer:t,layerView:s}=this;if("Map"!==t.raster.tileType)return!1;const{lods:i}=t.tileInfo,e=s.view.constraints?.effectiveLODs;return e?.length===i.length&&e.every((({scale:t},s)=>Math.abs(t-i[s].scale)<.001))}_computeFetchConcurrency(){const{blockBoundary:t}=this.layer.rasterInfo.storageInfo,s=t[t.length-1];return(s.maxCol-s.minCol+1)*(s.maxRow-s.minRow+1)>64?2:10}async _enqueueTileFetch(t,s){this.updatingHandles.addPromise(this._enqueueTileFetch1(t,s))}async _enqueueTileFetch1(t,s){if(!this._fetchQueue.has(t.key.id)){try{const s=await this._fetchQueue.push(t.key),i=this._getBandIds();let e=!this.useProgressiveUpdate||this.layerView.hasTilingEffects&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.layerView.moving&&0===this._fetchQueue.length){e=!1;try{await this._redrawImage(this._abortController?.signal)}catch(t){u(t)&&c.getLogger(this).error(t)}this._globalUpdateRequested=!1}!this.canUseWebGLForProcessing()&&"rasterVF"!==this.type||this.layerView.hasTilingEffects||null!=this._symbolizerParams||this._updateSymbolizerParams();const r=this._tileInfoView.getTileCoords(ai,t.key),n=this._tileInfoView.getTileResolution(t.key);await this.updateTileSource(t,{source:s,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:e,bandIds:i,coords:r,resolution:n}),t.once("attach",(()=>this.layerView.requestUpdate())),this.container.addChild(t)}catch(t){u(t)||c.getLogger(this).error(t)}this.layerView.requestUpdate()}}async _redrawImage(t){if(0===this.container.children.length)return;await this.layer.updateRenderer(),this.layerView.hasTilingEffects?await this._updateGlobalSymbolizerParams(t):(this._updateSymbolizerParams(),this._globalSymbolizerParams=null);const s=this.container.children.map((async t=>this.updateTileSymbolizerParameters(t,{local:this._symbolizerParams,global:this._globalSymbolizerParams})));await l(s),this.container.requestRender()}async _updateGlobalSymbolizerParams(t){const s={srcResolution:this._srcResolutions[this.previousLOD.level],registryId:this._blockCacheRegistryId,signal:t},i=await this.layer.fetchPixels(this.layerView.view.extent,this.layerView.view.width,this.layerView.view.height,s);if(!i||!i.pixelBlock)return;const{resolution:e}=this.previousLOD,r=this._getBandIds(),n=this.layer.symbolizer.generateWebGLParameters({pixelBlock:i.pixelBlock.extractBands(r),isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:r});!this.canUseWebGLForProcessing()&&n&&"stretch"===n.type&&this.layer.renderer&&"raster-stretch"===this.layer.renderer.type&&(n.factor=n.factor.map((t=>255*t)),n.outMin=Math.round(255*n.outMin),n.outMax=Math.round(255*n.outMax)),this._globalSymbolizerParams=n}_updateSymbolizerParams(){const{resolution:t}=this.previousLOD,s=this._getBandIds();this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:t,y:t},bandIds:s})}_updateBlockCacheRegistry(t=!1){const{layer:s,layerView:i}=this,{url:e,raster:r}=s,{multidimensionalDefinition:n}=s.normalizeRasterFetchOptions({multidimensionalDefinition:s.multidimensionalDefinition,timeExtent:i.timeExtent}),a=r.rasterInfo.multidimensionalInfo?r.getSliceIndex(n):null,o=gt(e,a);if(o!==this._blockCacheRegistryUrl){if(null!=this._blockCacheRegistryUrl&&mt(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=ft(o,r.rasterInfo),t){const{view:t}=i,s=this._tileInfoView.getClosestInfoForScale(t.scale),e=this._srcResolutions[s.level];dt(o,this._blockCacheRegistryId,t.extent,t.resolution,e,r.ioConfig.sampling)}this._blockCacheRegistryUrl=o}}async doRefresh(){if(!this.attached)return;await this.layer.updateRenderer(),this.layerView.hasTilingEffects||this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();const t=[];this._globalUpdateRequested=this.layerView.hasTilingEffects||!this.useProgressiveUpdate,this._tileStrategy.refresh((s=>t.push(this._enqueueTileFetch(s)))),await l(t)}};i([e()],oi.prototype,"_fetchQueue",void 0),i([e()],oi.prototype,"_globalUpdateRequested",void 0),i([e()],oi.prototype,"attached",void 0),i([e()],oi.prototype,"container",void 0),i([e()],oi.prototype,"layer",void 0),i([e()],oi.prototype,"layerView",void 0),i([e()],oi.prototype,"type",void 0),i([e()],oi.prototype,"useWebGLForProcessing",null),i([e()],oi.prototype,"useProgressiveUpdate",null),i([e()],oi.prototype,"timeExtent",void 0),i([e()],oi.prototype,"updating",null),oi=i([r("esri.views.2d.layers.imagery.BaseImageryTileSubView2D")],oi);let hi=class extends oi{constructor(){super(...arguments),this.type="raster"}attach(){super.attach(),this.container=new ni(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this.updateRasterFunctionParameters()}detach(){super.detach(),this.container.removeAllChildren(),this.container=null}canUseWebGLForProcessing(){const{symbolizer:t}=this.layer,s=t.lookup?.colormapLut?.indexedColormap,i=s&&s.length>this._maxIndexedColormapSize;return this.useWebGLForProcessing&&t.canRenderInWebGL&&!i&&!("majority"===this.layer.interpolation&&St(this.layer))}fetchTile(t,s){return this.layer.fetchTile(t.level,t.row,t.col,s)}updateRasterFunctionParameters(){const{raster:t,type:s}=this.layer,{container:i}=this;if("Function"!==t.datasetFormat||"wcs"===s)return i.rasterFunctionChain=null,i.children.forEach((t=>{const{bitmap:s}=t;s&&(s.suspended=!0,s.processed=!1,s.projected&&(s.invalidateTexture(),s.rasterTexture=null))})),void(this._rasterFunctionState="na");const e=this._rasterFunctionState,{rasterFunction:r,primaryRasters:n}=t,a=r.supportsGPU&&(!n||n.rasters.length<=1),o=a?r.flatWebGLFunctionChain:null,{renderer:h}=this.layer,u=!a||!o?.functions.length||"raster-stretch"===h?.type&&h.dynamicRangeAdjustment||!this.canUseWebGLForProcessing();i.rasterFunctionChain=u?null:o;const c=null==r?"na":i.rasterFunctionChain?"gpu":"cpu";i.children.forEach((t=>{const{bitmap:s}=t;s&&(s.suspended=e!==c,s.processed=!1,s.processedTexture=null)})),this._rasterFunctionState=c}async updateTileSource(t,s){const i=this._getBandIds(),e=this._getLayerInterpolation(),r=this.canUseWebGLForProcessing(),{source:n,globalSymbolizerParams:a,suspended:o,coords:h,resolution:u}=s,c=this.layerView.hasTilingEffects?a:s.symbolizerParams,{bitmap:l}=t;if([l.x,l.y]=h,l.resolution=u,n&&null!=n&&null!=n.pixelBlock){const t={extent:n.extent,pixelBlock:n.pixelBlock};if(l.rawPixelData=t,r)l.source=n.pixelBlock,l.isRendereredSource=!1;else{const s=await this.layer.applyRenderer(t,"stretch"===a?.type?a:void 0);l.source=s,l.isRendereredSource=!0}l.symbolizerParameters=r?c:null,r?l.transformGrid||(l.transformGrid=n.transformGrid):l.transformGrid=null}else{const t=this.createEmptyTilePixelBlock();l.source=t,l.symbolizerParameters=r?c:null,l.transformGrid=null}l.bandIds=r?i:null,l.width=this._tileInfoView.tileInfo.size[0],l.height=this._tileInfoView.tileInfo.size[1],l.interpolation=e,l.suspended=o,l.invalidateTexture()}async updateTileSymbolizerParameters(t,s){const{local:i,global:e}=s,r=this._getBandIds(),n=this._getLayerInterpolation(),a=this.canUseWebGLForProcessing(),{bitmap:o}=t,{rawPixelData:h}=o;a||null==h?(o.isRendereredSource&&null!=h&&(o.source=h.pixelBlock),o.isRendereredSource=!1):(o.source=await this.layer.applyRenderer(h,"stretch"===e?.type?e:void 0),o.isRendereredSource=!0),o.symbolizerParameters=a?this.layerView.hasTilingEffects?e:i:null,o.bandIds=a?r:null,o.interpolation=n,o.suspended=!1}_getLayerInterpolation(){const{interpolation:t,renderer:s}=this.layer;if(!s)return t;const i=s.type;return"raster-colormap"===i||"unique-value"===i||"class-breaks"===i?"nearest":"raster-stretch"===s.type&&null!=s.colorRamp?"bilinear"===t||"cubic"===t?"bilinear":"nearest":t}};i([e()],hi.prototype,"container",void 0),i([e()],hi.prototype,"layer",void 0),i([e()],hi.prototype,"type",void 0),hi=i([r("esri.views.2d.layers.imagery.ImageryTileView2D")],hi);const ui=hi;class ci extends ot{constructor(t,s,i,e,r,n,a=null){super(t,s,i,e,r,n),this.tileData=new _(a),this.tileData.coordScale=[r,n],this.tileData.once("isReady",(()=>this.ready()))}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(t){this.tileData.stencilRef=t}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{dvs:C(),tileMat3:C()}}setTransform(t){super.setTransform(t);const s=this.resolution/(t.resolution*t.pixelRatio),i=this.transforms.tileMat3,[e,r]=this.tileData.offset,n=[this.x+e*this.resolution,this.y-r*this.resolution],[a,o]=t.toScreenNoRotation([0,0],n),{symbolTileSize:h}=this.tileData.symbolizerParameters,u=Math.round((this.width-this.tileData.offset[0])/h)*h,c=Math.round((this.height-this.tileData.offset[1])/h)*h,l=u/this.rangeX*s,p=c/this.rangeY*s;z(i,l,0,0,0,p,0,a,o,1),I(this.transforms.dvs,t.displayViewMat3,i),this.tileData.transforms.dvs=this.transforms.dvs}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}}class li extends ut{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=["triangle"]}createTile(t){const i=this._tileInfoView.getTileBounds(s(),t),[e,r]=this._tileInfoView.tileInfo.size,n=this._tileInfoView.getTileResolution(t.level);return new ci(t,n,i[0],i[3],e,r)}prepareRenderPasses(t){const s=t.registerRenderPass({name:"imagery (vf tile)",brushes:[w],target:()=>this.children.map((t=>t.tileData)),drawPhase:ht.MAP});return[...super.prepareRenderPasses(t),s]}doRender(t){this.visible&&t.drawPhase===ht.MAP&&this.symbolTypes.forEach((s=>{t.renderPass=s,super.doRender(t)}))}}let pi=class extends oi{constructor(){super(...arguments),this._handle=null,this.type="rasterVF"}canUseWebGLForProcessing(){return!1}async fetchTile(t,s){s={...s,interpolation:"nearest",requestProjectedLocalDirections:!0};const i=await this.layer.fetchTile(t.level,t.row,t.col,s);return"vector-magdir"===this.layer.rasterInfo.dataType&&i?.pixelBlock&&(i.pixelBlock=await this.layer.convertVectorFieldData(i.pixelBlock,s)),i}updateTileSource(t,s){const i=s.symbolizerParams,{tileData:e}=t;e.key=t.key,e.width=this._tileInfoView.tileInfo.size[0],e.height=this._tileInfoView.tileInfo.size[1];const{symbolTileSize:r}=i,{source:n}=s;if(e.offset=this._getTileSymbolOffset(e.key,r),null!=n&&null!=n.pixelBlock){const t={extent:n.extent,pixelBlock:n.pixelBlock};e.rawPixelData=t,e.symbolizerParameters=i,e.source=this._sampleVectorFieldData(n.pixelBlock,i,e.offset)}else{const t=[Math.round((this._tileInfoView.tileInfo.size[0]-e.offset[0])/r),Math.round((this._tileInfoView.tileInfo.size[1]-e.offset[1])/r)],s=this.createEmptyTilePixelBlock(t);e.source=s,e.symbolizerParameters=i}return e.invalidateVAO(),Promise.resolve()}updateTileSymbolizerParameters(t,s){const i=s.local,{symbolTileSize:e}=i,{tileData:r}=t;r.offset=this._getTileSymbolOffset(r.key,e);const n=r.symbolizerParameters.symbolTileSize;r.symbolizerParameters=i;const a=r.rawPixelData?.pixelBlock;return null!=a&&n!==e&&(r.source=this._sampleVectorFieldData(a,r.symbolizerParameters,r.offset)),Promise.resolve()}attach(){super.attach(),this.container=new li(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=p((()=>this.layer.renderer),(t=>this._updateSymbolType(t)))}detach(){super.detach(),this.container.removeAllChildren(),this._handle?.remove(),this._handle=null,this.container=null}_getTileSymbolOffset(t,s){const i=t.col*this._tileInfoView.tileInfo.size[0]%s,e=t.row*this._tileInfoView.tileInfo.size[1]%s;return[i>s/2?s-i:-i,e>s/2?s-e:-e]}_sampleVectorFieldData(t,s,i){const{symbolTileSize:e}=s;return lt(t,"vector-uv",e,i)}_updateSymbolType(t){"vector-field"===t.type&&(this.container.symbolTypes="wind-barb"===t.style?["scalar","triangle"]:"simple-scalar"===t.style?["scalar"]:["triangle"])}};i([e()],pi.prototype,"container",void 0),i([e()],pi.prototype,"layer",void 0),i([e()],pi.prototype,"type",void 0),pi=i([r("esri.views.2d.layers.imagery.VectorFieldTileView2D")],pi);const di=pi;const mi=t=>{let s=class extends t{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.view=null,this.tileInfo=null}get fullExtent(){return this._getfullExtent()}_getfullExtent(){return this.projectFullExtent(this.view.spatialReference)}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){return yt(this.layer.fullExtent,this.view.spatialReference,!0)}supportsSpatialReference(t){return!!this.projectFullExtent(t)}projectFullExtent(t){const s=this.layer.fullExtent,i=yt(s,t,!1);return _t(s,t,i)}async fetchPopupFeatures(t,s){const{layer:i}=this;if(!t)throw new m("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:i});const{popupEnabled:e}=i,r=Rt(i,s);if(!e||null==r)throw new m("imageryTileLayerView:fetchPopupFeatures","Missing required popupTemplate or popupEnabled",{popupEnabled:e,popupTemplate:r});const n=[],{value:a,magdirValue:o,processedValue:h}=await i.identify(t,{timeExtent:this.timeExtent});let u="";if(a&&a.length){u="imagery-tile"===i.type&&i.hasStandardTime()&&null!=a[0]?a.map((t=>i.getStandardTimeValue(t))).join(", "):a.join(", ");const t={ObjectId:0},s="Raster.ServicePixelValue";t[s]=h?.join(", ")??u,t[s+".Raw"]=u;const e=i.rasterInfo.attributeTable;if(null!=e){const{fields:s,features:i}=e,r=s.find((({name:t})=>"value"===t.toLowerCase())),n=r?i.find((t=>String(t.attributes[r.name])===u)):null;if(n)for(const s in n.attributes)if(n.attributes.hasOwnProperty(s)){t[this._rasterFieldPrefix+s]=n.attributes[s]}}const r=i.rasterInfo.dataType;"vector-magdir"!==r&&"vector-uv"!==r||(t["Raster.Magnitude"]=o?.[0],t["Raster.Direction"]=o?.[1]);const c=new f(this.fullExtent.clone(),null,t);c.layer=i,c.sourceLayer=c.layer,n.push(c)}return n}};return i([e()],s.prototype,"layer",void 0),i([e(d)],s.prototype,"timeExtent",void 0),i([e()],s.prototype,"view",void 0),i([e()],s.prototype,"fullExtent",null),i([e()],s.prototype,"tileInfo",void 0),i([e({readOnly:!0})],s.prototype,"hasTilingEffects",null),i([e()],s.prototype,"datumTransformation",null),s=i([r("esri.views.layers.ImageryTileLayerView")],s),s};let fi=class extends(mi(Ft(P(T)))){constructor(){super(...arguments),this._useWebGLForProcessing=!0,this._useProgressiveUpdate=!0,this.subview=null}get useWebGLForProcessing(){return this._useWebGLForProcessing}set useWebGLForProcessing(t){this._useWebGLForProcessing=t,this.subview&&"useWebGLForProcessing"in this.subview&&(this.subview.useWebGLForProcessing=t)}get useProgressiveUpdate(){return this._useWebGLForProcessing}set useProgressiveUpdate(t){this._useProgressiveUpdate=t,this.subview&&"useProgressiveUpdate"in this.subview&&(this.subview.useProgressiveUpdate=t)}get displayParameters(){const{layer:t}=this,s=this._get("displayParameters");return t.renderer?{bandIds:t.bandIds,renderer:t.renderer,interpolation:t.interpolation,multidimensionalDefinition:t.multidimensionalDefinition,rasterFunction:"imagery-tile"===t.type?t.rasterFunction:null}:s}update(t){this.subview?.update(t),this.notifyChange("updating")}isUpdating(){return!this.subview||this.subview.updating}attach(){this.layer.increaseRasterJobHandlerUsage(),this._updateSubview(),this.addAttachHandles([p((()=>this.displayParameters),((t,s)=>{const i=t.interpolation!==s?.interpolation&&("majority"===t.interpolation||"majority"===s?.interpolation)&&St(this.layer),e=t.renderer!==s?.renderer&&s?.renderer?.type!==t.renderer?.type;e&&this._updateSubview();const r=t.multidimensionalDefinition!==s?.multidimensionalDefinition,n=t.rasterFunction!==s?.rasterFunction,a=n&&!this._useWebGLForProcessing,o=r||i||e||a;this.subview.redrawOrRefetch({refetch:o,reprocess:n}).catch((t=>{u(t)||c.getLogger(this).error(t)})),this.notifyChange("updating")})),p((()=>this.layer.blendMode??"normal"),(t=>{this.subview.container.blendMode=t}),g),p((()=>this.layer.effect??null),(t=>{this.subview.container.effect=t}),g),p((()=>this.layer.multidimensionalSubset??null),((t,s)=>{const{multidimensionalDefinition:i}=this.layer;null!=i&&y(i,t)!==y(i,s)&&(this.subview.redrawOrRefetch({refetch:!0}).catch((t=>{u(t)||c.getLogger(this).error(t)})),this.notifyChange("updating"))}),b),p((()=>this.timeExtent),(()=>{this.subview.timeExtent=this.timeExtent,this.subview.redrawOrRefetch({refetch:!0}).catch((t=>{u(t)||c.getLogger(this).error(t)}))}),x)])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.subview.moveEnd()}async hitTest(t,s){return[{type:"graphic",layer:this.layer,mapPoint:t,graphic:new f({attributes:{},geometry:t.clone()})}]}doRefresh(){return this.subview?this.subview.doRefresh():Promise.resolve()}_updateSubview(){const t=this.layer.renderer?.type;if(!t)return;const s="vector-field"===t?"rasterVF":"flow"===t?"flow":"raster";if(this.subview){if(this.subview.type===s)return void this._attachSubview(this.subview);this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}const{layer:i}=this;let e;if(e="rasterVF"===s?new di({layer:i,layerView:this}):"flow"===s?new v({layer:i,layerView:this}):new ui({layer:i,layerView:this}),"useWebGLForProcessing"in e&&(e.useWebGLForProcessing=this._useWebGLForProcessing),"useProgressiveUpdate"in e&&(e.useProgressiveUpdate=this._useProgressiveUpdate),"previousLOD"in e){const{subview:t}=this;e.previousLOD=t&&"previousLOD"in t?t.previousLOD:null}this._attachSubview(e),this.subview=e,this.requestUpdate()}_attachSubview(t){t&&!t.attached&&(t.attach(),t.attached=!0,this.container.addChildAt(t.container,0),t.container.blendMode=this.layer.blendMode,t.container.effect=this.layer.effect)}_detachSubview(t){t?.attached&&(this.container.removeChild(t.container),t.detach(),t.attached=!1)}};i([e()],fi.prototype,"subview",void 0),i([e()],fi.prototype,"useWebGLForProcessing",null),i([e()],fi.prototype,"useProgressiveUpdate",null),i([e({readOnly:!0})],fi.prototype,"displayParameters",null),fi=i([r("esri.views.2d.layers.ImageryTileLayerView2D")],fi);const gi=fi;export default gi;
//# sourceMappingURL=p-4c0f151f.js.map