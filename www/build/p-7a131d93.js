import{l as t,y as e,n as i,cu as s,ad as r,aF as n,o,a2 as a,cv as u,cw as h,cx as l,bP as c,as as d,ay as f,s as v,aN as p,cy as w,e as m,cz as g,cA as y,bI as b,cB as S,cC as k,c as _,cD as A,cE as I,c1 as T,bA as O,cF as x,cG as U}from"./p-b54724b6.js";import{b as j,W as E,c as N,L as P}from"./p-05938a61.js";import{e as D}from"./p-724753fd.js";import"./p-8043ab9b.js";import"./p-fc9cd10b.js";const C="esri-identity-form",F={base:C,group:`${C}__group`,label:`${C}__label`,footer:`${C}__footer`,esriInput:"esri-input",esriButton:"esri-button",esriButtonSecondary:"esri-button--secondary"},R="ArcGIS Online";let $=class extends E{constructor(t,e){super(t,e),this._usernameInputNode=null,this._passwordInputNode=null,this.signingIn=!1,this.server=null,this.resource=null,this.error=null,this.oAuthPrompt=!1}render(){const{error:t,server:e,resource:i,signingIn:r,oAuthPrompt:n,messages:o}=this,a=N("div",{class:F.group},s(n?o.oAuthInfo:o.info,{server:e&&/\.arcgis\.com/i.test(e)?R:e,resource:`(${i||o.lblItem})`})),u=n?null:N("div",{class:F.group,key:"username"},N("label",{class:F.label},o.lblUser,N("input",{value:"",required:!0,autocomplete:"off",spellcheck:!1,type:"text",bind:this,afterCreate:P,"data-node-ref":"_usernameInputNode",class:F.esriInput}))),h=n?null:N("div",{class:F.group,key:"password"},N("label",{class:F.label},o.lblPwd,N("input",{value:"",required:!0,type:"password",bind:this,afterCreate:P,"data-node-ref":"_passwordInputNode",class:F.esriInput}))),l=N("div",{class:this.classes(F.group,F.footer)},N("input",{type:"submit",disabled:!!r,value:r?o.lblSigning:o.lblOk,class:F.esriButton}),N("input",{type:"button",value:o.lblCancel,bind:this,onclick:this._cancel,class:this.classes(F.esriButton,F.esriButtonSecondary)})),c=t?N("div",null,t.details&&t.details.httpStatus?o.invalidUser:o.noAuthService):null;return N("form",{class:F.base,bind:this,onsubmit:this._submit},a,c,u,h,l)}_cancel(){this._set("signingIn",!1),this._usernameInputNode&&(this._usernameInputNode.value=""),this._passwordInputNode&&(this._passwordInputNode.value=""),this.emit("cancel")}_submit(t){t.preventDefault(),this._set("signingIn",!0);const e=this.oAuthPrompt?{}:{username:this._usernameInputNode&&this._usernameInputNode.value,password:this._passwordInputNode&&this._passwordInputNode.value};this.emit("submit",e)}};t([e(),j("esri/identity/t9n/identity")],$.prototype,"messages",void 0),t([e()],$.prototype,"signingIn",void 0),t([e()],$.prototype,"server",void 0),t([e()],$.prototype,"resource",void 0),t([e()],$.prototype,"error",void 0),t([e()],$.prototype,"oAuthPrompt",void 0),$=t([i("esri.identity.IdentityForm")],$);const q=$;
/*!
* tabbable 6.2.0
* @license MIT, https://github.com/focus-trap/tabbable/blob/master/LICENSE
*/var M=["input:not([inert])","select:not([inert])","textarea:not([inert])","a[href]:not([inert])","button:not([inert])","[tabindex]:not(slot):not([inert])","audio[controls]:not([inert])","video[controls]:not([inert])",'[contenteditable]:not([contenteditable="false"]):not([inert])',"details>summary:first-of-type:not([inert])","details:not([inert])"];var B=M.join(",");var z=typeof Element==="undefined";var L=z?function(){}:Element.prototype.matches||Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector;var G=!z&&Element.prototype.getRootNode?function(t){var e;return t===null||t===void 0?void 0:(e=t.getRootNode)===null||e===void 0?void 0:e.call(t)}:function(t){return t===null||t===void 0?void 0:t.ownerDocument};var J=function t(e,i){var s;if(i===void 0){i=true}var r=e===null||e===void 0?void 0:(s=e.getAttribute)===null||s===void 0?void 0:s.call(e,"inert");var n=r===""||r==="true";var o=n||i&&e&&t(e.parentNode);return o};var V=function t(e){var i;var s=e===null||e===void 0?void 0:(i=e.getAttribute)===null||i===void 0?void 0:i.call(e,"contenteditable");return s===""||s==="true"};var H=function t(e,i,s){if(J(e)){return[]}var r=Array.prototype.slice.apply(e.querySelectorAll(B));if(i&&L.call(e,B)){r.unshift(e)}r=r.filter(s);return r};var Y=function t(e,i,s){var r=[];var n=Array.from(e);while(n.length){var o=n.shift();if(J(o,false)){continue}if(o.tagName==="SLOT"){var a=o.assignedElements();var u=a.length?a:o.children;var h=t(u,true,s);if(s.flatten){r.push.apply(r,h)}else{r.push({scopeParent:o,candidates:h})}}else{var l=L.call(o,B);if(l&&s.filter(o)&&(i||!e.includes(o))){r.push(o)}var c=o.shadowRoot||typeof s.getShadowRoot==="function"&&s.getShadowRoot(o);var d=!J(c,false)&&(!s.shadowRootFilter||s.shadowRootFilter(o));if(c&&d){var f=t(c===true?o.children:c.children,true,s);if(s.flatten){r.push.apply(r,f)}else{r.push({scopeParent:o,candidates:f})}}else{n.unshift.apply(n,o.children)}}}return r};var X=function t(e){return!isNaN(parseInt(e.getAttribute("tabindex"),10))};var K=function t(e){if(!e){throw new Error("No node provided")}if(e.tabIndex<0){if((/^(AUDIO|VIDEO|DETAILS)$/.test(e.tagName)||V(e))&&!X(e)){return 0}}return e.tabIndex};var Q=function t(e,i){var s=K(e);if(s<0&&i&&!X(e)){return 0}return s};var W=function t(e,i){return e.tabIndex===i.tabIndex?e.documentOrder-i.documentOrder:e.tabIndex-i.tabIndex};var Z=function t(e){return e.tagName==="INPUT"};var tt=function t(e){return Z(e)&&e.type==="hidden"};var et=function t(e){var i=e.tagName==="DETAILS"&&Array.prototype.slice.apply(e.children).some((function(t){return t.tagName==="SUMMARY"}));return i};var it=function t(e,i){for(var s=0;s<e.length;s++){if(e[s].checked&&e[s].form===i){return e[s]}}};var st=function t(e){if(!e.name){return true}var i=e.form||G(e);var s=function t(e){return i.querySelectorAll('input[type="radio"][name="'+e+'"]')};var r;if(typeof window!=="undefined"&&typeof window.CSS!=="undefined"&&typeof window.CSS.escape==="function"){r=s(window.CSS.escape(e.name))}else{try{r=s(e.name)}catch(t){console.error("Looks like you have a radio button with a name attribute containing invalid CSS selector characters and need the CSS.escape polyfill: %s",t.message);return false}}var n=it(r,e.form);return!n||n===e};var rt=function t(e){return Z(e)&&e.type==="radio"};var nt=function t(e){return rt(e)&&!st(e)};var ot=function t(e){var i;var s=e&&G(e);var r=(i=s)===null||i===void 0?void 0:i.host;var n=false;if(s&&s!==e){var o,a,u;n=!!((o=r)!==null&&o!==void 0&&(a=o.ownerDocument)!==null&&a!==void 0&&a.contains(r)||e!==null&&e!==void 0&&(u=e.ownerDocument)!==null&&u!==void 0&&u.contains(e));while(!n&&r){var h,l,c;s=G(r);r=(h=s)===null||h===void 0?void 0:h.host;n=!!((l=r)!==null&&l!==void 0&&(c=l.ownerDocument)!==null&&c!==void 0&&c.contains(r))}}return n};var at=function t(e){var i=e.getBoundingClientRect(),s=i.width,r=i.height;return s===0&&r===0};var ut=function t(e,i){var s=i.displayCheck,r=i.getShadowRoot;if(getComputedStyle(e).visibility==="hidden"){return true}var n=L.call(e,"details>summary:first-of-type");var o=n?e.parentElement:e;if(L.call(o,"details:not([open]) *")){return true}if(!s||s==="full"||s==="legacy-full"){if(typeof r==="function"){var a=e;while(e){var u=e.parentElement;var h=G(e);if(u&&!u.shadowRoot&&r(u)===true){return at(e)}else if(e.assignedSlot){e=e.assignedSlot}else if(!u&&h!==e.ownerDocument){e=h.host}else{e=u}}e=a}if(ot(e)){return!e.getClientRects().length}if(s!=="legacy-full"){return true}}else if(s==="non-zero-area"){return at(e)}return false};var ht=function t(e){if(/^(INPUT|BUTTON|SELECT|TEXTAREA)$/.test(e.tagName)){var i=e.parentElement;while(i){if(i.tagName==="FIELDSET"&&i.disabled){for(var s=0;s<i.children.length;s++){var r=i.children.item(s);if(r.tagName==="LEGEND"){return L.call(i,"fieldset[disabled] *")?true:!r.contains(e)}}return true}i=i.parentElement}}return false};var lt=function t(e,i){if(i.disabled||J(i)||tt(i)||ut(i,e)||et(i)||ht(i)){return false}return true};var ct=function t(e,i){if(nt(i)||K(i)<0||!lt(e,i)){return false}return true};var dt=function t(e){var i=parseInt(e.getAttribute("tabindex"),10);if(isNaN(i)||i>=0){return true}return false};var ft=function t(e){var i=[];var s=[];e.forEach((function(e,r){var n=!!e.scopeParent;var o=n?e.scopeParent:e;var a=Q(o,n);var u=n?t(e.candidates):o;if(a===0){n?i.push.apply(i,u):i.push(o)}else{s.push({documentOrder:r,tabIndex:a,item:e,isScope:n,content:u})}}));return s.sort(W).reduce((function(t,e){e.isScope?t.push.apply(t,e.content):t.push(e.content);return t}),[]).concat(i)};var vt=function t(e,i){i=i||{};var s;if(i.getShadowRoot){s=Y([e],i.includeContainer,{filter:ct.bind(null,i),flatten:false,getShadowRoot:i.getShadowRoot,shadowRootFilter:dt})}else{s=H(e,i.includeContainer,ct.bind(null,i))}return ft(s)};var pt=function t(e,i){i=i||{};var s;if(i.getShadowRoot){s=Y([e],i.includeContainer,{filter:lt.bind(null,i),flatten:true,getShadowRoot:i.getShadowRoot})}else{s=H(e,i.includeContainer,lt.bind(null,i))}return s};var wt=function t(e,i){i=i||{};if(!e){throw new Error("No node provided")}if(L.call(e,B)===false){return false}return ct(i,e)};var mt=M.concat("iframe").join(",");var gt=function t(e,i){i=i||{};if(!e){throw new Error("No node provided")}if(L.call(e,mt)===false){return false}return lt(i,e)};
/*!
* focus-trap 7.4.3
* @license MIT, https://github.com/focus-trap/focus-trap/blob/master/LICENSE
*/function yt(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,s)}return i}function bt(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?yt(Object(i),!0).forEach((function(e){St(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):yt(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function St(t,e,i){e=_t(e);if(e in t){Object.defineProperty(t,e,{value:i,enumerable:true,configurable:true,writable:true})}else{t[e]=i}return t}function kt(t,e){if(typeof t!=="object"||t===null)return t;var i=t[Symbol.toPrimitive];if(i!==undefined){var s=i.call(t,e||"default");if(typeof s!=="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function _t(t){var e=kt(t,"string");return typeof e==="symbol"?e:String(e)}var At={activateTrap:function t(e,i){if(e.length>0){var s=e[e.length-1];if(s!==i){s.pause()}}var r=e.indexOf(i);if(r===-1){e.push(i)}else{e.splice(r,1);e.push(i)}},deactivateTrap:function t(e,i){var s=e.indexOf(i);if(s!==-1){e.splice(s,1)}if(e.length>0){e[e.length-1].unpause()}}};var It=function t(e){return e.tagName&&e.tagName.toLowerCase()==="input"&&typeof e.select==="function"};var Tt=function t(e){return e.key==="Escape"||e.key==="Esc"||e.keyCode===27};var Ot=function t(e){return e.key==="Tab"||e.keyCode===9};var xt=function t(e){return Ot(e)&&!e.shiftKey};var Ut=function t(e){return Ot(e)&&e.shiftKey};var jt=function t(e){return setTimeout(e,0)};var Et=function t(e,i){var s=-1;e.every((function(t,e){if(i(t)){s=e;return false}return true}));return s};var Nt=function t(e){for(var i=arguments.length,s=new Array(i>1?i-1:0),r=1;r<i;r++){s[r-1]=arguments[r]}return typeof e==="function"?e.apply(void 0,s):e};var Pt=function t(e){return e.target.shadowRoot&&typeof e.composedPath==="function"?e.composedPath()[0]:e.target};var Dt=[];var Ct=function t(e,i){var s=(i===null||i===void 0?void 0:i.document)||document;var r=(i===null||i===void 0?void 0:i.trapStack)||Dt;var n=bt({returnFocusOnDeactivate:true,escapeDeactivates:true,delayInitialFocus:true,isKeyForward:xt,isKeyBackward:Ut},i);var o={containers:[],containerGroups:[],tabbableGroups:[],nodeFocusedBeforeActivation:null,mostRecentlyFocusedNode:null,active:false,paused:false,delayInitialFocusTimer:undefined};var a;var u=function t(e,i,s){return e&&e[i]!==undefined?e[i]:n[s||i]};var h=function t(e,i){var s=typeof(i===null||i===void 0?void 0:i.composedPath)==="function"?i.composedPath():undefined;return o.containerGroups.findIndex((function(t){var i=t.container,r=t.tabbableNodes;return i.contains(e)||(s===null||s===void 0?void 0:s.includes(i))||r.find((function(t){return t===e}))}))};var l=function t(e){var i=n[e];if(typeof i==="function"){for(var r=arguments.length,o=new Array(r>1?r-1:0),a=1;a<r;a++){o[a-1]=arguments[a]}i=i.apply(void 0,o)}if(i===true){i=undefined}if(!i){if(i===undefined||i===false){return i}throw new Error("`".concat(e,"` was specified but was not a node, or did not return a node"))}var u=i;if(typeof i==="string"){u=s.querySelector(i);if(!u){throw new Error("`".concat(e,"` as selector refers to no known node"))}}return u};var c=function t(){var e=l("initialFocus");if(e===false){return false}if(e===undefined||!gt(e,n.tabbableOptions)){if(h(s.activeElement)>=0){e=s.activeElement}else{var i=o.tabbableGroups[0];var r=i&&i.firstTabbableNode;e=r||l("fallbackFocus")}}if(!e){throw new Error("Your focus-trap needs to have at least one focusable element")}return e};var d=function t(){o.containerGroups=o.containers.map((function(t){var e=vt(t,n.tabbableOptions);var i=pt(t,n.tabbableOptions);return{container:t,tabbableNodes:e,focusableNodes:i,firstTabbableNode:e.length>0?e[0]:null,lastTabbableNode:e.length>0?e[e.length-1]:null,nextTabbableNode:function t(e){var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var r=i.findIndex((function(t){return t===e}));if(r<0){return undefined}if(s){return i.slice(r+1).find((function(t){return wt(t,n.tabbableOptions)}))}return i.slice(0,r).reverse().find((function(t){return wt(t,n.tabbableOptions)}))}}}));o.tabbableGroups=o.containerGroups.filter((function(t){return t.tabbableNodes.length>0}));if(o.tabbableGroups.length<=0&&!l("fallbackFocus")){throw new Error("Your focus-trap must have at least one container with at least one tabbable node in it at all times")}};var f=function t(e){if(e===false){return}if(e===s.activeElement){return}if(!e||!e.focus){t(c());return}e.focus({preventScroll:!!n.preventScroll});o.mostRecentlyFocusedNode=e;if(It(e)){e.select()}};var v=function t(e){var i=l("setReturnFocus",e);return i?i:i===false?false:e};var p=function t(e){var i=Pt(e);if(h(i,e)>=0){return}if(Nt(n.clickOutsideDeactivates,e)){a.deactivate({returnFocus:n.returnFocusOnDeactivate});return}if(Nt(n.allowOutsideClick,e)){return}e.preventDefault()};var w=function t(e){var i=Pt(e);var s=h(i,e)>=0;if(s||i instanceof Document){if(s){o.mostRecentlyFocusedNode=i}}else{e.stopImmediatePropagation();f(o.mostRecentlyFocusedNode||c())}};var m=function t(e){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var s=Pt(e);d();var r=null;if(o.tabbableGroups.length>0){var a=h(s,e);var u=a>=0?o.containerGroups[a]:undefined;if(a<0){if(i){r=o.tabbableGroups[o.tabbableGroups.length-1].lastTabbableNode}else{r=o.tabbableGroups[0].firstTabbableNode}}else if(i){var c=Et(o.tabbableGroups,(function(t){var e=t.firstTabbableNode;return s===e}));if(c<0&&(u.container===s||gt(s,n.tabbableOptions)&&!wt(s,n.tabbableOptions)&&!u.nextTabbableNode(s,false))){c=a}if(c>=0){var v=c===0?o.tabbableGroups.length-1:c-1;var p=o.tabbableGroups[v];r=p.lastTabbableNode}else if(!Ot(e)){r=u.nextTabbableNode(s,false)}}else{var w=Et(o.tabbableGroups,(function(t){var e=t.lastTabbableNode;return s===e}));if(w<0&&(u.container===s||gt(s,n.tabbableOptions)&&!wt(s,n.tabbableOptions)&&!u.nextTabbableNode(s))){w=a}if(w>=0){var m=w===o.tabbableGroups.length-1?0:w+1;var g=o.tabbableGroups[m];r=g.firstTabbableNode}else if(!Ot(e)){r=u.nextTabbableNode(s)}}}else{r=l("fallbackFocus")}if(r){if(Ot(e)){e.preventDefault()}f(r)}};var g=function t(e){if(Tt(e)&&Nt(n.escapeDeactivates,e)!==false){e.preventDefault();a.deactivate();return}if(n.isKeyForward(e)||n.isKeyBackward(e)){m(e,n.isKeyBackward(e))}};var y=function t(e){var i=Pt(e);if(h(i,e)>=0){return}if(Nt(n.clickOutsideDeactivates,e)){return}if(Nt(n.allowOutsideClick,e)){return}e.preventDefault();e.stopImmediatePropagation()};var b=function t(){if(!o.active){return}At.activateTrap(r,a);o.delayInitialFocusTimer=n.delayInitialFocus?jt((function(){f(c())})):f(c());s.addEventListener("focusin",w,true);s.addEventListener("mousedown",p,{capture:true,passive:false});s.addEventListener("touchstart",p,{capture:true,passive:false});s.addEventListener("click",y,{capture:true,passive:false});s.addEventListener("keydown",g,{capture:true,passive:false});return a};var S=function t(){if(!o.active){return}s.removeEventListener("focusin",w,true);s.removeEventListener("mousedown",p,true);s.removeEventListener("touchstart",p,true);s.removeEventListener("click",y,true);s.removeEventListener("keydown",g,true);return a};var k=function t(e){var i=e.some((function(t){var e=Array.from(t.removedNodes);return e.some((function(t){return t===o.mostRecentlyFocusedNode}))}));if(i){f(c())}};var _=typeof window!=="undefined"&&"MutationObserver"in window?new MutationObserver(k):undefined;var A=function t(){if(!_){return}_.disconnect();if(o.active&&!o.paused){o.containers.map((function(t){_.observe(t,{subtree:true,childList:true})}))}};a={get active(){return o.active},get paused(){return o.paused},activate:function t(e){if(o.active){return this}var i=u(e,"onActivate");var r=u(e,"onPostActivate");var n=u(e,"checkCanFocusTrap");if(!n){d()}o.active=true;o.paused=false;o.nodeFocusedBeforeActivation=s.activeElement;i===null||i===void 0?void 0:i();var a=function t(){if(n){d()}b();A();r===null||r===void 0?void 0:r()};if(n){n(o.containers.concat()).then(a,a);return this}a();return this},deactivate:function t(e){if(!o.active){return this}var i=bt({onDeactivate:n.onDeactivate,onPostDeactivate:n.onPostDeactivate,checkCanReturnFocus:n.checkCanReturnFocus},e);clearTimeout(o.delayInitialFocusTimer);o.delayInitialFocusTimer=undefined;S();o.active=false;o.paused=false;A();At.deactivateTrap(r,a);var s=u(i,"onDeactivate");var h=u(i,"onPostDeactivate");var l=u(i,"checkCanReturnFocus");var c=u(i,"returnFocus","returnFocusOnDeactivate");s===null||s===void 0?void 0:s();var d=function t(){jt((function(){if(c){f(v(o.nodeFocusedBeforeActivation))}h===null||h===void 0?void 0:h()}))};if(c&&l){l(v(o.nodeFocusedBeforeActivation)).then(d,d);return this}d();return this},pause:function t(e){if(o.paused||!o.active){return this}var i=u(e,"onPause");var s=u(e,"onPostPause");o.paused=true;i===null||i===void 0?void 0:i();S();A();s===null||s===void 0?void 0:s();return this},unpause:function t(e){if(!o.paused||!o.active){return this}var i=u(e,"onUnpause");var s=u(e,"onPostUnpause");o.paused=false;i===null||i===void 0?void 0:i();d();b();A();s===null||s===void 0?void 0:s();return this},updateContainerElements:function t(e){var i=[].concat(e).filter(Boolean);o.containers=i.map((function(t){return typeof t==="string"?s.querySelector(t):t}));if(o.active){d()}A();return this}};a.updateContainerElements(e);return a};const Ft="esri-identity-modal",Rt={base:Ft,open:`${Ft}--open`,closed:`${Ft}--closed`,title:`${Ft}__title`,dialog:`${Ft}__dialog`,content:`${Ft}__content`,closeButton:`${Ft}__close-button`,iconClose:"esri-icon-close"};let $t=class extends E{constructor(t,e){super(t,e),this.container=document.createElement("div"),this.content=null,this.open=!1,this._focusTrap=null,this._close=()=>{this.open=!1},document.body.appendChild(this.container),this.addHandles(r((()=>this.open),(()=>this._toggleFocusTrap())))}destroy(){this._destroyFocusTrap()}get title(){return this.messages?.auth.signIn}render(){const t=this.id,{open:e,content:i,title:s,messages:r}=this,n=e&&!!i,o={[Rt.open]:n,[Rt.closed]:!n},a=N("button",{class:Rt.closeButton,"aria-label":r.close,title:r.close,bind:this,onclick:this._close,type:"button"},N("span",{"aria-hidden":"true",class:Rt.iconClose})),u=`${t}_title`,h=`${t}_content`,l=s?N("h1",{id:u,class:Rt.title},s):null,c=n?N("div",{bind:this,class:Rt.dialog,role:"dialog","aria-labelledby":u,"aria-describedby":h,afterCreate:this._createFocusTrap},a,l,this._renderContent(h)):null;return N("div",{tabIndex:-1,class:this.classes(Rt.base,o)},c)}_destroyFocusTrap(){this._focusTrap?.deactivate({onDeactivate:()=>{}}),this._focusTrap=null}_toggleFocusTrap(){const{_focusTrap:t,open:e}=this;t&&(e?t.activate():t.deactivate())}_createFocusTrap(t){this._destroyFocusTrap();const e=requestAnimationFrame((()=>{this._focusTrap=Ct(t,{initialFocus:"input",onDeactivate:this._close}),this._toggleFocusTrap()}));this.addHandles(n((()=>cancelAnimationFrame(e))))}_renderContent(t){const e=this.content;return"string"==typeof e?N("div",{class:Rt.content,id:t,innerHTML:e}):D(e)?N("div",{class:Rt.content,id:t},e.render()):e instanceof HTMLElement?N("div",{class:Rt.content,id:t,bind:e,afterCreate:this._attachToNode}):null}_attachToNode(t){const e=this;t.appendChild(e)}};t([e({readOnly:!0})],$t.prototype,"container",void 0),t([e()],$t.prototype,"content",void 0),t([e()],$t.prototype,"open",void 0),t([e(),j("esri/t9n/common")],$t.prototype,"messages",void 0),t([e()],$t.prototype,"title",null),$t=t([i("esri.identity.IdentityModal")],$t);const qt=$t;const Mt="esriJSAPIOAuth";class Bt{constructor(t,e){this.oAuthInfo=null,this.storage=null,this.appId=null,this.codeVerifier=null,this.expires=null,this.refreshToken=null,this.ssl=null,this.stateUID=null,this.token=null,this.userId=null,this.oAuthInfo=t,this.storage=e,this._init()}isValid(){let t=!1;if(this.oAuthInfo&&this.userId&&(this.refreshToken||this.token))if(null==this.expires&&this.refreshToken)t=!0;else if(this.expires){const e=Date.now();if(this.expires>e){(this.expires-e)/1e3>60*this.oAuthInfo.minTimeUntilExpiration&&(t=!0)}}return t}save(){if(!this.storage)return!1;const t=this._load(),e=this.oAuthInfo;if(e&&e.authNamespace&&e.portalUrl){let i=t[e.authNamespace];i||(i=t[e.authNamespace]={}),this.appId||(this.appId=e.appId),i[e.portalUrl]={appId:this.appId,codeVerifier:this.codeVerifier,expires:this.expires,refreshToken:this.refreshToken,ssl:this.ssl,stateUID:this.stateUID,token:this.token,userId:this.userId};try{this.storage.setItem(Mt,JSON.stringify(t))}catch(t){return console.warn(t),!1}return!0}return!1}destroy(){const t=this._load(),e=this.oAuthInfo;if(e&&e.appId&&e.portalUrl&&(null==this.expires||this.expires>Date.now())&&(this.refreshToken||this.token)){const t=e.portalUrl.replace(/^http:/i,"https:")+"/sharing/rest/oauth2/revokeToken",i=new FormData;if(i.append("f","json"),i.append("auth_token",this.refreshToken||this.token),i.append("client_id",e.appId),i.append("token_type_hint",this.refreshToken?"refresh_token":"access_token"),"function"==typeof navigator.sendBeacon)navigator.sendBeacon(t,i);else{const e=new XMLHttpRequest;e.open("POST",t),e.send(i)}}if(e&&e.authNamespace&&e.portalUrl&&this.storage){const i=t[e.authNamespace];if(i){delete i[e.portalUrl];try{this.storage.setItem(Mt,JSON.stringify(t))}catch(t){console.log(t)}}}e&&(e._oAuthCred=null,this.oAuthInfo=null)}_init(){const t=this._load(),e=this.oAuthInfo;if(e&&e.authNamespace&&e.portalUrl){let i=t[e.authNamespace];i&&(i=i[e.portalUrl],i&&(this.appId=i.appId,this.codeVerifier=i.codeVerifier,this.expires=i.expires,this.refreshToken=i.refreshToken,this.ssl=i.ssl,this.stateUID=i.stateUID,this.token=i.token,this.userId=i.userId))}}_load(){let t={};if(this.storage){const e=this.storage.getItem(Mt);if(e)try{t=JSON.parse(e)}catch(t){console.warn(t)}}return t}}Bt.prototype.declaredClass="esri.identity.OAuthCredential";var zt;let Lt=zt=class extends o{constructor(t){super(t),this._oAuthCred=null,this.appId=null,this.authNamespace="/",this.expiration=20160,this.flowType="auto",this.forceLogin=!1,this.forceUserId=!1,this.locale=null,this.minTimeUntilExpiration=30,this.popup=!1,this.popupCallbackUrl="oauth-callback.html",this.popupWindowFeatures="height=490,width=800,resizable,scrollbars,status",this.portalUrl="https://www.arcgis.com",this.preserveUrlHash=!1,this.userId=null}clone(){return zt.fromJSON(this.toJSON())}};t([e({json:{write:!0}})],Lt.prototype,"appId",void 0),t([e({json:{write:!0}})],Lt.prototype,"authNamespace",void 0),t([e({json:{write:!0}})],Lt.prototype,"expiration",void 0),t([e({json:{write:!0}})],Lt.prototype,"flowType",void 0),t([e({json:{write:!0}})],Lt.prototype,"forceLogin",void 0),t([e({json:{write:!0}})],Lt.prototype,"forceUserId",void 0),t([e({json:{write:!0}})],Lt.prototype,"locale",void 0),t([e({json:{write:!0}})],Lt.prototype,"minTimeUntilExpiration",void 0),t([e({json:{write:!0}})],Lt.prototype,"popup",void 0),t([e({json:{write:!0}})],Lt.prototype,"popupCallbackUrl",void 0),t([e({json:{write:!0}})],Lt.prototype,"popupWindowFeatures",void 0),t([e({json:{write:!0}})],Lt.prototype,"portalUrl",void 0),t([e({json:{write:!0}})],Lt.prototype,"preserveUrlHash",void 0),t([e({json:{write:!0}})],Lt.prototype,"userId",void 0),Lt=zt=t([i("esri.identity.OAuthInfo")],Lt);const Gt=Lt;let Jt=class extends o{constructor(t){super(t),this.adminTokenServiceUrl=null,this.currentVersion=null,this.hasPortal=null,this.hasServer=null,this.owningSystemUrl=null,this.owningTenant=null,this.server=null,this.shortLivedTokenValidity=null,this.tokenServiceUrl=null,this.webTierAuth=null}};t([e({json:{write:!0}})],Jt.prototype,"adminTokenServiceUrl",void 0),t([e({json:{write:!0}})],Jt.prototype,"currentVersion",void 0),t([e({json:{write:!0}})],Jt.prototype,"hasPortal",void 0),t([e({json:{write:!0}})],Jt.prototype,"hasServer",void 0),t([e({json:{write:!0}})],Jt.prototype,"owningSystemUrl",void 0),t([e({json:{write:!0}})],Jt.prototype,"owningTenant",void 0),t([e({json:{write:!0}})],Jt.prototype,"server",void 0),t([e({json:{write:!0}})],Jt.prototype,"shortLivedTokenValidity",void 0),t([e({json:{write:!0}})],Jt.prototype,"tokenServiceUrl",void 0),t([e({json:{write:!0}})],Jt.prototype,"webTierAuth",void 0),Jt=t([i("esri.identity.ServerInfo")],Jt);const Vt=Jt;const Ht={},Yt=t=>{const e=new l(t.owningSystemUrl).host,i=new l(t.server).host,s=/.+\.arcgis\.com$/i;return s.test(e)&&s.test(i)},Xt=(t,e)=>!!(Yt(t)&&e&&e.some((e=>e.test(t.server))));let Kt=null,Qt=null;try{Kt=window.localStorage,Qt=window.sessionStorage}catch{}class Wt extends a{constructor(){super(),this._portalConfig=globalThis.esriGeowConfig,this.serverInfos=[],this.oAuthInfos=[],this.credentials=[],this._soReqs=[],this._xoReqs=[],this._portals=[],this._defaultOAuthInfo=null,this._defaultTokenValidity=60,this.dialog=null,this.formConstructor=q,this.tokenValidity=null,this.normalizeWebTierAuth=!1,this._appOrigin="null"!==window.origin?window.origin:window.location.origin,this._appUrlObj=c(window.location.href),this._busy=null,this._rejectOnPersistedPageShow=!1,this._oAuthLocationParams=null,this._gwTokenUrl="/sharing/rest/generateToken",this._agsRest="/rest/services",this._agsPortal=/\/sharing(\/|$)/i,this._agsAdmin=/(https?:\/\/[^\/]+\/[^\/]+)\/admin\/?(\/.*)?$/i,this._adminSvcs=/\/rest\/admin\/services(\/|$)/i,this._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"}],this._legacyFed=[],this._regexSDirUrl=/http.+\/rest\/services\/?/gi,this._regexServerType=/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|KnowledgeGraphServer|MapServer|MissionServer|MobileServer|NAServer|NetworkDiagramServer|OGCFeatureServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer|VideoServer)).*/gi,this._gwUser=/http.+\/users\/([^\/]+)\/?.*/i,this._gwItem=/http.+\/items\/([^\/]+)\/?.*/i,this._gwGroup=/http.+\/groups\/([^\/]+)\/?.*/i,this._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i,this._createDefaultOAuthInfo=!0,this._hasTestedIfAppIsOnPortal=!1,this._getOAuthLocationParams(),window.addEventListener("pageshow",(t=>{this._pageShowHandler(t)}))}registerServers(t){const e=this.serverInfos;e?(t=t.filter((t=>!this.findServerInfo(t.server))),this.serverInfos=e.concat(t)):this.serverInfos=t,t.forEach((t=>{t.owningSystemUrl&&this._portals.push(t.owningSystemUrl),t.hasPortal&&this._portals.push(t.server)}))}registerOAuthInfos(t){const e=this.oAuthInfos;if(e){for(const i of t){const t=this.findOAuthInfo(i.portalUrl);t&&e.splice(e.indexOf(t),1)}this.oAuthInfos=e.concat(t)}else this.oAuthInfos=t}registerToken(t){t={...t};const e=this._sanitizeUrl(t.server),i=this._isServerRsrc(e);let s,r=this.findServerInfo(e),n=!0;r||(r=new Vt,r.server=this._getServerInstanceRoot(e),i?r.hasServer=!0:(r.tokenServiceUrl=this._getTokenSvcUrl(e),r.hasPortal=!0),this.registerServers([r])),s=this._findCredential(e),s?(delete t.server,Object.assign(s,t),n=!1):(s=new Zt({userId:t.userId,server:r.server,token:t.token,expires:t.expires,ssl:t.ssl,scope:i?"server":"portal"}),s.resources=[e],this.credentials.push(s)),s.emitTokenChange(!1),n||s.refreshServerTokens()}toJSON(){return h({serverInfos:this.serverInfos.map((t=>t.toJSON())),oAuthInfos:this.oAuthInfos.map((t=>t.toJSON())),credentials:this.credentials.map((t=>t.toJSON()))})}initialize(t){if(!t)return;"string"==typeof t&&(t=JSON.parse(t));const e=t.serverInfos,i=t.oAuthInfos,s=t.credentials;if(e){const t=[];e.forEach((e=>{e.server&&e.tokenServiceUrl&&t.push(e.declaredClass?e:new Vt(e))})),t.length&&this.registerServers(t)}if(i){const t=[];i.forEach((e=>{e.appId&&t.push(e.declaredClass?e:new Gt(e))})),t.length&&this.registerOAuthInfos(t)}s&&s.forEach((t=>{t.server&&t.token&&t.expires&&t.expires>Date.now()&&((t=t.declaredClass?t:new Zt(t)).emitTokenChange(),this.credentials.push(t))}))}findServerInfo(t){let e;t=this._sanitizeUrl(t);for(const i of this.serverInfos)if(this._hasSameServerInstance(i.server,t)){e=i;break}return e}findOAuthInfo(t){let e;t=this._sanitizeUrl(t);for(const i of this.oAuthInfos)if(this._hasSameServerInstance(i.portalUrl,t)){e=i;break}return e}findCredential(t,e){if(!t)return;let i;t=this._sanitizeUrl(t);const s=this._isServerRsrc(t)?"server":"portal";if(e){for(const r of this.credentials)if(this._hasSameServerInstance(r.server,t)&&e===r.userId&&r.scope===s){i=r;break}}else for(const e of this.credentials)if(this._hasSameServerInstance(e.server,t)&&-1!==this._getIdenticalSvcIdx(t,e)&&e.scope===s){i=e;break}return i}getCredential(t,e){let i,s,r=!0;e&&(i=!!e.token,s=e.error,r=!1!==e.prompt),e={...e},t=this._sanitizeUrl(t);const n=new AbortController,o=d();if(e.signal&&f(e.signal,(()=>{n.abort()})),f(n,(()=>{o.reject(new v("identity-manager:user-aborted","ABORTED"))})),p(n))return o.promise;e.signal=n.signal;const a=this._isAdminResource(t),u=i?this.findCredential(t):null;let h;if(u&&s&&s.details&&498===s.details.httpStatus)u.destroy();else if(u)return h=new v("identity-manager:not-authorized","You are currently signed in as: '"+u.userId+"'. You do not have access to this resource: "+t,{error:s}),o.reject(h),o.promise;const l=this._findCredential(t,e);if(l)return o.resolve(l),o.promise;let c=this.findServerInfo(t);if(c)!c.hasServer&&this._isServerRsrc(t)&&(c._restInfoPms=this._getTokenSvcUrl(t),c.hasServer=!0);else{const e=this._getTokenSvcUrl(t);if(!e)return h=new v("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),o.reject(h),o.promise;c=new Vt,c.server=this._getServerInstanceRoot(t),"string"==typeof e?(c.tokenServiceUrl=e,c.hasPortal=!0):(c._restInfoPms=e,c.hasServer=!0),this.registerServers([c])}return c.hasPortal&&void 0===c._selfReq&&(r||w(c.tokenServiceUrl,this._appOrigin)||this._gwDomains.some((t=>t.tokenServiceUrl===c.tokenServiceUrl)))&&(c._selfReq={owningTenant:e&&e.owningTenant,selfDfd:this._getPortalSelf(c.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),t)}),this._enqueue(t,c,e,o,a)}getResourceName(t){return this._isRESTService(t)?t.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(t)&&t.replace(this._gwUser,"$1")||this._gwItem.test(t)&&t.replace(this._gwItem,"$1")||this._gwGroup.test(t)&&t.replace(this._gwGroup,"$1")||""}generateToken(t,e,i){const s=this._rePortalTokenSvc.test(t.tokenServiceUrl),r=new l(this._appOrigin),n=t.shortLivedTokenValidity;let o,a,u,h,c,d,f,p;e&&(p=this.tokenValidity||n||this._defaultTokenValidity,p>n&&n>0&&(p=n)),i&&(o=i.isAdmin,a=i.serverUrl,u=i.token,d=i.signal,f=i.ssl,t.customParameters=i.customParameters),o?h=t.adminTokenServiceUrl:(h=t.tokenServiceUrl,c=new l(h.toLowerCase()),t.webTierAuth&&i?.serverUrl&&!f&&"http"===r.scheme&&(w(r.uri,h,!0)||"https"===c.scheme&&r.host===c.host&&"7080"===r.port&&"7443"===c.port)&&(h=h.replace(/^https:/i,"http:").replace(/:7443/i,":7080")));const g={query:{request:"getToken",username:e?.username,password:e?.password,serverUrl:a,token:u,expiration:p,referer:o||s?this._appOrigin:null,client:o?"referer":null,f:"json",...t.customParameters},method:"post",authMode:"anonymous",useProxy:this._useProxy(t,i),signal:d,...i?.ioArgs};s||(g.withCredentials=!1);return m(h,g).then((i=>{const s=i.data;if(!s||!s.token)return new v("identity-manager:authentication-failed","Unable to generate token");const r=t.server;return Ht[r]||(Ht[r]={}),e&&(Ht[r][e.username]=e.password),s.validity=p,s}))}isBusy(){return!!this._busy}checkSignInStatus(t){return this.checkAppAccess(t,"").then((t=>t.credential))}checkAppAccess(t,e,i){let s=!1;return this.getCredential(t,{prompt:!1}).then((r=>{let n;const o={f:"json"};if("portal"===r.scope)if(e&&(this._doPortalSignIn(t)||i&&i.force))n=r.server+"/sharing/rest/oauth2/validateAppAccess",o.client_id=e;else{if(!r.token)return{credential:r};n=r.server+"/sharing/rest"}else{if(!r.token)return{credential:r};n=r.server+"/rest/services"}return r.token&&(o.token=r.token),m(n,{query:o,authMode:"anonymous"}).then((t=>{if(!1===t.data.valid)throw new v("identity-manager:not-authorized",`You are currently signed in as: '${r.userId}'.`,t.data);return s=!!t.data.viewOnlyUserTypeApp,{credential:r}})).catch((t=>{if("identity-manager:not-authorized"===t.name)throw t;const e=t.details&&t.details.httpStatus;if(498===e)throw r.destroy(),new v("identity-manager:not-authenticated","User is not signed in.");if(400===e)throw new v("identity-manager:invalid-request");return{credential:r}}))})).then((t=>({credential:t.credential,viewOnly:s})))}setOAuthResponseHash(t){t&&("#"===t.charAt(0)&&(t=t.substring(1)),this._processOAuthPopupParams(g(t)))}setOAuthRedirectionHandler(t){this._oAuthRedirectFunc=t}setProtocolErrorHandler(t){this._protocolFunc=t}signIn(t,e,i={}){const s=d(),n=()=>{u?.remove(),h?.remove(),l?.remove(),a?.destroy(),this.dialog?.destroy(),this.dialog=a=u=h=l=null},o=()=>{n(),this._oAuthDfd=null,s.reject(new v("identity-manager:user-aborted","ABORTED"))};i.signal&&f(i.signal,(()=>{o()}));let a=new this.formConstructor;a.resource=this.getResourceName(t),a.server=e.server,this.dialog=new qt,this.dialog.content=a,this.dialog.open=!0,this.emit("dialog-create");let u=a.on("cancel",o),h=r((()=>this.dialog.open),o),l=a.on("submit",(t=>{this.generateToken(e,t,{isAdmin:i.isAdmin,signal:i.signal}).then((r=>{n();const o=new Zt({userId:t.username,server:e.server,token:r.token,expires:null!=r.expires?Number(r.expires):null,ssl:!!r.ssl,isAdmin:i.isAdmin,validity:r.validity});s.resolve(o)})).catch((t=>{a.error=t,a.signingIn=!1}))}));return s.promise}oAuthSignIn(t,e,i,s){this._oAuthDfd=d();const n=this._oAuthDfd;let o;s?.signal&&f(s.signal,(()=>{const t=this._oAuthDfd&&this._oAuthDfd.oAuthWin_;t&&!t.closed?t.close():this.dialog&&p()})),n.resUrl_=t,n.sinfo_=e,n.oinfo_=i;const a=i._oAuthCred;if(a.storage&&("authorization-code"===i.flowType||"auto"===i.flowType&&!i.popup&&e.currentVersion>=8.4)){let t=crypto.getRandomValues(new Uint8Array(32));o=y(t),a.codeVerifier=o,t=crypto.getRandomValues(new Uint8Array(32)),a.stateUID=y(t),a.save()||(a.codeVerifier=o=null)}else a.codeVerifier=null;let u,h,l,c;this._getCodeChallenge(o).then((n=>{const o=!s||!1!==s.oAuthPopupConfirmation;i.popup&&o?(u=new this.formConstructor,u.oAuthPrompt=!0,u.server=e.server,this.dialog=new qt,this.dialog.content=u,this.dialog.open=!0,this.emit("dialog-create"),h=u.on("cancel",p),l=r((()=>this.dialog.open),p),c=u.on("submit",(()=>{w(),this._doOAuthSignIn(t,e,i,n)}))):this._doOAuthSignIn(t,e,i,n)}));const p=()=>{w(),this._oAuthDfd=null,n.reject(new v("identity-manager:user-aborted","ABORTED"))},w=()=>{h?.remove(),l?.remove(),c?.remove(),u?.destroy(),this.dialog?.destroy(),this.dialog=null};return n.promise}destroyCredentials(){if(this.credentials){this.credentials.slice().forEach((t=>{t.destroy()}))}this.emit("credentials-destroy")}enablePostMessageAuth(t="https://www.arcgis.com/sharing/rest"){this._postMessageAuthHandle&&this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=b(window,"message",(e=>{if((e.origin===this._appOrigin||e.origin.endsWith(".arcgis.com"))&&"arcgis:auth:requestCredential"===e.data?.type){const i=e.source;this.getCredential(t).then((t=>{i.postMessage({type:"arcgis:auth:credential",credential:{expires:t.expires,server:t.server,ssl:t.ssl,token:t.token,userId:t.userId}},e.origin)})).catch((t=>{i.postMessage({type:"arcgis:auth:error",error:{name:t.name,message:t.message}},e.origin)}))}}))}disablePostMessageAuth(){this._postMessageAuthHandle&&(this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=null)}_getOAuthLocationParams(){let t=window.location.hash;if(t){"#"===t.charAt(0)&&(t=t.substring(1));const e=g(t);let i=!1;if(e.access_token&&e.expires_in&&e.state&&e.hasOwnProperty("username"))try{e.state=JSON.parse(e.state),e.state.portalUrl&&(this._oAuthLocationParams=e,i=!0)}catch{}else if(e.error&&e.error_description&&(console.log("IdentityManager OAuth Error: ",e.error," - ",e.error_description),"access_denied"===e.error&&(i=!0,e.state)))try{e.state=JSON.parse(e.state)}catch{}i&&(window.location.hash=e.state?.hash||"")}let e=window.location.search;if(e){"?"===e.charAt(0)&&(e=e.substring(1));const t=g(e);let i=!1;if(t.code&&t.state)try{t.state=JSON.parse(t.state),t.state.portalUrl&&t.state.uid&&(this._oAuthLocationParams=t,i=!0)}catch{}else if(t.error&&t.error_description&&(console.log("IdentityManager OAuth Error: ",t.error," - ",t.error_description),"access_denied"===t.error&&(i=!0,t.state)))try{t.state=JSON.parse(t.state)}catch{}if(i){const e={...t};["code","error","error_description","message_code","persist","state"].forEach((t=>{delete e[t]}));const i=S(e),s=window.location.pathname+(i?`?${i}`:"")+(t.state?.hash||"");window.history.replaceState(window.history.state,"",s)}}}_getOAuthToken(t,e,i,s,r){return t=t.replace(/^http:/i,"https:"),m(`${t}/sharing/rest/oauth2/token`,{authMode:"anonymous",method:"post",query:s&&r?{grant_type:"authorization_code",code:e,redirect_uri:s,client_id:i,code_verifier:r}:{grant_type:"refresh_token",refresh_token:e,client_id:i}}).then((t=>t.data))}_getCodeChallenge(t){if(t&&globalThis.isSecureContext){const e=(new TextEncoder).encode(t);return crypto.subtle.digest("SHA-256",e).then((t=>y(new Uint8Array(t))))}return Promise.resolve(null)}_pageShowHandler(t){if(t.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow){const t=new v("identity-manager:user-aborted","ABORTED");this._errbackFunc(t)}}_findCredential(t,e){let i,s,r,n,o=-1;const a=e&&e.token,u=e&&e.resource,h=this._isServerRsrc(t)?"server":"portal",l=this.credentials.filter((e=>this._hasSameServerInstance(e.server,t)&&e.scope===h));if(t=u||t,l.length)if(1===l.length){if(i=l[0],r=this.findServerInfo(i.server),s=r&&r.owningSystemUrl,n=s?this.findCredential(s,i.userId):void 0,o=this._getIdenticalSvcIdx(t,i),!a)return-1===o&&i.resources.push(t),this._addResource(t,n),i;-1!==o&&(i.resources.splice(o,1),this._removeResource(t,n))}else{let e,i;if(l.some((a=>(i=this._getIdenticalSvcIdx(t,a),-1!==i&&(e=a,r=this.findServerInfo(e.server),s=r&&r.owningSystemUrl,n=s?this.findCredential(s,e.userId):void 0,o=i,!0)))),a)e&&(e.resources.splice(o,1),this._removeResource(t,n));else if(e)return this._addResource(t,n),e}}_findOAuthInfo(t){let e=this.findOAuthInfo(t);if(!e)for(const i of this.oAuthInfos)if(this._isIdProvider(i.portalUrl,t)){e=i;break}return e}_addResource(t,e){e&&-1===this._getIdenticalSvcIdx(t,e)&&e.resources.push(t)}_removeResource(t,e){let i=-1;e&&(i=this._getIdenticalSvcIdx(t,e),i>-1&&e.resources.splice(i,1))}_useProxy(t,e){return e&&e.isAdmin&&!w(t.adminTokenServiceUrl,this._appOrigin)||!this._isPortalDomain(t.tokenServiceUrl)&&"10.1"===String(t.currentVersion)&&!w(t.tokenServiceUrl,this._appOrigin)}_getOrigin(t){const e=new l(t);return e.scheme+"://"+e.host+(null!=e.port?":"+e.port:"")}_getServerInstanceRoot(t){const e=t.toLowerCase();let i=e.indexOf(this._agsRest);return-1===i&&this._isAdminResource(t)&&(i=this._agsAdmin.test(t)?t.replace(this._agsAdmin,"$1").length:t.search(this._adminSvcs)),-1!==i||k(e)||(i=e.indexOf("/sharing")),-1===i&&"/"===e.substr(-1)&&(i=e.length-1),i>-1?t.substring(0,i):t}_hasSameServerInstance(t,e){return"/"===t.substr(-1)&&(t=t.slice(0,-1)),t=t.toLowerCase(),e=this._getServerInstanceRoot(e).toLowerCase(),t=this._normalizeAGOLorgDomain(t),e=this._normalizeAGOLorgDomain(e),(t=t.substr(t.indexOf(":")))===(e=e.substr(e.indexOf(":")))}_normalizeAGOLorgDomain(t){const e=/^https?:\/\/(?:cdn|[a-z\d-]+\.maps)\.arcgis\.com/i,i=/^https?:\/\/(?:cdndev|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,s=/^https?:\/\/(?:cdnqa|[a-z\d-]+\.mapsqa)\.arcgis\.com/i;return e.test(t)?t=t.replace(e,"https://www.arcgis.com"):i.test(t)?t=t.replace(i,"https://devext.arcgis.com"):s.test(t)&&(t=t.replace(s,"https://qaext.arcgis.com")),t}_sanitizeUrl(t){const e=(_.request.proxyUrl||"").toLowerCase(),i=e?t.toLowerCase().indexOf(e+"?"):-1;return-1!==i&&(t=t.substring(i+e.length+1)),t=A(t),c(t).path}_isRESTService(t){return t.includes(this._agsRest)}_isAdminResource(t){return this._agsAdmin.test(t)||this._adminSvcs.test(t)}_isServerRsrc(t){return this._isRESTService(t)||this._isAdminResource(t)}_isIdenticalService(t,e){let i=!1;if(this._isRESTService(t)&&this._isRESTService(e)){const s=this._getSuffix(t).toLowerCase(),r=this._getSuffix(e).toLowerCase();if(i=s===r,!i){const t=/(.*)\/(MapServer|FeatureServer|UtilityNetworkServer).*/gi;i=s.replaceAll(t,"$1")===r.replaceAll(t,"$1")}}else this._isAdminResource(t)&&this._isAdminResource(e)?i=!0:this._isServerRsrc(t)||this._isServerRsrc(e)||!this._isPortalDomain(t)||(i=!0);return i}_isPortalDomain(t){const e=new l(t.toLowerCase()),i=this._portalConfig;let s=this._gwDomains.some((t=>t.regex.test(e.uri)));return!s&&i&&(s=this._hasSameServerInstance(this._getServerInstanceRoot(i.restBaseUrl),e.uri)),s||_.portalUrl&&(s=w(e,_.portalUrl,!0)),s||(s=this._portals.some((t=>this._hasSameServerInstance(t,e.uri)))),s=s||this._agsPortal.test(e.path),s}_isIdProvider(t,e){let i=-1,s=-1;this._gwDomains.forEach(((r,n)=>{-1===i&&r.regex.test(t)&&(i=n),-1===s&&r.regex.test(e)&&(s=n)}));let r=!1;if(i>-1&&s>-1&&(0===i||4===i?0!==s&&4!==s||(r=!0):1===i?1!==s&&2!==s||(r=!0):2===i?2===s&&(r=!0):3===i&&3===s&&(r=!0)),!r){const i=this.findServerInfo(e),s=i&&i.owningSystemUrl;s&&Yt(i)&&this._isPortalDomain(s)&&this._isIdProvider(t,s)&&(r=!0)}return r}_getIdenticalSvcIdx(t,e){let i=-1;for(let s=0;s<e.resources.length;s++){const r=e.resources[s];if(this._isIdenticalService(t,r)){i=s;break}}return i}_getSuffix(t){return t.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")}_getTokenSvcUrl(t){let e,i,s;if(this._isRESTService(t)||this._isAdminResource(t)){const s=this._getServerInstanceRoot(t);return e=s+"/admin/generateToken",i=m(t=s+"/rest/info",{query:{f:"json"}}).then((t=>t.data)),{adminUrl:e,promise:i}}if(this._isPortalDomain(t)){let e="";if(this._gwDomains.some((i=>(i.regex.test(t)&&(e=i.tokenServiceUrl),!!e))),e||this._portals.some((i=>(this._hasSameServerInstance(i,t)&&(e=i+this._gwTokenUrl),!!e))),e||(s=t.toLowerCase().indexOf("/sharing"),-1!==s&&(e=t.substring(0,s)+this._gwTokenUrl)),e||(e=this._getOrigin(t)+this._gwTokenUrl),e){const i=new l(t).port;/^http:\/\//i.test(t)&&"7080"===i&&(e=e.replace(/:7080/i,":7443")),e=e.replace(/http:/i,"https:")}return e}if(t.toLowerCase().includes("premium.arcgisonline.com"))return"https://premium.arcgisonline.com/server/tokens"}_processOAuthResponseParams(t,e,i){const s=e._oAuthCred;if(t.code){const r=s.codeVerifier;return s.codeVerifier=null,s.stateUID=null,s.save(),this._getOAuthToken(i.server,t.code,e.appId,this._getRedirectURI(e,!0),r).then((r=>{const n=new Zt({userId:r.username,server:i.server,token:r.access_token,expires:Date.now()+1e3*r.expires_in,ssl:r.ssl,oAuthState:t.state,_oAuthCred:s});return e.userId=n.userId,s.storage=r.persist?Kt:Qt,s.refreshToken=r.refresh_token,s.token=null,s.expires=r.refresh_token_expires_in?Date.now()+1e3*r.refresh_token_expires_in:null,s.userId=n.userId,s.ssl=n.ssl,s.save(),n}))}const r=new Zt({userId:t.username,server:i.server,token:t.access_token,expires:Date.now()+1e3*Number(t.expires_in),ssl:"true"===t.ssl,oAuthState:t.state,_oAuthCred:s});return e.userId=r.userId,s.storage=t.persist?Kt:Qt,s.refreshToken=null,s.token=r.token,s.expires=r.expires,s.userId=r.userId,s.ssl=r.ssl,s.save(),Promise.resolve(r)}_processOAuthPopupParams(t){const e=this._oAuthDfd;if(this._oAuthDfd=null,e)if(clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle?.remove(),t.error){const i="access_denied"===t.error,s=new v(i?"identity-manager:user-aborted":"identity-manager:authentication-failed",i?"ABORTED":"OAuth: "+t.error+" - "+t.error_description);e.reject(s)}else this._processOAuthResponseParams(t,e.oinfo_,e.sinfo_).then((t=>{e.resolve(t)})).catch((t=>{e.reject(t)}))}_setOAuthResponseQueryString(t){t&&("?"===t.charAt(0)&&(t=t.substring(1)),this._processOAuthPopupParams(g(t)))}_exchangeToken(t,e,i){return m(`${t}/sharing/rest/oauth2/exchangeToken`,{authMode:"anonymous",method:"post",query:{f:"json",client_id:e,token:i}}).then((t=>t.data.token))}_getPlatformSelf(t,e){return t=t.replace(/^http:/i,"https:"),m(`${t}/sharing/rest/oauth2/platformSelf`,{authMode:"anonymous",headers:{"X-Esri-Auth-Client-Id":e,"X-Esri-Auth-Redirect-Uri":window.location.href.replace(/#.*$/,"")},method:"post",query:{f:"json",expiration:30},withCredentials:!0}).then((t=>t.data))}_getPortalSelf(t,e){let i;if(this._gwDomains.some((e=>(e.regex.test(t)&&(i=e.customBaseUrl),!!i))),i)return Promise.resolve({allSSL:!0,currentVersion:"8.4",customBaseUrl:i,portalMode:"multitenant",supportsOAuth:!0});this._appOrigin.startsWith("https:")?t=t.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(e)&&(t=t.replace(/^https:/i,"http:").replace(/:7443/i,":7080"));return m(t,{query:{f:"json"},authMode:"anonymous",withCredentials:!0}).then((t=>t.data))}_doPortalSignIn(t){const e=this._portalConfig,i=window.location.href,s=this.findServerInfo(t);return!(!e&&!this._isPortalDomain(i)||!(s?s.hasPortal||s.owningSystemUrl&&this._isPortalDomain(s.owningSystemUrl):this._isPortalDomain(t))||!(this._isIdProvider(i,t)||e&&(this._hasSameServerInstance(this._getServerInstanceRoot(e.restBaseUrl),t)||this._isIdProvider(e.restBaseUrl,t))||w(i,t,!0)))}_checkProtocol(t,e,i,s){let r=!0;const n=s?e.adminTokenServiceUrl:e.tokenServiceUrl;if(n.trim().toLowerCase().startsWith("https:")&&!this._appOrigin.startsWith("https:")&&I(n)&&(r=!!this._protocolFunc&&!!this._protocolFunc({resourceUrl:t,serverInfo:e}),!r)){i(new v("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection."))}return r}_enqueue(t,e,i,s,r,n){return s||(s=d()),s.resUrl_=t,s.sinfo_=e,s.options_=i,s.admin_=r,s.refresh_=n,this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(t),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(s)):this._xoReqs.push(s):this._doSignIn(s),s.promise}_doSignIn(t){this._busy=t,this._rejectOnPersistedPageShow=!1;const e=e=>{const i=t.options_&&t.options_.resource,s=t.resUrl_,r=t.refresh_;let n=!1;this.credentials.includes(e)||(r&&this.credentials.includes(r)?(r.userId=e.userId,r.token=e.token,r.expires=e.expires,r.validity=e.validity,r.ssl=e.ssl,r.creationTime=e.creationTime,n=!0,e=r):this.credentials.push(e)),e.resources||(e.resources=[]),e.resources.includes(i||s)||e.resources.push(i||s),e.scope=this._isServerRsrc(s)?"server":"portal",e.emitTokenChange();const o=this._soReqs,a={};this._soReqs=[],o.forEach((t=>{if(!this._isIdenticalService(s,t.resUrl_)){const i=this._getSuffix(t.resUrl_);a[i]||(a[i]=!0,e.resources.push(t.resUrl_))}})),t.resolve(e),o.forEach((t=>{this._hasSameServerInstance(this._getServerInstanceRoot(s),t.resUrl_)?t.resolve(e):this._soReqs.push(t)})),this._busy=t.resUrl_=t.sinfo_=t.refresh_=null,n||this.emit("credential-create",{credential:e}),this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},i=e=>{t.reject(e),this._busy=t.resUrl_=t.sinfo_=t.refresh_=null,this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},s=(r,n,o,a)=>{const u=t.sinfo_,h=!t.options_||!1!==t.options_.prompt,l=u.hasPortal&&this._findOAuthInfo(t.resUrl_);let c,d;if(r)e(new Zt({userId:r,server:u.server,token:o||null,expires:null!=a?Number(a):null,ssl:!!n}));else if(window!==window.parent&&this._appUrlObj.query?.["arcgis-auth-origin"]&&this._appUrlObj.query?.["arcgis-auth-portal"]&&this._hasSameServerInstance(this._getServerInstanceRoot(this._appUrlObj.query["arcgis-auth-portal"]),t.resUrl_)){window.parent.postMessage({type:"arcgis:auth:requestCredential"},this._appUrlObj.query["arcgis-auth-origin"]);const s=b(window,"message",(t=>{t.source===window.parent&&t.data&&("arcgis:auth:credential"===t.data.type?(s.remove(),t.data.credential.expires<Date.now()?i(new v("identity-manager:credential-request-failed","Parent application's token has expired.")):e(new Zt(t.data.credential))):"arcgis:auth:error"===t.data.type&&(s.remove(),"tokenExpiredError"===t.data.error.name?i(new v("identity-manager:credential-request-failed","Parent application's token has expired.")):i(v.fromJSON(t.data.error))))}));f(t.options_?.signal,(()=>{s.remove()}))}else if(l){let r=l._oAuthCred;if(!r){const t=new Bt(l,Kt),e=new Bt(l,Qt);t.isValid()&&e.isValid()?t.expires>e.expires?(r=t,e.destroy()):(r=e,t.destroy()):r=t.isValid()?t:e,l._oAuthCred=r}if(r.isValid()){c=new Zt({userId:r.userId,server:u.server,token:r.token,expires:r.expires,ssl:r.ssl,_oAuthCred:r});const i=l.appId!==r.appId&&this._doPortalSignIn(t.resUrl_);i||r.refreshToken?(t._pendingDfd=r.refreshToken?this._getOAuthToken(u.server,r.refreshToken,r.appId).then((t=>(c.expires=Date.now()+1e3*t.expires_in,c.token=t.access_token,c))):Promise.resolve(c),t._pendingDfd.then((t=>i?this._exchangeToken(t.server,l.appId,t.token).then((e=>(t.token=e,t))).catch((()=>t)):t)).then((t=>{e(t)})).catch((()=>{r?.destroy(),s()}))):e(c)}else if(this._oAuthLocationParams&&this._hasSameServerInstance(l.portalUrl,this._oAuthLocationParams.state.portalUrl)&&(this._oAuthLocationParams.access_token||this._oAuthLocationParams.code&&this._oAuthLocationParams.state.uid===r.stateUID&&r.codeVerifier)){const s=this._oAuthLocationParams;this._oAuthLocationParams=null,t._pendingDfd=this._processOAuthResponseParams(s,l,u).then((t=>{e(t)})).catch(i)}else{const s=()=>{h?t._pendingDfd=this.oAuthSignIn(t.resUrl_,u,l,t.options_).then(e,i):(d=new v("identity-manager:not-authenticated","User is not signed in."),i(d))};this._doPortalSignIn(t.resUrl_)?t._pendingDfd=this._getPlatformSelf(u.server,l.appId).then((t=>{w(t.portalUrl,this._appOrigin,!0)?(c=new Zt({userId:t.username,server:u.server,expires:Date.now()+1e3*t.expires_in,token:t.token}),e(c)):s()})).catch(s):s()}}else if(h){if(this._checkProtocol(t.resUrl_,u,i,t.admin_)){let s=t.options_;t.admin_&&(s=s||{},s.isAdmin=!0),t._pendingDfd=this.signIn(t.resUrl_,u,s).then(e,i)}}else d=new v("identity-manager:not-authenticated","User is not signed in."),i(d)},r=()=>{const s=t.sinfo_,r=s.owningSystemUrl,n=t.options_;let o,a,u,h;if(n&&(o=n.token,a=n.error,u=n.prompt),h=this._findCredential(r,{token:o,resource:t.resUrl_}),!h)for(const t of this.credentials)if(this._isIdProvider(r,t.server)){h=t;break}if(h){const r=this.findCredential(t.resUrl_,h.userId);if(r)e(r);else if(Xt(s,this._legacyFed)){const t=h.toJSON();t.server=s.server,t.resources=null,e(new Zt(t))}else{(t._pendingDfd=this.generateToken(this.findServerInfo(h.server),null,{serverUrl:t.resUrl_,token:h.token,signal:t.options_.signal,ssl:h.ssl})).then((i=>{e(new Zt({userId:h?.userId,server:s.server,token:i.token,expires:null!=i.expires?Number(i.expires):null,ssl:!!i.ssl,isAdmin:t.admin_,validity:i.validity}))}),i)}}else{this._busy=null,o&&(t.options_.token=null);(t._pendingDfd=this.getCredential(r.replace(/\/?$/,"/sharing"),{resource:t.resUrl_,owningTenant:s.owningTenant,signal:t.options_.signal,token:o,error:a,prompt:u})).then((()=>{this._enqueue(t.resUrl_,t.sinfo_,t.options_,t,t.admin_)}),(e=>{t.resUrl_=t.sinfo_=t.refresh_=null,t.reject(e)}))}};this._errbackFunc=i;const n=t.sinfo_.owningSystemUrl,o=this._isServerRsrc(t.resUrl_),a=t.sinfo_._restInfoPms;a?a.promise.then((e=>{const i=t.sinfo_;if(i._restInfoPms){i.adminTokenServiceUrl=i._restInfoPms.adminUrl,i._restInfoPms=null,i.tokenServiceUrl=(T("authInfo.tokenServicesUrl",e)||T("authInfo.tokenServiceUrl",e)||T("tokenServiceUrl",e))??null,i.shortLivedTokenValidity=T("authInfo.shortLivedTokenValidity",e)??null,i.currentVersion=e.currentVersion,i.owningTenant=e.owningTenant;const t=i.owningSystemUrl=e.owningSystemUrl;t&&this._portals.push(t)}o&&i.owningSystemUrl?r():s()}),(()=>{t.sinfo_._restInfoPms=null;const e=new v("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");i(e)})):o&&n?r():t.sinfo_._selfReq?t.sinfo_._selfReq.selfDfd.then((e=>{const i={};let s,r,n,o;return e&&(s=e.user&&e.user.username,i.username=s,i.allSSL=e.allSSL,r=e.supportsOAuth,o=parseFloat(e.currentVersion),"multitenant"===e.portalMode&&(n=e.customBaseUrl),t.sinfo_.currentVersion=o),t.sinfo_.webTierAuth=!!s,s&&this.normalizeWebTierAuth?this.generateToken(t.sinfo_,null,{ssl:i.allSSL}).catch((()=>null)).then((t=>(i.portalToken=t&&t.token,i.tokenExpiration=t&&t.expires,i))):!s&&r&&o>=4.4&&!this._findOAuthInfo(t.resUrl_)?this._generateOAuthInfo({portalUrl:t.sinfo_.server,customBaseUrl:n,owningTenant:t.sinfo_._selfReq.owningTenant}).catch((()=>null)).then((()=>i)):i})).catch((()=>null)).then((e=>{t.sinfo_._selfReq=null,e?s(e.username,e.allSSL,e.portalToken,e.tokenExpiration):s()})):s()}_generateOAuthInfo(t){let e,i=null,s=t.portalUrl;const r=t.customBaseUrl,n=t.owningTenant,o=!this._defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal;if(o){i=window.location.href;let t=i.indexOf("?");t>-1&&(i=i.slice(0,t)),t=i.search(/\/(apps|home)\//),i=t>-1?i.slice(0,t):null}return o&&i?(this._hasTestedIfAppIsOnPortal=!0,e=m(i+"/sharing/rest",{query:{f:"json"}}).then((()=>{this._defaultOAuthInfo=new Gt({appId:"arcgisonline",popupCallbackUrl:i+"/home/oauth-callback.html"})}))):e=Promise.resolve(),e.then((()=>{if(this._defaultOAuthInfo)return s=s.replace(/^http:/i,"https:"),m(s+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:n,client_id:this._defaultOAuthInfo.appId,redirect_uri:O(this._defaultOAuthInfo.popupCallbackUrl),f:"json"}}).then((t=>{if(t.data.valid){const e=this._defaultOAuthInfo.clone();t.data.urlKey&&r?e.portalUrl="https://"+t.data.urlKey.toLowerCase()+"."+r:e.portalUrl=s,e.popup=window!==window.top||!(w(s,this._appOrigin)||this._gwDomains.some((t=>t.regex.test(s)&&t.regex.test(this._appOrigin)))),this.oAuthInfos.push(e)}}))}))}_doOAuthSignIn(t,e,i,s){const r=i._oAuthCred,n={portalUrl:i.portalUrl};!i.popup&&i.preserveUrlHash&&window.location.hash&&(n.hash=window.location.hash),r.stateUID&&(n.uid=r.stateUID);const o={client_id:i.appId,response_type:r.codeVerifier?"code":"token",state:JSON.stringify(n),expiration:i.expiration,locale:i.locale,redirect_uri:this._getRedirectURI(i,!!r.codeVerifier)};i.forceLogin&&(o.force_login=!0),i.forceUserId&&i.userId&&(o.prepopulatedusername=i.userId),!i.popup&&this._doPortalSignIn(t)&&(o.redirectToUserOrgUrl=!0),r.codeVerifier&&(o.code_challenge=s||r.codeVerifier,o.code_challenge_method=s?"S256":"plain");const a=i.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",u=a+"?"+S(o);if(i.popup){const t=window.open(u,"esriJSAPIOAuth",i.popupWindowFeatures);if(t)t.focus(),this._oAuthDfd.oAuthWin_=t,this._oAuthIntervalId=setInterval((()=>{if(t.closed){clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle.remove();const t=this._oAuthDfd;if(t){const e=new v("identity-manager:user-aborted","ABORTED");t.reject(e)}}}),500),this._oAuthOnPopupHandle=b(window,["arcgis:auth:hash","arcgis:auth:location:search"],(t=>{"arcgis:auth:hash"===t.type?this.setOAuthResponseHash(t.detail):this._setOAuthResponseQueryString(t.detail)}));else{const t=new v("identity-manager:popup-blocked","ABORTED");this._oAuthDfd.reject(t)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:o,authorizeUrl:a,resourceUrl:t,serverInfo:e,oAuthInfo:i}):window.location.href=u}_getRedirectURI(t,e){const i=window.location.href.replace(/#.*$/,"");if(t.popup)return O(t.popupCallbackUrl);if(e){const t=c(i);return t.query&&["code","error","error_description","message_code","persist","state"].forEach((e=>{delete t.query[e]})),x(t.path,t.query)}return i}}Wt.prototype.declaredClass="esri.identity.IdentityManagerBase";let Zt=class extends a.EventedAccessor{constructor(t){super(t),this._oAuthCred=null,this.tokenRefreshBuffer=2,t&&t._oAuthCred&&(this._oAuthCred=t._oAuthCred)}initialize(){this.resources=this.resources||[],null==this.creationTime&&(this.creationTime=Date.now())}refreshToken(){const t=u.findServerInfo(this.server),e=t&&t.owningSystemUrl,i=!!e&&"server"===this.scope,s=i&&Xt(t,u._legacyFed),r=t.webTierAuth,n=r&&u.normalizeWebTierAuth,o=Ht[this.server],a=o&&o[this.userId];let h,l=this.resources&&this.resources[0],c=i?u.findServerInfo(e):null,d={username:this.userId,password:a};if(r&&!n)return;i&&!c&&u.serverInfos.some((t=>(u._isIdProvider(e,t.server)&&(c=t),!!c)));const f=c?u.findCredential(c.server,this.userId):null;if(!i||f){if(!s){if(i)h={serverUrl:l,token:f&&f.token,ssl:f&&f.ssl};else if(n)d=null,h={ssl:this.ssl};else{if(!a){let e;return l&&(l=u._sanitizeUrl(l),this._enqueued=1,e=u._enqueue(l,t,null,null,this.isAdmin,this),e.then((()=>{this._enqueued=0,this.refreshServerTokens()})).catch((()=>{this._enqueued=0}))),e}this.isAdmin&&(h={isAdmin:!0})}return u.generateToken(i?c:t,i?null:d,h).then((t=>{this.token=t.token,this.expires=null!=t.expires?Number(t.expires):null,this.creationTime=Date.now(),this.validity=t.validity,this.emitTokenChange(),this.refreshServerTokens()})).catch((()=>{}))}f?.refreshToken()}}refreshServerTokens(){"portal"===this.scope&&u.credentials.forEach((t=>{const e=u.findServerInfo(t.server),i=e&&e.owningSystemUrl;t!==this&&t.userId===this.userId&&i&&"server"===t.scope&&(u._hasSameServerInstance(this.server,i)||u._isIdProvider(i,this.server))&&(Xt(e,u._legacyFed)?(t.token=this.token,t.expires=this.expires,t.creationTime=this.creationTime,t.validity=this.validity,t.emitTokenChange()):t.refreshToken())}))}emitTokenChange(t){clearTimeout(this._refreshTimer);const e=this.server&&u.findServerInfo(this.server),i=e&&e.owningSystemUrl,s=i&&u.findServerInfo(i);!1===t||i&&"portal"!==this.scope&&(!s||!s.webTierAuth||u.normalizeWebTierAuth)||null==this.expires&&null==this.validity||this._startRefreshTimer(),this.emit("token-change")}destroy(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null,this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);const t=u.credentials.indexOf(this);t>-1&&u.credentials.splice(t,1),this.emitTokenChange(),this.emit("destroy")}toJSON(){const t=h({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),e=this.resources;return e&&e.length>0&&(t.resources=e.slice()),t}_startRefreshTimer(){clearTimeout(this._refreshTimer);const t=6e4*this.tokenRefreshBuffer,e=2**31-1;let i=(this.validity?this.creationTime+6e4*this.validity:this.expires)-Date.now();i<0?i=0:i>e&&(i=e),this._refreshTimer=setTimeout(this.refreshToken.bind(this),i>t?i-t:i)}};t([e()],Zt.prototype,"creationTime",void 0),t([e()],Zt.prototype,"expires",void 0),t([e()],Zt.prototype,"isAdmin",void 0),t([e()],Zt.prototype,"oAuthState",void 0),t([e()],Zt.prototype,"resources",void 0),t([e()],Zt.prototype,"scope",void 0),t([e()],Zt.prototype,"server",void 0),t([e()],Zt.prototype,"ssl",void 0),t([e()],Zt.prototype,"token",void 0),t([e()],Zt.prototype,"tokenRefreshBuffer",void 0),t([e()],Zt.prototype,"userId",void 0),t([e()],Zt.prototype,"validity",void 0),Zt=t([i("esri.identity.Credential")],Zt);class te extends Wt{}te.prototype.declaredClass="esri.identity.IdentityManager";const ee=new te;U(ee);export default ee;
//# sourceMappingURL=p-7a131d93.js.map