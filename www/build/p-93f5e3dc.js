import{ad as t,Q as s,aR as i,b as p,l as e,y as r,n as a}from"./p-b54724b6.js";import{t as o,n as c}from"./p-14679aa5.js";import{f as h,d as m}from"./p-5f5f43c2.js";import{h as j}from"./p-cd4a8b9a.js";import{e as n}from"./p-cae2235f.js";import{y as f,d as l}from"./p-faf4e331.js";import{a as d}from"./p-3faf3e32.js";import"./p-a25d6f7d.js";import"./p-07f12c16.js";import"./p-cc8b27b8.js";import"./p-52a9dec5.js";import"./p-2d1dac84.js";import"./p-843f0c78.js";import"./p-570a8a46.js";import"./p-13e550f5.js";import"./p-49f0006c.js";import"./p-541ec65c.js";import"./p-b3dc802f.js";import"./p-0fe6a545.js";import"./p-1fd43aa6.js";import"./p-795f7c81.js";import"./p-29040467.js";import"./p-0e94eaa4.js";import"./p-33c0f331.js";import"./p-9f1a0adc.js";import"./p-5b0b1d68.js";import"./p-4f76b2d1.js";import"./p-42c332a2.js";import"./p-38e70926.js";import"./p-74887bd8.js";import"./p-783b6965.js";import"./p-a3f0a5f3.js";import"./p-e6a64715.js";import"./p-dc29c329.js";import"./p-58405edc.js";import"./p-6ffbaa7a.js";import"./p-fc9cd10b.js";import"./p-fdc41b20.js";import"./p-ecc7ed03.js";import"./p-05938a61.js";import"./p-8043ab9b.js";import"./p-1184cc61.js";import"./p-98e621d1.js";import"./p-1b31d781.js";import"./p-f7f8e6f9.js";import"./p-a779e49b.js";import"./p-7572c366.js";import"./p-832f907c.js";import"./p-5abe9c67.js";import"./p-0856fe30.js";import"./p-a5e3ec2a.js";import"./p-80be55a5.js";import"./p-b88ddb1e.js";import"./p-8dc3148c.js";import"./p-ca5fb53c.js";import"./p-d7fc78fa.js";import"./p-581eca80.js";import"./p-2a2efb66.js";import"./p-1701e549.js";import"./p-07a1e707.js";import"./p-8bc47c76.js";import"./p-c19b935f.js";import"./p-c8e3775b.js";import"./p-e75aa2b5.js";import"./p-f5f26b1f.js";import"./p-a379c2ce.js";import"./p-9a4094ba.js";const u=[102113,102100,3857,3785,900913],b=[0,0];let w=class extends(d(o(h(m)))){constructor(){super(...arguments),this._tileStrategy=null,this._fetchQueue=null,this._tileRequests=new Map,this.layer=null}get tileMatrixSet(){const t=this._getTileMatrixSetBySpatialReference(this.layer.activeLayer);return t?(t.id!==this.layer.activeLayer.tileMatrixSetId&&(this.layer.activeLayer.tileMatrixSetId=t.id),t):null}update(t){this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume()}attach(){const s=this.tileMatrixSet?.tileInfo;s&&(this._tileInfoView=new j(s),this._fetchQueue=new f({tileInfoView:this._tileInfoView,concurrency:16,process:(t,s)=>this.fetchTile(t,s)}),this._tileStrategy=new l({cachePolicy:"keep",resampling:!0,acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView}),this.addAttachHandles(t((()=>[this.layer?.activeLayer?.styleId,this.tileMatrixSet]),(()=>this._refresh()))),super.attach())}detach(){super.detach(),this._tileStrategy?.destroy(),this._fetchQueue?.destroy(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}releaseTile(t){this._fetchQueue.abort(t.key.id),this._bitmapView.removeChild(t),t.once("detach",(()=>t.destroy())),this.requestUpdate()}acquireTile(t){const s=this._bitmapView.createTile(t),i=s.bitmap;return[i.x,i.y]=this._tileInfoView.getTileCoords(b,s.key),i.resolution=this._tileInfoView.getTileResolution(s.key),[i.width,i.height]=this._tileInfoView.tileInfo.size,this._enqueueTileFetch(s),this._bitmapView.addChild(s),this.requestUpdate(),s}async doRefresh(){!this.attached||this.updateRequested||this.suspended||this._refresh()}isUpdating(){return this._fetchQueue?.updating??!1}async fetchTile(t,i={}){const p="tilemapCache"in this.layer?this.layer.tilemapCache:null,{signal:e,resamplingLevel:r=0}=i;if(!p)return this._fetchImage(t,e);const a=new n(0,0,0,0);let o;try{await p.fetchAvailabilityUpsample(t.level,t.row,t.col,a,{signal:e}),o=await this._fetchImage(a,e)}catch(p){if(s(p))throw p;if(r<3){const s=this._tileInfoView.getTileParentId(t.id);if(s){const p=new n(s),e=await this.fetchTile(p,{...i,resamplingLevel:r+1});return c(this._tileInfoView,e,p,t)}}throw p}return c(this._tileInfoView,o,a,t)}canResume(){const t=super.canResume();return t?null!==this.tileMatrixSet:t}supportsSpatialReference(t){return this.layer.activeLayer.tileMatrixSets?.some((s=>i(s.tileInfo?.spatialReference,t)))??!1}async _enqueueTileFetch(t){if(!this._fetchQueue.has(t.key.id)){try{const s=await this._fetchQueue.push(t.key);t.bitmap.source=s,t.bitmap.width=this._tileInfoView.tileInfo.size[0],t.bitmap.height=this._tileInfoView.tileInfo.size[1],t.once("attach",(()=>this.requestUpdate()))}catch(t){s(t)||p.getLogger(this).error(t)}this.requestUpdate()}}async _fetchImage(t,s){return this.layer.fetchImageBitmapTile(t.level,t.row,t.col,{signal:s})}_refresh(){this._fetchQueue.reset(),this._tileStrategy.refresh((t=>{if(!t.bitmap.source)return;const i={id:t.key.id,fulfilled:!1,promise:this._fetchQueue.push(t.key).then((s=>{t.bitmap.source=s})).catch((i=>{s(i)||(t.bitmap.source=null)})).finally((()=>{t.requestRender(),i.fulfilled=!0}))};this._tileRequests.set(t,i)}))}_getTileMatrixSetBySpatialReference(t){const s=this.view.spatialReference;if(!t.tileMatrixSets)return null;let p=t.tileMatrixSets.find((t=>i(t.tileInfo?.spatialReference,s)));return!p&&s.isWebMercator&&(p=t.tileMatrixSets.find((t=>u.includes(t.tileInfo?.spatialReference.wkid??-1)))),p}};e([r()],w.prototype,"_fetchQueue",void 0),e([r({readOnly:!0})],w.prototype,"tileMatrixSet",null),w=e([a("esri.views.2d.layers.WMTSLayerView2D")],w);const y=w;export default y;
//# sourceMappingURL=p-93f5e3dc.js.map