import{b as e,s as n,e as t,E as i,dr as a,aU as s,bg as r,dJ as o}from"./p-b54724b6.js";import{g as l,s as c,r as u}from"./p-a3f0a5f3.js";import{e as f}from"./p-dc29c329.js";import{T as p,L as d,I as m}from"./p-7a0db0bb.js";import{o as g}from"./p-5525ea5e.js";const y=e.getLogger("esri.layers.graphics.sources.ogcfeature"),w="http://www.opengis.net/def/crs/",h=`${w}OGC/1.3/CRS84`;async function b(e,s,r={},o=5){const{links:l}=e,c=M(l,"items","application/geo+json")||M(l,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(null==c)throw new n("ogc-feature-layer:missing-items-page","Missing items url");const{data:u}=await t(c.href,{signal:r.signal,query:{limit:o,...r.customParameters,token:r.apiKey},headers:{accept:"application/geo+json"}});await p(u);const f=d(u,{geometryType:s.geometryType}),m=s.fields||f.fields||[],w=null!=s.hasZ?s.hasZ:f.hasZ,h=f.geometryType,b=s.objectIdField||f.objectIdFieldName||"OBJECTID";let j=s.timeInfo;const x=m.find((({name:e})=>e===b));if(x)x.editable=!1,x.nullable=!1;else{if(!f.objectIdFieldType)throw new n("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");m.unshift({name:b,alias:b,type:"number"===f.objectIdFieldType?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(b!==f.objectIdFieldName){const e=m.find((({name:e})=>e===f.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}m===f.fields&&f.unknownFields.length>0&&y.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:f.unknownFields}});for(const e of m){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new n("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(!i.jsonValues.includes(e.type))throw new n("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(j){const e=new a(m);if(j.startTimeField){const n=e.get(j.startTimeField);n?(j.startTimeField=n.name,n.type="esriFieldTypeDate"):j.startTimeField=null}if(j.endTimeField){const n=e.get(j.endTimeField);n?(j.endTimeField=n.name,n.type="esriFieldTypeDate"):j.endTimeField=null}if(j.trackIdField){const n=e.get(j.trackIdField);n?j.trackIdField=n.name:(j.trackIdField=null,y.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:j}}))}j.startTimeField||j.endTimeField||(y.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:j}}),j=null)}return{drawingInfo:h?g(h):null,extent:K(e),geometryType:h,fields:m,hasZ:!!w,objectIdField:b,timeInfo:j}}async function j(e,i={}){const{links:a}=e,s=M(a,"data","application/json")||M(a,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(null==s)throw new n("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:r,customParameters:o,signal:l}=i,{data:c}=await t(s.href,{signal:l,headers:{accept:"application/json"},query:{...o,token:r}});return c}async function x(e,i={}){const{links:a}=e,s=M(a,"conformance","application/json")||M(a,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(null==s)throw new n("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:r,customParameters:o,signal:l}=i,{data:c}=await t(s.href,{signal:l,headers:{accept:"application/json"},query:{...o,token:r}});return c}async function I(e,n={}){const{apiKey:i,customParameters:a,signal:s}=n,{data:r}=await t(e,{signal:s,headers:{accept:"application/json"},query:{...a,token:i}});return r}async function F(e,n={}){const i="application/vnd.oai.openapi+json;version=3.0",a=M(e.links,"service-desc",i);if(null==a)return y.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:s,customParameters:r,signal:o}=n,{data:l}=await t(a.href,{signal:o,headers:{accept:i},query:{...r,token:s}});return l}function T(e){const n=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),t=n?.groups;if(!t)return null;const{authority:i,code:a}=t;switch(i.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return s.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return s.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(a,10);return Number.isNaN(e)?null:e}default:return null}}async function k(e,n,t){const i=await v(e,n,t);return l(i)}async function v(e,i,a){const{collection:l,layerDefinition:p,maxRecordCount:d,queryParameters:{apiKey:g,customParameters:y},spatialReference:w,supportedCrs:h}=e,{links:b}=l,j=M(b,"items","application/geo+json")||M(b,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(null==j)throw new n("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:x,num:I,start:F,timeExtent:T,where:k}=i;if(i.objectIds)throw new n("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const v=s.fromJSON(w),q=i.outSpatialReference??v,P=q.isWGS84?null:$(q,h),K=O(x,h),R=C(T),N=D(k),E=I??(null!=F&&void 0!==F?10:d),{data:G}=await t(j.href,{...a,query:{...y,...K,crs:P,datetime:R,query:N,limit:E,startindex:F,token:g},headers:{accept:"application/geo+json"}});let S=!1;if(G.links){const e=G.links.find((e=>"next"===e.rel));S=!!e}!S&&Number.isInteger(G.numberMatched)&&Number.isInteger(G.numberReturned)&&(S=G.numberReturned<G.numberMatched);const{fields:Z,geometryType:z,hasZ:A,objectIdField:J}=p,B=m(G,{geometryType:z,hasZ:A,objectIdField:J});if(!P&&q.isWebMercator)for(const e of B)if(null!=e.geometry&&null!=z){const n=c(e.geometry,z,A,!1);n.spatialReference=s.WGS84,e.geometry=u(r(n,q))}for(const e of B)e.objectId=e.attributes[J];const Q=P||!P&&q.isWebMercator?q.toJSON():o,U=new f;return U.exceededTransferLimit=S,U.features=B,U.fields=Z,U.geometryType=z,U.hasZ=A,U.objectIdFieldName=J,U.spatialReference=Q,U}function q(e){return null!=e&&"extent"===e.type}function $(e,n){const{isWebMercator:t,wkid:i}=e;if(!i)return null;const a=t?n[3857]??n[102100]??n[102113]??n[900913]:n[e.wkid];return a?`${w}${a}`:null}function P(e){if(null==e)return"";const{xmin:n,ymin:t,xmax:i,ymax:a}=e;return`${n},${t},${i},${a}`}function C(e){if(null==e)return null;const{start:n,end:t}=e;return`${null!=n?n.toISOString():".."}/${null!=t?t.toISOString():".."}`}function D(e){return null!=e&&e&&"1=1"!==e?e:null}function O(e,n){if(!q(e))return null;const{spatialReference:t}=e;if(!t||t.isWGS84)return{bbox:P(e)};const i=$(t,n);return null!=i?{bbox:P(e),"bbox-crs":i}:t.isWebMercator?{bbox:P(r(e,s.WGS84))}:null}function K(e){const n=e.extent?.spatial;if(!n)return null;const t=n.bbox[0],i=4===t.length,a=t[0],r=t[1],o=i?void 0:t[2];return{xmin:a,ymin:r,xmax:i?t[2]:t[3],ymax:i?t[3]:t[4],zmin:o,zmax:i?void 0:t[5],spatialReference:s.WGS84.toJSON()}}function M(e,n,t){return e.find((e=>e.rel===n&&e.type===t))||e.find((e=>e.rel===n&&!e.type))}export{x as F,I,v as S,F as T,h as b,b as h,j,T as k,w,k as x};
//# sourceMappingURL=p-b7965e5f.js.map