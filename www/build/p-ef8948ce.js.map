{"version":3,"names":["v","r","getLogger","b","I","e","t","title","id","declaredClass","S","type","async","g","load","u","j","a","messages","filter","map","name","message","details","ignoreUnsupported","length","errors","L","beforeSave","write","P","layer","layerJSON","isTable","layers","tables","J","m","f","JSAPI","typeKeywords","indexOf","N","portalItem","error","loaded","O","test","url","E","customParameters","apiKey","o","l","fetchData","T","layerId","s","A","serviceJSON","layersJSON","n","i","$","p","itemResources","c","added","d","x","removed","some","forEach","push","includes","sourceJSON","find","defaultPopupTemplate","popupInfo","toJSON","U","findIndex","K","dynamicDataSource","F","Promise","all","Set","size","R","from","clone","portal","getDefault","D","fullExtent","serverType","extent","w","h","METADATA","MULTI_LAYER","SINGLE_LAYER","TABLE","q","signIn","user","addItem","item","data","folder","z","C","y","update","M","slice","reload","Y","_"],"sources":["./node_modules/@arcgis/core/layers/save/featureLayerUtils.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.27/esri/copyright.txt for details.\n*/\nimport{difference as e}from\"../../core/arrayUtils.js\";import t from\"../../core/Error.js\";import r from\"../../core/Logger.js\";import{debounce as a,eachAlways as o}from\"../../core/promiseUtils.js\";import{updateOrigins as l}from\"../../core/accessorSupport/originUtils.js\";import s from\"../FeatureLayer.js\";import{parse as n}from\"../support/arcgisLayerUrl.js\";import{fetchFeatureService as i}from\"../support/fetchService.js\";import{isFeatureCollectionLayer as u,isFeatureServiceLayer as p}from\"../support/layerUtils.js\";import c from\"../../portal/Portal.js\";import d from\"../../portal/PortalItem.js\";import{createForItemWrite as y}from\"../../portal/support/jsonContext.js\";import{addTypeKeyword as m,TypeKeyword as f,getWGS84ExtentForItem as w,removeTypeKeyword as h}from\"../../portal/support/portalItemUtils.js\";const v=r.getLogger(\"esri.layers.FeatureLayer\"),b=\"Feature Service\";function I(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function S(e,r){if(r.type!==b)throw new t(\"feature-layer:portal-item-wrong-type\",I(e,`should have portal item of type \"${b}\"`))}async function g(e){if(await e.load(),u(e))throw new t(\"feature-layer:save\",I(e,\"using an in-memory source cannot be saved to a portal item\"))}function j(e,r){let a=(e.messages??[]).filter((({type:e})=>\"error\"===e)).map((({name:e,message:r,details:a})=>new t(e,r,a)));if(r?.ignoreUnsupported&&(a=a.filter((({name:e})=>\"layer:unsupported\"!==e&&\"symbol:unsupported\"!==e&&\"symbol-layer:unsupported\"!==e&&\"property:unsupported\"!==e&&\"url:unsupported\"!==e))),a.length>0)throw new t(\"feature-layer:save\",\"Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information\",{errors:a})}async function L(e,t,r){\"beforeSave\"in e&&\"function\"==typeof e.beforeSave&&await e.beforeSave();const a=e.write({},t);return j(t,r),a}function P(e){const{layer:t,layerJSON:r}=e;return t.isTable?{layers:[],tables:[r]}:{layers:[r],tables:[]}}function J(e){m(e,f.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}function N(e){const r=e.portalItem;if(!r)throw v.error(\"save: requires the portalItem property to be set\"),new t(\"feature-layer:portal-item-not-set\",I(e,\"requires the portalItem property to be set\"));if(!r.loaded)throw new t(\"feature-layer:portal-item-not-loaded\",I(e,\"cannot be saved to a portal item that does not exist or is inaccessible\"));S(e,r)}async function O(e,t){return/\\/\\d+\\/?$/.test(e.url??\"\")?P(t[0]):E(e,t)}async function E(e,t){const{layer:{url:r,customParameters:a,apiKey:o}}=t[0];let l=await e.fetchData(\"json\");l&&null!=l.layers&&null!=l.tables||(l=await T(l,{url:r??\"\",customParameters:a,apiKey:o},t.map((e=>e.layer.layerId))));for(const s of t)A(s.layer,s.layerJSON,l);return l}async function T(e,t,r){e||={},e.layers||=[],e.tables||=[];const{url:a,customParameters:o,apiKey:l}=t,{serviceJSON:s,layersJSON:n}=await i(a,{customParameters:o,apiKey:l}),u=$(e.layers,s.layers,r),p=$(e.tables,s.tables,r);e.layers=u.itemResources,e.tables=p.itemResources;const c=[...u.added,...p.added],d=n?[...n.layers,...n.tables]:[];return await x(e,c,a,d),e}function $(t,r,a){const o=e(t,r,((e,t)=>e.id===t.id));t=t.filter((e=>!o.removed.some((t=>t.id===e.id))));const l=o.added.map((({id:e})=>({id:e})));return l.forEach((({id:e})=>{t.push({id:e})})),{itemResources:t,added:l.filter((({id:e})=>!a.includes(e)))}}async function x(e,t,r,a){const l=t.map((({id:e})=>new s({url:r,layerId:e,sourceJSON:a.find((({id:t})=>t===e))})));await o(l.map((e=>e.load()))),l.forEach((t=>{const{layerId:r,loaded:a,defaultPopupTemplate:o}=t;if(!a||null==o)return;A(t,{id:r,popupInfo:o.toJSON()},e)}))}function A(e,t,r){e.isTable?U(r.tables,t):U(r.layers,t)}function U(e,t){if(!e)return;const r=e.findIndex((({id:e})=>e===t.id));-1===r?e.push(t):e[r]=t}function K(e){const{portalItem:t}=e;return p(e)&&!e.dynamicDataSource&&!!t?.loaded&&t.type===b}async function F(e){if(!e?.length)throw new t(\"feature-layer-utils-saveall:missing-parameters\",\"'layers' array should contain at least one feature layer\");await Promise.all(e.map((e=>e.load())));for(const o of e)if(!K(o))throw new t(\"feature-layer-utils-saveall:invalid-parameters\",`'layers' array should only contain layers or tables in a feature service loaded from 'Feature Service' item. ${I(o,\"does not conform\")}`,{layer:o});const r=e.map((e=>e.portalItem.id));if(new Set(r).size>1)throw new t(\"feature-layer-utils-saveall:invalid-parameters\",\"All layers in the 'layers' array should be loaded from the same portal item\");const a=e.map((e=>e.layerId));if(new Set(a).size!==a.length)throw new t(\"feature-layer-utils-saveall:invalid-parameters\",\"'layers' array should contain only one instance each of layer or table in a feature service\")}function R(e,t){let r=d.from(t);return r.id&&(r=r.clone(),r.id=null),r.type??=b,r.portal??=c.getDefault(),S(e,r),r}async function D(e,t){const{url:r,layerId:a,title:o,fullExtent:l,isTable:s}=e,i=n(r),u=null!=i&&\"FeatureServer\"===i.serverType;t.url=u?r:`${r}/${a}`,t.title||=o,t.extent=null,s||null==l||(t.extent=await w(l)),h(t,f.METADATA),h(t,f.MULTI_LAYER),m(t,f.SINGLE_LAYER),s&&m(t,f.TABLE),J(t)}async function q(e,t,r){const a=e.portal;await(a?.signIn()),await(a?.user?.addItem({item:e,data:t,folder:r?.folder}))}const z=a(C);async function C(e,t){await g(e),N(e);const r=e.portalItem,a=y(r),o=await L(e,a,t),s=await O(r,[{layer:e,layerJSON:o}]);return J(r),await r.update({data:s}),l(a),r}const M=a((async(e,t)=>{await F(e);const r=e[0].portalItem,a=y(r),o=await Promise.all(e.map((e=>L(e,a,t)))),s=await O(r,e.map(((e,t)=>({layer:e,layerJSON:o[t]}))));return J(r),await r.update({data:s}),await Promise.all(e.slice(1).map((e=>e.portalItem.reload()))),l(a),r.clone()})),Y=a(_);async function _(e,t,r){await g(e);const a=R(e,t),o=y(a),s=P({layer:e,layerJSON:await L(e,o,r)});return await D(e,a),await q(a,s,r),e.portalItem=a,l(o),a}export{z as save,M as saveAll,Y as saveAs};\n"],"mappings":"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"}