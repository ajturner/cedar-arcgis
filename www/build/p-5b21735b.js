import{l as t,y as e,aT as i,n as s,o as r,a8 as n,V as l,jN as o,jO as a,s as u,R as c,a6 as d,hG as h,hJ as m,hH as f,d3 as p,d4 as g,d5 as y,bS as w,ad as x,aW as v,au as S,cK as T,c1 as M,e as I,U as b,bP as E,cB as L,W as R}from"./p-b54724b6.js";import{p as j,L as C}from"./p-99d6b059.js";import{o as V}from"./p-f3bb10eb.js";import{j as P,p as F}from"./p-8bc47c76.js";import{e as A}from"./p-58fca073.js";import{o as O}from"./p-d2815bc0.js";import{o as U}from"./p-d5b10b16.js";var W;let D=W=class extends r{constructor(t){super(t),this.fullExtent=null,this.id=null,this.tileInfo=null}clone(){const t=new W;return this.hasOwnProperty("fullExtent")&&(t.fullExtent=this.fullExtent&&this.fullExtent.clone()),this.hasOwnProperty("id")&&(t.id=this.id),this.hasOwnProperty("tileInfo")&&(t.tileInfo=this.tileInfo&&this.tileInfo.clone()),t}};t([e({type:i,json:{read:{source:"fullExtent"}}})],D.prototype,"fullExtent",void 0),t([e({type:String,json:{read:{source:"id"}}})],D.prototype,"id",void 0),t([e({type:P,json:{read:{source:"tileInfo"}}})],D.prototype,"tileInfo",void 0),D=W=t([s("esri.layer.support.TileMatrixSet")],D);const K=D;var $;let k=$=class extends r{constructor(t){super(t),this.id=null,this.title=null,this.description=null,this.legendUrl=null}clone(){const t=new $;return this.hasOwnProperty("description")&&(t.description=this.description),this.hasOwnProperty("id")&&(t.id=this.id),this.hasOwnProperty("isDefault")&&(t.isDefault=this.isDefault),this.hasOwnProperty("keywords")&&(t.keywords=this.keywords&&this.keywords.slice()),this.hasOwnProperty("legendUrl")&&(t.legendUrl=this.legendUrl),this.hasOwnProperty("title")&&(t.title=this.title),t}};t([e({json:{read:{source:"id"}}})],k.prototype,"id",void 0),t([e({json:{read:{source:"title"}}})],k.prototype,"title",void 0),t([e({json:{read:{source:"abstract"}}})],k.prototype,"description",void 0),t([e({json:{read:{source:"legendUrl"}}})],k.prototype,"legendUrl",void 0),t([e({json:{read:{source:"isDefault"}}})],k.prototype,"isDefault",void 0),t([e({json:{read:{source:"keywords"}}})],k.prototype,"keywords",void 0),k=$=t([s("esri.layer.support.WMTSStyle")],k);const B=k;var _;let G=_=class extends r{constructor(t){super(t),this.description=null,this.fullExtent=null,this.fullExtents=null,this.id=null,this.imageFormats=null,this.layer=null,this.parent=null,this.styles=null,this.title=null,this.tileMatrixSetId=null,this.tileMatrixSets=null}readFullExtent(t,e){return(t=e.fullExtent)?i.fromJSON(t):null}readFullExtents(t,e){return e.fullExtents?.length?e.fullExtents.map((t=>i.fromJSON(t))):e.tileMatrixSets?.map((t=>i.fromJSON(t.fullExtent))).filter((t=>t))??[]}get imageFormat(){let t=this._get("imageFormat");return t||(t=this.imageFormats&&this.imageFormats.length?this.imageFormats[0]:""),t}set imageFormat(t){const e=this.imageFormats;t&&(t.includes("image/")||e&&!e.includes(t))&&(t.includes("image/")||(t="image/"+t),e&&!e.includes(t))?console.error("The layer doesn't support the format of "+t):this._set("imageFormat",t)}get styleId(){let t=this._get("styleId");return t||(t=this.styles?.at(0)?.id??""),t}set styleId(t){this._set("styleId",t)}get tileMatrixSet(){return this.tileMatrixSets?this.tileMatrixSets.find((t=>t.id===this.tileMatrixSetId)):null}clone(){const t=new _;return this.hasOwnProperty("description")&&(t.description=this.description),this.hasOwnProperty("imageFormats")&&(t.imageFormats=this.imageFormats&&this.imageFormats.slice()),this.hasOwnProperty("imageFormat")&&(t.imageFormat=this.imageFormat),this.hasOwnProperty("fullExtent")&&(t.fullExtent=this.fullExtent&&this.fullExtent.clone()),this.hasOwnProperty("id")&&(t.id=this.id),this.hasOwnProperty("layer")&&(t.layer=this.layer),this.hasOwnProperty("styleId")&&(t.styleId=this.styleId),this.hasOwnProperty("styles")&&(t.styles=this.styles&&this.styles.clone()),this.hasOwnProperty("tileMatrixSetId")&&(t.tileMatrixSetId=this.tileMatrixSetId),this.hasOwnProperty("tileMatrixSets")&&(t.tileMatrixSets=this.tileMatrixSets?.clone()),this.hasOwnProperty("title")&&(t.title=this.title),t}};t([e()],G.prototype,"description",void 0),t([e()],G.prototype,"fullExtent",void 0),t([n("fullExtent",["fullExtent"])],G.prototype,"readFullExtent",null),t([e({readOnly:!0})],G.prototype,"fullExtents",void 0),t([n("fullExtents",["fullExtents","tileMatrixSets"])],G.prototype,"readFullExtents",null),t([e()],G.prototype,"id",void 0),t([e()],G.prototype,"imageFormat",null),t([e({json:{read:{source:"formats"}}})],G.prototype,"imageFormats",void 0),t([e()],G.prototype,"layer",void 0),t([e()],G.prototype,"parent",void 0),t([e()],G.prototype,"styleId",null),t([e({type:l.ofType(B),json:{read:{source:"styles"}}})],G.prototype,"styles",void 0),t([e({json:{write:{ignoreOrigin:!0}}})],G.prototype,"title",void 0),t([e()],G.prototype,"tileMatrixSetId",void 0),t([e({readOnly:!0})],G.prototype,"tileMatrixSet",null),t([e({type:l.ofType(K),json:{read:{source:"tileMatrixSets"}}})],G.prototype,"tileMatrixSets",void 0),G=_=t([s("esri.layers.support.WMTSSublayer")],G);const N=G;const H=90.71428571428571;function q(t){const e=t.replaceAll(/ows:/gi,"");if(!J("Contents",(new DOMParser).parseFromString(e,"text/xml").documentElement))throw new u("wmtslayer:wmts-capabilities-xml-is-not-valid","the wmts get capabilities response is not compliant",{text:t})}function z(t,e){t=t.replaceAll(/ows:/gi,"");const i=(new DOMParser).parseFromString(t,"text/xml").documentElement,s=new Map,r=new Map,n=J("Contents",i);if(!n)throw new u("wmtslayer:wmts-capabilities-xml-is-not-valid");const l=J("OperationsMetadata",i),o=l?.querySelector("[name='GetTile']"),a=o?.getElementsByTagName("Get"),c=a&&Array.prototype.slice.call(a),d=e.url?.indexOf("https"),h=void 0!==d&&d>-1;let m,f,p=e.serviceMode,g=e?.url;if(c&&c.length&&c.some((t=>{const e=J("Constraint",t);return!e||et("AllowedValues","Value",p,e)?(g=t.attributes[0].nodeValue,!0):(!e||et("AllowedValues","Value","RESTful",e)||et("AllowedValues","Value","REST",e)?f=t.attributes[0].nodeValue:e&&!et("AllowedValues","Value","KVP",e)||(m=t.attributes[0].nodeValue),!1)})),!g)if(f)g=f,p="RESTful";else if(m)g=m,p="KVP";else{const t=J("ServiceMetadataURL",i);g=t?.getAttribute("xlink:href")}const y=g.indexOf("1.0.0/");-1===y&&"RESTful"===p?g+="/":y>-1&&(g=g.substring(0,y)),"KVP"===p&&(g+=y>-1?"":"?"),h&&(g=g.replace(/^http:/i,"https:"));const w=tt("ServiceIdentification>ServiceTypeVersion",i),x=tt("ServiceIdentification>AccessConstraints",i),v=x&&/^none$/i.test(x)?null:x,S=Q("Layer",n),T=Q("TileMatrixSet",n),M=S.map((t=>{const e=tt("Identifier",t);return s.set(e,t),it(e,t,T,h,w)}));return{copyright:v,dimensionMap:r,layerMap:s,layers:M,serviceMode:p,tileUrl:g}}function X(t){return t.layers.forEach((t=>{t.tileMatrixSets?.forEach((t=>{const e=t.tileInfo;e&&96!==e.dpi&&(e.lods?.forEach((i=>{i.scale=96*i.scale/e.dpi,i.resolution=vt(e.spatialReference?.wkid,i.scale*H/96,t.id)})),e.dpi=96)}))})),t}function Y(t){return t.nodeType===Node.ELEMENT_NODE}function J(t,e){for(let i=0;i<e.childNodes.length;i++){const s=e.childNodes[i];if(Y(s)&&s.nodeName===t)return s}return null}function Q(t,e){const i=[];for(let s=0;s<e.childNodes.length;s++){const r=e.childNodes[s];Y(r)&&r.nodeName===t&&i.push(r)}return i}function Z(t,e){const i=[];for(let s=0;s<e.childNodes.length;s++){const r=e.childNodes[s];Y(r)&&r.nodeName===t&&i.push(r)}return i.map((t=>t.textContent)).filter(c)}function tt(t,e){return t.split(">").forEach((t=>{e&&(e=J(t,e))})),e&&e.textContent}function et(t,e,i,s){let r;return Array.prototype.slice.call(s.childNodes).some((s=>{if(s.nodeName.includes(t)){const t=J(e,s),n=t&&t.textContent;if(n===i||i.split(":")&&i.split(":")[1]===n)return r=s,!0}return!1})),r}function it(t,e,i,s,r){const n=tt("Abstract",e),l=Z("Format",e);return{id:t,fullExtent:ot(e),fullExtents:at(e),description:n,formats:l,styles:ut(e,s),title:tt("Title",e),tileMatrixSets:ct(r,e,i)}}function st(t,e){const i=[],s=t.layerMap?.get(e);if(!s)return null;const r=Q("ResourceURL",s),n=Q("Dimension",s);let l,o,a,u;return n.length&&(l=tt("Identifier",n[0]),o=Z("Default",n[0])||Z("Value",n[0])),n.length>1&&(a=tt("Identifier",n[1]),u=Z("Default",n[1])||Z("Value",n[1])),t.dimensionMap.set(e,{dimensions:o,dimensions2:u}),r.forEach((t=>{let e=t.getAttribute("template");if("tile"===t.getAttribute("resourceType")){if(l&&o.length)if(e.includes("{"+l+"}"))e=e.replace("{"+l+"}","{dimensionValue}");else{const t=e.toLowerCase().indexOf("{"+l.toLowerCase()+"}");t>-1&&(e=e.substring(0,t)+"{dimensionValue}"+e.substring(t+l.length+2))}if(a&&u.length)if(e.includes("{"+a+"}"))e=e.replace("{"+a+"}","{dimensionValue2}");else{const t=e.toLowerCase().indexOf("{"+a.toLowerCase()+"}");t>-1&&(e=e.substring(0,t)+"{dimensionValue2}"+e.substring(t+a.length+2))}i.push({template:e,format:t.getAttribute("format"),resourceType:"tile"})}})),i}function rt(t,e,i,s,r,n,l,o){const a=nt(t,e,s);if(!(a?.length>0))return"";const{dimensionMap:u}=t,c=u.get(e).dimensions?.[0],d=u.get(e).dimensions2?.[0];return a[l%a.length].template.replaceAll(/\{Style\}/gi,r??"").replaceAll(/\{TileMatrixSet\}/gi,i??"").replaceAll(/\{TileMatrix\}/gi,n).replaceAll(/\{TileRow\}/gi,""+l).replaceAll(/\{TileCol\}/gi,""+o).replaceAll(/\{dimensionValue\}/gi,c).replaceAll(/\{dimensionValue2\}/gi,d)}function nt(t,e,i){const s=st(t,e),r=s?.filter((t=>t.format===i));return(r?.length?r:s)??[]}function lt(t,e,i,s){const{dimensionMap:r}=t,n=st(t,e);let l="";if(n&&n.length>0){const t=r.get(e).dimensions&&r.get(e).dimensions[0],o=r.get(e).dimensions2&&r.get(e).dimensions2[0];l=n[0].template,l.indexOf(".xxx")===l.length-4&&(l=l.slice(0,l.length-4)),l=l.replaceAll(/\{Style\}/gi,s),l=l.replaceAll(/\{TileMatrixSet\}/gi,i),l=l.replaceAll(/\{TileMatrix\}/gi,"{level}"),l=l.replaceAll(/\{TileRow\}/gi,"{row}"),l=l.replaceAll(/\{TileCol\}/gi,"{col}"),l=l.replaceAll(/\{dimensionValue\}/gi,t),l=l.replaceAll(/\{dimensionValue2\}/gi,o)}return l}function ot(t){const e=J("WGS84BoundingBox",t),i=e?tt("LowerCorner",e).split(" "):["-180","-90"],s=e?tt("UpperCorner",e).split(" "):["180","90"];return{xmin:parseFloat(i[0]),ymin:parseFloat(i[1]),xmax:parseFloat(s[0]),ymax:parseFloat(s[1]),spatialReference:{wkid:4326}}}function at(t){const e=[];return U(t,{BoundingBox:t=>{if(!t.getAttribute("crs"))return;const i=t.getAttribute("crs").toLowerCase(),s=ht(i),r=i.includes("epsg")&&O(s.wkid);let n,l,o,a;U(t,{LowerCorner:t=>{[n,l]=t.textContent.split(" ").map((t=>Number.parseFloat(t))),r&&([n,l]=[l,n])},UpperCorner:t=>{[o,a]=t.textContent.split(" ").map((t=>Number.parseFloat(t))),r&&([o,a]=[a,o])}}),e.push({xmin:n,ymin:l,xmax:o,ymax:a,spatialReference:s})}}),e}function ut(t,e){return Q("Style",t).map((t=>{const i=J("LegendURL",t),s=J("Keywords",t),r=s?Z("Keyword",s):[];let n=i&&i.getAttribute("xlink:href");e&&(n=n&&n.replace(/^http:/i,"https:"));return{abstract:tt("Abstract",t),id:tt("Identifier",t),isDefault:"true"===t.getAttribute("isDefault"),keywords:r,legendUrl:n,title:tt("Title",t)}}))}function ct(t,e,i){return Q("TileMatrixSetLink",e).map((e=>dt(t,e,i)))}function dt(t,e,i){const s=J("TileMatrixSet",e).textContent,r=Z("TileMatrix",e),n=i.find((t=>{const e=J("Identifier",t),i=e&&e.textContent;return!!(i===s||s.split(":")&&s.split(":")[1]===i)})),l=J("TileMatrixSetLimits",e),o=l&&Q("TileMatrixLimits",l),a=new Map;if(o?.length)for(const t of o){const e=J("TileMatrix",t).textContent,i=+J("MinTileRow",t).textContent,s=+J("MaxTileRow",t).textContent,r=+J("MinTileCol",t).textContent,n=+J("MaxTileCol",t).textContent;a.set(e,{minCol:r,maxCol:n,minRow:i,maxRow:s})}const u=tt("SupportedCRS",n).toLowerCase(),c=mt(n,u),d=c.spatialReference,h=J("TileMatrix",n),m=[parseInt(tt("TileWidth",h),10),parseInt(tt("TileHeight",h),10)],f=[];if(r.length)r.forEach(((t,e)=>{const i=et("TileMatrix","Identifier",t,n);f.push(xt(i,u,e,s,a))}));else{Q("TileMatrix",n).forEach(((t,e)=>{f.push(xt(t,u,e,s,a))}))}const p=pt(t,n,c,m,f[0]).toJSON(),g=new P({dpi:96,spatialReference:d,size:m,origin:c,lods:f}).toJSON();return{id:s,fullExtent:p,tileInfo:g}}function ht(t){t=t.toLowerCase();let e=parseInt(t.split(":").pop(),10);900913!==e&&3857!==e||(e=102100);const i=wt(t);return null!=i&&(e=i),{wkid:e}}function mt(t,e){return ft(J("TileMatrix",t),e)}function ft(t,e){const i=ht(e),[s,r]=tt("TopLeftCorner",t).split(" ").map((t=>parseFloat(t))),n=e.includes("epsg")&&O(i.wkid);return new d(n?{x:r,y:s,spatialReference:i}:{x:s,y:r,spatialReference:i})}function pt(t,e,s,r,n){const l=J("BoundingBox",e);let o,a,u,c,d,h;if(l&&(o=tt("LowerCorner",l).split(" "),a=tt("UpperCorner",l).split(" ")),o&&o.length>1&&a&&a.length>1)u=parseFloat(o[0]),d=parseFloat(o[1]),c=parseFloat(a[0]),h=parseFloat(a[1]);else{const t=J("TileMatrix",e),i=parseInt(tt("MatrixWidth",t),10),l=parseInt(tt("MatrixHeight",t),10);u=s.x,h=s.y,c=u+i*r[0]*n.resolution,d=h-l*r[1]*n.resolution}return gt(t,s.spatialReference,s)?new i(d,u,h,c,s.spatialReference):new i(u,d,c,h,s.spatialReference)}function gt(t,e,i){return"1.0.0"===t&&O(e.wkid)&&!(i.spatialReference.isGeographic&&i.x<-90&&i.y>=-90)}var yt;function wt(t){return t.includes("crs84")||t.includes("crs:84")?yt.CRS84:t.includes("crs83")||t.includes("crs:83")?yt.CRS83:t.includes("crs27")||t.includes("crs:27")?yt.CRS27:null}function xt(t,e,i,s,r){const n=ht(e),l=tt("Identifier",t);let o=parseFloat(tt("ScaleDenominator",t));const a=vt(n.wkid,o,s);o*=96/H;const u=+tt("MatrixWidth",t),c=+tt("MatrixHeight",t),{maxCol:d=u-1,maxRow:h=c-1,minCol:m=0,minRow:f=0}=r.get(l)??{},{x:p,y:g}=ft(t,e);return new F({cols:[m,d],level:i,levelValue:l,origin:[p,g],scale:o,resolution:a,rows:[f,h]})}function vt(t,e,i){let s;return s=o.hasOwnProperty(""+t)?o.values[o[t]]:"default028mm"===i?6370997*Math.PI/180:a(t).metersPerDegree,7*e/25e3/s}!function(t){t[t.CRS84=4326]="CRS84",t[t.CRS83=4269]="CRS83",t[t.CRS27=4267]="CRS27"}(yt||(yt={}));var St;const Tt={"image/png":".png","image/png8":".png","image/png24":".png","image/png32":".png","image/jpg":".jpg","image/jpeg":".jpeg","image/gif":".gif","image/bmp":".bmp","image/tiff":".tif","image/jpgpng":"","image/jpegpng":"","image/unknown":""},Mt=new Set(["version","service","request","layer","style","format","tilematrixset","tilematrix","tilerow","tilecol"]);let It=St=class extends(h(m(f(p(g(y(w))))))){constructor(...t){super(...t),this.activeLayer=null,this.copyright="",this.customParameters=null,this.customLayerParameters=null,this.fullExtent=null,this.operationalLayerType="WebTiledLayer",this.resourceInfo=null,this.serviceMode="RESTful",this.sublayers=null,this.type="wmts",this.version="1.0.0",this.addHandles([x((()=>this.activeLayer),((t,e)=>{e&&!this.sublayers?.includes(e)&&(e.layer=null,e.parent=null),t&&(t.layer=this,t.parent=this)}),v),S((()=>this.sublayers),"after-add",(({item:t})=>{t.layer=this,t.parent=this}),v),S((()=>this.sublayers),"after-remove",(({item:t})=>{t.layer=null,t.parent=null}),v),x((()=>this.sublayers),((t,e)=>{if(e)for(const t of e)t.layer=null,t.parent=null;if(t)for(const e of t)e.layer=this,e.parent=this}),v)])}normalizeCtorArgs(t,e){return"string"==typeof t?{url:t,...e}:t}load(t){return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMTS"]},t).catch(T).then((()=>this._fetchService(t))).catch((t=>{throw T(t),new u("wmtslayer:unsupported-service-data","Invalid response from the WMTS service.",{error:t})}))),Promise.resolve(this)}readActiveLayerFromService(t,e,i){this.activeLayer||(this.activeLayer=new N);let s=e.layers.find((t=>t.id===this.activeLayer.id));return s||(s=e.layers[0]),this.activeLayer.read(s,i),this.activeLayer}readActiveLayerFromItemOrWebDoc(t,e){const{templateUrl:i,wmtsInfo:s}=e,r=i?this._getLowerCasedUrlParams(i):null,n=s?.layerIdentifier;let l=null;const o=s?.tileMatrixSet;o&&(Array.isArray(o)?o.length&&(l=o[0]):l=o);const a=r?.format,u=r?.style;return new N({id:n,imageFormat:a,styleId:u,tileMatrixSetId:l})}writeActiveLayer(t,e,i,s){const r=this.activeLayer;e.templateUrl=this.getUrlTemplate(r.id,r.tileMatrixSetId,r.imageFormat,r.styleId);const n=M("tileMatrixSet.tileInfo",r);e.tileInfo=n?n.toJSON(s):null,e.wmtsInfo={...e.wmtsInfo,layerIdentifier:r.id,tileMatrixSet:r.tileMatrixSetId}}readCustomParameters(t,e){const i=e.wmtsInfo;return i?this._mergeParams(i.customParameters,i.url):null}get fullExtents(){return this.activeLayer.fullExtents}readServiceMode(t,e){return e.templateUrl.includes("?")?"KVP":"RESTful"}readSublayersFromService(t,e,i){return bt(e.layers,i)}get supportedSpatialReferences(){return this.activeLayer.tileMatrixSets?.map((t=>t.tileInfo?.spatialReference)).toArray().filter(c)??[]}get tilemapCache(){const t=this.activeLayer?.tileMatrixSet?.tileInfo;return t?new A(t):void 0}get title(){return this.activeLayer?.title??"Layer"}set title(t){this._overrideIfSome("title",t)}get url(){return this._get("url")}set url(t){t&&"/"===t.substr(-1)?this._set("url",t.slice(0,-1)):this._set("url",t)}createWebTileLayer(t){const e=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId),i=this._getTileMatrixSetById(t.tileMatrixSetId),s=i?.tileInfo,r=t.fullExtent,n=new j({layerIdentifier:t.id,tileMatrixSet:t.tileMatrixSetId,url:this.url});return this.customLayerParameters&&(n.customLayerParameters=this.customLayerParameters),this.customParameters&&(n.customParameters=this.customParameters),new C({fullExtent:r,urlTemplate:e,tileInfo:s,wmtsInfo:n})}async fetchTile(t,e,i,s={}){const{signal:r}=s,n=this.getTileUrl(t,e,i),{data:l}=await I(n,{responseType:"image",signal:r});return l}async fetchImageBitmapTile(t,e,i,s={}){const{signal:r}=s;if(this.fetchTile!==St.prototype.fetchTile){const n=await this.fetchTile(t,e,i,s);return V(n,t,e,i,r)}const n=this.getTileUrl(t,e,i),{data:l}=await I(n,{responseType:"blob",signal:r});return V(l,t,e,i,r)}findSublayerById(t){return this.sublayers?.find((e=>e.id===t))}getTileUrl(t,e,i){const s=this._getTileMatrixSetById(this.activeLayer.tileMatrixSetId),r=s?.tileInfo?.lods[t],n=r?r.levelValue||`${r.level}`:`${t}`;let l=this.resourceInfo?"":rt({dimensionMap:this.dimensionMap,layerMap:this.layerMap},this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId,n,e,i);if(!l){l=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId).replaceAll(/\{level\}/gi,n).replaceAll(/\{row\}/gi,`${e}`).replaceAll(/\{col\}/gi,`${i}`)}return l=this._appendCustomLayerParameters(l),l}getUrlTemplate(t,e,i,s){if(!this.resourceInfo){const i=lt({dimensionMap:this.dimensionMap,layerMap:this.layerMap},t,e,s);if(i)return i}if("KVP"===this.serviceMode)return this.url+"?SERVICE=WMTS&VERSION="+this.version+"&REQUEST=GetTile&LAYER="+t+"&STYLE="+s+"&FORMAT="+i+"&TILEMATRIXSET="+e+"&TILEMATRIX={level}&TILEROW={row}&TILECOL={col}";if("RESTful"===this.serviceMode){let r="";return Tt[i.toLowerCase()]&&(r=Tt[i.toLowerCase()]),this.url+t+"/"+s+"/"+e+"/{level}/{row}/{col}"+r}return""}async _fetchService(t){let e;if(this.resourceInfo)"KVP"===this.resourceInfo.serviceMode&&(this.url+=this.url.includes("?")?"":"?"),e={ssl:!1,data:this.resourceInfo};else try{e=await this._getCapabilities(this.serviceMode,t),q(e.data)}catch{const i="KVP"===this.serviceMode?"RESTful":"KVP";try{e=await this._getCapabilities(i,t),q(e.data),this.serviceMode=i}catch(t){throw new u("wmtslayer:unsupported-service-data","Services does not support RESTful or KVP service modes.",{error:t})}}this.resourceInfo?e.data=X(e.data):e.data=z(e.data,{serviceMode:this.serviceMode,url:this.url}),e.data&&this.read(e.data,{origin:"service"})}async _getCapabilities(t,e){const i=this._getCapabilitiesUrl(t);return await I(i,{...e,responseType:"text"})}_getTileMatrixSetById(t){const e=this.findSublayerById(this.activeLayer.id),i=e?.tileMatrixSets?.find((e=>e.id===t));return i}_appendCustomParameters(t){return this._appendParameters(t,this.customParameters)}_appendCustomLayerParameters(t){return this._appendParameters(t,{...b(this.customParameters),...this.customLayerParameters})}_appendParameters(t,e){const i=E(t),s={...i.query,...e},r=L(s);return""===r?i.path:`${i.path}?${r}`}_getCapabilitiesUrl(t){this.url=this.url.split("?")[0];const e="KVP"===t?`${this.url}?request=GetCapabilities&service=WMTS&version=${this.version}`:`${this.url}/${this.version}/WMTSCapabilities.xml`;return this._appendCustomParameters(e)}_getLowerCasedUrlParams(t){if(!t)return null;const e=E(t).query;if(!e)return null;const i={};return Object.keys(e).forEach((t=>{i[t.toLowerCase()]=e[t]})),i}_mergeParams(t,e){const i=this._getLowerCasedUrlParams(e);if(i){const e=Object.keys(i);e.length&&(t=t?b(t):{},e.forEach((e=>{t.hasOwnProperty(e)||Mt.has(e)||(t[e]=i[e])})))}return t}};function bt(t,e){return t.map((t=>{const i=new N;return i.read(t,e),i}))}t([e()],It.prototype,"dimensionMap",void 0),t([e()],It.prototype,"layerMap",void 0),t([e({type:N,json:{origins:{"web-document":{write:{ignoreOrigin:!0}}}}})],It.prototype,"activeLayer",void 0),t([n("service","activeLayer",["layers"])],It.prototype,"readActiveLayerFromService",null),t([n(["web-document","portal-item"],"activeLayer",["wmtsInfo"])],It.prototype,"readActiveLayerFromItemOrWebDoc",null),t([R(["web-document","portal-item"],"activeLayer",{templateUrl:{type:String},tileInfo:{type:P},"wmtsInfo.layerIdentifier":{type:String},"wmtsInfo.tileMatrixSet":{type:String}})],It.prototype,"writeActiveLayer",null),t([e({type:String,value:"",json:{write:!0}})],It.prototype,"copyright",void 0),t([e({type:["show","hide"]})],It.prototype,"listMode",void 0),t([e({json:{read:!0,write:!0}})],It.prototype,"blendMode",void 0),t([e({json:{origins:{"web-document":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}},"portal-item":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}}}}})],It.prototype,"customParameters",void 0),t([n(["portal-item","web-document"],"customParameters")],It.prototype,"readCustomParameters",null),t([e({json:{origins:{"web-document":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}},"portal-item":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}}}}})],It.prototype,"customLayerParameters",void 0),t([e({type:i,json:{write:{ignoreOrigin:!0},origins:{"web-document":{read:{source:"fullExtent"}},"portal-item":{read:{source:"fullExtent"}}}}})],It.prototype,"fullExtent",void 0),t([e({readOnly:!0})],It.prototype,"fullExtents",null),t([e({type:["WebTiledLayer"]})],It.prototype,"operationalLayerType",void 0),t([e()],It.prototype,"resourceInfo",void 0),t([e()],It.prototype,"serviceMode",void 0),t([n(["portal-item","web-document"],"serviceMode",["templateUrl"])],It.prototype,"readServiceMode",null),t([e({type:l.ofType(N)})],It.prototype,"sublayers",void 0),t([n("service","sublayers",["layers"])],It.prototype,"readSublayersFromService",null),t([e({readOnly:!0})],It.prototype,"supportedSpatialReferences",null),t([e({readOnly:!0})],It.prototype,"tilemapCache",null),t([e({json:{read:{source:"title"}}})],It.prototype,"title",null),t([e({json:{read:!1},readOnly:!0,value:"wmts"})],It.prototype,"type",void 0),t([e({json:{origins:{service:{read:{source:"tileUrl"}},"web-document":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}},"portal-item":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}}}}})],It.prototype,"url",null),t([e()],It.prototype,"version",void 0),It=St=t([s("esri.layers.WMTSLayer")],It);const Et=It;export default Et;
//# sourceMappingURL=p-5b21735b.js.map