import{bK as t,l as s,y as i,n,a3 as r,af as e,bL as h,bM as o}from"./p-b54724b6.js";import{m as c,b as u}from"./p-74887bd8.js";import{u as a,l}from"./p-cd4a8b9a.js";import{e as f}from"./p-cae2235f.js";function p(){const t=new Float32Array(6);return t[0]=1,t[3]=1,t}function d(t){const s=new Float32Array(6);return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=t[3],s[4]=t[4],s[5]=t[5],s}function M(t,s,i,n,r,e){const h=new Float32Array(6);return h[0]=t,h[1]=s,h[2]=i,h[3]=n,h[4]=r,h[5]=e,h}function y(t,s){return new Float32Array(t,s,6)}function g(t,s,i,n){const r=s[n],e=s[n+1];t[n]=i[0]*r+i[2]*e+i[4],t[n+1]=i[1]*r+i[3]*e+i[5]}function m(t,s,i,n=0,r=0,e=2){const h=r||s.length/e;for(let r=n;r<h;r++){g(t,s,i,r*e)}}Object.freeze(Object.defineProperty({__proto__:null,clone:d,create:p,createView:y,fromValues:M,transform:g,transformMany:m},Symbol.toStringTag,{value:"Module"}));function b(t,s){return t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=s[3],t[4]=s[4],t[5]=s[5],t}function w(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t}function v(t,s,i,n,r,e,h){return t[0]=s,t[1]=i,t[2]=n,t[3]=r,t[4]=e,t[5]=h,t}function O(t,s){const i=s[0],n=s[1],r=s[2],e=s[3],h=s[4],o=s[5];let c=i*e-n*r;return c?(c=1/c,t[0]=e*c,t[1]=-n*c,t[2]=-r*c,t[3]=i*c,t[4]=(r*o-e*h)*c,t[5]=(n*h-i*o)*c,t):null}function _(t){return t[0]*t[3]-t[1]*t[2]}function S(t,s,i){const n=s[0],r=s[1],e=s[2],h=s[3],o=s[4],c=s[5],u=i[0],a=i[1],l=i[2],f=i[3],p=i[4],d=i[5];return t[0]=n*u+e*a,t[1]=r*u+h*a,t[2]=n*l+e*f,t[3]=r*l+h*f,t[4]=n*p+e*d+o,t[5]=r*p+h*d+c,t}function k(t,s,i){const n=s[0],r=s[1],e=s[2],h=s[3],o=s[4],c=s[5],u=Math.sin(i),a=Math.cos(i);return t[0]=n*a+e*u,t[1]=r*a+h*u,t[2]=n*-u+e*a,t[3]=r*-u+h*a,t[4]=o,t[5]=c,t}function F(t,s,i){const n=s[0],r=s[1],e=s[2],h=s[3],o=s[4],c=s[5],u=i[0],a=i[1];return t[0]=n*u,t[1]=r*u,t[2]=e*a,t[3]=h*a,t[4]=o,t[5]=c,t}function j(t,s,i){const n=s[0],r=s[1],e=s[2],h=s[3],o=s[4],c=s[5],u=i[0],a=i[1];return t[0]=n,t[1]=r,t[2]=e,t[3]=h,t[4]=n*u+e*a+o,t[5]=r*u+h*a+c,t}function A(t,s){const i=Math.sin(s),n=Math.cos(s);return t[0]=n,t[1]=i,t[2]=-i,t[3]=n,t[4]=0,t[5]=0,t}function x(t,s){return t[0]=s[0],t[1]=0,t[2]=0,t[3]=s[1],t[4]=0,t[5]=0,t}function N(t,s){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=s[0],t[5]=s[1],t}function T(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"}function C(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+1)}function I(t,s,i){return t[0]=s[0]+i[0],t[1]=s[1]+i[1],t[2]=s[2]+i[2],t[3]=s[3]+i[3],t[4]=s[4]+i[4],t[5]=s[5]+i[5],t}function z(t,s,i){return t[0]=s[0]-i[0],t[1]=s[1]-i[1],t[2]=s[2]-i[2],t[3]=s[3]-i[3],t[4]=s[4]-i[4],t[5]=s[5]-i[5],t}function B(t,s,i){return t[0]=s[0]*i,t[1]=s[1]*i,t[2]=s[2]*i,t[3]=s[3]*i,t[4]=s[4]*i,t[5]=s[5]*i,t}function V(t,s,i,n){return t[0]=s[0]+i[0]*n,t[1]=s[1]+i[1]*n,t[2]=s[2]+i[2]*n,t[3]=s[3]+i[3]*n,t[4]=s[4]+i[4]*n,t[5]=s[5]+i[5]*n,t}function q(t,s){return t[0]===s[0]&&t[1]===s[1]&&t[2]===s[2]&&t[3]===s[3]&&t[4]===s[4]&&t[5]===s[5]}function G(s,i){const n=s[0],r=s[1],e=s[2],h=s[3],o=s[4],c=s[5],u=i[0],a=i[1],l=i[2],f=i[3],p=i[4],d=i[5],M=t();return Math.abs(n-u)<=M*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(r-a)<=M*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(e-l)<=M*Math.max(1,Math.abs(e),Math.abs(l))&&Math.abs(h-f)<=M*Math.max(1,Math.abs(h),Math.abs(f))&&Math.abs(o-p)<=M*Math.max(1,Math.abs(o),Math.abs(p))&&Math.abs(c-d)<=M*Math.max(1,Math.abs(c),Math.abs(d))}const P=S,Q=z;Object.freeze(Object.defineProperty({__proto__:null,add:I,copy:b,determinant:_,equals:G,exactEquals:q,frob:C,fromRotation:A,fromScaling:x,fromTranslation:N,identity:w,invert:O,mul:P,multiply:S,multiplyScalar:B,multiplyScalarAndAdd:V,rotate:k,scale:F,set:v,str:T,sub:Q,subtract:z,translate:j},Symbol.toStringTag,{value:"Module"}));function R(t,s){return t.length=0,s.forEach((s=>t.push(s))),t}const E=new Set,K=[],L=new Map,D=[0,0];let H=class extends r{constructor(t){super(t),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:t,process:s}=this;this._queue=new a({concurrency:t,process:(t,i)=>{const n=this._keyToItem.get(t);return s(n,{signal:i})},peeker:t=>t.values().next().value})}destroy(){this.clear(),this._queue=e(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(t){const s="string"==typeof t?t:t.id;this._queue.abort(s)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(t){return"string"==typeof t?this._keyToItem.has(t):this._keyToItem.has(t.id)}isOngoing(t){const s="string"==typeof t?t:t.id;return this.has(s)&&this._queue.isOngoing(s)}pause(){this._queue.pause()}push(t,s){const i=t.key.id+"-"+s;if(this.has(i))return this.get(i);const n=this._queue.push(i),r=()=>{this._keyToItem.delete(i),this.notifyChange("updating")};return this._keyToItem.set(i,t),n.then(r,r),this.notifyChange("updating"),n}reset(){this._queue.reset(),this.notifyChange("updating")}resume(){this._queue.resume()}_peekByScaleFirst(t){if(!this.state)return t.values().next().value;const s=this.tileInfoView;let i=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY;t.forEach((t=>{const s=this._keyToItem.get(t),r=this.tileInfoView.getTileScale(s.key);L.has(r)||(L.set(r,[]),i=Math.max(r,i),n=Math.min(r,n)),L.get(r).push(s.key),E.add(r)}));let r=this.state.scale;L.has(r)||(R(K,E),K.sort(((t,s)=>t-s)),r=K.reduce(((t,s)=>Math.abs(s-r)<Math.abs(t-r)?s:t),K[0])),r=Math.min(r,i),r=Math.max(r,n);const e=L.get(r),h=s.getClosestInfoForScale(r),o=h.getColumnForX(this.state.center[0]),c=h.getRowForY(this.state.center[1]);return e.sort(((t,s)=>{const i=h.denormalizeCol(t.col,t.world),n=h.denormalizeCol(s.col,s.world);return Math.sqrt((o-i)*(o-i)+(c-t.row)*(c-t.row))-Math.sqrt((o-n)*(o-n)+(c-s.row)*(c-s.row))})),E.clear(),L.clear(),e[0].id}_peekByCenterFirst(t){if(!this.state)return t.values().next().value;const s=this.tileInfoView,i=this.state.center;let n,r=Number.POSITIVE_INFINITY;return t.forEach((t=>{const e=this._keyToItem.get(t);s.getTileCoords(D,e.key);const h=c(D,i);h<r&&(r=h,n=e.key)})),n.id}};s([i({constructOnly:!0})],H.prototype,"concurrency",void 0),s([i({constructOnly:!0})],H.prototype,"process",void 0),s([i()],H.prototype,"state",void 0),s([i({constructOnly:!0})],H.prototype,"strategy",void 0),s([i({constructOnly:!0})],H.prototype,"tileInfoView",void 0),s([i({readOnly:!0})],H.prototype,"updating",null),H=s([n("esri.views.2d.tiling.PagedTileQueue")],H);function J(t,s){return t.length=0,s.forEach((s=>t.push(s))),t}const U=new Set,W=[],X=new Map,Y=[0,0];let Z=class extends r{constructor(t){super(t),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:t,process:s,strategy:i}=this;this._queue=new a({concurrency:t,process:(t,i)=>{const n=this._keyToItem.get(t);return s(n,{signal:i})},peeker:"scale-first"===i?t=>this._peekByScaleFirst(t):t=>this._peekByCenterFirst(t)})}destroy(){this.clear(),this._queue=e(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(t){const s="string"==typeof t?t:t.id;this._queue.abort(s)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(t){return"string"==typeof t?this._keyToItem.has(t):this._keyToItem.has(t.id)}isOngoing(t){const s="string"==typeof t?t:t.id;return this.has(s)&&this._queue.isOngoing(s)}pause(){this._queue.pause()}push(t){const s=t.key.id;if(this._queue.has(s))return this._queue.get(s);const i=this._queue.push(s),n=()=>{this._keyToItem.delete(s),this.notifyChange("updating")};return this._keyToItem.set(s,t),i.then(n,n),this.notifyChange("updating"),i}reset(){this._queue.reset()}resume(){this._queue.resume()}_peekByScaleFirst(t){if(!this.state)return t.values().next().value;const s=this.tileInfoView;let i=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY;t.forEach((t=>{const s=this._keyToItem.get(t),r=this.tileInfoView.getTileScale(s.key);X.has(r)||(X.set(r,[]),i=Math.max(r,i),n=Math.min(r,n)),X.get(r).push(s.key),U.add(r)}));let r=this.state.scale;X.has(r)||(J(W,U),W.sort(((t,s)=>t-s)),r=W.reduce(((t,s)=>Math.abs(s-r)<Math.abs(t-r)?s:t),W[0])),r=Math.min(r,i),r=Math.max(r,n);const e=X.get(r),h=s.getClosestInfoForScale(r),o=h.getColumnForX(this.state.center[0]),c=h.getRowForY(this.state.center[1]);return e.sort(((t,s)=>{const i=h.denormalizeCol(t.col,t.world),n=h.denormalizeCol(s.col,s.world);return Math.sqrt((o-i)*(o-i)+(c-t.row)*(c-t.row))-Math.sqrt((o-n)*(o-n)+(c-s.row)*(c-s.row))})),U.clear(),X.clear(),e[0].id}_peekByCenterFirst(t){if(!this.state)return t.values().next().value;const s=this.tileInfoView,i=this.state.center;let n,r=Number.POSITIVE_INFINITY;return t.forEach((t=>{const e=this._keyToItem.get(t);s.getTileCoords(Y,e.key);const h=c(Y,i);h<r&&(r=h,n=e.key)})),n.id}};s([i({constructOnly:!0})],Z.prototype,"concurrency",void 0),s([i({constructOnly:!0})],Z.prototype,"process",void 0),s([i()],Z.prototype,"state",void 0),s([i({constructOnly:!0})],Z.prototype,"strategy",void 0),s([i({constructOnly:!0})],Z.prototype,"tileInfoView",void 0),s([i({readOnly:!0})],Z.prototype,"updating",null),Z=s([n("esri.views.2d.tiling.TileQueue")],Z);const $=Z;class tt{constructor(t,s,i){this.maxSize=t,this._tileInfoView=s,this._removedFunc=i,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(t){return this._tilePerId.has(t)}get(t){return this._tilePerId.get(t)}pop(t){const s=this._tilePerId.get(t);if(!s)return;const i=s.key.level,n=this._tileKeysPerLevel[i];st(this._tilePerId,t);for(let s=0;s<n.length;s++)if(n[s].id===t){n.splice(s,1);break}return s.visible=!0,s}add(t){t.visible=!1;const s=t.key,i=s.id;if(this._tilePerId.has(i))return;this._tilePerId.set(i,t);const n=s.level;this._tileKeysPerLevel[n]||(this._tileKeysPerLevel[n]=[]),this._tileKeysPerLevel[n].push(s)}prune(t,s,i){let n=this._tilePerId.size;if(n<=this.maxSize)return;let r=this._tileKeysPerLevel.length-1;for(;n>this.maxSize&&r>=0;)r!==t&&(n=this._pruneAroundCenterTile(n,s,i,r)),r--;n>this.maxSize&&(n=this._pruneAroundCenterTile(n,s,i,t))}_pruneAroundCenterTile(t,s,i,n){const r=this._tileKeysPerLevel[n];if(!r||0===r.length)return t;const{size:e,origin:h}=this._tileInfoView.tileInfo,o=i*e[0],c=i*e[1],a=[0,0],l=[0,0];for(r.sort(((t,i)=>(a[0]=h.x+o*(t.col+.5),a[1]=h.y-c*(t.row+.5),l[0]=h.x+o*(i.col+.5),l[1]=h.y-c*(i.row+.5),u(a,s)-u(l,s))));r.length>0;){const s=r.pop();if(this._removeTile(s.id),--t===this.maxSize)break}return t}_removeTile(t){const s=this._tilePerId.get(t);this._removedFunc&&s&&this._removedFunc(s),st(this._tilePerId,t)}}function st(t,s){t.delete(s)}const it=new f(0,0,0,0),nt=new Map,rt=[],et=[];class ht{constructor(t){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,null!=t.resampling&&(this.resampling=t.resampling),t.cachePolicy&&(this.cachePolicy=t.cachePolicy),t.coveragePolicy&&(this.coveragePolicy=t.coveragePolicy),null!=t.buffer&&(this.buffer=t.buffer),t.cacheSize&&(this._tileCache=new tt(t.cacheSize,this.tileInfoView,(t=>{this.releaseTile(t)})))}destroy(){this.tileIndex.clear()}update(t){const{resampling:s,tileIndex:i}=this,{scale:n,center:r,resolution:e}=t.state,{minScale:h,maxScale:o}=this.tileInfoView,c=!t.stationary&&n>this._previousScale;if(this._previousScale=n,!s&&(n>h||n<o))return this.tiles.length=0,void this.clear();const u=this.tileInfoView.getTileCoverage(t.state,this.buffer,this.resampling,this.coveragePolicy);if(!u)return this.tiles.length=0,void this.clear();const{spans:a,lodInfo:f}=u,{level:p}=f;this.tiles.length=0,i.forEach((t=>t.visible=!0));let d=0,M=0;if(a.length>0)for(const{row:t,colFrom:s,colTo:n}of a)for(let r=s;r<=n;r++){d++;const s=it.set(p,t,f.normalizeCol(r),f.getWorldForColumn(r)).id;let n=i.get(s);if(n)n.isReady?(nt.set(s,n),M++):c||this._addParentTile(s,nt);else{if(this._tileCache?.has(s)){if(n=this._tileCache.pop(s),this.tileIndex.set(s,n),n.isReady){nt.set(s,n),M++;continue}}else n=this.acquireTile(it),this.tileIndex.set(s,n);c||this._addParentTile(s,nt)}}const y=M===d;for(const[t,s]of i){if(nt.has(t))continue;it.set(t);const i=this.tileInfoView.intersects(u,it),n="purge"===this.cachePolicy?it.level!==p:it.level>p;!i||!c&&y?!n&&i||rt.push(s):s.isReady?n&&"purge"===this.cachePolicy&&this._hasReadyAncestor(it,p)?rt.push(s):et.push(s):n&&rt.push(s)}for(const t of et)t.isReady&&nt.set(t.key.id,t);for(const t of rt)this._tileCache?this._tileCache.add(t):this.releaseTile(t),i.delete(t.key.id);for(const t of nt.values())this.tiles.push(t);for(const t of i.values())nt.has(t.key.id)||(t.visible=!1);this._tileCache?.prune(p,r,e),l.pool.release(u),et.length=0,rt.length=0,nt.clear()}clear(){const{tileIndex:t}=this;for(const s of t.values())this.releaseTile(s);t.clear()}refresh(t){for(const s of this.tileIndex.values())this.tiles.includes(s)?t(s):rt.push(s);for(const t of rt)this.releaseTile(t),this.tileIndex.delete(t.key.id);this._tileCache?.clear()}updateCacheSize(t){this._tileCache&&(this._tileCache.maxSize=t)}_addParentTile(t,s){let i=t,n=null;for(;i=this.tileInfoView.getTileParentId(i),i;)if(this.tileIndex.has(i)){if(n=this.tileIndex.get(i),n?.isReady){s.has(n.key.id)||s.set(n.key.id,n);break}}else if(this._tileCache?.has(i)&&(n=this._tileCache.pop(i),this.tileIndex.set(i,n),n?.isReady)){s.has(n.key.id)||s.set(n.key.id,n);break}}_hasReadyAncestor(t,s){const i=o();this.tileInfoView.getTileBounds(i,t,!0);for(const n of this.tileIndex.values())if(n.isReady&&n.key.level>=s&&n.key.level<t.level){const t=o();if(this.tileInfoView.getTileBounds(t,n.key,!0),h(t,i))return!0}return!1}}export{x as M,m as a,w as b,F as c,ht as d,k as e,N as f,A as h,j as i,p as n,S as o,O as r,v as s,$ as y};
//# sourceMappingURL=p-faf4e331.js.map